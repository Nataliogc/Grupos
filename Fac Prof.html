<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas - Hotel Guadiana</title>
    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Montserrat:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap');

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
            }

            .page-container {
                box-shadow: none;
                margin: 0;
                border: none;
                width: 100%;
                min-height: auto;
            }

            .editable:hover {
                background: transparent;
            }

            select {
                appearance: none;
                -webkit-appearance: none;
                border: none;
                background: transparent;
                padding: 0;
            }

            .print-bg-green {
                background-color: #2d5a43 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-bg-gray {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
        }

        .editable {
            min-height: 1.2em;
            min-width: 20px;
            display: inline-block;
            cursor: text;
        }

        .editable:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
        }

        .editable:focus {
            outline: 2px solid #2d5a43;
            background: white;
        }

        .font-pro {
            font-family: 'Courier Prime', monospace;
            letter-spacing: -0.5px;
        }

        .font-logo {
            font-family: 'Libre Baskerville', serif;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 10mm 15mm;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tab-active {
            border-bottom: 3px solid #2d5a43;
            color: #2d5a43;
            font-weight: 700;
        }

        select.no-print {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 4px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        select.no-print:hover {
            border-color: #2d5a43;
            color: #2d5a43;
            background-color: #fff;
        }

        .logo-placeholder {
            max-height: 80px;
            max-width: 250px;
            object-fit: contain;
        }

        .legal-footer {
            font-size: 8px;
            line-height: 1.3;
            color: #1f2937;
            text-align: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        #ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .iva-breakdown-small {
            font-size: 9px;
            color: #4b5563;
            line-height: 1.4;
        }

        /* Estilos especÃ­ficos Proforma PDF */
        .proforma-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .proforma-header-table td {
            vertical-align: top;
        }

        .proforma-box {
            border: 1px solid black;
            display: inline-block;
            width: 220px;
            font-size: 10px;
            font-family: 'Courier Prime', monospace;
        }

        .proforma-box-header {
            border-bottom: 1px solid black;
            display: flex;
            font-weight: bold;
            background: #f9fafb;
        }

        .proforma-box-header div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-header div:last-child {
            border-right: none;
        }

        .proforma-box-row {
            display: flex;
        }

        .proforma-box-row div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-row div:last-child {
            border-right: none;
        }

        .proforma-table th {
            border-bottom: 2px solid black;
            border-top: 1px solid black;
            padding: 5px 0;
            font-weight: bold;
            text-align: left;
            font-size: 10px;
        }

        .proforma-table td {
            padding: 4px 0;
            font-size: 10px;
            vertical-align: top;
        }

        .proforma-total-box {
            background-color: #2d5a43;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            width: 300px;
            float: right;
        }

        .clean-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 4px;
        }

        .clean-label {
            font-weight: bold;
            width: 100px;
        }
    </style>
</head>

<body class="bg-gray-200 p-0 md:p-8">

    <!-- Panel de Control Superior -->
    <div
        class="max-w-[210mm] mx-auto mb-6 no-print bg-white shadow-lg rounded-xl p-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex gap-6 items-center">
            <a href="Admin.html" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-[#2d5a43]"
                title="Volver al Admin">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </a>
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entorno de
                    Trabajo</span>
                <div class="flex gap-4">
                    <button onclick="switchTemplate('confirmacion')" id="btn-confirmacion"
                        class="pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        ConfirmaciÃ³n</button>
                    <button onclick="switchTemplate('proforma')" id="btn-proforma"
                        class="pb-2 px-2 text-gray-400 hover:text-gray-600 transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Factura Proforma</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Seleccionar Hotel</span>
            <select id="hotel-selector" onchange="updateHotel(this.value)"
                class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#2d5a43]">
                <option value="guadiana">Sercotel Guadiana</option>
                <option value="cumbria">Sercotel Cumbria</option>
            </select>
        </div>

        <div class="flex gap-2">
            <button onclick="saveAndExit()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-blue-500 transition-all flex items-center gap-1 shadow-md">
                ðŸ’¾ Guardar y Salir
            </button>
            <button onclick="generateAIEmail()"
                class="bg-emerald-50 hover:bg-emerald-100 text-[#2d5a43] px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-emerald-200 transition-all flex items-center gap-1">
                âœ¨ Redactar Email
            </button>
            <button onclick="window.print()"
                class="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all uppercase text-[10px]">
                Imprimir / PDF
            </button>
        </div>
    </div>

    <!-- CONTENEDOR DE LA PÃGINA -->
    <div id="capture-area" class="page-container shadow-2xl border border-gray-300">

        <!-- MODELO 1: CONFIRMACIÃ“N (Estilo Moderno) -->
        <div id="tpl-confirmacion" class="template-content font-sans">
            <div class="flex justify-between items-start mb-8">
                <div class="logo-box">
                    <img id="logo-img-1" src="Logos/Sercotel Guadiana.jpg" class="max-h-24 w-auto object-contain"
                        alt="Logo">
                </div>
                <div class="text-right">
                    <h3
                        class="text-lg font-bold text-gray-700 border-b-2 border-gray-700 inline-block mb-1 uppercase tracking-tighter">
                        ConfirmaciÃ³n de Reserva</h3>
                    <p class="text-sm font-bold">Reserva: <span class="editable" id="reserva-id-1"
                            contenteditable="true">206268</span></p>
                    <p class="text-[10px] text-gray-400 italic">Fecha: <span class="editable" id="fecha-proforma-1"
                            contenteditable="true">12/02/2026</span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="border-l-4 border-[#2d5a43] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Solicitante</h4>
                    <div class="text-xs space-y-1">
                        <p><strong>Organismo:</strong> <span class="editable" id="solicitante-org-1"
                                contenteditable="true">EAPN-ES</span></p>
                        <p><strong>Contacto:</strong> <span class="editable" id="solicitante-nombre-1"
                                contenteditable="true">MARCELLO RONCHI</span></p>
                        <p><strong>Email:</strong> <span class="editable" id="solicitante-email-1"
                                contenteditable="true">marcello.ronchi@eapn.es</span></p>
                    </div>
                </div>
                <div class="border-l-4 border-[#eab308] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Reserva</h4>
                    <div class="text-xs grid grid-cols-2 gap-x-1">
                        <span class="text-gray-500">Personas:</span> <span class="editable font-bold"
                            id="reserva-personas-1" contenteditable="true">70</span>
                        <span class="text-gray-500">Entrada:</span> <span class="editable font-bold"
                            id="reserva-entrada-1" contenteditable="true">21-04-2026</span>
                        <span class="text-gray-500">Salida:</span> <span class="editable font-bold"
                            id="reserva-salida-1" contenteditable="true">24-04-2026</span>
                    </div>
                </div>
            </div>

            <table class="w-full text-[10px] mb-6 border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-[#2d5a43] border-b-2 border-[#2d5a43] uppercase text-[8px] font-bold">
                        <th class="p-2 text-left">Fecha</th>
                        <th class="p-2 text-center w-8">Cant.</th>
                        <th class="p-2 text-left">Concepto</th>
                        <th class="p-2 text-center w-8">Reg</th>
                        <th class="p-2 text-center w-8">DÃ­as</th>
                        <th class="p-2 text-right w-16">Precio/U</th>
                        <th class="p-2 text-right w-20">Total</th>
                        <th class="p-2 w-4 no-print"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <!-- MODELO 2: FACTURA PROFORMA (REDISEÃ‘ADO PARA COINCIDIR CON IMAGEN) -->
        <div id="tpl-proforma" class="template-content hidden font-pro text-black">

            <!-- Texto Vertical Legal -->
            <div class="absolute left-[3mm] top-0 bottom-0 flex items-center justify-center text-[8px] text-black font-sans font-bold"
                style="writing-mode: vertical-rl; transform: rotate(180deg);">
                <span class="whitespace-nowrap italic">SWEETMOON DESARROLLOS S.L. &nbsp;&nbsp;&nbsp; Inscrito en la hoja
                    CR-00035559 del Registro Mercantil de Ciudad Real. Folio electrÃ³nico. InscripciÃ³n/anotaciÃ³n 4
                    &nbsp;&nbsp;&nbsp; N.I.F. B-87067302</span>
            </div>

            <table class="w-full mb-6">
                <tr>
                    <td width="55%" class="align-top">
                        <div class="flex items-center gap-4 mb-8">
                            <img id="logo-img-2" src="Logos/Sercotel Guadiana.jpg"
                                class="max-h-20 w-auto object-contain" alt="Logo">
                        </div>

                        <!-- Caja Datos Factura -->
                        <div class="proforma-box w-[250px] border-black">
                            <div class="proforma-box-header bg-gray-100 border-b border-black">
                                <div class="border-r border-black">Factura</div>
                                <div class="border-r border-black">Fecha</div>
                                <div>Pag.</div>
                            </div>
                            <div class="proforma-box-row">
                                <div class="border-r border-black font-bold text-[10px]" id="reserva-id-2">PROFORMA
                                </div>
                                <div class="border-r border-black text-xs"><span class="editable" id="fecha-proforma-2"
                                        contenteditable="true">12-02-2026</span></div>
                                <div class="text-xs">1</div>
                            </div>
                        </div>
                    </td>
                    <td width="45%" class="align-top pt-2">
                        <div class="bg-slate-50 p-4 rounded-lg shadow-sm text-xs font-mono text-gray-600">
                            <div class="font-bold text-black uppercase text-sm editable" id="solicitante-org-2"
                                contenteditable="true" style="display:block;">RAZÃ“N SOCIAL</div>
                            <div class="editable" id="client-address" contenteditable="true" style="display:block;">
                                Calle DirecciÃ³n</div>
                            <div class="editable" id="client-city" contenteditable="true" style="display:block;">CP,
                                Ciudad</div>
                            <div class="mt-4 font-bold text-black">
                                N.I.F.: <span class="editable" id="client-nif" contenteditable="true">B00000000</span>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- Caja Datos Ocupante -->
            <div class="border border-black p-2 mb-6 text-[11px] leading-relaxed relative" id="ocupante-box">
                <button
                    class="no-print absolute -top-3 -right-3 bg-emerald-500 text-white rounded-full w-5 h-5 text-[9px] font-bold shadow hover:bg-emerald-600 transition hidden"
                    id="ocupante-restore"
                    onclick="document.querySelectorAll('.ocupante-row').forEach(r=>r.classList.remove('hidden'));this.classList.add('hidden');"
                    title="Restaurar campos ocultos">â†º</button>
                <div class="mb-2 ocupante-row flex items-center gap-1">
                    <span><strong>Ocupante :</strong> <span class="editable min-w-[200px]"
                            contenteditable="true">EAPN</span></span>
                    <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                        onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                        title="Ocultar">âœ•</button>
                </div>
                <div class="grid grid-cols-[1fr_1fr_1fr] gap-x-2">
                    <div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span><strong>HabitaciÃ³n :</strong> <span class="editable w-16"
                                    contenteditable="true"></span></span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">âœ•</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span><strong>Nro. Personas :</strong> <span class="editable font-bold"
                                    id="reserva-personas-2" contenteditable="true">70</span></span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">âœ•</button>
                        </div>
                    </div>
                    <div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span><strong>Entrada :</strong> <span class="editable font-bold" id="reserva-entrada-2"
                                    contenteditable="true">21-04-2026</span></span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">âœ•</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span><strong>Salida :</strong> <span class="editable font-bold" id="reserva-salida-2"
                                    contenteditable="true">24-04-2026</span></span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">âœ•</button>
                        </div>
                    </div>
                    <div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span><strong>NÂº Bono :</strong> <span class="editable"
                                    contenteditable="true">42583</span></span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">âœ•</button>
                        </div>
                    </div>
                </div>
                <div class="no-print mt-2 text-center">
                    <button onclick="addOcupanteField()"
                        class="text-[9px] uppercase tracking-widest font-bold text-gray-400 hover:text-emerald-600 transition">+
                        AÃ±adir campo</button>
                </div>
            </div>

            <!-- Tabla de Conceptos -->
            <table class="w-full text-[11px] proforma-table mb-2">
                <thead>
                    <tr class="border-y border-black">
                        <th width="12%" class="text-left font-bold py-1">FECHA</th>
                        <th width="8%" class="text-left font-bold py-1">HAB.</th>
                        <th width="8%" class="text-left font-bold py-1">CANT.</th>
                        <th width="32%" class="text-left font-bold py-1">CONCEPTO</th>
                        <th width="13%" class="text-right font-bold py-1 uppercase">Cargos</th>
                        <th width="13%" class="text-right font-bold py-1 uppercase">Abonos</th>
                        <th width="14%" class="text-right font-bold py-1 uppercase">Saldo</th>
                        <th class="w-4 no-print border-none"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <div class="no-print flex justify-center mb-4 mt-2">
            <button onclick="addRow()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-[9px] uppercase font-bold tracking-widest transition border border-gray-300">
                + AÃ±adir Concepto
            </button>
        </div>

        <!-- TOTALES Y FOOTER -->
        <div class="mt-auto">
            <!-- Totales DinÃ¡micos -->
            <div id="footer-totals" class="w-full"></div>

            <!-- PolÃ­ticas de Reserva (Solo en ConfirmaciÃ³n) -->
            <div id="tpl-policies" class="mt-8 text-[10px] leading-relaxed border-t border-gray-100 pt-4 hidden">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h5 class="font-bold text-[#2d5a43] uppercase mb-2">PolÃ­ticas de CancelaciÃ³n</h5>
                        <p class="editable" contenteditable="true">CancelaciÃ³n gratuita hasta 7 dÃ­as antes de la
                            llegada. Entre 7 y 3 dÃ­as, cargo de la 1Âª noche. Menos de 72 horas o No-Show, cargo del 100%
                            de la estancia.</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-[#2d5a43] uppercase mb-2">GarantÃ­a y Pago</h5>
                        <p class="editable" contenteditable="true">Para confirmar la reserva se requiere el cumplimiento
                            de los plazos de depÃ³sito indicados. El resto del pago se realizarÃ¡ en el check-in o segÃºn
                            acuerdo comercial.</p>
                    </div>
                </div>

            </div>

            <!-- Footer con diseÃ±o verde -->
            <div id="common-footer" class="mt-20 pt-4 border-t border-black text-[10px] font-pro">
                <div class="flex justify-between items-end">
                    <div class="flex gap-8">
                        <div>
                            <span class="text-[#2d5a43] font-bold hotel-address-footer">C/GUADIANA 36</span><br>
                            <span class="text-[#22c55e] font-bold hotel-cp-footer">13002</span> <span
                                class="hotel-city-footer">Ciudad Real</span>
                        </div>
                        <div>
                            <span class="text-[#2d5a43] font-bold">E-mail:</span> <span
                                class="hotel-email-footer">info@hotelguadiana.es</span><br>
                            <span class="text-[#22c55e] font-bold">Web:</span> <span
                                class="hotel-web-footer">www.hotelguadiana.es</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[#2d5a43] font-bold">Tel:</span> <span class="hotel-tel-footer">926 22 33
                            13</span><br>
                        <span class="text-[#22c55e] font-bold">Fax:</span> <span class="hotel-fax-footer">926 27 30
                            57</span>
                    </div>
                </div>
                <!-- Hora y Fecha pie de pÃ¡gina -->
                <div class="mt-8 flex justify-between text-gray-400 text-[9px]">
                    <div class="flex gap-4">
                        <span id="timestamp-date">12-02-26</span>
                        <span id="timestamp-time">16.50</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="no-print">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-[#2d5a43] flex items-center gap-2"></h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div id="ai-content" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto mb-6 pr-2">
                Generando respuesta...
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t">
                <button onclick="copyAIContent()" id="btn-copy"
                    class="text-xs font-bold uppercase tracking-widest text-emerald-700 bg-emerald-50 px-4 py-2 rounded-lg hover:bg-emerald-100 transition-all">
                    Copiar texto
                </button>
                <button onclick="closeAIModal()"
                    class="text-xs font-bold uppercase tracking-widest text-gray-500 bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- ConfiguraciÃ³n Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script>
        const HOTELS = {
            guadiana: {
                name: "Hotel",
                subname: "Guadiana",
                letter: "G",
                stars: "****",
                logo: "Logos/Sercotel Guadiana.jpg",
                brand: "by Sercotel",
                company: "SWEETMOON DESARROLLOS S.L.",
                nif: "B87067302",
                address: "C/ Guadalupe, 6",
                cp: "13003",
                city: "Ciudad Real",
                tel: "926 22 33 13",
                fax: "926 27 30 57",
                email: "info@hotelguadiana.es",
                web: "www.hotelguadiana.es",
                iban: "ES30 3190 3953 1851 8526 3521",
                legal: "Inscrito en la hoja CR-00035559 del Registro Mercantil de Ciudad Real. Folio electrÃ³nico. InscripciÃ³n/anotaciÃ³n 4"
            },
            cumbria: {
                name: "Hotel",
                subname: "Cumbria",
                letter: "C",
                stars: "***",
                logo: "Logos/Cumbria Spa&Hotel.jpg",
                brand: "Cumbria Spa",
                company: "MOON FREE PORT, S.L.",
                nif: "B87895058",
                address: "Ctra. Fuencaliente, s/n",
                cp: "13004",
                city: "Ciudad Real",
                tel: "926 25 10 25",
                fax: "926 25 10 26",
                email: "recepcion@hotelcumbria.es",
                web: "www.hotelcumbria.es",
                iban: "ES19 3081 0601 0850 0004 8966",
                legal: "Inscrito en el tomo 699 de libro 0 folio 2 hoja CR-32491 inscripciÃ³n 2Âª"
            }
        };

        // Se carga desde js/firebase-config.js
        const apiKey = window.firebaseConfig ? window.firebaseConfig.apiKey : "";
        let currentTemplate = 'confirmacion';
        let currentHotel = 'guadiana';

        // Datos iniciales actualizados para coincidir con la imagen
        let items = [
            { fecha: '21-04-26', hab: '8', cant: '', concepto: 'HABITACION D.STD Y DESAYUNO', precio: 475.52, iva: 10 },
            { fecha: '21-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '22-04-26', hab: '', cant: '70', concepto: 'HABITACION D.STD Y MEDIA PENSI', precio: 5902.40, iva: 10 },
            { fecha: '22-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '23-04-26', hab: '', cant: '70', concepto: 'HABITACION D.STD Y MEDIA PENSI', precio: 5902.40, iva: 10 },
            { fecha: '23-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '24-04-26', hab: '', cant: '', concepto: 'SALONES/ALQUILER', precio: 100.00, iva: 21 }
        ];

        // SincronizaciÃ³n de datos comunes
        function syncFields() {
            // Sync all fields EXCEPT reserva-id (proforma uses fixed "PROFORMA" text)
            const fields = ['fecha-proforma', 'solicitante-org', 'solicitante-nombre', 'solicitante-email', 'reserva-personas', 'reserva-entrada', 'reserva-salida'];
            fields.forEach(f => {
                const el1 = document.getElementById(f + '-1');
                const el2 = document.getElementById(f + '-2');
                if (el1 && el2) {
                    if (document.activeElement !== el1) el1.innerText = el2.innerText;
                    if (document.activeElement !== el2) el2.innerText = el1.innerText;
                }
            });
            // Auto-guardado
            syncWithFicha();
        }
        setInterval(syncFields, 3000);

        function saveAndExit() {
            syncWithFicha();
            window.location.href = 'GestiÃ³n de Grupos.html';
        }

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            // Incorporamos la instrucciÃ³n del sistema en el prompt para cumplir con el formato estricto solicitado
            const fullPrompt = "Eres un asistente de recepciÃ³n de un hotel de lujo (Hotel Guadiana). Tu tono es profesional, cortÃ©s y servicial. Siempre respondes en espaÃ±ol.\n\n" + prompt;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: fullPrompt }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error API Gemini:", errorText);
                    throw new Error("Error en la llamada a la API");
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return "Error de conexiÃ³n con la IA.";
            }
        }

        async function generateAIEmail() {
            showAIModal("âœ¨ Redactando Email Profesional");
            const total = items.reduce((acc, curr) => acc + (curr.precio || 0), 0);
            const cliente = document.getElementById('solicitante-org-1').innerText;
            const prompt = `Redacta un correo electrÃ³nico profesional para enviar esta factura proforma. Cliente: ${cliente}, Total: ${formatNum(total)} â‚¬. Tono amable y profesional.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        async function generateAIPlan() {
            showAIModal("âœ¨ Sugerencia de Plan para el Grupo");
            const personas = document.getElementById('reserva-personas-1').innerText;
            const prompt = `Sugiere un plan de ocio en Ciudad Real para ${personas} personas.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        function showAIModal(title) {
            document.getElementById('ai-modal-title').innerText = title;
            document.getElementById('ai-content').innerText = "Generando...";
            document.getElementById('ai-modal').style.display = 'flex';
        }
        function closeAIModal() { document.getElementById('ai-modal').style.display = 'none'; }

        function loadSelectedGroup() {
            const saved = localStorage.getItem('selectedGroup');
            if (!saved) return;

            const formatDate = (val) => {
                if (!val) return "-";
                const str = val.toString().trim();
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                }
                return val;
            };

            try {
                const group = JSON.parse(saved);

                // 1. Vincular Hotel
                if ((group["Hotel_Asignado"] || "").toLowerCase().includes('cumb')) {
                    updateHotel('cumbria');
                } else {
                    updateHotel('guadiana');
                }

                // 2. Poblar campos de texto
                const mapping = {
                    'reserva-id': group["Reserva"] || '',
                    'solicitante-org': group["Fiscal_RazonSocial"] || group["Empresa/Agencia"] || group["Nombre del Grupo"] || '',
                    'solicitante-nombre': group["Nombre del Grupo"] || '',
                    'reserva-personas': group["Pax."] || '',
                    'reserva-entrada': formatDate(group["Entrada"]),
                    'reserva-salida': formatDate(group["Salida"]),
                    'fecha-proforma': new Date().toLocaleDateString('es-ES'),
                    // Fiscal Data
                    'client-address': group["Fiscal_Direccion"] || '',
                    'client-city': (group["Fiscal_CP"] ? group["Fiscal_CP"] + ' ' : '') + (group["Fiscal_Poblacion"] || ''),
                    'client-nif': group["Fiscal_CIF"] || '',
                    'solicitante-email': group["Email"] || group["Fiscal_Email"] || ''
                };

                Object.keys(mapping).forEach(id => {
                    const el1 = document.getElementById(id + '-1'); // Check if ID with -1 suffix exists (mostly for first template)
                    const el2 = document.getElementById(id + '-2'); // Check for -2 suffix
                    const elExact = document.getElementById(id); // Check for exact ID match

                    if (el1) el1.innerText = mapping[id];
                    // Skip reserva-id-2 so proforma keeps "PROFORMA" text
                    if (el2 && id !== 'reserva-id') el2.innerText = mapping[id];
                    if (elExact) elExact.innerText = mapping[id];
                });

                // 3. Cargar Items Guardados o Crear Inicial
                if (group.ProformaItems && Array.isArray(group.ProformaItems) && group.ProformaItems.length > 0) {
                    items = group.ProformaItems;
                } else {
                    const importe = parseFloat((group["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    if (!isNaN(importe)) {
                        items = [{
                            fecha: formatDate(group["Entrada"]),
                            hab: '',
                            cant: group["Pax."] || '1',
                            concepto: `ESTANCIA GRUPO: ${group["Nombre del Grupo"]}`,
                            precio: importe,
                            iva: 10,
                            regimen: 'AD'
                        }];
                    }
                }
            } catch (e) {
                console.error("Error cargando grupo seleccionado:", e);
            }
        }

        function saveAndExit() {
            // 1. Gather current data from DOM to update the 'group' object
            const saved = localStorage.getItem('selectedGroup');
            if (saved) {
                let group = JSON.parse(saved);

                // Update Proforma Items
                group.ProformaItems = items;

                // Save back to selectedGroup (for persistence)
                localStorage.setItem('selectedGroup', JSON.stringify(group));

                // Update the main database (nexus_groups_data)
                const allGroupsStr = localStorage.getItem('nexus_groups_data');
                if (allGroupsStr) {
                    const allGroups = JSON.parse(allGroupsStr);
                    const idx = allGroups.findIndex(g => g["Reserva"] === group["Reserva"]);
                    if (idx !== -1) {
                        allGroups[idx] = { ...allGroups[idx], ...group };
                        localStorage.setItem('nexus_groups_data', JSON.stringify(allGroups));
                    }
                }

                // Set flag to re-open this ficha in Gestion de Grupos
                localStorage.setItem('openGroupFicha', group["Nombre del Grupo"]);
            }

            // Redirect
            window.location.href = 'GestiÃ³n de Grupos.html';
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadSelectedGroup();
            renderItems();
        });
        function copyAIContent() {
            navigator.clipboard.writeText(document.getElementById('ai-content').innerText);
            const btn = document.getElementById('btn-copy');
            if (btn) {
                btn.innerText = "Â¡Copiado!";
                setTimeout(() => btn.innerText = "Copiar texto", 2000);
            }
        }

        function switchTemplate(tpl) {
            currentTemplate = tpl;
            document.getElementById('tpl-confirmacion').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('tpl-proforma').classList.toggle('hidden', tpl !== 'proforma');
            document.getElementById('tpl-policies').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('btn-confirmacion').className = tpl === 'confirmacion' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            document.getElementById('btn-proforma').className = tpl === 'proforma' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            renderItems();
        }

        function formatNum(num) {
            let n = parseFloat(num);
            if (isNaN(n)) return "0,00";
            return n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateHotel(hotelKey) {
            currentHotel = hotelKey;
            const h = HOTELS[hotelKey];

            // Actualizar Logos
            const img1 = document.getElementById('logo-img-1');
            const img2 = document.getElementById('logo-img-2');
            if (img1) img1.src = h.logo;
            if (img2) img2.src = h.logo;

            // Actualizar Headers Text (Por si acaso se usan)
            document.querySelectorAll('.hotel-name-display').forEach(el => el.innerHTML = `${h.name} <span class="stars-display text-[#eab308]">${h.stars}</span>`);
            document.querySelectorAll('.hotel-name-display-2').forEach(el => el.innerHTML = `${h.name} <span class="stars-display-2 text-orange-400">${h.stars}</span>`);
            document.querySelectorAll('.hotel-subname-display, .hotel-subname-display-2').forEach(el => el.innerText = h.subname);
            document.querySelectorAll('.hotel-brand-display, .hotel-brand-display-2').forEach(el => el.innerText = h.brand);
            document.querySelectorAll('.hotel-letter-display').forEach(el => el.innerText = h.letter);
            document.querySelectorAll('.hotel-city-display').forEach(el => el.innerText = h.city);

            // Actualizar Legal Text (Vertical)
            const legalSpan = document.querySelector('#tpl-proforma .absolute span');
            if (legalSpan) {
                legalSpan.innerHTML = `${h.company} &nbsp;&nbsp;&nbsp; ${h.legal} &nbsp;&nbsp;&nbsp; N.I.F. ${h.nif}`;
            }

            // Actualizar Footer
            document.querySelector('.hotel-address-footer').innerText = h.address.toUpperCase();
            document.querySelector('.hotel-cp-footer').innerText = h.cp;
            document.querySelector('.hotel-city-footer').innerText = h.city;
            document.querySelector('.hotel-email-footer').innerText = h.email;
            document.querySelector('.hotel-web-footer').innerText = h.web;
            document.querySelector('.hotel-tel-footer').innerText = h.tel;
            document.querySelector('.hotel-fax-footer').innerText = h.fax;

            renderItems();
        }

        function renderItems() {
            const h = HOTELS[currentHotel];
            const now = new Date();
            const tsDate = document.getElementById('timestamp-date');
            const tsTime = document.getElementById('timestamp-time');
            if (tsDate) tsDate.innerText = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
            if (tsTime) tsTime.innerText = now.getHours() + "." + String(now.getMinutes()).padStart(2, '0');

            const containers = document.querySelectorAll('.invoice-items');
            const footer = document.getElementById('footer-totals');
            let total = 0;
            let runningTotal = 0;
            let base10 = 0, iva10 = 0, base21 = 0, iva21 = 0;

            containers.forEach(c => c.innerHTML = '');

            items.forEach((item, index) => {
                const precioUnitario = parseFloat(item.precio) || 0;
                const cantidad = parseFloat(item.cant) || 1;
                const dias = parseFloat(item.dias) || 1;
                const subtotal = precioUnitario * cantidad * dias;

                total += subtotal;
                runningTotal += subtotal;

                const ivaVal = parseFloat(item.iva) || 10;
                if (ivaVal === 10) {
                    const base = subtotal / 1.1;
                    base10 += base;
                    iva10 += (subtotal - base);
                } else {
                    const base = subtotal / 1.21;
                    base21 += base;
                    iva21 += (subtotal - base);
                }

                // Date handling
                const dateVal = toInputDate(item.fecha);

                const draggables = `draggable="true" ondragstart="dragStart(event, ${index})" ondragover="allowDrop(event)" ondrop="drop(event, ${index})" style="cursor: grab;"`;

                if (currentTemplate === 'confirmacion') {
                    const row = `
                        <tr class="border-b" ${draggables}>
                            <td class="p-2">
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit text-gray-500 w-24 outline-none text-[10px]">
                            </td>
                            <td class="p-2 text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'cant', this.innerText)">${item.cant || ''}</span></td>
                            <td class="p-2"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span></td>
                            <td class="p-2 text-center text-gray-400">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'regimen', this.innerText)" placeholder="-">${item.regimen || '-'}</span>
                            </td>
                            <td class="p-2 text-center">1</td>
                            <td class="p-2 text-right"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(precioUnitario)}</span></td>
                            <td class="p-2 text-right font-bold">${formatNum(subtotal)}</td>
                            <td class="p-2 no-print text-center"><button onclick="removeItem(${index})" class="text-red-300 hover:text-red-600">âœ•</button></td>
                        </tr>`;
                    document.querySelector('#tpl-confirmacion .invoice-items').insertAdjacentHTML('beforeend', row);
                } else {
                    const ivaVal = parseFloat(item.iva) || 10;
                    const row = `
                        <tr class="h-6" ${draggables}>
                            <td class="align-top">
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit w-24 outline-none">
                            </td>
                            <td class="align-top text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'hab', this.innerText)">${item.hab || ''}</span></td>
                            <td class="align-top text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'cant', this.innerText)">${item.cant || ''}</span></td>
                            <td class="align-top uppercase font-bold text-[10px]">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                                <select onchange="updateItem(${index}, 'iva', this.value)" class="no-print ml-1 text-[8px] bg-gray-100 border border-gray-300 rounded px-1 py-0.5 text-gray-500 cursor-pointer align-middle" title="Tipo IVA">
                                    <option value="10" ${ivaVal === 10 ? 'selected' : ''}>10%</option>
                                    <option value="21" ${ivaVal === 21 ? 'selected' : ''}>21%</option>
                                </select>
                            </td>
                            <td class="align-top text-right font-bold"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(precioUnitario)}</span></td>
                            <td class="align-top text-right"></td>
                            <td class="align-top text-right font-bold">${formatNum(subtotal)}</td>
                            <td class="no-print align-top text-center"><button onclick="removeItem(${index})" class="text-red-300 hover:text-red-600">âœ•</button></td>
                        </tr>`;
                    document.querySelector('#tpl-proforma .invoice-items').insertAdjacentHTML('beforeend', row);
                }
            });

            // Footer Logic (Confirmacion) - Full payment details
            if (currentTemplate === 'confirmacion') {
                const h = HOTELS[currentHotel];
                const entradaStr = document.getElementById('reserva-entrada-1')?.innerText || '21-04-2026';
                const [d, m, y] = entradaStr.split(/[-\/]/).map(Number);
                const fechaEntrada = (d && m && y) ? new Date(y < 100 ? 2000 + y : y, m - 1, d) : new Date();

                const fRelease = new Date(fechaEntrada);
                fRelease.setDate(fRelease.getDate() - (parseInt(JSON.parse(localStorage.getItem('selectedGroup') || '{}')["Com_Relix"]) || 22));

                const fDeposito1 = new Date(fechaEntrada);
                fDeposito1.setDate(fDeposito1.getDate() - 60);
                const fDeposito2 = new Date(fechaEntrada);
                fDeposito2.setDate(fDeposito2.getDate() - 30);

                const formatDate = (date) => date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

                footer.innerHTML = `
                    <div class="flex flex-col items-end mt-4">
                        <div class="bg-[#2d5a43] text-white p-4 w-64 shadow-lg mb-2">
                            <p class="text-[8px] uppercase tracking-widest border-b border-emerald-800 mb-1 text-left">Total Factura (IVA inc.)</p>
                            <p class="text-xl font-bold text-right">${formatNum(total)} â‚¬</p>
                        </div>
                    </div>
                    <div class="mt-4 font-pro text-[11px]">
                        <div class="flex w-full font-bold text-sm mb-4 px-4">
                             <div class="w-1/2 text-left">
                                <div class="text-[10px] font-normal mt-1 border border-gray-200 p-2 rounded no-print bg-gray-50 flex items-center gap-2 cursor-pointer hover:bg-emerald-50 transition" onclick="alert('Solicitando enlace de pago seguro Redsys...')">
                                    <span class="text-emerald-600">ðŸ’³</span> Solicitar enlace de pago seguro
                                </div>
                             </div>
                             <div class="w-1/2 flex justify-between">
                                 <span class="tracking-tighter">TOTAL a PAGAR</span>
                                 <span>${formatNum(total)}</span>
                             </div>
                        </div>

                        <div class="w-full grid grid-cols-2 gap-8 px-4 mt-4">
                            <div class="text-left leading-relaxed text-[10px]">
                                <p class="font-bold text-sm mb-1">${h.subname === 'Cumbria' ? 'Cumbria Spa & Hotel' : 'Sercotel Guadiana'}</p>
                                <p>${h.company} - ${h.nif}</p>
                                <p class="font-bold italic text-emerald-800">IBAN ${h.subname === 'Cumbria' ? 'EUROCAJA RURAL' : 'GLOBALCAJA'}: ${h.iban}</p>
                            </div>
                            <div class="text-right space-y-1">
                                <p><strong>1er DepÃ³sito Requerido (30%):</strong> <span class="editable" contenteditable="true">${formatNum(total * 0.3)}</span> â‚¬ (Vence: ${formatDate(fDeposito1)})</p>
                                <p><strong>2Âº DepÃ³sito Requerido (70%):</strong> <span class="editable" contenteditable="true">${formatNum(total * 0.7)}</span> â‚¬ (Vence: ${formatDate(fDeposito2)})</p>
                                <p class="pt-2 text-[10px] text-gray-600 italic"><strong>Fecha de Release Final:</strong> ${formatDate(fRelease)}</p>
                            </div>
                        </div>
                    </div>`;
            } else {
                // Footer Logic (Proforma) - Final Premium Design with Inline Styles (No Tailwind required)
                footer.innerHTML = `
                    <div style="margin-top: 40px; width: 100%; display: flex; justify-content: flex-end;">
                        <div style="width: 380px; font-family: 'Courier Prime', monospace;">
                            <!-- IVA Breakdown Table -->
                            <div style="border-top: 2px solid black; margin-bottom: 4px;"></div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px; text-transform: uppercase; letter-spacing: -0.2px;">
                                <thead style="color: #9ca3af; font-weight: normal;">
                                    <tr>
                                        <th style="text-align: left; padding: 8px 0; font-weight: normal;">Tipo Impuesto</th>
                                        <th style="text-align: right; padding: 8px 0; font-weight: normal;">Base Imp.</th>
                                        <th style="text-align: right; padding: 8px 0; font-weight: normal;">Cuota IVA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${base10 > 0 ? `
                                    <tr style="color: #374151; border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 8px 0;">IVA REGR. (10%)</td>
                                        <td style="text-align: right; padding: 8px 0;">${formatNum(base10)} â‚¬</td>
                                        <td style="text-align: right; padding: 8px 0;">${formatNum(iva10)} â‚¬</td>
                                    </tr>` : ''}
                                    ${base21 > 0 ? `
                                    <tr style="color: #374151; border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 8px 0;">IVA GRAL. (21%)</td>
                                        <td style="text-align: right; padding: 8px 0;">${formatNum(base21)} â‚¬</td>
                                        <td style="text-align: right; padding: 8px 0;">${formatNum(iva21)} â‚¬</td>
                                    </tr>` : ''}
                                </tbody>
                            </table>

                            <!-- Total Section -->
                            <div style="margin-top: 16px; display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="background-color: #000; color: #fff; padding: 16px 24px; width: 100%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                                    <span style="font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">Total Factura Proforma</span>
                                    <span style="font-size: 24px; font-weight: 900; font-variant-numeric: tabular-nums;">${formatNum(total)} <span style="font-size: 14px; font-weight: 400;">â‚¬</span></span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 16px; text-align: right;">
                                <p style="font-size: 9px; color: #9ca3af; font-style: italic; font-weight: 300; line-height: 1.5;">
                                    * Este documento es una liquidaciÃ³n provisional (Factura Proforma).<br>
                                    No tiene validez como factura ordinaria hasta su emisiÃ³n definitiva.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Digital Seal / Space for Signature -->
                    <div style="margin-top: 32px; border-top: 1px dashed #e5e7eb; padding-top: 16px; display: flex; justify-content: space-between; align-items: flex-start; opacity: 0.6;">
                        <div style="font-size: 8px; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px;">
                            EmisiÃ³n: ${new Date().toLocaleDateString('es-ES')} - Nexus Designer System
                        </div>
                        <div style="width: 100px; height: 100px; border: 1px solid #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #d1d5db; text-align: center; text-transform: uppercase; letter-spacing: -0.5px; padding: 8px;">
                            Sello / Firma<br>Establecimiento
                        </div>
                    </div>`;
            }

            syncWithFicha();
        }

        // --- Drag and Drop Helpers ---
        function addOcupanteField() {
            const box = document.getElementById('ocupante-box');
            const addBtn = box.querySelector('.no-print.mt-2');
            const newRow = document.createElement('div');
            newRow.className = 'ocupante-row flex items-center gap-1 mt-1';
            newRow.innerHTML = `
                <span><strong class="editable" contenteditable="true" style="display:inline-block;min-width:60px;">Campo</strong> : <span class="editable" contenteditable="true" style="display:inline-block;min-width:120px;">Valor</span></span>
                <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto" onclick="this.parentElement.remove();if(!document.querySelector('.ocupante-row.hidden')){document.getElementById('ocupante-restore').classList.add('hidden');}" title="Eliminar">âœ•</button>
            `;
            box.insertBefore(newRow, addBtn);
        }

        function dragStart(ev, index) {
            ev.dataTransfer.setData("text/plain", index);
            ev.dataTransfer.effectAllowed = "move";
        }
        function allowDrop(ev) {
            ev.preventDefault();
        }
        function drop(ev, targetIndex) {
            ev.preventDefault();
            const sourceIndex = parseInt(ev.dataTransfer.getData("text/plain"));
            if (sourceIndex === targetIndex) return;

            const movedItem = items[sourceIndex];
            items.splice(sourceIndex, 1);
            items.splice(targetIndex, 0, movedItem);
            renderItems();
        }

        // --- Date Helpers ---
        function toInputDate(dateStr) {
            if (!dateStr) return '';
            // Detect ISO
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dateStr;
            // Parse DD-MM-YYYY or DD/MM/YYYY
            const parts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
            if (parts.length < 3) return '';
            let d = parts[0], m = parts[1], y = parts[2];
            if (d.length === 4) { [y, m, d] = parts; } // Handle YYYY-MM-DD passed as others
            if (y && y.length === 2) y = '20' + y;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        function formatDateForDisplay(isoDate) {
            if (!isoDate) return '';
            const d = new Date(isoDate);
            if (isNaN(d.getTime())) return isoDate;
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // --- Update Item Logic ---
        function updateItem(index, key, val) {
            if (key === 'fecha') {
                // Input date returns YYYY-MM-DD
                // Store as is or format? Let's format to DD-MM-YYYY for consistency with legacy
                items[index][key] = formatDateForDisplay(val).replace(/\//g, '-');
            } else if (['concepto', 'hab', 'cant', 'regimen'].includes(key)) {
                items[index][key] = val;
            } else {
                items[index][key] = parseFloat(val.toString().replace(/\./g, '').replace(',', '.')) || 0;
            }
            renderItems();
        }

        function addRow() {
            items.push({ fecha: formatDateForDisplay(new Date().toISOString().split('T')[0]).replace(/\//g, '-'), hab: '', cant: '1', concepto: 'Nuevo Concepto', precio: 0, iva: 10, regimen: '' });
            renderItems();
        }
        function removeItem(index) { items.splice(index, 1); renderItems(); }

        function syncWithFicha() {
            const saved = localStorage.getItem('selectedGroup');
            if (!saved) return;

            let group = JSON.parse(saved);

            // 1. Calcular Totales desde Items
            const totalRevenue = items.reduce((acc, curr) => acc + (parseFloat(curr.precio) || 0), 0);
            const totalPax = items.reduce((acc, curr) => acc + (parseInt(curr.cant) || 0), 0);

            // 2. Fechas
            const entrada = document.getElementById('reserva-entrada-1')?.innerText || group["Entrada"];
            const salida = document.getElementById('reserva-salida-1')?.innerText || group["Salida"];

            // 3. Hotel
            const hotel = currentHotel === 'cumbria' ? 'Cumbria' : 'Guadiana';

            // 4. Actualizar Objeto Grupo
            group["Importe(*)"] = totalRevenue;
            group["Pax."] = document.getElementById('reserva-personas-1')?.innerText || group["Pax."];
            group["Entrada"] = entrada;
            group["Salida"] = salida;
            group["Hotel_Asignado"] = hotel;

            // GUARDAR ITEMS DE LA PROFORMA
            group["ProformaItems"] = items;

            // Sincronizar DepÃ³sitos
            group["Dep1_Importe"] = (totalRevenue * 0.3).toFixed(2);
            group["Dep2_Importe"] = (totalRevenue * 0.7).toFixed(2);

            // Sincronizar Release (7 dÃ­as antes de entrada por defecto)
            if (entrada) {
                const parts = entrada.includes('/') ? entrada.split('/') : entrada.split('-');
                if (parts.length === 3) {
                    // Asumimos formato dd/mm/yyyy o yyyy-mm-dd
                    let d, m, y;
                    if (parts[0].length === 4) { [y, m, d] = parts; } else { [d, m, y] = parts; }

                    const fechaEntrada = new Date(y, m - 1, d);
                    const fechaRelease = new Date(fechaEntrada);

                    // CÃ¡lculo dinÃ¡mico si tenemos los dÃ­as de release
                    const diasRelease = parseInt(group["Com_Relix"]) || 22; // Por defecto 22 dÃ­as
                    fechaRelease.setDate(fechaRelease.getDate() - diasRelease);

                    group["Com_Vencimiento_Rel"] = fechaRelease.toISOString().split('T')[0];
                }
            }
            if (!group["Com_Relix"]) group["Com_Relix"] = "22"; // Default Release Days

            // Guardar en LocalStorage para que GestiÃ³n de Grupos lo lea
            localStorage.setItem('selectedGroup', JSON.stringify(group));

            // TambiÃ©n actualizar la lista principal 'nexus_groups_data' si es posible (simulaciÃ³n)
            // En un entorno real, esto serÃ­a una llamada a Firebase updateDoc
            const allGroupsStr = localStorage.getItem('nexus_groups_data');
            if (allGroupsStr) {
                const allGroups = JSON.parse(allGroupsStr);
                const idx = allGroups.findIndex(g => g["Reserva"] === group["Reserva"]);
                if (idx !== -1) {
                    allGroups[idx] = { ...allGroups[idx], ...group };
                    localStorage.setItem('nexus_groups_data', JSON.stringify(allGroups));
                }
            }
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.querySelectorAll('.logo-placeholder').forEach(img => { img.src = e.target.result; img.classList.remove('hidden'); });
                    document.querySelectorAll('.font-logo').forEach(t => t.classList.add('hidden'));
                    const logoContainer = document.getElementById('default-logo-2');
                    if (logoContainer) logoContainer.classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


    </script>
</body>

</html>