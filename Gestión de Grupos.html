<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Groups - Gestión Inteligente</title>
    <link rel="icon" type="image/png" href="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png">

    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM (Versión 18) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK (Compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes blynk {

            0%,
            100% {
                opacity: 1;
                filter: brightness(1);
            }

            50% {
                opacity: 0.6;
                filter: brightness(1.1);
            }
        }

        .animate-blynk {
            animation: blynk 1.5s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Configuración Firebase Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script type="text/babel">
        // Aseguramos que las librerías estén disponibles
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;

        // --- CONFIGURACIÓN FIREBASE ---
        // Se carga desde js/firebase-config.js
        const firebaseConfig = window.firebaseConfig;

        // Inicialización robusta
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- PRUEBA TÉCNICA OBLIGATORIA (Escritura inicial) ---
        db.collection("test").add({
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            test: true,
            userMessage: "Verificación de conexión desde App"
        }).then(docRef => {
            console.log("✅ Conexión Firestore EXITOSA. Doc ID:", docRef.id);
        }).catch(err => {
            console.error("❌ Error de conexión Firestore:", err);
        });

        // --- CONFIGURACIÓN IA (CONEXIÓN DIRECTA) ---
        async function callGemini(customPrompt) {
            const apiKey = window.firebaseConfig.apiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: customPrompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(`Error en servidor IA: ${errorMsg}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                console.error("Error en llamada IA:", err);
                return "Hubo un error al conectar con la IA estratégica. Por favor, intenta de nuevo.";
            }
        }

        // Datos iniciales de ejemplo
        const INITIAL_DATA = [
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACIÓN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "15", "Pernoct.": "30", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "Régimen": "HD", "Importe(*)": "1514", "Garantía": "ANTES 18:00" },
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACIÓN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "7", "Pernoct.": "14", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "Régimen": "HA", "Importe(*)": "536", "Garantía": "ANTES 18:00" },
            { "Reserva": "202263", "Nombre del Grupo": "TABLAO Y TUMBAO", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "60", "Pernoct.": "120", "Empresa/Agencia": "SALSEA 2026/TABLAO", "Segment.": "DIRECTO OFFLINE", "Régimen": "HA", "Importe(*)": "3732", "Garantía": "FLEXIBLE" },
            { "Reserva": "205249", "Nombre del Grupo": "BM BENFICA", "Entrada": "2026-01-23", "Salida": "2026-01-24", "Noches": "1", "Pax.": "22", "Pernoct.": "22", "Empresa/Agencia": "C.D. BENFICA", "Segment.": "DEPORTIVO", "Régimen": "PC", "Importe(*)": "2100", "Garantía": "PAGADO" }
        ];

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ff5722', '#795548'];

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [columns, setColumns] = useState(Object.keys(INITIAL_DATA[0]));

            const formatDate = (val) => {
                if (!val) return "-";
                const str = val.toString().trim();
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toLocaleDateString('es-ES');
                }
                return val;
            };
            const [activeTab, setActiveTab] = useState('dashboard');
            const [searchTerm, setSearchTerm] = useState('');
            const [newColumnName, setNewColumnName] = useState('');
            const [showColumnModal, setShowColumnModal] = useState(false);
            const [expandedGroup, setExpandedGroup] = useState(null);
            const [expandedSegment, setExpandedSegment] = useState(null);

            // Estados para IA
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [showAiModal, setShowAiModal] = useState(false);

            // Estados para Añadir Grupo
            const [showAddGroupModal, setShowAddGroupModal] = useState(false);
            const [newGroup, setNewGroup] = useState({
                "Nombre del Grupo": "",
                "Entrada": new Date().toISOString().split('T')[0],
                "Salida": "",
                "Pax.": "0",
                "Empresa/Agencia": "",
                "Segment.": "GRUPOS",
                "Régimen": "HD",
                "Importe(*)": "0",
                "Reserva": Math.floor(Math.random() * 900000 + 100000).toString(),
                "Estado": "Confirmada"
            });

            // --- Filtros y Ordenación ---
            const [filterStatus, setFilterStatus] = useState('all'); // all, confirmada, anulada
            const [filterTime, setFilterTime] = useState('future'); // all, future, past
            const [sortConfig, setSortConfig] = useState({ key: 'Entrada', direction: 'asc' });

            // --- Procesamiento de Datos (Filtrado y Ordenación) ---
            const processedData = useMemo(() => {
                if (!data) return [];

                let filtered = [...data];
                const today = new Date().toISOString().split('T')[0];

                // 1. Filtro de Estado
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(row => {
                        const state = (row["Estado"] || "").toLowerCase();
                        if (filterStatus === 'confirmada') return !state.includes('anulada') && !state.includes('cancelada');
                        if (filterStatus === 'anulada') return state.includes('anulada') || state.includes('cancelada');
                        return true;
                    });
                }

                // 2. Filtro de Tiempo
                if (filterTime !== 'all') {
                    filtered = filtered.filter(row => {
                        let dateStr = row["Entrada"];
                        if (dateStr) {
                            dateStr = dateStr.toString();
                            if (dateStr.includes('/') && dateStr.length === 10) {
                                const [d, m, y] = dateStr.split('/');
                                dateStr = `${y}-${m}-${d}`;
                            }
                        }

                        if (!dateStr) return false;
                        if (filterTime === 'future') return dateStr >= today;
                        if (filterTime === 'past') return dateStr < today;
                        return true;
                    });
                }

                // 3. Ordenación
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let valA = a[sortConfig.key] || "";
                        let valB = b[sortConfig.key] || "";

                        // Tratamiento especial fechas
                        if (sortConfig.key === 'Entrada' || sortConfig.key === 'Salida') {
                            const strA = valA.toString();
                            const strB = valB.toString();
                            if (strA.includes('/')) valA = strA.split('/').reverse().join('-');
                            if (strB.includes('/')) valB = strB.split('/').reverse().join('-');
                        }
                        // Tratamiento números
                        if (sortConfig.key === 'Importe(*)' || sortConfig.key === 'Pax.') {
                            valA = parseFloat(valA.toString().replace('.', '').replace(',', '.')) || 0;
                            valB = parseFloat(valB.toString().replace('.', '').replace(',', '.')) || 0;
                        }

                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                return filtered;
            }, [data, filterStatus, filterTime, sortConfig]);

            // --- Cálculos de Estadísticas Globales (Reemplazado por lógica nueva) ---
            // Se usa stats calculado más abajo basado en processedData

            // --- Agrupación de Datos por "Nombre del Grupo" (Filtrados) ---
            const groupedData = useMemo(() => {
                const groups = {};

                processedData.forEach(row => {
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";
                    if (!groups[groupName]) {
                        groups[groupName] = {
                            name: groupName,
                            agency: row["Empresa/Agencia"] || "",
                            arrival: row["Entrada"],
                            departure: row["Salida"],
                            status: row["Estado"] || "Confirmada",
                            totalPax: 0,
                            totalRevenue: 0,
                            totalNights: 0,
                            records: []
                        };
                    }

                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) groups[groupName].totalRevenue += importe;
                    if (!isNaN(pax)) groups[groupName].totalPax += pax;
                    if (!isNaN(noches)) groups[groupName].totalNights += noches;

                    groups[groupName].records.push(row);
                });

                return Object.values(groups).sort((a, b) => b.totalRevenue - a.totalRevenue);
            }, [processedData]);

            // --- Análisis detallado por Segmentos (Filtrados) ---
            const segmentStats = useMemo(() => {
                const segments = {};

                processedData.forEach(row => {
                    const segName = row["Segment."] || "Sin Segmento";
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";

                    if (!segments[segName]) {
                        segments[segName] = {
                            name: segName,
                            revenue: 0,
                            pax: 0,
                            nights: 0,
                            count: 0,
                            groupList: new Set()
                        };
                    }

                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) segments[segName].revenue += importe;
                    if (!isNaN(pax)) segments[segName].pax += pax;
                    if (!isNaN(noches)) segments[segName].nights += noches;
                    segments[segName].count += 1;
                    segments[segName].groupList.add(groupName);
                });

                return Object.values(segments).map(s => ({
                    ...s,
                    groupCount: s.groupList.size,
                    groups: Array.from(s.groupList).sort()
                })).sort((a, b) => b.revenue - a.revenue);
            }, [processedData]);

            // --- Datos para Gráficos Globales (Filtrados) ---
            const chartData = useMemo(() => {
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const revenueByMonth = {};

                processedData.forEach(row => {
                    let dateStr = row["Entrada"];
                    if (dateStr) {
                        dateStr = dateStr.toString();
                        if (dateStr.includes('/') && dateStr.length === 10) {
                            dateStr = dateStr.split('/').reverse().join('-');
                        }
                    }

                    if (dateStr) {
                        const date = new Date(dateStr);
                        if (!isNaN(date)) {
                            const key = `${monthNames[date.getMonth()]} ${date.getFullYear().toString().slice(-2)}`;
                            const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                            revenueByMonth[key] = (revenueByMonth[key] || 0) + (isNaN(importe) ? 0 : importe);
                        }
                    }
                });

                const barData = Object.keys(revenueByMonth).map(key => ({
                    name: key,
                    Ingresos: revenueByMonth[key]
                }));

                return { barData };
            }, [processedData]);

            // --- Top Grupos Chart ---
            const topGroupsData = useMemo(() => {
                return groupedData.slice(0, 10).map(g => ({
                    name: g.name.length > 15 ? g.name.substring(0, 15) + '...' : g.name,
                    fullDate: g.name,
                    Ingresos: g.totalRevenue
                }));
            }, [groupedData]);


            // --- Funciones IA ---
            const handleConsultantClick = async () => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                // Preparamos el resumen para la IA incluyendo datos de segmentación
                const summary = {
                    totalRevenue: stats.revenue,
                    totalGroups: stats.count,
                    topSegments: segmentStats.slice(0, 3).map(s => `${s.name} (${s.revenue.toFixed(0)}€)`).join(', '),
                    topMonths: chartData.barData.sort((a, b) => b.Ingresos - a.Ingresos).slice(0, 3).map(m => m.name).join(', ')
                };

                const prompt = `Actúa como un analista de Revenue Management experto para un hotel. 
                Analiza estos datos resumidos de grupos:
                - Ingresos Totales: ${summary.totalRevenue}
                - Total Grupos: ${summary.totalGroups}
                - Top 3 Segmentos (Ingresos): ${summary.topSegments}
                - Top Meses: ${summary.topMonths}
                
                Dame 3 conclusiones estratégicas breves y 1 recomendación de acción. Usa formato Markdown.
                Enfócate mucho en la rentabilidad de los segmentos. ¿Qué segmento deberíamos potenciar?`;

                try {
                    const result = await callGemini(prompt);
                    // Check if result is an error message
                    if (result && (result.includes("Error") || result.includes("Hubo un error"))) {
                        setAiResult({ title: "Error Detectado", content: `**Detalles:** ${result}\n\n*Nota:* Si usas el archivo local (file://), la restricción de API web puede bloquearlo.` });
                    } else {
                        setAiResult({ title: "Análisis Estratégico", content: result });
                    }
                } catch (e) {
                    setAiResult({ title: "Error Crítico", content: e.message });
                }
                setIsAiLoading(false);
            };

            const handleEmailClick = async (group) => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                const prompt = `Escribe un email formal y acogedor para el organizador del grupo "${group.name}".
                Detalles:
                - Agencia: ${group.agency}
                - Llegada: ${group.arrival}
                - Salida: ${group.departure}
                - Pax: ${group.totalPax}
                - Importe total estimado: ${group.totalRevenue}€
                
                El objetivo es confirmar los detalles y dar la bienvenida. Menciona que estamos a su disposición para cualquier petición especial (dietas, salones, etc). Firma como "Dpto. de Grupos". Usa formato Markdown.`;

                const result = await callGemini(prompt);
                setAiResult({ title: `Borrador Email: ${group.name}`, content: result });
                setIsAiLoading(false);
            };

            const handleProformaClick = (group) => {
                // Tomar datos agregados del grupo y pasarlos como un registro único
                const firstRec = group.records[0] || {};
                const groupData = {
                    ...firstRec,
                    "Nombre del Grupo": group.name,
                    "Empresa/Agencia": group.agency,
                    "Importe(*)": group.totalRevenue.toString(),
                    "Pax.": group.totalPax.toString(),
                    "Entrada": group.arrival,
                    "Salida": group.departure
                };
                localStorage.setItem('selectedGroup', JSON.stringify(groupData));
                window.location.href = 'Fac Prof.html';
            };

            // --- Persistencia FIREBASE ---
            useEffect(() => {
                const unsubscribe = db.collection("groups").onSnapshot((snapshot) => {
                    const roomData = [];
                    snapshot.forEach((doc) => {
                        roomData.push(doc.data());
                    });

                    if (roomData.length > 0) {
                        // Ordenar por fecha de entrada antes de guardar en el estado
                        const getIsoDate = (val) => {
                            if (!val) return "9999-12-31";
                            const str = String(val);
                            const parts = str.split(/[\/-]/);
                            if (parts.length === 3) {
                                if (parts[0].length === 4) return str; // YYYY-MM-DD
                                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; // DD-MM-YYYY
                            }
                            return str;
                        };
                        const sorted = roomData.sort((a, b) => {
                            return getIsoDate(a["Entrada"]).localeCompare(getIsoDate(b["Entrada"]));
                        });
                        setData(sorted);

                        const allKeys = new Set();
                        roomData.forEach(r => Object.keys(r).forEach(k => {
                            if (!["_diff", "updatedAt"].includes(k)) allKeys.add(k);
                        }));
                        setColumns(Array.from(allKeys));
                    } else {
                        setData([]);
                    }
                }, (error) => {
                    console.error("Error en tiempo real Firebase:", error);
                });

                return () => unsubscribe();
            }, []);



            // Actualizar estadísticas basadas en datos filtrados
            const stats = useMemo(() => {
                let totalRevenue = 0;
                let totalPax = 0;
                let totalNights = 0;

                processedData.forEach(row => {
                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) totalRevenue += importe;
                    if (!isNaN(pax)) totalPax += pax;
                    if (!isNaN(noches)) totalNights += noches;
                });

                return {
                    revenue: totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }),
                    revenueRaw: totalRevenue,
                    pax: totalPax,
                    avgStay: totalPax > 0 ? (totalNights / processedData.length).toFixed(1) : 0,
                };
            }, [processedData]);

            // Auto-abrir Ficha si se detecta bandera en localStorage
            useEffect(() => {
                const groupToOpen = localStorage.getItem('openGroupFicha');
                if (groupToOpen && groupedData.length > 0) {
                    const found = groupedData.find(g => g.name === groupToOpen);
                    if (found) {
                        openFicha(found);
                        localStorage.removeItem('openGroupFicha');
                    }
                }
            }, [groupedData]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            // Estados para Selección de Hotel en Importación
            const [isHotelModalOpen, setIsHotelModalOpen] = useState(false);
            const [pendingFile, setPendingFile] = useState(null);

            // --- Funciones de Archivo (Parser Recargado) ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setPendingFile(file);
                setIsHotelModalOpen(true);
            };

            const confirmHotelAndProcess = (hotelName) => {
                const file = pendingFile;
                setIsHotelModalOpen(false);
                setPendingFile(null);

                const reader = new FileReader();

                const processMatrixData = (rows, defaultStatus) => {
                    let headerRowIndex = -1;
                    const validData = [];
                    let currentStatus = defaultStatus;
                    let headers = [];

                    // Barrido completo para detectar bloques
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        const rowStr = row.join(" ").toLowerCase();

                        // Detectar cambios de sección internos (por si acaso vienen en la misma hoja)
                        if (rowStr.includes("reservas de grupos anuladas") || rowStr.includes("anuladas")) {
                            currentStatus = "Anulada";
                        } else if (rowStr.includes("reservas de grupos confirmadas") || rowStr.includes("confirmadas")) {
                            currentStatus = "Confirmada";
                        }

                        // Detectar cabecera (Flexible: Si encontramos "Reserva" y algo que suene a "Grupo" o "Nombre")
                        const hasReserva = rowStr.includes("reserva");
                        const hasGrupo = rowStr.includes("grupo") || rowStr.includes("nombre del g");

                        if (hasReserva && hasGrupo) {
                            headerRowIndex = i;
                            if (Array.isArray(row)) headers = row.map(h => {
                                const val = (h || "").toString().trim();
                                // Normalizar nombre de columna para el sistema
                                if (val.toLowerCase().includes("nombre del g")) return "Nombre del Grupo";
                                return val;
                            });
                            continue;
                        }

                        // Si tenemos headers, procesamos la fila
                        if (headerRowIndex !== -1 && headers.length > 0) {
                            // Ignorar filas vacías o repetidas cabeceras
                            if (row.length === 0) continue;

                            const obj = {};
                            let hasData = false;

                            headers.forEach((header, idx) => {
                                if (header) {
                                    obj[header] = row[idx] || "";
                                    if (obj[header]) hasData = true;
                                }
                            });

                            if (hasData) {
                                const reservaVal = (obj["Reserva"] || "").toString().toLowerCase();
                                // Ignorar si parece otra cabecera
                                if (reservaVal.includes("reserva")) continue;

                                // Inyectar Estado detectado
                                obj["Estado"] = currentStatus;
                                obj["Hotel_Asignado"] = hotelName;

                                if (reservaVal.length > 0 || (obj["Nombre del Grupo"] && obj["Nombre del Grupo"].length > 0)) {
                                    validData.push(obj);
                                }
                            }
                        }
                    }

                    return validData;
                };

                if (file.name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: false,
                            complete: (res) => processMatrixData(res.data)
                        });
                    };
                    reader.readAsText(file);
                }
                else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let allDetectedData = [];

                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                            // Determinamos estado por nombre de hoja
                            let defaultStatus = "Confirmada";
                            if (sheetName.toLowerCase().includes("anula")) defaultStatus = "Anulada";

                            const sheetData = processMatrixData(matrix, defaultStatus);
                            allDetectedData = [...allDetectedData, ...sheetData];
                        });

                        if (allDetectedData.length > 0) {
                            sanitizeAndSetData(allDetectedData);
                        } else {
                            alert("No se encontraron datos en el Excel.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert("Formato no soportado.");
                }
            };

            const sanitizeAndSetData = (rawData) => {
                const incomingRows = rawData.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(k => {
                        if (k && k.trim() !== "") cleanRow[k.trim()] = row[k];
                    });
                    return cleanRow;
                });

                // Copia profunda de los datos actuales para el merge
                const mergedData = [...data];

                // 1. Procesar registros entrantes
                incomingRows.forEach(newRow => {
                    const resID = newRow["Reserva"];
                    if (!resID) return;

                    const existingIdx = mergedData.findIndex(r => String(r["Reserva"]) === String(resID));

                    if (existingIdx === -1) {
                        // Es un grupo nuevo (No estaba en DB)
                        mergedData.push({ ...newRow, "_diff": "new" });
                    } else {
                        // Es un grupo existente, verificar cambios
                        const existingRow = mergedData[existingIdx];
                        let diffType = null;

                        // Caso A: Cambio a Anulada (Cancelación Detectada)
                        if (newRow["Estado"] === "Anulada" && existingRow["Estado"] !== "Anulada") {
                            diffType = "cancelled";
                        }
                        // Caso B: Reactivación (Estaba anulado y ahora viene como confirmado)
                        else if (newRow["Estado"] === "Confirmada" && existingRow["Estado"] === "Anulada") {
                            diffType = "new"; // O "restored"
                        }
                        // Caso C: Verificación de cambios en cualquier valor
                        else {
                            const hasChanges = Object.keys(newRow).some(key => {
                                if (key.startsWith("_") || key === "updatedAt") return false;
                                return String(newRow[key]) !== String(existingRow[key] || "");
                            });

                            if (hasChanges) {
                                diffType = "modified";
                            }
                        }

                        // Actualizar la fila conservando datos que no vienen en el excel pero están en DB
                        mergedData[existingIdx] = {
                            ...existingRow,
                            ...newRow,
                            "_diff": diffType || existingRow._diff || null
                        };
                    }
                });

                // Asegurar que 'Estado' esté en las columnas
                const allKeys = new Set();
                mergedData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));

                // Ordenar por fecha de entrada antes de guardar
                const sortedData = mergedData.sort((a, b) => {
                    const getIsoDate = (val) => {
                        if (!val) return "9999-12-31";
                        const str = String(val);
                        const parts = str.split(/[\/-]/);
                        if (parts.length === 3) {
                            if (parts[0].length === 4) return str; // YYYY-MM-DD
                            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; // DD-MM-YYYY
                        }
                        return str;
                    };
                    return getIsoDate(a["Entrada"]).localeCompare(getIsoDate(b["Entrada"]));
                });

                setData(sortedData);
                setColumns(Array.from(allKeys).filter(k => k !== "_diff" && k !== "Hotel_Asignado"));

                // Guardar en Firebase (Batch Set con Merge)
                const batch = db.batch();
                sortedData.forEach(row => {
                    const resID = String(row["Reserva"]);
                    const docRef = db.collection("groups").doc(resID);
                    batch.set(docRef, {
                        ...row,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                });

                batch.commit().then(() => {
                    alert(`Sincronización profesional en NUBE completada exitosamente.`);
                }).catch(err => {
                    console.error("Error batch Firebase:", err);
                    alert("Error al sincronizar con la nube.");
                });
            };

            const acceptChanges = () => {
                const batch = db.batch();
                data.forEach(row => {
                    if (row._diff) {
                        const { _diff, ...rest } = row;
                        const docRef = db.collection("groups").doc(String(row["Reserva"]));
                        batch.set(docRef, {
                            ...rest,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                });
                batch.commit();
            };

            const exportCSV = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'Analisis_Grupos_Editado.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Funciones de Edición ---
            const handleCellChange = (rowIndex, column, value) => {
                const row = data[rowIndex];
                const resID = String(row["Reserva"]);

                // Actualización optimista
                const newData = [...data];
                newData[rowIndex][column] = value;
                setData(newData);

                // Actualizar Firebase con merge y timestamp
                db.collection("groups").doc(resID).set({
                    [column]: value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).catch(err => console.error("Error editando celda:", err));
            };

            const addNewColumn = () => {
                if (!newColumnName) return;
                const newData = data.map(row => ({ ...row, [newColumnName]: "" }));
                setData(newData);
                setColumns([...columns, newColumnName]);
                setNewColumnName('');
                setShowColumnModal(false);
            };

            // Estados para Ficha de Grupo
            const [showFichaModal, setShowFichaModal] = useState(false);
            const [selectedGroupFicha, setSelectedGroupFicha] = useState(null);

            const openFicha = (group) => {
                setSelectedGroupFicha(group);
                setShowFichaModal(true);
            };

            const updateGroupMetadata = (name, field, value) => {
                // Actualizar estado local para feedback inmediato
                setData(prevData => {
                    const newData = prevData.map(r => {
                        if (r["Nombre del Grupo"] === name) {
                            const updatedRow = { ...r, [field]: value };
                            // Sincronizar Hotel con Hotel_Asignado para Proforma
                            if (field === "Hotel") {
                                updatedRow["Hotel_Asignado"] = value;
                            }
                            return updatedRow;
                        }
                        return r;
                    });

                    if (selectedGroupFicha && selectedGroupFicha.name === name) {
                        const updatedRecords = newData.filter(r => r["Nombre del Grupo"] === name);
                        setSelectedGroupFicha(prev => ({
                            ...prev,
                            records: updatedRecords
                        }));
                    }
                    return newData;
                });

                // Actualizar en Firebase
                const rowsToUpdate = data.filter(r => r["Nombre del Grupo"] === name);
                const batch = db.batch();
                rowsToUpdate.forEach(row => {
                    const docRef = db.collection("groups").doc(String(row["Reserva"]));
                    const updateData = {
                        [field]: value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (field === "Hotel") updateData["Hotel_Asignado"] = value;

                    batch.set(docRef, updateData, { merge: true });
                });
                batch.commit();
            };

            const calculateDeposits = (group) => {
                const total = group.totalRevenue || 0;
                const dep1 = (total * 0.3).toFixed(2);
                const final = (total * 0.7).toFixed(2);

                updateGroupMetadata(group.name, "Dep1_Importe", dep1 + " €");
                updateGroupMetadata(group.name, "Dep2_Importe", final + " €");
            };

            const addNewRow = () => {
                const emptyRow = {};
                columns.forEach(col => emptyRow[col] = "");
                emptyRow["Entrada"] = new Date().toISOString().split('T')[0];
                setData([emptyRow, ...data]);
            };

            const toggleGroupExpand = (groupName) => {
                if (expandedGroup === groupName) setExpandedGroup(null);
                else setExpandedGroup(groupName);
            };

            const registerNewGroup = () => {
                if (!newGroup["Nombre del Grupo"]) {
                    alert("Por favor, introduce el nombre del grupo.");
                    return;
                }

                // Calcular noches automáticamente si hay entrada y salida
                let noches = "0";
                if (newGroup.Entrada && newGroup.Salida) {
                    const diffTime = Math.abs(new Date(newGroup.Salida) - new Date(newGroup.Entrada));
                    noches = Math.ceil(diffTime / (1000 * 60 * 60 * 24)).toString();
                }

                const groupToSave = { ...newGroup, "Noches": noches, "Pernoct.": (parseInt(newGroup["Pax."]) * parseInt(noches)).toString() };
                setData([groupToSave, ...data]);
                setShowAddGroupModal(false);
                setNewGroup({
                    "Nombre del Grupo": "",
                    "Entrada": new Date().toISOString().split('T')[0],
                    "Salida": "",
                    "Pax.": "0",
                    "Empresa/Agencia": "",
                    "Segment.": "GRUPOS",
                    "Régimen": "HD",
                    "Importe(*)": "0",
                    "Reserva": Math.floor(Math.random() * 900000 + 100000).toString(),
                    "Estado": "Confirmada"
                });
            };

            // Icons

            const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>;
            const IconTable = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="3" y1="15" x2="21" y2="15" /><line x1="9" y1="3" x2="9" y2="21" /><line x1="15" y1="3" x2="15" y2="21" /></svg>;
            const IconX = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>;
            const IconBuilding = ({ size = 16, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2" /><path d="M9 22v-4h6v4" /><path d="M8 6h.01" /><path d="M16 6h.01" /><path d="M8 10h.01" /><path d="M16 10h.01" /><path d="M8 14h.01" /><path d="M16 14h.01" /></svg>;
            const IconChart = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>;
            const IconGroup = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>;
            const IconPieChart = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></svg>;
            const IconChevronDown = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9l6 6 6-6" /></svg>;
            const IconChevronUp = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 15l-6-6-6 6" /></svg>;
            const IconChevronRight = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6" /></svg>;
            const IconChevronLeft = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6" /></svg>;
            const IconSparkles = ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} text-yellow-400`}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>;
            const IconMail = ({ size = 16, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></svg>;
            const IconBrain = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" /><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" /></svg>;
            const IconUsers = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>;
            const IconUpload = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>;
            const IconDownload = ({ size = 20, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>;

            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-20">
                        <div className="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-2">
                                <a href="Admin.html" className="p-2 hover:bg-slate-700 rounded-lg transition-colors mr-2" title="Volver al Admin">
                                    <IconChevronLeft size={20} />
                                </a>
                                <div className="bg-white rounded-lg p-1 shadow-sm">
                                    <img src="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png" className="h-10 w-auto object-contain" alt="Logo Nexus" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold">Nexus Groups</h1>
                                    <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Inteligencia Hotelera</p>
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={() => setShowAddGroupModal(true)}
                                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 text-sm"
                                >
                                    <IconPlus size={16} /> Dar de Alta Grupo
                                </button>
                                <label className="bg-white hover:bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-bold shadow-sm border border-blue-200 transition-all flex items-center gap-2 cursor-pointer text-sm">
                                    <IconUpload size={16} /> Importar (CSV/XLS)
                                    <input type="file" className="hidden" accept=".csv, .xlsx, .xls" onChange={handleFileUpload} />
                                </label>
                                <button
                                    onClick={exportCSV}
                                    className="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-bold shadow-sm border border-slate-200 transition-all flex items-center gap-2 text-sm"
                                >
                                    <IconDownload size={16} /> Exportar
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto mt-6 px-4">
                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            {/* ... cards ... */}
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                                <p className="text-sm text-gray-500 font-semibold">Total Ingresos Est.</p>
                                <p className="text-2xl font-bold text-slate-800">{stats.revenue}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                                <p className="text-sm text-gray-500 font-semibold">Total Pax</p>
                                <p className="text-2xl font-bold text-slate-800">{stats.pax}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                                <p className="text-sm text-gray-500 font-semibold">Grupos Únicos</p>
                                <p className="text-2xl font-bold text-slate-800">{stats.count}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                                <p className="text-sm text-gray-500 font-semibold">Estancia Media (días)</p>
                                <p className="text-2xl font-bold text-slate-800">{stats.avgStay}</p>
                            </div>
                        </div>

                        {/* --- FILTERS TOOLBAR --- */}
                        <div className="bg-white p-3 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Estado:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                >
                                    <option value="all">Todos</option>
                                    <option value="confirmada">Confirmados</option>
                                    <option value="anulada">Anulados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Tiempo:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterTime}
                                    onChange={(e) => setFilterTime(e.target.value)}
                                >
                                    <option value="all">Historico Completo</option>
                                    <option value="future">Futuros (Desde hoy)</option>
                                    <option value="past">Pasados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2 ml-auto">
                                <span className="text-sm font-semibold text-gray-600">Ordenar por:</span>
                                <button onClick={() => requestSort('Entrada')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Entrada' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    📅 Fecha {sortConfig.key === 'Entrada' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                </button>
                                <button onClick={() => requestSort('Importe(*)')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Importe(*)' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    💰 Importe {sortConfig.key === 'Importe(*)' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                </button>
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex gap-4 mb-4 border-b border-gray-300 overflow-x-auto items-center justify-between">
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveTab('dashboard')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'dashboard' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconChart size={18} /> Resumen General
                                </button>
                                <button
                                    onClick={() => setActiveTab('segments')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'segments' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconPieChart size={18} /> Segmentación
                                </button>
                                <button
                                    onClick={() => setActiveTab('groups')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'groups' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconGroup size={18} /> Por Grupos
                                </button>
                                <button
                                    onClick={() => setActiveTab('table')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'table' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconTable size={18} /> Datos Brutos
                                </button>
                            </div>
                            {/* AI Main Button */}
                            {activeTab !== 'table' && (
                                <button
                                    onClick={handleConsultantClick}
                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm font-bold transition transform hover:scale-105 mb-2 md:mb-0"
                                >
                                    <IconBrain size={18} /> Consultor Virtual
                                    <IconSparkles size={14} />
                                </button>
                            )}
                        </div>

                        {/* --- CONTENT AREA --- */}

                        {/* 1. GLOBAL DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                                <div className="bg-white p-6 rounded-lg shadow h-96">
                                    <h3 className="text-lg font-bold mb-4 text-slate-700">Ingresos por Mes</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={chartData.barData}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="name" />
                                            <YAxis />
                                            <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                            <Bar dataKey="Ingresos" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow h-96">
                                    <h3 className="text-lg font-bold mb-4 text-slate-700">Top Segmentos (Resumen)</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie
                                                data={segmentStats}
                                                dataKey="revenue"
                                                nameKey="name"
                                                cx="50%"
                                                cy="50%"
                                                outerRadius={100}
                                                fill="#8884d8"
                                                label={({ name, percent }) => `${(percent * 100).toFixed(0)}%`}
                                            >
                                                {segmentStats.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                ))}
                                            </Pie>
                                            <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                            <Legend />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}

                        {/* 2. SEGMENTATION ANALYSIS (NEW) */}
                        {activeTab === 'segments' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Ingresos por Segmento</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={segmentStats} layout="vertical" margin={{ left: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                <XAxis type="number" hide />
                                                <YAxis type="category" dataKey="name" width={100} tick={{ fontSize: 11 }} interval={0} />
                                                <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                                <Bar dataKey="revenue" fill="#8884d8" radius={[0, 4, 4, 0]}>
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Distribución de Pax (Volumen)</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={segmentStats}
                                                    dataKey="pax"
                                                    nameKey="name"
                                                    cx="50%"
                                                    cy="50%"
                                                    outerRadius={80}
                                                    label={({ name, percent }) => `${(percent * 100).toFixed(0)}%`}
                                                >
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Detailed Table */}
                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="p-4 border-b bg-slate-50">
                                        <h3 className="text-lg font-bold text-slate-700">Tabla de Rentabilidad por Segmento</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs">
                                                <tr>
                                                    <th className="p-3 w-10"></th>
                                                    <th className="p-3">Segmento</th>
                                                    <th className="p-3 text-right"># Grupos</th>
                                                    <th className="p-3 text-right">Pax Total</th>
                                                    <th className="p-3 text-right">Noches Totales</th>
                                                    <th className="p-3 text-right">Ingresos Totales</th>
                                                    <th className="p-3 text-right">ADR Medio</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {segmentStats.map((seg, idx) => (
                                                    <React.Fragment key={idx}>
                                                        <tr className="hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => setExpandedSegment(expandedSegment === seg.name ? null : seg.name)}>
                                                            <td className="p-3 text-center text-gray-400">
                                                                {expandedSegment === seg.name ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />}
                                                            </td>
                                                            <td className="p-3 font-medium text-slate-800 flex items-center gap-2">
                                                                <span className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[idx % COLORS.length] }}></span>
                                                                {seg.name}
                                                            </td>
                                                            <td className="p-3 text-right font-bold text-blue-600">{seg.groupCount}</td>
                                                            <td className="p-3 text-right">{seg.pax}</td>
                                                            <td className="p-3 text-right">{seg.nights}</td>
                                                            <td className="p-3 text-right font-bold text-slate-700">
                                                                {seg.revenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                            <td className="p-3 text-right text-emerald-600 font-bold">
                                                                {(seg.nights > 0 ? (seg.revenue / seg.nights) : 0).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                        </tr>
                                                        {expandedSegment === seg.name && (
                                                            <tr>
                                                                <td colSpan="7" className="p-0 bg-slate-50">
                                                                    <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                                        {seg.groups.map((groupName, gIdx) => {
                                                                            const groupObj = groupedData.find(g => g.name === groupName);
                                                                            return (
                                                                                <div
                                                                                    key={gIdx}
                                                                                    onClick={() => groupObj && openFicha(groupObj)}
                                                                                    className="bg-white p-2 rounded border border-slate-200 shadow-sm hover:border-blue-500 hover:shadow-md transition-all cursor-pointer flex justify-between items-center group"
                                                                                >
                                                                                    <span className="text-xs font-bold text-slate-700 group-hover:text-blue-600 truncate">{groupName}</span>
                                                                                    <IconChevronRight size={12} className="text-slate-300 group-hover:text-blue-500" />
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. GROUP ANALYSIS */}
                        {activeTab === 'groups' && (
                            <div className="animate-fade-in space-y-6">
                                {/* Top Groups Chart */}
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h3 className="text-lg font-bold mb-4 text-slate-700">Top 10 Grupos por Ingresos</h3>
                                    <div className="h-72">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={topGroupsData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                <XAxis type="number" />
                                                <YAxis type="category" dataKey="name" width={150} tick={{ fontSize: 12 }} />
                                                <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                                <Bar
                                                    dataKey="Ingresos"
                                                    fill="#10b981"
                                                    radius={[0, 4, 4, 0]}
                                                    barSize={20}
                                                    onClick={(data_point) => {
                                                        const found = groupedData.find(g => g.name === data_point.fullDate);
                                                        if (found) openFicha(found);
                                                    }}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Aggregated Groups List */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="p-4 border-b">
                                        <h3 className="text-lg font-bold text-slate-700">Listado Detallado de Grupos</h3>
                                        <input
                                            type="text"
                                            placeholder="Buscar grupo..."
                                            className="mt-2 border rounded px-3 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs">
                                                <tr>
                                                    <th className="p-3 w-10"></th>
                                                    <th className="p-3">Nombre del Grupo</th>
                                                    <th className="p-3">Entrada</th>
                                                    <th className="p-3 text-right">Pax Total</th>
                                                    <th className="p-3 text-right">Ingresos Totales</th>
                                                    <th className="p-3 text-center">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {groupedData
                                                    .filter(g => g.name.toLowerCase().includes(searchTerm.toLowerCase()))
                                                    .map((group, idx) => (
                                                        <React.Fragment key={idx}>
                                                            <tr className="hover:bg-slate-50 transition-colors">
                                                                <td className="p-3 text-center text-gray-400 cursor-pointer" onClick={() => toggleGroupExpand(group.name)}>
                                                                    {expandedGroup === group.name ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />}
                                                                </td>
                                                                <td className="p-3 font-medium text-slate-800 cursor-pointer hover:text-blue-600 transition-colors" onClick={() => openFicha(group)}>{group.name}</td>
                                                                <td className="p-3 text-gray-600 cursor-pointer" onClick={() => openFicha(group)}>{formatDate(group.arrival)}</td>
                                                                <td className="p-3 text-right font-medium cursor-pointer" onClick={() => openFicha(group)}>{group.totalPax}</td>
                                                                <td className="p-3 text-right font-bold text-green-600 cursor-pointer" onClick={() => openFicha(group)}>
                                                                    {group.totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                                </td>
                                                                <td className="p-3 text-center flex justify-center gap-2">
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); openFicha(group); }}
                                                                        className="text-emerald-600 hover:text-emerald-800 bg-emerald-50 hover:bg-emerald-100 px-3 py-1.5 rounded-lg transition text-xs font-bold flex items-center gap-1"
                                                                        title="Ficha del Grupo"
                                                                    >
                                                                        <IconTable size={14} /> Ficha
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); handleProformaClick(group); }}
                                                                        className="text-slate-600 hover:text-slate-800 bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-lg transition text-xs font-bold flex items-center gap-1"
                                                                        title="Generar Proforma"
                                                                    >
                                                                        <IconDownload size={14} /> Proforma
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); handleEmailClick(group); }}
                                                                        className="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-full transition"
                                                                        title="Redactar Email con IA"
                                                                    >
                                                                        <div className="flex items-center gap-1"><IconMail size={14} /> <IconSparkles size={10} /></div>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            {expandedGroup === group.name && (
                                                                <tr className="bg-slate-50">
                                                                    <td colSpan="6" className="p-4 pl-12">
                                                                        <div className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Desglose de Reservas</div>
                                                                        <table className="w-full text-xs bg-white rounded border shadow-sm">
                                                                            <thead>
                                                                                <tr className="bg-gray-100 border-b">
                                                                                    <th className="p-2">Reserva ID</th>
                                                                                    <th className="p-2">Régimen</th>
                                                                                    <th className="p-2">Segmento</th>
                                                                                    <th className="p-2 text-right">Pax</th>
                                                                                    <th className="p-2 text-right">Importe</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {group.records.map((rec, rIdx) => (
                                                                                    <tr key={rIdx} className="border-b last:border-0">
                                                                                        <td className="p-2">{rec["Reserva"]}</td>
                                                                                        <td className="p-2">{rec["Régimen"]}</td>
                                                                                        <td className="p-2">{rec["Segment."]}</td>
                                                                                        <td className="p-2 text-right">{rec["Pax."]}</td>
                                                                                        <td className="p-2 text-right">{rec["Importe(*)"]} €</td>
                                                                                    </tr>
                                                                                ))}
                                                                            </tbody>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 4. RAW DATA EDITOR */}
                        {activeTab === 'table' && (
                            <div className="bg-white rounded-lg shadow flex flex-col h-[70vh] animate-fade-in">
                                {/* Table Toolbar */}
                                <div className="p-4 border-b flex flex-wrap gap-4 justify-between items-center">
                                    <input
                                        type="text"
                                        placeholder="Buscar en todos los campos..."
                                        className="border rounded px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <div className="flex gap-2">
                                        {data.some(r => r._diff) && (
                                            <button onClick={acceptChanges} className="bg-emerald-600 text-white hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-all animate-bounce flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>
                                                ACEPTAR ACTUALIZACIONES
                                            </button>
                                        )}
                                        <button onClick={addNewRow} className="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Fila
                                        </button>
                                        <button onClick={() => setShowColumnModal(true)} className="bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Columna
                                        </button>
                                    </div>
                                </div>

                                {/* Table Container */}
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left text-sm border-collapse">
                                        <thead className="bg-slate-50 text-slate-600 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                {columns.map((col, idx) => (
                                                    <th key={idx} className="p-3 font-semibold border-b whitespace-nowrap min-w-[120px]">
                                                        {col}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {data
                                                .filter(row => JSON.stringify(Object.values(row)).toLowerCase().includes(searchTerm.toLowerCase()))
                                                .map((row, rIdx) => {
                                                    let rowClass = "hover:bg-slate-50 transition-colors group";
                                                    let highlightColor = "";

                                                    if (row._diff === "new") {
                                                        rowClass += " animate-blynk bg-green-50";
                                                        highlightColor = "border-l-4 border-green-500";
                                                    } else if (row._diff === "cancelled") {
                                                        rowClass += " animate-blynk bg-red-50";
                                                        highlightColor = "border-l-4 border-red-500";
                                                    } else if (row._diff === "modified") {
                                                        rowClass += " animate-blynk bg-blue-50";
                                                        highlightColor = "border-l-4 border-blue-500";
                                                    }

                                                    return (
                                                        <tr key={rIdx} className={rowClass}>
                                                            {columns.map((col, cIdx) => (
                                                                <td key={`${rIdx}-${cIdx}`} className={`p-1 border-b ${cIdx === 0 ? highlightColor : ''}`}>
                                                                    <input
                                                                        type="text"
                                                                        value={row[col] || ''}
                                                                        onChange={(e) => handleCellChange(rIdx, col, e.target.value)}
                                                                        className="w-full bg-transparent px-2 py-1 rounded hover:bg-white focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none truncate font-medium"
                                                                        style={{ color: row._diff ? 'inherit' : 'unset' }}
                                                                    />
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="p-2 border-t text-xs text-gray-500 text-center">
                                    Mostrando {data.length} registros. Edita las celdas directamente.
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal Añadir Columna */}
                    {showColumnModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-96">
                                <h3 className="text-lg font-bold mb-4">Añadir Nueva Columna</h3>
                                <input
                                    type="text"
                                    placeholder="Nombre (ej. Estado, Notas)"
                                    className="w-full border p-2 rounded mb-4"
                                    value={newColumnName}
                                    onChange={(e) => setNewColumnName(e.target.value)}
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowColumnModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button onClick={addNewColumn} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Añadir</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Añadir Grupo Manual */}
                    {showAddGroupModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl animate-fade-in overflow-hidden">
                                <div className="bg-[#2d5a43] p-6 text-white flex justify-between items-center">
                                    <div>
                                        <h3 className="text-xl font-bold">Registro de Nuevo Grupo</h3>
                                        <p className="text-emerald-100/70 text-xs">Introduce los detalles de la reserva manual</p>
                                    </div>
                                    <button onClick={() => setShowAddGroupModal(false)} className="text-white/60 hover:text-white transition-colors">
                                        <IconPlus className="rotate-45" size={24} />
                                    </button>
                                </div>
                                <div className="p-8 grid grid-cols-2 gap-6">
                                    <div className="col-span-2">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nombre del Grupo</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold transition-colors"
                                            placeholder="Ej: Boda Familia García / Congreso Médico"
                                            value={newGroup["Nombre del Grupo"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Nombre del Grupo": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entrada</label>
                                        <input
                                            type="date"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup.Entrada}
                                            onChange={(e) => setNewGroup({ ...newGroup, Entrada: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Salida</label>
                                        <input
                                            type="date"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup.Salida}
                                            onChange={(e) => setNewGroup({ ...newGroup, Salida: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Pax Totales</label>
                                        <input
                                            type="number"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Pax."]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Pax.": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Importe Total (€)</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            placeholder="0,00"
                                            value={newGroup["Importe(*)"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Importe(*)": e.target.value })}
                                        />
                                    </div>
                                    <div className="col-span-1">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Agencia / Empresa</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Empresa/Agencia"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Empresa/Agencia": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Segmento</label>
                                        <select
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Segment."]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Segment.": e.target.value })}
                                        >
                                            <option value="GRUPOS">GRUPOS</option>
                                            <option value="DEPORTIVO">DEPORTIVO</option>
                                            <option value="TOUR-OPERACIÓN">TOUR-OPERACIÓN</option>
                                            <option value="BODA/CELEBRACIÓN">BODA/CELEBRACIÓN</option>
                                            <option value="CONGRESO">CONGRESO</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="p-6 bg-slate-50 border-t flex gap-3">
                                    <button
                                        onClick={() => setShowAddGroupModal(false)}
                                        className="flex-1 py-4 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-100 transition-all uppercase text-xs tracking-widest"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={registerNewGroup}
                                        className="flex-[2] py-4 bg-[#2d5a43] text-white font-bold rounded-xl hover:bg-[#1e3a2c] transition-all shadow-lg shadow-emerald-900/10 uppercase text-xs tracking-widest"
                                    >
                                        Confirmar Alta
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Resultados IA */}
                    {showAiModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col animate-fade-in">
                                <div className="p-4 border-b bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-t-lg flex justify-between items-center">
                                    <h3 className="font-bold flex items-center gap-2">
                                        <IconBrain className="text-purple-300" />
                                        {aiResult ? aiResult.title : "Analizando datos..."}
                                    </h3>
                                    <button onClick={() => setShowAiModal(false)} className="text-slate-400 hover:text-white">&times;</button>
                                </div>
                                <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                                    {isAiLoading ? (
                                        <div className="flex flex-col items-center justify-center py-10">
                                            <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                            <p className="text-slate-500 animate-pulse-slow text-center">
                                                Gemini está analizando tus reservas... <br />
                                                <span className="text-xs">Buscando patrones y rentabilidad.</span>
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="prose prose-sm max-w-none text-slate-700" dangerouslySetInnerHTML={{ __html: marked.parse(aiResult?.content || "") }}></div>
                                    )}
                                </div>
                                <div className="p-4 border-t bg-slate-50 text-right rounded-b-lg">
                                    <button onClick={() => setShowAiModal(false)} className="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded transition">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showFichaModal && selectedGroupFicha && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col animate-fade-in border border-slate-200">
                                {/* CENTRO DE MANDO NEXUS (Header + Acciones) */}
                                <div className="bg-[#0f172a] text-white p-3 border-b border-white/10 shrink-0">
                                    <div className="flex justify-between items-start gap-4">
                                        <div className="flex gap-3">
                                            <div className="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20 shrink-0">
                                                <IconUsers size={20} />
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-xl font-black tracking-tight leading-none text-emerald-400">{selectedGroupFicha.name}</h3>
                                                    <span className={`px-2 py-0.5 rounded text-[8px] font-black uppercase ${(selectedGroupFicha.records[0]?.["Estado"] || "").toLowerCase().includes('conf') ? 'bg-emerald-400 text-slate-900' : 'bg-orange-400 text-slate-900'}`}>
                                                        {selectedGroupFicha.records[0]?.["Estado"] || 'PROSPECTO'}
                                                    </span>
                                                    <span className="bg-white/10 px-2 py-0.5 rounded text-[8px] font-black text-white/80 uppercase">
                                                        {selectedGroupFicha.records[0]?.["Régimen"] || 'HD'}
                                                    </span>
                                                </div>
                                                <p className="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1">
                                                    {selectedGroupFicha.records[0]?.["Empresa/Agencia"] || 'VENTA DIRECTA'} • {selectedGroupFicha.totalPax} PAX • REF: {selectedGroupFicha.records[0]?.["Reserva"]}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    const proformaData = {
                                                        ...selectedGroupFicha.records[0],
                                                        "Importe(*)": selectedGroupFicha.totalRevenue,
                                                        "Pax.": selectedGroupFicha.totalPax,
                                                        "Hotel_Asignado": selectedGroupFicha.records[0]?.["Hotel"] || "Guadiana"
                                                    };
                                                    localStorage.setItem('selectedGroup', JSON.stringify(proformaData));
                                                    window.location.href = 'Fac Prof.html';
                                                }}
                                                className="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-emerald-500/20"
                                            >
                                                <IconTable size={12} /> PROFORMA / FACTURA
                                            </button>
                                            <button
                                                onClick={() => handleEmailClick(selectedGroupFicha)}
                                                className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-blue-600/20"
                                            >
                                                <IconMail size={12} /> REDACTAR EMAIL IA
                                            </button>
                                            <button
                                                onClick={() => setShowFichaModal(false)}
                                                className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-red-500/20"
                                            >
                                                <IconX size={12} /> SALIR
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar bg-slate-50/50">
                                    {/* DASHBOARD COMERCIAL HORIZONTAL - FORZADO CON GRID INLINE */}
                                    <div style={{ display: 'grid', gridTemplateColumns: '1.8fr 1fr', gap: '8px' }}>
                                        {/* Bloque 1: Estrategia y Control */}
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px' }}>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Tarifa Neta</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[11px] font-black text-slate-800"
                                                        value={selectedGroupFicha.records[0]?.["Com_Precio"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Precio", e.target.value)}
                                                        placeholder="0.00 €"
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Release %</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[11px] font-black text-slate-800"
                                                        value={selectedGroupFicha.records[0]?.["Com_Relix"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Relix", e.target.value)}
                                                        placeholder="0%"
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Pick-up PAX</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[11px] font-black text-emerald-600 text-center"
                                                        value={selectedGroupFicha.records[0]?.["Com_Pickup"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Pickup", e.target.value)}
                                                        placeholder="0"
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Fase Comercial</label>
                                                    <select
                                                        className="w-full bg-slate-100 border border-slate-200 rounded p-1 text-[9px] font-black text-slate-700 uppercase"
                                                        value={selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto"}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Estado_Interno", e.target.value)}
                                                    >
                                                        <option>PROSPECTO</option>
                                                        <option>ENVIADO</option>
                                                        <option>SEGUIMIENTO</option>
                                                        <option>CONFIRMADO</option>
                                                        <option>CONTRATO OK</option>
                                                    </select>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Régimen</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[11px] font-black text-slate-800 text-center uppercase"
                                                        value={selectedGroupFicha.records[0]?.["Régimen"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Régimen", e.target.value)}
                                                        placeholder="HD..."
                                                    />
                                                </div>
                                            </div>
                                            {/* Más Datos Comerciales */}
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '8px', marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #f1f5f9' }}>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Rentabilidad</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px] font-black text-emerald-600"
                                                        value={selectedGroupFicha.records[0]?.["Com_Rentabilidad"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Rentabilidad", e.target.value)}
                                                        placeholder="0.00 €"
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Vto. Release</label>
                                                    <input
                                                        type="date"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px] font-bold text-red-500"
                                                        value={selectedGroupFicha.records[0]?.["Com_Vencimiento_Rel"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Vencimiento_Rel", e.target.value)}
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Email</label>
                                                    <input
                                                        type="text"
                                                        className="w-full bg-slate-50 border border-slate-200 rounded p-1 text-[10px] font-medium text-slate-600"
                                                        value={selectedGroupFicha.records[0]?.["Com_Email_Contacto"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Email_Contacto", e.target.value)}
                                                        placeholder="Email..."
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[8px] font-black text-slate-400 uppercase">Hotel</label>
                                                    <select
                                                        className="w-full bg-slate-100 border border-slate-200 rounded p-1 text-[10px] font-black text-slate-600 uppercase"
                                                        value={selectedGroupFicha.records[0]?.["Hotel"] || "Guadiana"}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Hotel", e.target.value)}
                                                    >
                                                        <option>Guadiana</option>
                                                        <option>Cumbria</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Bloque 2: Información Operativa (Timing + Noches) */}
                                        <div className="bg-[#2d5a43] px-3 py-2 rounded-lg text-white shadow-md flex items-center justify-between gap-4 h-fit self-start mt-2">
                                            <div className="flex-1 space-y-0.5">
                                                <div className="flex justify-between items-center text-[7px] font-bold border-b border-white/10 pb-0.5">
                                                    <span className="opacity-60">IN</span>
                                                    <span className="font-black text-[11px]">{formatDate(selectedGroupFicha.arrival)}</span>
                                                </div>
                                                <div className="flex justify-between items-center text-[7px] font-bold pt-0.5">
                                                    <span className="opacity-60">OUT</span>
                                                    <span className="font-black text-[11px]">{formatDate(selectedGroupFicha.departure)}</span>
                                                </div>
                                            </div>
                                            <div className="pl-3 border-l border-white/20 text-center">
                                                <p className="text-[7px] font-black opacity-60 uppercase leading-none">Noches</p>
                                                <p className="text-xl font-black leading-none mt-0.5">{selectedGroupFicha.totalNights}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* INVENTARIO COMPACTO */}
                                    <div className="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex items-center gap-3">
                                        <div className="px-2 border-r border-slate-100 text-[8px] font-black text-slate-400 uppercase shrink-0">Inv Hab:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {[
                                                { label: "D.STD", key: "Room_DSTD", color: "border-emerald-500" },
                                                { label: "D.SUP", key: "Room_DSUP", color: "border-blue-500" },
                                                { label: "SUI", key: "Room_SUI", color: "border-purple-500" },
                                                { label: "S.SUP", key: "Room_SSUP", color: "border-indigo-500" },
                                                { label: "CUA", key: "Room_CUA", color: "border-orange-500" }
                                            ].map((item) => (
                                                <div key={item.key} className={`flex items-center bg-slate-50 border-l-2 ${item.color} rounded px-1.5 py-0.5`}>
                                                    <span className="text-[7px] font-black text-slate-500 mr-1 uppercase">{item.label}</span>
                                                    <input
                                                        type="number"
                                                        className="w-8 bg-transparent border-none p-0 text-[10px] font-black text-slate-800 text-center"
                                                        value={selectedGroupFicha.records[0]?.[item.key] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, item.key, e.target.value)}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* FINANZAS Y BITÁCORA SIDE-BY-SIDE INTEGRADO */}
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1.5fr', gap: '8px' }}>
                                        {/* Tesorería Compacta */}
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm space-y-2">
                                            <div className="flex justify-between items-center mb-1">
                                                <p className="text-[8px] font-black text-slate-400 uppercase tracking-widest">Tesorería</p>
                                                <button
                                                    onClick={() => calculateDeposits(selectedGroupFicha)}
                                                    className="text-[7px] bg-emerald-50 text-emerald-600 font-black px-1.5 py-0.5 rounded border border-emerald-100 transition-colors"
                                                >
                                                    AUTOCALCULAR (30/70%)
                                                </button>
                                            </div>
                                            {[
                                                { label: "DEP 1 (30%)", key: "Dep1", color: "text-emerald-600" },
                                                { label: "FINAL (70%)", key: "Dep2", color: "text-blue-600" }
                                            ].map((dep) => (
                                                <div key={dep.key} className="flex items-center justify-between bg-slate-50 p-1.5 rounded border border-slate-100">
                                                    <div className="text-left">
                                                        <p className="text-[7px] font-bold text-slate-400 uppercase leading-none">{dep.label}</p>
                                                        <input
                                                            type="text"
                                                            className="bg-transparent border-none p-0 text-[11px] font-black text-slate-800 w-20"
                                                            value={selectedGroupFicha.records[0]?.[`${dep.key}_Importe`] || ""}
                                                            onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, `${dep.key}_Importe`, e.target.value)}
                                                            placeholder="0.00 €"
                                                        />
                                                    </div>
                                                    <button
                                                        onClick={() => updateGroupMetadata(selectedGroupFicha.name, `${dep.key}_Status`, selectedGroupFicha.records[0]?.[`${dep.key}_Status`] === "Cobrado" ? "Pendiente" : "Cobrado")}
                                                        className={`px-2 py-0.5 rounded text-[7px] font-black uppercase ${selectedGroupFicha.records[0]?.[`${dep.key}_Status`] === "Cobrado" ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-500'}`}
                                                    >
                                                        {selectedGroupFicha.records[0]?.[`${dep.key}_Status`] || 'PND'}
                                                    </button>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Bitácora / Notas Operativas */}
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex flex-col">
                                            <p className="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Notas de Control Comercial / Operativo</p>
                                            <textarea
                                                className="flex-1 w-full min-h-[60px] bg-slate-50 border border-slate-100 rounded p-2 text-[10px] font-medium text-slate-700 focus:outline-none resize-none"
                                                placeholder="Añadir seguimiento aquí..."
                                                value={selectedGroupFicha.records[0]?.["Com_Notas"] || ""}
                                                onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Notas", e.target.value)}
                                            ></textarea>
                                        </div>
                                    </div>

                                    {/* REGISTROS ARCHIVO (Opcional scrollable) */}
                                    <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                                        <table className="w-full text-[9px] leading-tight">
                                            <thead className="bg-[#0f172a] text-white font-black uppercase">
                                                <tr>
                                                    <th className="px-3 py-1.5 text-left">Reserva</th>
                                                    <th className="px-3 py-1.5 text-left">Periodo</th>
                                                    <th className="px-3 py-1.5 text-right">Hab</th>
                                                    <th className="px-3 py-1.5 text-right">Importe</th>
                                                    <th className="px-3 py-1.5 text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {selectedGroupFicha.records.map((rec, idx) => (
                                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-3 py-1.5 font-bold text-slate-900">{rec["Reserva"]}</td>
                                                        <td className="px-3 py-1.5 text-slate-600">{formatDate(rec["Entrada"])} - {formatDate(rec["Salida"])}</td>
                                                        <td className="px-3 py-1.5 text-right font-bold">{rec["Hab."] || '-'}</td>
                                                        <td className="px-3 py-1.5 text-right font-black text-emerald-600">{rec["Importe(*)"]} €</td>
                                                        <td className="px-3 py-1.5 text-center">
                                                            <span className={`px-2 py-0.5 rounded text-[7px] font-black uppercase ${rec["Estado"]?.toLowerCase().includes('conf') ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                                {rec["Estado"] || '???'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Selección de Hotel para Importación */}
                    {isHotelModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[100] p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 animate-fade-in text-center">
                                <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                    <IconUpload size={32} />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">¿A qué hotel pertenecen estos datos?</h3>
                                <p className="text-sm text-slate-500 mb-8">Selecciona el hotel para asignar correctamente las reservas importadas.</p>

                                <div className="grid grid-cols-1 gap-4">
                                    <button
                                        onClick={() => confirmHotelAndProcess("Sercotel Guadiana")}
                                        className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                    >
                                        <span className="text-emerald-600">Sercotel Guadiana</span>
                                        <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Principal</span>
                                    </button>
                                    <button
                                        onClick={() => confirmHotelAndProcess("Cumbria Spa & Hotel")}
                                        className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                    >
                                        <span className="text-blue-600">Cumbria Spa & Hotel</span>
                                        <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Asociado</span>
                                    </button>
                                </div>

                                <button
                                    onClick={() => { setIsHotelModalOpen(false); setPendingFile(null); }}
                                    className="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold uppercase tracking-widest"
                                >
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>