<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas - SERCOTEL GUADIANA</title>
    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Montserrat:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap');

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page-container {
                box-shadow: none;
                margin: 0;
                border: none;
                width: 100%;
                min-height: auto;
            }

            .editable:hover {
                background: transparent;
            }

            select {
                appearance: none;
                -webkit-appearance: none;
                border: none;
                background: transparent;
                padding: 0;
            }

            /* Forzar impresi√≥n de sombras y fondos */
            .shadow-lg,
            .shadow-md,
            .shadow-sm,
            [style*="box-shadow"] {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
        }

        .editable {
            min-height: 1.2em;
            min-width: 20px;
            display: inline-block;
            cursor: text;
        }

        .editable:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
        }

        .editable:focus {
            outline: 2px solid #2d5a43;
            background: white;
        }

        .font-pro {
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0px;
        }

        .font-logo {
            font-family: 'Libre Baskerville', serif;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 10mm 15mm;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tab-active {
            border-bottom: 3px solid #2d5a43;
            color: #2d5a43;
            font-weight: 700;
        }

        select.no-print {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 4px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        select.no-print:hover {
            border-color: #2d5a43;
            color: #2d5a43;
            background-color: #fff;
        }

        .logo-placeholder {
            max-height: 80px;
            max-width: 250px;
            object-fit: contain;
        }

        .legal-footer {
            font-size: 8px;
            line-height: 1.3;
            color: #1f2937;
            text-align: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        #ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .iva-breakdown-small {
            font-size: 9px;
            color: #4b5563;
            line-height: 1.4;
        }

        /* Estilos espec√≠ficos Proforma PDF */
        .proforma-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .static-legal-sidebar {
            position: absolute;
            left: 5mm;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 50;
        }

        .vertical-legal-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-size: 7px;
            font-weight: 700;
            color: #1a1a1a;
            white-space: nowrap;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        .proforma-header-table td {
            vertical-align: top;
        }

        .proforma-box {
            border: 1px solid black;
            display: inline-block;
            width: 220px;
            font-size: 10px;
            font-family: 'Courier Prime', monospace;
        }

        .proforma-box-header {
            border-bottom: 1px solid black;
            display: flex;
            font-weight: bold;
            background: #f9fafb;
        }

        .proforma-box-header div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-header div:last-child {
            border-right: none;
        }

        .proforma-box-row {
            display: flex;
        }

        .proforma-box-row div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-row div:last-child {
            border-right: none;
        }

        .proforma-table th {
            border-bottom: 2px solid black;
            border-top: 1px solid black;
            padding: 5px 0;
            font-weight: bold;
            text-align: left;
            font-size: 10px;
        }

        .proforma-table td {
            padding: 4px 0;
            font-size: 10px;
            vertical-align: top;
        }

        .proforma-total-box {
            background-color: #2d5a43;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            width: 300px;
            float: right;
        }

        .clean-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 4px;
        }

        .clean-label {
            font-weight: bold;
            width: 100px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .header-logo-container {
            flex: 1;
            display: flex;
            justify-content: flex-start;
        }

        .header-info-container {
            flex: 1;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            color: #333;
            line-height: 1.5;
        }

        .header-title-container {
            flex: 1;
            text-align: right;
        }
    </style>
</head>

<body class="bg-gray-200 p-0 md:p-8">

    <!-- Panel de Control Superior -->
    <div
        class="max-w-[210mm] mx-auto mb-6 no-print bg-white shadow-lg rounded-xl p-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex gap-6 items-center">
            <button onclick="saveAndExit()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-[#2d5a43]"
                title="Volver a la Ficha">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </button>
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entorno de
                    Trabajo</span>
                <div class="flex gap-4">
                    <button onclick="switchTemplate('confirmacion')" id="btn-confirmacion"
                        class="pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Confirmaci√≥n</button>
                    <button onclick="switchTemplate('proforma')" id="btn-proforma"
                        class="pb-2 px-2 text-gray-400 hover:text-gray-600 transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Factura Proforma</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Seleccionar Hotel</span>
            <select id="hotel-selector" onchange="updateHotel(this.value)"
                class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#2d5a43]">
                <option value="guadiana">Sercotel Guadiana</option>
                <option value="cumbria">Sercotel Cumbria</option>
            </select>
        </div>

        <div class="flex gap-2">
            <button onclick="saveAndExit()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-blue-500 transition-all flex items-center gap-1 shadow-md">
                üíæ Guardar y Salir
            </button>
            <button onclick="generateAIEmail()"
                class="bg-emerald-50 hover:bg-emerald-100 text-[#2d5a43] px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-emerald-200 transition-all flex items-center gap-1">
                ‚ú® Redactar Email
            </button>
            <button onclick="window.print()"
                class="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all uppercase text-[10px]">
                Imprimir / PDF
            </button>
        </div>
    </div>

    <!-- CONTENEDOR DE LA P√ÅGINA -->
    <div id="capture-area" class="page-container shadow-2xl border border-gray-300">

        <!-- Sidebar Legal Vertical Global -->
        <div class="static-legal-sidebar">
            <div id="global-vertical-legal" class="vertical-legal-text italic">
                <!-- Se rellena din√°micamente -->
            </div>
        </div>

        <!-- CABECERA UNIVERSAL (PARA AMBOS MODELOS) -->
        <div class="header-container">
            <div class="header-logo-container">
                <img id="logo-img-universal" src="Logos/Sercotel Guadiana.jpg" class="max-h-24 w-auto object-contain"
                    alt="Logo">
            </div>

            <div class="header-info-container">
                <div id="header-address-line" class="font-bold">C/ Guadiana, 36</div>
                <div id="header-city-line">13002 - Ciudad Real (Espa√±a)</div>
                <div id="header-tel-line">Telf.: (+34) <span id="header-tel-val">926 22 33 13</span></div>
            </div>

            <div class="header-title-container">
                <div id="doc-type-title"
                    class="text-lg font-black uppercase tracking-tighter text-gray-800 border-b-2 border-gray-800 inline-block px-1">
                    Confirmaci√≥n
                </div>
                <div class="mt-2 text-[11px] font-bold text-gray-500">
                    <span id="doc-type-label">Reserva:</span> <span id="reserva-id-universal"
                        class="editable font-black text-slate-800" contenteditable="true">---</span>
                </div>
                <div class="text-[10px] text-gray-400 mt-0.5">
                    Fecha: <span id="fecha-universal" class="editable" contenteditable="true">--/--/----</span>
                </div>
            </div>
        </div>

        <!-- MODELO 1: CONFIRMACI√ìN (Estilo Moderno) -->
        <div id="tpl-confirmacion" class="template-content font-sans">
            <!-- Header removed and moved to universal container -->

            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="border-l-4 border-[#2d5a43] pl-4">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-1">Solicitante</h4>
                    <div class="text-xs space-y-1">
                        <p><strong class="font-bold text-slate-500">Organismo:</strong> <span
                                class="editable font-black text-slate-800" id="solicitante-org-1"
                                contenteditable="true">EAPN-ES</span></p>
                        <p><strong class="font-bold text-slate-500">Contacto:</strong> <span
                                class="editable font-bold text-slate-700" id="solicitante-nombre-1"
                                contenteditable="true">MARCELLO RONCHI</span></p>
                        <p><strong class="font-bold text-slate-500">Email:</strong> <span
                                class="editable text-slate-600" id="solicitante-email-1"
                                contenteditable="true">marcello.ronchi@eapn.es</span></p>
                        <p><strong class="font-bold text-slate-500">Tel√©fono:</strong> <span class="editable"
                                id="solicitante-tel-1" contenteditable="true">-</span></p>
                    </div>
                </div>
                <div class="border-l-4 border-[#eab308] pl-4">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-1">Reserva</h4>
                    <div class="text-xs grid grid-cols-2 gap-x-1">
                        <span class="text-gray-500">Personas:</span> <span class="editable font-bold"
                            id="reserva-personas-1" contenteditable="true">70</span>
                        <span class="text-gray-500">Entrada:</span> <span class="editable font-bold"
                            id="reserva-entrada-1" contenteditable="true">21-04-2026</span>
                        <span class="text-gray-500">Salida:</span> <span class="editable font-bold"
                            id="reserva-salida-1" contenteditable="true">24-04-2026</span>
                    </div>
                    <!-- Nuevo Contenedor IVA corporativo -->
                    <div id="iva-summary-confirmacion" class="mt-4"></div>
                </div>
            </div>

            <table class="w-full text-[10px] mb-6 border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-[#2d5a43] border-b-2 border-[#2d5a43] uppercase text-[8px] font-bold">
                        <th class="p-2 text-left w-20">Fecha</th>
                        <th class="p-2 text-center w-8">Cantidad</th>
                        <th class="p-2 text-left">Concepto</th>
                        <th class="p-2 text-center w-8">Reg.</th>
                        <th class="p-2 text-center w-8">D√≠as</th>
                        <th class="p-2 text-right w-16">Precio/U</th>
                        <th class="p-2 text-right w-20">Total</th>
                        <th class="p-2 text-right w-20">Acumulado</th>
                        <th class="p-2 w-4 no-print"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <div id="tpl-proforma" class="template-content hidden font-pro text-black">
            <div class="mb-6 flex justify-between items-end border-b-2 border-slate-800 pb-2">
                <h1 class="text-3xl font-black uppercase tracking-widest text-slate-800">Factura Proforma</h1>
                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Documento Informativo</span>
            </div>
            <table class="w-full mb-6">
                <tr>
                    <td width="55%" class="align-top">

                        <!-- Caja Datos Factura -->
                        <div class="proforma-box w-[250px] border-black">
                            <div class="proforma-box-header bg-gray-100 border-b border-black text-center">
                                <div class="border-r border-black" id="proforma-header-label">N¬∫ Factura</div>
                                <div class="border-r border-black">Fecha</div>
                                <div>Pag.</div>
                            </div>
                            <div class="proforma-box-row text-center">
                                <div class="border-r border-black font-bold text-[10px] editable" id="reserva-id-2"
                                    contenteditable="true">Proforma</div>
                                <div class="border-r border-black text-xs"><span class="editable" id="fecha-proforma-2"
                                        contenteditable="true">12-02-2026</span></div>
                                <div class="text-xs">1</div>
                            </div>
                        </div>
                    </td>
                    <td width="45%" class="align-top pt-2">
                        <div class="bg-slate-50 p-4 rounded-lg shadow-sm text-xs font-mono text-gray-600">
                            <div class="font-bold text-black uppercase text-sm editable" id="solicitante-org-2"
                                contenteditable="true" style="display:block;">&nbsp;</div>
                            <div class="editable uppercase" id="client-address" contenteditable="true"
                                style="display:block;">&nbsp;</div>
                            <div class="editable uppercase" id="client-city" contenteditable="true"
                                style="display:block;">&nbsp;</div>
                            <div class="mt-4 font-bold text-black uppercase">
                                N.I.F. / CIF: <span class="editable" id="client-nif"
                                    contenteditable="true">&nbsp;</span>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- Caja Datos Ocupante -->
            <div class="border border-black p-2 mb-6 text-[11px] leading-relaxed relative flex justify-between gap-4"
                id="ocupante-box">
                <button
                    class="no-print absolute -top-3 -right-3 bg-emerald-500 text-white rounded-full w-5 h-5 text-[9px] font-bold shadow hover:bg-emerald-600 transition hidden"
                    id="ocupante-restore"
                    onclick="document.querySelectorAll('.ocupante-row').forEach(r=>r.classList.remove('hidden'));this.classList.add('hidden');"
                    title="Restaurar campos ocultos">‚Ü∫</button>

                <div class="flex-1">
                    <div class="mb-1 ocupante-row flex items-center gap-1">
                        <span><strong>Ocupante :</strong> <span class="editable min-w-[200px]" contenteditable="true"
                                id="f-pax-name">---</span></span>
                        <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                            onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                            title="Ocultar">‚úï</button>
                    </div>
                    <div class="ocupante-row flex items-center gap-1">
                        <span class="w-24"><strong>Cantidad :</strong></span>
                        <span class="editable flex-1" contenteditable="true" id="f-room-summary">---</span>
                        <button class="no-print text-red-300 hover:text-red-600 text-[10px]"
                            onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                            title="Ocultar">‚úï</button>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4">
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Nro. Personas :</strong></span>
                            <span class="editable" contenteditable="true" id="f-pax-count">62</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>N¬∫ Bono :</strong></span>
                            <span class="editable" contenteditable="true" id="f-voucher">---</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Entrada :</strong></span>
                            <span class="editable" contenteditable="true" id="f-date-in">22-04-2026</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Salida :</strong></span>
                            <span class="editable" contenteditable="true" id="f-date-out">24-04-2026</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                    </div>
                    <div
                        class="mt-1 border-t border-dotted border-gray-300 pt-1 text-[9px] text-gray-500 no-print flex gap-2">
                        <button onclick="addOcupanteField()" class="hover:text-black uppercase font-bold">+
                            Campo</button>
                    </div>
                </div>

                <!-- Espacio para Desglose (Eliminado de aqu√≠ para moverlo bajo el total) -->
                <div id="iva-summary-proforma" class="hidden"></div>
            </div>

            <!-- Tabla de Conceptos -->
            <table class="w-full text-[11px] proforma-table mb-2">
                <thead>
                    <tr class="border-y border-black font-black uppercase text-[9px]">
                        <th width="12%" class="text-left py-1.5">FECHA</th>
                        <th width="8%" class="text-center py-1.5">CANTIDAD</th>
                        <th width="30%" class="text-left py-1.5">CONCEPTO</th>
                        <th width="8%" class="text-center py-1.5">REG.</th>
                        <th width="8%" class="text-center py-1.5">D√çAS</th>
                        <th width="10%" class="text-right py-1.5">PRECIO/U</th>
                        <th width="12%" class="text-right py-1.5">TOTAL</th>
                        <th width="12%" class="text-right py-1.5">ACUMULADO</th>
                        <th class="w-4 no-print border-none"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <div class="no-print flex justify-center mb-4 mt-2">
            <button onclick="addRow()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-[9px] uppercase font-bold tracking-widest transition border border-gray-300">
                + A√±adir Concepto
            </button>
        </div>

        <!-- TOTALES Y FOOTER -->
        <div class="mt-auto">
            <!-- Totales Din√°micos -->
            <div id="footer-totals" class="w-full"></div>

            <!-- Pol√≠ticas de Reserva (Solo en Confirmaci√≥n) -->
            <div id="tpl-policies" class="hidden"></div>

            <!-- Pie de P√°gina Premium: Configuraci√≥n 100% Din√°mica (Casi vac√≠o ahora que la info est√° arriba) -->
            <div id="common-footer" class="mt-8 border-t border-slate-50 font-pro">
                <div class="mt-4 flex flex-col items-center gap-2">
                    <p class="hotel-legal-footer hidden"></p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="no-print">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-[#2d5a43] flex items-center gap-2"></h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div id="ai-content" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto mb-6 pr-2">
                Generando respuesta...
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t">
                <button onclick="copyAIContent()" id="btn-copy"
                    class="text-xs font-bold uppercase tracking-widest text-emerald-700 bg-emerald-50 px-4 py-2 rounded-lg hover:bg-emerald-100 transition-all">
                    Copiar texto
                </button>
                <button onclick="closeAIModal()"
                    class="text-xs font-bold uppercase tracking-widest text-gray-500 bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Configuraci√≥n Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script>
        const HOTELS = {
            guadiana: {
                name: "SERCOTEL",
                subname: "GUADIANA",
                letter: "G",
                stars: "****",
                logo: "Logos/Sercotel Guadiana.jpg",
                brand: "by Sercotel",
                company: "SWEETMOON DESARROLLOS S.L.",
                nif: "B87067302",
                address: "C/ Guadiana, 36",
                cp: "13002",
                city: "Ciudad Real",
                tel: "926 22 33 13",
                fax: "926 27 30 57",
                email: "info@hotelguadiana.es",
                web: "www.hotelguadiana.es",
                bank: "Globalcaja",
                iban: "ES30 3190 3953 1851 8526 3521",
                irus: "1000292995580",
                paymentGateway: "",
                legal: "Inscrito en la hoja CR-00035559 del Registro Mercantil de Ciudad Real. Folio electr√≥nico. Inscripci√≥n/anotaci√≥n 4"
            },
            cumbria: {
                name: "Hotel",
                subname: "Cumbria",
                letter: "C",
                stars: "***",
                logo: "Logos/Cumbria Spa&Hotel.jpg",
                brand: "Cumbria Spa",
                company: "MOON FREE PORT, S.L.",
                nif: "B87895058",
                address: "Ctra. Fuencaliente, s/n",
                cp: "13004",
                city: "Ciudad Real",
                tel: "926 25 10 25",
                fax: "926 25 10 26",
                email: "recepcion@hotelcumbria.es",
                web: "www.hotelcumbria.es",
                bank: "Caixabank",
                iban: "ES19 3081 0601 0850 0004 8966",
                paymentGateway: "",
                legal: "Inscrito en el tomo 699 de libro 0 folio 2 hoja CR-32491 inscripci√≥n 2¬™"
            }
        };

        // --- CARGAR CONFIGURACI√ìN DESDE CLOUD ---
        async function refreshConfigFromCloud() {
            try {
                if (typeof db === 'undefined') return;
                const doc = await db.collection("settings").doc("main").get();
                if (doc.exists) {
                    const cloudData = doc.data();
                    if (cloudData.guadiana) Object.assign(HOTELS.guadiana, cloudData.guadiana);
                    if (cloudData.cumbria) Object.assign(HOTELS.cumbria, cloudData.cumbria);
                    // log
                    // Re-render si ya carg√≥
                    updateHotel(currentHotel);
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è Error cargando config cloud:", e);
            }
        }

        // Se carga desde js/firebase-config.js
        const apiKey = window.firebaseConfig ? window.firebaseConfig.apiKey : "";
        let currentTemplate = 'confirmacion';
        let currentHotel = 'guadiana';
        let showBankDetails = true; // Flag for bank details visibility in Proforma
        let showLegalNotice = true; // Flag for legal notice visibility in Proforma

        // Datos iniciales vac√≠os para permitir creaci√≥n manual
        let items = [];

        // Sincronizaci√≥n de datos comunes
        function syncFields() {
            // Sync all fields EXCEPT reserva-id (proforma uses fixed "PROFORMA" text)
            const fields = [
                'fecha-proforma', 'solicitante-org', 'solicitante-nombre', 'solicitante-email',
                'reserva-personas', 'reserva-entrada', 'reserva-salida',
                'client-address', 'client-city', 'client-nif',
                'f-pax-name', 'f-pax-count', 'f-date-in', 'f-date-out', 'f-room-summary'
            ];
            fields.forEach(f => {
                const el1 = document.getElementById(f + '-1');
                const el2 = document.getElementById(f + '-2');
                const elExact = document.getElementById(f);

                // Collect values from any available element
                let value = "";
                if (el1) value = el1.innerText;
                else if (el2) value = el2.innerText;
                else if (elExact) value = (elExact.tagName === 'INPUT' ? elExact.value : elExact.innerText);

                if (el1 && document.activeElement !== el1) el1.innerText = value;
                if (el2 && document.activeElement !== el2) el2.innerText = value;
                if (elExact && document.activeElement !== elExact) {
                    if (elExact.tagName === 'INPUT') elExact.value = value;
                    else elExact.innerText = value;
                }
            });
            // Auto-guardado local
            syncWithFicha();
        }
        setInterval(syncFields, 3000);

        async function saveAndExit() {
            const targetFile = "Gesti√≥n de Grupos.html";
            const saved = localStorage.getItem('selectedGroup');
            let reservaId = "";
            if (saved) {
                try {
                    const group = JSON.parse(saved);
                    reservaId = group.Reserva || group["Reserva"] || "";
                } catch (e) { }
            }
            if (reservaId) {
                localStorage.setItem('nexus_return_reserva', reservaId);
            }

            const url = encodeURI(targetFile) + (reservaId ? '?reserva=' + encodeURIComponent(reservaId) : '');

            // Funci√≥n para redirigir
            const doRedirect = () => {
                // log
                window.location.href = url;
            };

            // Intentar sincronizar pero con un timeout de seguridad para no bloquear al usuario
            const syncPromise = syncWithFicha().catch(e => console.error("Error sincronizando:", e));
            const timeoutPromise = new Promise(resolve => setTimeout(resolve, 1500));

            await Promise.race([syncPromise, timeoutPromise]);
            doRedirect();
        }

        async function callGemini(prompt) {
            let dynamicKey = window.firebaseConfig?.apiKey || "";
            let model = "gemini-1.5-flash";

            try {
                if (typeof db !== 'undefined') {
                    const settingsDoc = await db.collection("settings").doc("main").get();
                    if (settingsDoc.exists) {
                        const s = settingsDoc.data().system || {};
                        if (s.geminiApiKey) dynamicKey = s.geminiApiKey;
                        if (s.geminiModel) model = s.geminiModel;
                    }
                }
            } catch (e) {
                console.warn("Fallback to config key.");
            }

            if (!dynamicKey || dynamicKey === "TU_API_KEY_AQUI") {
                return "‚ö†Ô∏è ERROR: No se ha configurado la API Key en el panel de Configuraci√≥n.";
            }

            const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${dynamicKey}`;
            const fullPrompt = "Eres un asistente de recepci√≥n de un hotel de lujo (SERCOTEL GUADIANA). Tu tono es profesional, cort√©s y servicial. Siempre respondes en espa√±ol.\n\n" + prompt;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const msg = error.error?.message || "";
                    if (msg.includes("blocked") || msg.includes("PERMISSION_DENIED")) {
                        return "üö´ ACCESO DENEGADO: Tu API Key est√° bloqueada o no tiene los permisos necesarios (Generative Language API) en Google Cloud Console.";
                    }
                    throw new Error(msg || "Error en la llamada a la API");
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return `Error de conexi√≥n con la IA: ${e.message}`;
            }
        }

        async function generateAIEmail() {
            showAIModal("‚ú® Redactando Email Profesional");
            const total = items.reduce((acc, curr) => acc + (curr.precio || 0), 0);
            const cliente = document.getElementById('solicitante-org-1').innerText;
            const prompt = `Redacta un correo electr√≥nico profesional para enviar esta factura proforma. Cliente: ${cliente}, Total: ${formatNum(total)} ‚Ç¨. Tono amable y profesional.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        async function generateAIPlan() {
            showAIModal("‚ú® Sugerencia de Plan para el Grupo");
            const personas = document.getElementById('reserva-personas-1').innerText;
            const prompt = `Sugiere un plan de ocio en Ciudad Real para ${personas} personas.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        function showAIModal(title) {
            document.getElementById('ai-modal-title').innerText = title;
            document.getElementById('ai-content').innerText = "Generando...";
            document.getElementById('ai-modal').style.display = 'flex';
        }
        function closeAIModal() { document.getElementById('ai-modal').style.display = 'none'; }

        const toNum = (val) => {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            const s = String(val).replace(/[^\d,.-]/g, '');
            if (s.includes(',') && s.includes('.')) return parseFloat(s.replace(/\./g, '').replace(',', '.'));
            if (s.includes(',')) return parseFloat(s.replace(',', '.'));
            return parseFloat(s) || 0;
        };

        const toInputDate = (val) => {
            if (!val || val === "---") return "";
            const s = String(val).trim();
            if (/^\d{5}$/.test(s)) {
                const d = new Date(Math.round((parseInt(s) - 25569) * 86400 * 1000));
                return d.toISOString().split('T')[0];
            }
            if (/^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}/.test(s)) {
                const [d, m, y] = s.split(/[-\/]/);
                return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }
            if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.split('T')[0];
            const dObj = new Date(s);
            if (!isNaN(dObj.getTime())) return dObj.toISOString().split('T')[0];
            return s;
        };

        const formatDate = (val) => {
            if (!val || val === "---") return "-";
            const iso = toInputDate(val);
            if (!iso || !iso.includes('-')) return val;
            const [y, m, d] = iso.split('-');
            return `${d}-${m}-${y}`;
        };

        const parseMoney = (val) => toNum(val);

        function loadSelectedGroup() {
            const saved = localStorage.getItem('selectedGroup');
            const today = new Date().toLocaleDateString('es-ES');

            // log

            // Reset inicial de placeholders para evitar ver datos de otro grupo o placeholders hardcoded
            const idsToReset = [
                'reserva-id', 'solicitante-org', 'solicitante-nombre', 'solicitante-tel', 'solicitante-email',
                'reserva-personas', 'reserva-entrada', 'reserva-salida', 'client-address', 'client-city', 'client-nif',
                'f-pax-name', 'f-pax-count', 'f-date-in', 'f-date-out', 'f-room-summary'
            ];
            idsToReset.forEach(id => {
                const el1 = document.getElementById(id + '-1');
                const el2 = document.getElementById(id + '-2');
                const elExact = document.getElementById(id);
                const elUniversal = document.getElementById(id + '-universal');
                if (el1) el1.innerText = '';
                if (el2) el2.innerText = '';
                if (elExact) {
                    if (elExact.tagName === 'INPUT') elExact.value = '';
                    else elExact.innerText = '';
                }
                if (elUniversal) elUniversal.innerText = '';
            });
            document.querySelectorAll('[id^="fecha-proforma-"]').forEach(el => el.innerText = today);

            if (!saved) {
                console.warn("‚ö†Ô∏è No se encontraron datos en 'selectedGroup'");
                if (document.getElementById('reserva-id-1')) document.getElementById('reserva-id-1').innerText = 'MANUAL';
                return;
            }

            try {
                const group = JSON.parse(saved);
                // log
                // log

                // log
                const hotelVal = (group["Hotel_Asignado"] || group["Hotel"] || "").toLowerCase();
                if (hotelVal.includes('cumb')) {
                    updateHotel('cumbria');
                } else {
                    updateHotel('guadiana');
                }

                // Mapping robusto
                const mapping = {
                    'reserva-id': group["Reserva"] || '',
                    'solicitante-org': group["Fiscal_RazonSocial"] || group["Empresa/Agencia"] || group["Nombre del Grupo"] || '',
                    'solicitante-nombre': group["Persona_Contacto"] || group["Com_Nombre_Contacto"] || group["Nombre del Grupo"] || '',
                    'solicitante-tel': group["Telefono"] || group["Com_Telefono_Contacto"] || '',
                    'solicitante-email': group["Email"] || group["Com_Email_Contacto"] || group["Fiscal_Email"] || '',
                    'reserva-personas': group["Pax."] || '',
                    'reserva-entrada': formatDate(group["Entrada"]),
                    'reserva-salida': formatDate(group["Salida"]),
                    'fecha-proforma': today,
                    'client-address': group["Fiscal_Direccion"] || '',
                    'client-city': (group["Fiscal_CP"] ? group["Fiscal_CP"] + ' ' : '') + (group["Fiscal_Poblacion"] || '') + (group["Fiscal_Provincia"] ? ', ' + group["Fiscal_Provincia"] : ''),
                    'client-nif': group["Fiscal_CIF"] || '',
                    'f-pax-name': group["Nombre del Grupo"] || '',
                    'f-pax-count': group["Pax."] || '',
                    'f-date-in': formatDate(group["Entrada"]),
                    'f-date-out': formatDate(group["Salida"]),
                    'f-room-summary': group["RoomSummary"] || '---'
                };

                // Override con campos personalizados SOLO si no hay dato en la ficha
                // o si el campo no es de los vitales (fiscales)
                const customFields = group.ProformaCustomFields || {};
                const criticalFiscalFields = ['client-address', 'client-city', 'client-nif', 'solicitante-org'];
                const placeholders = ["Calle Direcci√≥n", "RAZ√ìN SOCIAL", "CP, Ciudad", "B00000000", "---"];

                Object.keys(mapping).forEach(k => {
                    const isCritical = criticalFiscalFields.includes(k);
                    const hasFichaData = mapping[k] && mapping[k] !== '' && !placeholders.includes(mapping[k]);
                    const hasCustomData = customFields[k] && customFields[k] !== '' && !placeholders.includes(customFields[k]);

                    if (isCritical) {
                        // Para campos fiscales, si hay dato en la ficha, ignoramos cualquier custom
                        if (hasFichaData) {
                            // log
                        } else if (hasCustomData) {
                            // Si la ficha est√° vac√≠a pero el usuario escribi√≥ algo manual (que no es placeholder), lo aceptamos
                            mapping[k] = customFields[k];
                        } else {
                            // Si ambos est√°n vac√≠os o tienen placeholders, vaciamos el campo por completo
                            mapping[k] = "";
                        }
                    } else if (customFields[k] !== undefined && customFields[k] !== '') {
                        // Para campos no cr√≠ticos, permitimos el override normal
                        mapping[k] = customFields[k];
                    }
                });

                // Renderizar mapeos
                Object.keys(mapping).forEach(id => {
                    const el1 = document.getElementById(id + '-1');
                    const el2 = document.getElementById(id + '-2');
                    const elExact = document.getElementById(id);
                    const elUniversal = document.getElementById(id + '-universal');
                    const finalVal = (mapping[id] !== undefined && mapping[id] !== null) ? String(mapping[id]) : "";

                    if (el1) el1.innerText = finalVal;
                    if (el2) el2.innerText = finalVal;
                    if (elExact) {
                        if (elExact.tagName === 'INPUT') elExact.value = finalVal;
                        else elExact.innerText = finalVal;
                    }
                    if (elUniversal) elUniversal.innerText = finalVal;

                    if (id === 'reserva-id') {
                        ['reserva-id-2', 'reserva-id-universal'].forEach(rid => {
                            const e = document.getElementById(rid);
                            if (e) e.innerText = finalVal;
                        });
                    }
                });

                // Restore dynamic rows
                if (customFields.dynamicRows && Array.isArray(customFields.dynamicRows)) {
                    const container = document.querySelector('#ocupante-box .flex-1');
                    if (container) {
                        const footer = [...container.children].find(child => child.classList.contains('border-t') && child.classList.contains('no-print'));
                        customFields.dynamicRows.forEach(row => {
                            const newRow = document.createElement('div');
                            newRow.className = 'ocupante-row flex items-center gap-1 mt-1';
                            newRow.innerHTML = `
                                <span class="w-24"><strong><span class="editable" contenteditable="true">${row.key}</span> :</strong></span>
                                <span class="editable flex-1" contenteditable="true" style="min-width: 100px;">${row.value}</span>
                                <button class="no-print text-red-200 hover:text-red-500 text-[10px] ml-auto"
                                        onclick="this.parentElement.remove()" title="Eliminar">‚úï</button>
                            `;
                            if (footer) container.insertBefore(newRow, footer);
                            else container.appendChild(newRow);
                        });
                    }
                }

                // Cargar Items
                if (group.ProformaItems && Array.isArray(group.ProformaItems) && group.ProformaItems.length > 0) {
                    items = group.ProformaItems;
                } else {
                    const importe = parseMoney(group["Importe(*)"]);
                    if (importe > 0) {
                        items = [{
                            fecha: formatDate(group["Entrada"]),
                            hab: '',
                            cant: group["Pax."] || '1',
                            concepto: `ESTANCIA GRUPO: ${group["Nombre del Grupo"]}`,
                            precio: importe,
                            iva: 10,
                            regimen: group["R√©gimen"] || 'AD'
                        }];
                    }
                }
            } catch (e) {
                console.error("‚ùå Error en loadSelectedGroup:", e);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(window.firebaseConfig);
            }
            if (typeof firebase !== 'undefined') window.db = firebase.firestore();
            await refreshConfigFromCloud();
            loadSelectedGroup();
            renderItems();
        });

        function copyAIContent() {
            navigator.clipboard.writeText(document.getElementById('ai-content').innerText);
            const btn = document.getElementById('btn-copy');
            if (btn) {
                btn.innerText = "¬°Copiado!";
                setTimeout(() => btn.innerText = "Copiar texto", 2000);
            }
        }

        function switchTemplate(tpl) {
            currentTemplate = tpl;
            document.getElementById('tpl-confirmacion').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('tpl-proforma').classList.toggle('hidden', tpl !== 'proforma');
            document.getElementById('tpl-policies').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('btn-confirmacion').className = tpl === 'confirmacion' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            document.getElementById('btn-proforma').className = tpl === 'proforma' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';

            const docTitle = document.getElementById('doc-type-title');
            const docLabel = document.getElementById('doc-type-label');
            if (docTitle) docTitle.innerText = tpl === 'confirmacion' ? 'Confirmaci√≥n' : 'Proforma';
            if (docLabel) docLabel.innerText = tpl === 'confirmacion' ? 'Reserva:' : 'N¬∫ Factura:';

            const titleContainer = document.querySelector('.header-title-container');
            const infoContainer = document.querySelector('.header-info-container');
            if (tpl === 'proforma') {
                if (titleContainer) titleContainer.style.display = 'none';
                if (infoContainer) {
                    infoContainer.style.textAlign = 'left';
                    infoContainer.style.flex = 'none';
                    infoContainer.style.paddingLeft = '40px';
                    infoContainer.style.marginTop = '10px';
                }
            } else {
                if (titleContainer) titleContainer.style.display = 'block';
                if (infoContainer) {
                    infoContainer.style.textAlign = 'center';
                    infoContainer.style.flex = '1';
                    infoContainer.style.paddingLeft = '0';
                }
            }
            renderItems();
        }

        function formatNum(num) {
            let n = parseFloat(num);
            if (isNaN(n)) return "0,00";
            // Usa toLocaleString para forzar formato espa√±ol: 1.234,56
            return n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateHotel(hotelKey) {
            currentHotel = hotelKey;
            const h = HOTELS[hotelKey];
            if (!h) return;
            const imgUniversal = document.getElementById('logo-img-universal');
            if (imgUniversal) imgUniversal.src = h.logo;
            const hAddr = document.getElementById('header-address-line');
            const hCity = document.getElementById('header-city-line');
            const hTel = document.getElementById('header-tel-val');
            if (hAddr) hAddr.innerText = h.address;
            if (hCity) hCity.innerText = `${h.cp} - ${h.city} (Espa√±a)`;
            if (hTel) hTel.innerText = h.tel;
            const legalVertical = document.getElementById('global-vertical-legal');
            if (legalVertical) {
                legalVertical.innerHTML = `<span class="italic">${h.company} &nbsp;&nbsp;&nbsp; ${h.address} &middot; ${h.cp} ${h.city} &nbsp;&nbsp;&nbsp; ${h.legal} ${h.irus ? `&nbsp;&nbsp;&nbsp; IRUS: ${h.irus}` : ''} &nbsp;&nbsp;&nbsp; N.I.F. ${h.nif}</span>`;
            }

            // DYNAMIC THEME OVERRIDE
            const primaryColor = hotelKey === 'cumbria' ? '#0f172a' : '#2d5a43';
            const secondaryColor = hotelKey === 'cumbria' ? '#334155' : '#1e3a2c';
            let styleTheme = document.getElementById('dynamic-theme-override');
            if (!styleTheme) {
                styleTheme = document.createElement('style');
                styleTheme.id = 'dynamic-theme-override';
                document.head.appendChild(styleTheme);
            }
            styleTheme.innerHTML = `
                .text-\\[\\#2d5a43\\] { color: ${primaryColor} !important; }
                .bg-\\[\\#2d5a43\\] { background-color: ${primaryColor} !important; }
                .border-\\[\\#2d5a43\\] { border-color: ${primaryColor} !important; }
                .focus\\:ring-\\[\\#2d5a43\\]:focus { --tw-ring-color: ${primaryColor} !important; }
                .hover\\:bg-\\[\\#1e3a2c\\]:hover { background-color: ${secondaryColor} !important; }
                .tab-active { border-bottom-color: ${primaryColor} !important; color: ${primaryColor} !important; }
                .editable:focus { outline-color: ${primaryColor} !important; }
            `;
            const updateField = (selector, val) => {
                const el = document.querySelector(selector);
                if (el) el.innerText = val;
            };
            updateField('.hotel-address-footer', (h.address || '').toUpperCase());
            updateField('.hotel-cp-footer', h.cp || '');
            updateField('.hotel-city-footer', h.city || '');
            updateField('.hotel-email-footer', h.email || '');
            updateField('.hotel-web-footer', h.web || '');
            updateField('.hotel-tel-footer', h.tel || '');
            updateField('.hotel-fax-footer', h.fax || '');
            updateField('.hotel-legal-footer', h.legal || '');
            updateField('.hotel-bank-footer', h.bank || '');
            updateField('.hotel-iban-footer', h.iban || '');
            renderItems();
        }

        const formatDateSafe = (val) => {
            if (!val || val === "---") return "-";
            return formatDate(val);
        };

        function renderItems() {
            const h = HOTELS[currentHotel];
            const now = new Date();
            const tsDate = document.getElementById('timestamp-date');
            const tsTime = document.getElementById('timestamp-time');
            if (tsDate) tsDate.innerText = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
            if (tsTime) tsTime.innerText = now.getHours() + "." + String(now.getMinutes()).padStart(2, '0');

            const containers = document.querySelectorAll('.invoice-items');
            const footer = document.getElementById('footer-totals');
            let total = 0;
            let runningTotal = 0;
            let totalComision = 0;
            let base10 = 0, iva10 = 0, base21 = 0, iva21 = 0;

            containers.forEach(c => c.innerHTML = '');

            items.forEach((item, index) => {
                const precioUnitario = parseFloat(item.precio) || 0;
                const habs = parseFloat(item.hab) || 1;
                const cantidad = parseFloat(item.cant) || 1;
                const dias = parseFloat(item.dias) || 1;
                const subtotal = precioUnitario * habs * cantidad * dias;
                let itemComision = (parseFloat(item.comision?.comision_unitaria) || 0) * habs * cantidad * dias;
                if (itemComision <= 0 && item.comision?.porcentaje) {
                    itemComision = subtotal * (parseFloat(item.comision.porcentaje) / 100);
                }

                totalComision += itemComision;
                const netSubtotal = subtotal - itemComision;

                total += subtotal; // Gross total (sumado al final de la tabla)
                runningTotal += subtotal;

                const ivaVal = parseFloat(item.iva) || 10;
                if (ivaVal === 10) {
                    const base = netSubtotal / 1.1;
                    base10 += base;
                    iva10 += (netSubtotal - base);
                } else {
                    const base = netSubtotal / 1.21;
                    base21 += base;
                    iva21 += (netSubtotal - base);
                }

                // Date handling
                const dateVal = toInputDate(item.fecha);

                const draggables = `draggable="true" ondragstart="dragStart(event, ${index})" ondragover="allowDrop(event)" ondrop="drop(event, ${index})" style="cursor: grab;"`;

                if (currentTemplate === 'confirmacion') {
                    // Modelo 1: Reserva
                    const row = `
                        <tr class="border-b group" ${draggables}>
                            <td class="p-1 flex items-center gap-1">
                                <span class="no-print opacity-0 group-hover:opacity-40 cursor-grab">‚ãÆ‚ãÆ</span>
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit text-gray-500 w-22 outline-none text-[9px]">
                            </td>
                            <td class="p-1 text-center font-bold text-gray-400 text-[10px]">${item.cant || '1'}</td>
                            <td class="p-1 text-[11px] font-black text-gray-800">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                            </td>
                            <td class="p-1 text-center text-gray-400">
                                <span class="editable text-[9px]" contenteditable="true" onblur="updateItem(${index}, 'regimen', this.innerText)" placeholder="-">${item.regimen || '-'}</span>
                            </td>
                            <td class="p-1 text-center text-[9px] text-gray-500">${item.dias || 1}</td>
                            <td class="p-1 text-right text-[10px]"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(precioUnitario)}</span></td>
                            <td class="p-1 text-right font-black text-gray-900 text-[11px]">${formatNum(subtotal)}</td>
                            <td class="p-1 text-right text-gray-300 font-medium text-[10px]">${formatNum(runningTotal)}</td>
                            <td class="p-1 no-print text-center">
                                <button onclick="removeItem(${index})" class="text-gray-300 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </td>
                        </tr>`;
                    document.querySelector('#tpl-confirmacion .invoice-items').insertAdjacentHTML('beforeend', row);
                } else {
                    // Modelo 2: Proforma / Factura (Sincronizado con el modelo visual solicitado)
                    const row = `
                        <tr class="h-7 group border-b border-gray-100" ${draggables}>
                            <td class="align-middle flex items-center gap-1 py-1">
                                <span class="no-print opacity-0 group-hover:opacity-40 cursor-grab">‚ãÆ‚ãÆ</span>
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit w-20 outline-none text-[9px] text-gray-500">
                            </td>
                            <td class="align-middle text-center font-bold text-gray-400 text-[10px]">${item.cant || '1'}</td>
                            <td class="align-middle font-black text-gray-800 text-[11px] uppercase py-1">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                            </td>
                            <td class="align-middle text-center text-gray-400">
                                <span class="editable text-[9px]" contenteditable="true" onblur="updateItem(${index}, 'regimen', this.innerText)" placeholder="-">${item.regimen || '-'}</span>
                            </td>
                            <td class="align-middle text-center text-[9px] text-gray-500">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'dias', this.innerText)">${item.dias || 1}</span>
                            </td>
                            <td class="align-middle text-right text-gray-600 text-[10px]">${formatNum(precioUnitario)}</td>
                            <td class="align-middle text-right font-black text-gray-900 text-[11px]">${formatNum(subtotal)}</td>
                            <td class="align-middle text-right text-gray-300 font-medium text-[10px]">${formatNum(runningTotal)}</td>
                            <td class="no-print align-middle text-center py-1">
                                <button onclick="removeItem(${index})" class="text-gray-300 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </td>
                        </tr>`;
                    document.querySelector('#tpl-proforma .invoice-items').insertAdjacentHTML('beforeend', row);
                }
            });

            if (totalComision > 0) {
                const uniquePercs = new Set();
                items.forEach(item => {
                    if (item.comision?.porcentaje) uniquePercs.add(item.comision.porcentaje);
                });
                const percLabel = uniquePercs.size === 1 ? ` (${Array.from(uniquePercs)[0]}%)` : "";

                containers.forEach(c => {
                    const row = currentTemplate === 'confirmacion'
                        ? `<tr class="border-b bg-gray-50/50 italic text-gray-400">
                            <td class="p-1"></td>
                            <td class="p-1 text-center font-bold">1</td>
                            <td class="p-1 text-[10px] uppercase font-bold">(-) COM/DTO${percLabel} SOBRE ${formatNum(total)}</td>
                            <td class="p-1"></td>
                            <td class="p-1"></td>
                            <td class="p-1 text-right text-[10px]">${formatNum(totalComision)}</td>
                            <td class="p-1 text-right font-bold text-red-500">-${formatNum(totalComision)}</td>
                            <td class="p-1 text-right text-gray-300 font-medium text-[10px]"></td>
                            <td class="p-1 no-print"></td>
                           </tr>`
                        : `<tr class="h-7 border-b border-gray-100 italic text-gray-400 bg-gray-50/30">
                            <td class="py-1"></td>
                            <td class="text-center font-bold">1</td>
                            <td class="font-bold py-1 text-[9px] uppercase">(-) COM/DTO${percLabel} SOBRE ${formatNum(total)}</td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-right text-[10px]">${formatNum(totalComision)}</td>
                            <td class="text-right font-bold text-red-500">-${formatNum(totalComision)}</td>
                            <td class="text-right text-gray-300 font-medium text-[10px]"></td>
                            <td class="no-print"></td>
                           </tr>`;
                    c.insertAdjacentHTML('beforeend', row);
                });
            }

            // Footer Logic (Confirmacion) - Full payment details
            if (currentTemplate === 'confirmacion') {
                const h = HOTELS[currentHotel];
                const groupData = JSON.parse(localStorage.getItem('selectedGroup') || '{}');

                // --- PAGO PLAN LOGIC ---
                let groupPlan = [];
                try {
                    groupPlan = JSON.parse(groupData.PaymentPlan_JSON || "[]");
                } catch (e) { groupPlan = []; }

                const entradaStr = document.getElementById('reserva-entrada-1')?.innerText || groupData["Entrada"] || '21-04-2026';
                const [dId, mId, yId] = entradaStr.split(/[-\/]/).map(Number);
                const fechaEntrada = (dId && mId && yId) ? new Date(yId < 100 ? 2000 + yId : yId, mId - 1, dId) : new Date();

                const formatDateSafe = (date) => {
                    if (!(date instanceof Date) || isNaN(date.getTime())) return "-";
                    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                };

                const fRelease = new Date(fechaEntrada);
                fRelease.setDate(fRelease.getDate() - (parseInt(groupData["Com_Relix"]) || 22));

                const totalNetoPagar = total - totalComision;

                // Si hay plan, recalcular importes basados en el neto si tienen porcentaje
                if (groupPlan.length > 0 && totalComision > 0) {
                    groupPlan = groupPlan.map(p => {
                        if (p.percent && p.status !== "Cobrado") { // No recalcular si ya est√° cobrado
                            return { ...p, amount: (totalNetoPagar * (parseFloat(p.percent) / 100)).toFixed(2) };
                        }
                        return p;
                    });
                }

                // If no plan, create a default 30/70 for display based on totalNetoPagar
                if (groupPlan.length === 0) {
                    const d1 = new Date(fechaEntrada); d1.setDate(d1.getDate() - 60);
                    const d2 = new Date(fechaEntrada); d2.setDate(d2.getDate() - 30);
                    groupPlan = [
                        { label: "1er Pago Garant√≠a", percent: 30, amount: (totalNetoPagar * 0.3).toFixed(2), date: d1.toISOString().split('T')[0], status: "Pendiente" },
                        { label: "Liquidaci√≥n Final", percent: 70, amount: (totalNetoPagar * 0.7).toFixed(2), date: d2.toISOString().split('T')[0], status: "Pendiente" }
                    ];
                }

                // Calculate paid/pending balance
                const totalPaid = groupPlan.filter(p => p.status === "Cobrado").reduce((acc, p) => acc + (parseFloat(p.amount) || 0), 0);
                const totalPending = totalNetoPagar - totalPaid;

                footer.innerHTML = `
                    <div class="mt-10 font-pro" style="page-break-inside: avoid;">
                        <!-- Divider decorativo -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="flex-1 h-px" style="background: linear-gradient(to right, transparent, #cbd5e1 40%, #cbd5e1 60%, transparent); -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" class="text-slate-300" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-[0.25em]">Condiciones de Pago</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" class="text-slate-300" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                            </div>
                            <div class="flex-1 h-px" style="background: linear-gradient(to left, transparent, #cbd5e1 40%, #cbd5e1 60%, transparent); -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                        </div>

                        <!-- TOTALES - Bloque principal arriba -->
                        <div class="mb-6 rounded-2xl overflow-hidden shadow-md border border-slate-200" style="-webkit-print-color-adjust: exact; print-color-adjust: exact;">
                            <div class="relative" style="background: linear-gradient(135deg, ${currentHotel === 'cumbria' ? '#0f172a' : '#1a3a28'} 0%, ${currentHotel === 'cumbria' ? '#1e293b' : '#214732'} 50%, ${currentHotel === 'cumbria' ? '#334155' : '#2d5a43'} 100%); -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                <!-- Decorative elements -->
                                <div class="absolute top-0 right-0 w-40 h-40 rounded-full pointer-events-none" style="background: radial-gradient(circle, rgba(255,255,255,0.04) 0%, transparent 70%); -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                                <div class="absolute bottom-0 left-0 w-24 h-24 rounded-full pointer-events-none" style="background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%); -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                                
                                <div class="relative z-10 px-7 py-5 flex justify-between items-center">
                                    <div>
                                        <span class="text-[9px] font-bold uppercase tracking-[0.3em] block mb-2" style="color: rgba(255,255,255,0.45); -webkit-print-color-adjust: exact; print-color-adjust: exact;">Total Presupuestado</span>
                                        <div class="flex items-baseline gap-1.5">
                                            <span class="tabular-nums tracking-tight leading-none" style="font-size: 30px; font-weight: 900; color: #ffffff; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${formatNum(totalNetoPagar)}</span>
                                            <span class="font-bold" style="font-size: 14px; color: rgba(255,255,255,0.5); -webkit-print-color-adjust: exact; print-color-adjust: exact;">‚Ç¨</span>
                                        </div>
                                    </div>
                                    ${totalPaid >= Math.abs(totalNetoPagar) ? `
                                    <div class="text-right flex flex-col items-end gap-2">
                                        <span class="px-3 py-1.5 rounded-lg text-[8px] font-black uppercase tracking-[0.15em] flex items-center gap-1.5 shadow-lg" style="background-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                            Pagado Total
                                        </span>
                                        <span class="text-[9px] font-black tabular-nums" style="color: rgba(255,255,255,0.35); -webkit-print-color-adjust: exact; print-color-adjust: exact;">0,00 ‚Ç¨ pendiente</span>
                                    </div>
                                    ` : `
                                    <div class="text-right" style="border-left: 1px solid rgba(255,255,255,0.1); padding-left: 24px; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                        <span class="text-[9px] font-bold uppercase tracking-[0.3em] block mb-2" style="color: rgba(255,255,255,0.45); -webkit-print-color-adjust: exact; print-color-adjust: exact;">Pendiente / Pagar</span>
                                        <div class="flex items-baseline justify-end gap-1">
                                            <span class="tabular-nums leading-none" style="font-size: 22px; font-weight: 900; color: #fbbf24; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${formatNum(totalPending)}</span>
                                            <span class="font-bold" style="font-size: 11px; color: rgba(251, 191, 36, 0.6); -webkit-print-color-adjust: exact; print-color-adjust: exact;">‚Ç¨</span>
                                        </div>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- BLOQUE BANCO / TITULAR -->
                            <div class="bg-gradient-to-br from-slate-50 to-white pt-2 pb-4 px-5 rounded-2xl border border-slate-200/80 shadow-sm relative overflow-hidden" style="-webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                 <!-- Decorative corner -->
                                 <div class="absolute -top-6 -right-6 w-28 h-28 rounded-full pointer-events-none" style="background: radial-gradient(circle, rgba(100,116,139,0.06) 0%, transparent 70%); -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                                 
                                 <!-- Header -->
                                 <div class="flex items-center gap-2 mb-3 relative z-10">
                                     <div class="w-5 h-5 rounded-full flex items-center justify-center shadow-sm" style="background: linear-gradient(135deg, ${currentHotel === 'cumbria' ? '#0f172a' : '#214732'}, ${currentHotel === 'cumbria' ? '#334155' : '#2d5a43'}); -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24" fill="none" style="color: rgba(255,255,255,0.85); -webkit-print-color-adjust: exact; print-color-adjust: exact;" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M3 10h18"/><path d="M5 6l7-3 7 3"/><path d="M4 10v11"/><path d="M20 10v11"/><path d="M8 14v4"/><path d="M12 14v4"/><path d="M16 14v4"/></svg>
                                     </div>
                                     <h5 class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em] pt-0.5">Transferencia Bancaria</h5>
                                 </div>
                                 
                                 <!-- Content: Side by Side -->
                                 <div class="relative z-10 flex border-t border-slate-100 pt-3">
                                     <!-- Beneficiario -->
                                     <div class="flex-1">
                                         <p class="text-[6.5px] font-bold text-slate-400 uppercase tracking-[0.15em] mb-1">Beneficiario</p>
                                         <p class="font-black text-slate-800 uppercase" style="font-size: 9.5px; letter-spacing: -0.01em;">${h.company}</p>
                                         <p class="font-bold text-slate-400 mt-0.5" style="font-size: 7.5px;">NIF: <span class="font-black text-slate-600">${h.nif}</span></p>
                                     </div>
                                     
                                     <!-- Cuenta IBAN -->
                                     <div class="flex-1 flex justify-end">
                                         <div class="bg-white p-2.5 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-center min-w-[280px]" style="-webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                            <div class="flex items-center justify-between mb-1.5">
                                                <p class="text-[7.5px] font-black text-slate-400 tracking-wider leading-none uppercase">${h.bank}</p>
                                                <span class="text-[6.5px] font-black px-1.5 py-0.5 rounded-sm uppercase tracking-[0.15em] leading-none" style="background: linear-gradient(135deg, ${currentHotel === 'cumbria' ? '#0f172a' : '#214732'}, ${currentHotel === 'cumbria' ? '#334155' : '#2d5a43'}); color: rgba(255,255,255,0.9); -webkit-print-color-adjust: exact; print-color-adjust: exact;">IBAN</span>
                                            </div>
                                            <p class="font-black text-slate-700 tabular-nums" style="font-size: 11px; letter-spacing: 0.1em; line-height: 1;">${h.iban}</p>
                                         </div>
                                     </div>
                                 </div>
                            </div>

                            <!-- PLAN DE PAGOS -->
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <h5 class="text-[7.5px] font-black text-slate-400 uppercase tracking-[0.2em]">Plan de Garant√≠a y Pagos</h5>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    ${groupPlan.map((dep, idx) => {
                    const isPaid = dep.status === "Cobrado";
                    const depDate = dep.date ? new Date(dep.date) : null;
                    return `
                                            <div class="rounded-xl relative overflow-hidden" style="border: 1.5px solid ${isPaid ? '#a7f3d0' : '#e2e8f0'}; ${isPaid ? 'background-color: #ecfdf5;' : 'background-color: #ffffff;'} -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                                <div class="w-full" style="height: 3px; background: ${isPaid ? 'linear-gradient(to right, #059669, #34d399)' : `linear-gradient(to right, ${currentHotel === 'cumbria' ? '#0f172a' : '#214732'}, ${currentHotel === 'cumbria' ? '#475569' : '#2d5a43'})`}; opacity: ${isPaid ? '1' : '0.4'}; -webkit-print-color-adjust: exact; print-color-adjust: exact;"></div>
                                                
                                                ${isPaid ? `
                                                <div class="absolute inset-0 flex items-center justify-center opacity-[0.05] pointer-events-none" style="color: #059669; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                                    <span class="text-3xl font-black -rotate-12 uppercase tracking-widest border-4 border-current px-2 py-0.5 rounded-lg">Pagado</span>
                                                </div>
                                                ` : ''}
                                                
                                                <div class="p-2 relative z-10 flex flex-col h-full justify-between">
                                                    <div class="flex justify-between items-start mb-2 border-b border-slate-100 pb-1">
                                                        <span class="text-[7.5px] font-bold ${isPaid ? 'text-emerald-700' : 'text-slate-500'} uppercase leading-none">
                                                            ${isPaid ? 'Pagado' : dep.label}
                                                        </span>
                                                        <span class="text-[7px] font-black tabular-nums" style="color: ${isPaid ? '#059669' : '#94a3b8'}; -webkit-print-color-adjust: exact; print-color-adjust: exact;">${dep.percent}%</span>
                                                    </div>
                                                    <div class="flex justify-between items-end mt-1">
                                                        <div>
                                                            <p class="text-[8.5px] ${isPaid ? 'text-emerald-500' : 'text-slate-500'} font-black uppercase tracking-wider mb-1">${isPaid ? 'Cobrado' : 'Vence'}</p>
                                                            <p class="text-[10px] text-slate-600">${formatDateSafe(depDate)}</p>
                                                        </div>
                                                        <div class="text-right">
                                                            <p class="tabular-nums leading-none flex items-baseline gap-0.5" style="font-size: 11px; font-weight: 900; ${isPaid ? 'color: #047857;' : 'color: #1e293b;'} -webkit-print-color-adjust: exact; print-color-adjust: exact;">${formatNum(dep.amount)}<span style="font-size: 7.5px; opacity: 0.6;">‚Ç¨</span></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                         `;
                }).join('')}
                                </div>

                                <!-- RELEASE DEADLINE TAG -->
                                <div class="flex justify-center pt-2 pb-4">
                                    <div class="px-5 py-2.5 rounded-2xl flex items-center gap-3 shadow-sm border border-slate-200" style="background-color: #f8fafc; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" style="color: #0f172a; -webkit-print-color-adjust: exact; print-color-adjust: exact;" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        <div class="flex flex-col">
                                            <span class="text-[7.5px] font-bold text-slate-400 uppercase tracking-widest leading-none mb-0.5">Release Final</span>
                                            <span class="text-[9px] font-black text-slate-800 tabular-nums leading-none tracking-wide">${formatDateSafe(fRelease)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else {
                const breakdownHtml = `
                    <div style="background-color: ${currentHotel === 'cumbria' ? '#0f172a' : '#2d5a43'}; color: white; padding: 10px; border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); -webkit-print-color-adjust: exact;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 8px; text-transform: uppercase;">
                            <thead style="opacity: 0.7; border-bottom: 0.5px solid rgba(255,255,255,0.2);">
                                <tr>
                                    <th style="text-align: left; padding-bottom: 4px;">Tipo IVA</th>
                                    <th style="text-align: right; padding-bottom: 4px;">Base</th>
                                    <th style="text-align: right; padding-bottom: 4px;">Cuota</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${base10 > 0 ? `
                                <tr>
                                    <td style="padding-top: 4px;">REDUC. (10%)</td>
                                    <td style="text-align: right; padding-top: 4px;">${formatNum(base10)} ‚Ç¨</td>
                                    <td style="text-align: right; padding-top: 4px;">${formatNum(iva10)} ‚Ç¨</td>
                                </tr>` : ''}
                                ${base21 > 0 ? `
                                <tr>
                                    <td style="padding-top: 2px;">GRAL. (21%)</td>
                                    <td style="text-align: right; padding-top: 2px;">${formatNum(base21)} ‚Ç¨</td>
                                    <td style="text-align: right; padding-top: 2px;">${formatNum(iva21)} ‚Ç¨</td>
                                </tr>` : ''}
                                <tr style="border-top: 1px solid rgba(255,255,255,0.3); font-weight: bold;">
                                    <td style="padding-top: 6px;">TOTAL NETO</td>
                                    <td colspan="2" style="text-align: right; padding-top: 6px; font-size: 10px;">${formatNum(base10 + base21)} ‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;

                // Inyectar en paneles de reserva
                const summaryConfirmacion = document.getElementById('iva-summary-confirmacion');
                const summaryProforma = document.getElementById('iva-summary-proforma');
                if (summaryConfirmacion) summaryConfirmacion.innerHTML = breakdownHtml;
                if (summaryProforma) summaryProforma.innerHTML = breakdownHtml;

                // Footer Logic (Proforma) - Only the black box and small text
                footer.innerHTML = `
                    <div style="margin-top: 20px; width: 100%; display: flex; justify-content: flex-end;">
                        <div style="width: 320px; font-family: 'Montserrat', sans-serif;">
                            <!-- Total Section -->
                            <div style="background-color: ${currentHotel === 'cumbria' ? '#0f172a' : '#2d5a43'}; color: #fff; padding: 12px 16px; width: 100%; display: flex; justify-content: space-between; align-items: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <span style="font-size: 10px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;">Total IVA Incluido</span>
                                <span style="font-size: 18px; font-weight: 900;">${formatNum(total - totalComision)} <span style="font-size: 12px; font-weight: 400; opacity: 0.8;">‚Ç¨</span></span>
                            </div>
                            
                            <!-- Discrete IVA Breakdown Section -->
                            <div style="margin-top: 10px; border-top: 1px solid #f3f4f6; padding: 6px 0;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 7px; color: #6b7280; text-transform: uppercase;">
                                    <tr>
                                        <th style="text-align: left; opacity: 0.6; font-weight: 700;">Base Imponible</th>
                                        <th style="text-align: center; opacity: 0.6; font-weight: 700;">IVA</th>
                                        <th style="text-align: right; opacity: 0.6; font-weight: 700;">Cuota</th>
                                    </tr>
                                    ${base10 > 0 ? `
                                    <tr>
                                        <td style="padding: 2px 0;">${formatNum(base10)} ‚Ç¨</td>
                                        <td style="text-align: center; padding: 2px 0;">10%</td>
                                        <td style="text-align: right; padding: 2px 0;">${formatNum(iva10)} ‚Ç¨</td>
                                    </tr>` : ''}
                                    ${base21 > 0 ? `
                                    <tr>
                                        <td style="padding: 2px 0;">${formatNum(base21)} ‚Ç¨</td>
                                        <td style="text-align: center; padding: 2px 0;">21%</td>
                                        <td style="text-align: right; padding: 2px 0;">${formatNum(iva21)} ‚Ç¨</td>
                                    </tr>` : ''}
                                </table>
                            </div>
                            
                            <div id="bank-details-wrapper" style="margin-top: 10px; text-align: right; border-top: 1px solid #eee; pt-4; position: relative;" class="group">
                                ${showBankDetails ? `
                                    <button class="no-print absolute top-0 -left-6 text-red-300 hover:text-red-500 text-xs" 
                                            onclick="showBankDetails=false;renderItems();;" title="Eliminar datos bancarios">‚úï</button>
                                    <p style="font-size: 9px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 3px; letter-spacing: 0.5px;">
                                        Cuenta de Abono Corriente
                                    </p>
                                     <p style="font-size: 9px; color: #111827; font-weight: 800; text-transform: uppercase; margin-bottom: 1px; font-family: 'Montserrat', sans-serif;">
                                         Titular: ${h.company}
                                     </p>
                                     <p style="font-size: 9px; color: #111827; font-weight: 800; text-transform: uppercase; margin-bottom: 6px; font-family: 'Montserrat', sans-serif;">
                                         ${h.bank} : <span style="letter-spacing: -0.2px;">${h.iban}</span>
                                     </p>
                                     ${(group["Enlace_TPV"] || h.paymentGateway) ? `
                                        <p style="font-size: 8px; color: #059669; font-weight: 800; text-transform: uppercase; margin-top: 4px; display: flex; align-items: center; justify-content: flex-end; gap: 4px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                                            <a href="${group["Enlace_TPV"] || h.paymentGateway}" target="_blank" style="color: #059669; text-decoration: none; border-bottom: 1px solid #d1fae5;">Pago Online con Tarjeta</a>
                                        </p>
                                     ` : ''}
                                ` : `
                                    <button class="no-print text-gray-200 hover:text-gray-400 font-medium uppercase tracking-tighter" 
                                            style="font-size: 5px; background: none; border: none; padding: 0; margin-bottom: 2px;"
                                            onclick="showBankDetails=true;renderItems();">+ restaurar datos bancarios</button>
                                `}
                                <div id="legal-notice-wrapper" style="position: relative; border-top: 0.5px solid #f3f4f6; pt-2">
                                    ${showLegalNotice ? `
                                        <button class="no-print absolute top-2 -left-6 text-red-100 hover:text-red-300 text-[10px]" 
                                                onclick="showLegalNotice=false;renderItems();" title="Eliminar aviso legal">‚úï</button>
                                        <p style="font-size: 7px; color: #9ca3af; font-style: italic; font-weight: 400; line-height: 1.3;">
                                            * Este documento es una liquidaci√≥n provisional (Factura Proforma).<br>
                                            No tiene validez como factura ordinaria hasta su emisi√≥n definitiva.
                                        </p>
                                    ` : `
                                        <button class="no-print text-gray-200 hover:text-gray-400 font-medium uppercase tracking-tighter" 
                                                style="font-size: 5px; background: none; border: none; padding: 0; margin-top: 1px;"
                                                onclick="showLegalNotice=true;renderItems();">+ restaurar aviso legal</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>`;
            }

            syncWithFicha();
        }

        // --- Drag and Drop Helpers ---
        function addOcupanteField() {
            const container = document.querySelector('#ocupante-box .flex-1');
            if (!container) return;

            const footer = [...container.children].find(child => child.classList.contains('border-t') && child.classList.contains('no-print'));

            const newRow = document.createElement('div');
            newRow.className = 'ocupante-row flex items-center gap-1 mt-1';
            newRow.innerHTML = `
                <span class="w-24"><strong><span class="editable" contenteditable="true">Campo</span> :</strong></span>
                <span class="editable flex-1" contenteditable="true" style="min-width: 100px;">Valor</span>
                <button class="no-print text-red-200 hover:text-red-500 text-[10px] ml-auto" 
                        onclick="this.parentElement.remove()" title="Eliminar">‚úï</button>
            `;

            if (footer) {
                container.insertBefore(newRow, footer);
            } else {
                container.appendChild(newRow);
            }
        }

        function dragStart(ev, index) {
            ev.dataTransfer.setData("text/plain", index);
            ev.dataTransfer.effectAllowed = "move";
        }
        function allowDrop(ev) {
            ev.preventDefault();
        }
        function drop(ev, targetIndex) {
            ev.preventDefault();
            const sourceIndex = parseInt(ev.dataTransfer.getData("text/plain"));
            if (sourceIndex === targetIndex) return;

            const movedItem = items[sourceIndex];
            items.splice(sourceIndex, 1);
            items.splice(targetIndex, 0, movedItem);
            renderItems();
        }

        // --- Update Item Logic ---
        function updateItem(index, key, val) {
            if (key === 'fecha') {
                // Input date returns YYYY-MM-DD
                // Store as is or format? Let's format to DD-MM-YYYY for consistency with legacy
                items[index][key] = formatDate(val).replace(/\//g, '-');
            } else if (['concepto', 'hab', 'cant', 'regimen', 'dias'].includes(key)) {
                items[index][key] = val;
            } else {
                items[index][key] = parseMoney(val);
            }
            renderItems();
        }

        function addRow() {
            items.push({
                fecha: formatDate(new Date().toISOString().split('T')[0]).replace(/\//g, '-'),
                hab: '',
                cant: '1',
                concepto: 'Nuevo Concepto',
                precio: 0,
                iva: 10,
                regimen: ''
            });
            renderItems();
        }
        function removeItem(index) { items.splice(index, 1); renderItems(); }

        async function syncWithFicha() {
            const saved = localStorage.getItem('selectedGroup');
            if (!saved) return;

            let group = JSON.parse(saved);

            // 1. Calcular Totales desde Items
            const totalRevenue = items.reduce((acc, curr) => {
                const p = parseFloat(curr.precio) || 0;
                const h = parseFloat(curr.hab) || 1;
                const c = parseFloat(curr.cant) || 1;
                const d = parseFloat(curr.dias) || 1;
                return acc + (p * h * c * d);
            }, 0);

            // 2. Fechas
            const entrada = document.getElementById('reserva-entrada-1')?.innerText || group["Entrada"];
            const salida = document.getElementById('reserva-salida-1')?.innerText || group["Salida"];

            // 3. Hotel
            const hotel = currentHotel === 'cumbria' ? 'Cumbria' : 'SERCOTEL GUADIANA';

            // 4. Actualizar Objeto Grupo
            const customFields = {};
            const editableIds = [
                'solicitante-org', 'solicitante-nombre', 'solicitante-tel', 'solicitante-email',
                'reserva-personas', 'reserva-entrada', 'reserva-salida', 'fecha-proforma',
                'client-address', 'client-city', 'client-nif',
                'f-pax-name', 'f-pax-count', 'f-date-in', 'f-date-out', 'f-room-summary'
            ];

            editableIds.forEach(id => {
                let el = document.getElementById(id + '-1') || document.getElementById(id);
                if (el) {
                    customFields[id] = el.tagName === 'INPUT' ? el.value : el.innerText;
                }
            });

            // Capture dynamic rows
            const dynamicRows = Array.from(document.querySelectorAll('.ocupante-row')).map(row => {
                const spans = row.querySelectorAll('.editable');
                if (spans.length >= 2) {
                    return { key: spans[0].innerText.trim(), value: spans[1].innerText.trim() };
                }
                return null;
            }).filter(Boolean);
            customFields['dynamicRows'] = dynamicRows;

            const updatedData = {
                "Importe(*)": totalRevenue,
                "Pax.": customFields['reserva-personas'] || group["Pax."],
                "Entrada": entrada,
                "Salida": salida,
                "Hotel_Asignado": hotel,
                "ProformaCustomFields": customFields,
                "updatedAt": firebase.firestore.FieldValue.serverTimestamp()
            };

            if (items.length > 0) {
                updatedData["ProformaItems"] = items;
                updatedData["Dep1_Importe"] = parseFloat((totalRevenue * 0.3).toFixed(2));
                updatedData["Dep2_Importe"] = parseFloat((totalRevenue * 0.7).toFixed(2));
            }

            // Sincronizar Release
            if (entrada) {
                const parts = entrada.includes('/') ? entrada.split('/') : entrada.split('-');
                if (parts.length === 3) {
                    let d, m, y;
                    if (parts[0].length === 4) { [y, m, d] = parts; } else { [d, m, y] = parts; }
                    const fechaEntrada = new Date(y, m - 1, d);
                    const fechaRelease = new Date(fechaEntrada);
                    const diasRelease = parseInt(group["Com_Relix"]) || 22;
                    fechaRelease.setDate(fechaRelease.getDate() - diasRelease);
                    updatedData["Com_Vencimiento_Rel"] = fechaRelease.toISOString().split('T')[0];
                }
            }

            // Actualizar LocalStorage
            const finalGroup = { ...group, ...updatedData };
            localStorage.setItem('selectedGroup', JSON.stringify(finalGroup));

            // PERSISTENCIA EN CLOUD (Firestore)
            if (finalGroup.Reserva && typeof db !== 'undefined') {
                try {
                    const finalGroupReservaId = String(finalGroup.Reserva || "").trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '').toUpperCase();
                    await db.collection("groups").doc(finalGroupReservaId).set(updatedData, { merge: true });
                    // log
                } catch (e) {
                    console.error("‚ùå Error persistiendo en Firestore:", e);
                }
            }
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.querySelectorAll('.logo-placeholder').forEach(img => { img.src = e.target.result; img.classList.remove('hidden'); });
                    document.querySelectorAll('.font-logo').forEach(t => t.classList.add('hidden'));
                    const logoContainer = document.getElementById('default-logo-2');
                    if (logoContainer) logoContainer.classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


        async function saveAndExit() {
            const targetFile = "Gesti√≥n de Grupos.html";
            const saved = localStorage.getItem('selectedGroup');
            let reservaId = "";
            if (saved) {
                try {
                    const group = JSON.parse(saved);
                    reservaId = group.Reserva || group["Reserva"] || "";
                } catch (e) { }
            }
            if (reservaId) {
                localStorage.setItem('nexus_return_reserva', reservaId);
            }

            const url = encodeURI(targetFile) + (reservaId ? '?reserva=' + encodeURIComponent(reservaId) : '');

            // Funci√≥n para redirigir
            const doRedirect = () => {
                // log
                window.location.href = url;
            };

            // Intentar sincronizar pero con un timeout de seguridad
            try {
                const syncPromise = syncWithFicha();
                const timeoutPromise = new Promise(resolve => setTimeout(resolve, 1500));
                await Promise.race([syncPromise, timeoutPromise]);
            } catch (e) {
                console.error("Error sincronizando antes de salir:", e);
            }
            doRedirect();
        }

    </script>
</body>

</html>