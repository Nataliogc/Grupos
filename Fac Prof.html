<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas - Hotel Guadiana</title>
    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Montserrat:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap');

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page-container {
                box-shadow: none;
                margin: 0;
                border: none;
                width: 100%;
                min-height: auto;
            }

            .editable:hover {
                background: transparent;
            }

            select {
                appearance: none;
                -webkit-appearance: none;
                border: none;
                background: transparent;
                padding: 0;
            }

            /* Forzar impresi√≥n de sombras y fondos */
            .shadow-lg,
            .shadow-md,
            .shadow-sm,
            [style*="box-shadow"] {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
        }

        .editable {
            min-height: 1.2em;
            min-width: 20px;
            display: inline-block;
            cursor: text;
        }

        .editable:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
        }

        .editable:focus {
            outline: 2px solid #2d5a43;
            background: white;
        }

        .font-pro {
            font-family: 'Courier Prime', monospace;
            letter-spacing: -0.5px;
        }

        .font-logo {
            font-family: 'Libre Baskerville', serif;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 10mm 15mm;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tab-active {
            border-bottom: 3px solid #2d5a43;
            color: #2d5a43;
            font-weight: 700;
        }

        select.no-print {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 4px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        select.no-print:hover {
            border-color: #2d5a43;
            color: #2d5a43;
            background-color: #fff;
        }

        .logo-placeholder {
            max-height: 80px;
            max-width: 250px;
            object-fit: contain;
        }

        .legal-footer {
            font-size: 8px;
            line-height: 1.3;
            color: #1f2937;
            text-align: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        #ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .iva-breakdown-small {
            font-size: 9px;
            color: #4b5563;
            line-height: 1.4;
        }

        /* Estilos espec√≠ficos Proforma PDF */
        .proforma-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .proforma-header-table td {
            vertical-align: top;
        }

        .proforma-box {
            border: 1px solid black;
            display: inline-block;
            width: 220px;
            font-size: 10px;
            font-family: 'Courier Prime', monospace;
        }

        .proforma-box-header {
            border-bottom: 1px solid black;
            display: flex;
            font-weight: bold;
            background: #f9fafb;
        }

        .proforma-box-header div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-header div:last-child {
            border-right: none;
        }

        .proforma-box-row {
            display: flex;
        }

        .proforma-box-row div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-row div:last-child {
            border-right: none;
        }

        .proforma-table th {
            border-bottom: 2px solid black;
            border-top: 1px solid black;
            padding: 5px 0;
            font-weight: bold;
            text-align: left;
            font-size: 10px;
        }

        .proforma-table td {
            padding: 4px 0;
            font-size: 10px;
            vertical-align: top;
        }

        .proforma-total-box {
            background-color: #2d5a43;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            width: 300px;
            float: right;
        }

        .clean-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 4px;
        }

        .clean-label {
            font-weight: bold;
            width: 100px;
        }
    </style>
</head>

<body class="bg-gray-200 p-0 md:p-8">

    <!-- Panel de Control Superior -->
    <div
        class="max-w-[210mm] mx-auto mb-6 no-print bg-white shadow-lg rounded-xl p-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex gap-6 items-center">
            <button onclick="saveAndExit()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-[#2d5a43]"
                title="Volver a la Ficha">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </button>
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entorno de
                    Trabajo</span>
                <div class="flex gap-4">
                    <button onclick="switchTemplate('confirmacion')" id="btn-confirmacion"
                        class="pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Confirmaci√≥n</button>
                    <button onclick="switchTemplate('proforma')" id="btn-proforma"
                        class="pb-2 px-2 text-gray-400 hover:text-gray-600 transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Factura Proforma</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Seleccionar Hotel</span>
            <select id="hotel-selector" onchange="updateHotel(this.value)"
                class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#2d5a43]">
                <option value="guadiana">Sercotel Guadiana</option>
                <option value="cumbria">Sercotel Cumbria</option>
            </select>
        </div>

        <div class="flex gap-2">
            <button onclick="saveAndExit()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-blue-500 transition-all flex items-center gap-1 shadow-md">
                üíæ Guardar y Salir
            </button>
            <button onclick="generateAIEmail()"
                class="bg-emerald-50 hover:bg-emerald-100 text-[#2d5a43] px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-emerald-200 transition-all flex items-center gap-1">
                ‚ú® Redactar Email
            </button>
            <button onclick="window.print()"
                class="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all uppercase text-[10px]">
                Imprimir / PDF
            </button>
        </div>
    </div>

    <!-- CONTENEDOR DE LA P√ÅGINA -->
    <div id="capture-area" class="page-container shadow-2xl border border-gray-300">

        <!-- MODELO 1: CONFIRMACI√ìN (Estilo Moderno) -->
        <div id="tpl-confirmacion" class="template-content font-sans">
            <div class="flex justify-between items-start mb-8">
                <div class="logo-box">
                    <img id="logo-img-1" src="Logos/Sercotel Guadiana.jpg" class="max-h-24 w-auto object-contain"
                        alt="Logo">
                </div>
                <div class="text-right">
                    <h3
                        class="text-lg font-bold text-gray-700 border-b-2 border-gray-700 inline-block mb-1 uppercase tracking-tighter">
                        Confirmaci√≥n de Reserva</h3>
                    <p class="text-sm font-bold">Reserva: <span class="editable" id="reserva-id-1"
                            contenteditable="true">206268</span></p>
                    <p class="text-[10px] text-gray-400 italic">Fecha: <span class="editable" id="fecha-proforma-1"
                            contenteditable="true">12/02/2026</span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="border-l-4 border-[#2d5a43] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Solicitante</h4>
                    <div class="text-xs space-y-1">
                        <p><strong>Organismo:</strong> <span class="editable" id="solicitante-org-1"
                                contenteditable="true">EAPN-ES</span></p>
                        <p><strong>Contacto:</strong> <span class="editable" id="solicitante-nombre-1"
                                contenteditable="true">MARCELLO RONCHI</span></p>
                        <p><strong>Email:</strong> <span class="editable" id="solicitante-email-1"
                                contenteditable="true">marcello.ronchi@eapn.es</span></p>
                        <p><strong>Tel√©fono:</strong> <span class="editable" id="solicitante-tel-1"
                                contenteditable="true">-</span></p>
                    </div>
                </div>
                <div class="border-l-4 border-[#eab308] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Reserva</h4>
                    <div class="text-xs grid grid-cols-2 gap-x-1">
                        <span class="text-gray-500">Personas:</span> <span class="editable font-bold"
                            id="reserva-personas-1" contenteditable="true">70</span>
                        <span class="text-gray-500">Entrada:</span> <span class="editable font-bold"
                            id="reserva-entrada-1" contenteditable="true">21-04-2026</span>
                        <span class="text-gray-500">Salida:</span> <span class="editable font-bold"
                            id="reserva-salida-1" contenteditable="true">24-04-2026</span>
                    </div>
                    <!-- Nuevo Contenedor IVA corporativo -->
                    <div id="iva-summary-confirmacion" class="mt-4"></div>
                </div>
            </div>

            <table class="w-full text-[10px] mb-6 border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-[#2d5a43] border-b-2 border-[#2d5a43] uppercase text-[8px] font-bold">
                        <th class="p-2 text-left w-20">Fecha</th>
                        <th class="p-2 text-center w-8">Cant.</th>
                        <th class="p-2 text-left">Concepto</th>
                        <th class="p-2 text-center w-8">Reg.</th>
                        <th class="p-2 text-center w-8">D√≠as</th>
                        <th class="p-2 text-right w-16">Precio/U</th>
                        <th class="p-2 text-right w-20">Total</th>
                        <th class="p-2 text-right w-20">Acumulado</th>
                        <th class="p-2 w-4 no-print"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <!-- MODELO 2: FACTURA PROFORMA (REDISE√ëADO PARA COINCIDIR CON IMAGEN) -->
        <div id="tpl-proforma" class="template-content hidden font-pro text-black">

            <!-- Texto Vertical Legal -->
            <div class="absolute left-[3mm] top-0 bottom-0 flex items-center justify-center text-[8px] text-black font-sans font-bold"
                style="writing-mode: vertical-rl; transform: rotate(180deg);">
                <span class="whitespace-nowrap italic">SWEETMOON DESARROLLOS S.L. &nbsp;&nbsp;&nbsp; Inscrito en la hoja
                    CR-00035559 del Registro Mercantil de Ciudad Real. Folio electr√≥nico. Inscripci√≥n/anotaci√≥n 4
                    &nbsp;&nbsp;&nbsp; N.I.F. B-87067302</span>
            </div>

            <table class="w-full mb-6">
                <tr>
                    <td width="55%" class="align-top">
                        <div class="flex items-center gap-4 mb-8">
                            <img id="logo-img-2" src="Logos/Sercotel Guadiana.jpg"
                                class="max-h-20 w-auto object-contain" alt="Logo">
                        </div>

                        <!-- Caja Datos Factura -->
                        <div class="proforma-box w-[250px] border-black">
                            <div class="proforma-box-header bg-gray-100 border-b border-black">
                                <div class="border-r border-black">Factura</div>
                                <div class="border-r border-black">Fecha</div>
                                <div>Pag.</div>
                            </div>
                            <div class="proforma-box-row">
                                <div class="border-r border-black font-bold text-[10px]" id="reserva-id-2">PROFORMA
                                </div>
                                <div class="border-r border-black text-xs"><span class="editable" id="fecha-proforma-2"
                                        contenteditable="true">12-02-2026</span></div>
                                <div class="text-xs">1</div>
                            </div>
                        </div>
                    </td>
                    <td width="45%" class="align-top pt-2">
                        <div class="bg-slate-50 p-4 rounded-lg shadow-sm text-xs font-mono text-gray-600">
                            <div class="font-bold text-black uppercase text-sm editable" id="solicitante-org-2"
                                contenteditable="true" style="display:block;">RAZ√ìN SOCIAL</div>
                            <div class="editable" id="client-address" contenteditable="true" style="display:block;">
                                Calle Direcci√≥n</div>
                            <div class="editable" id="client-city" contenteditable="true" style="display:block;">CP,
                                Ciudad</div>
                            <div class="mt-4 font-bold text-black">
                                N.I.F.: <span class="editable" id="client-nif" contenteditable="true">B00000000</span>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- Caja Datos Ocupante -->
            <div class="border border-black p-2 mb-6 text-[11px] leading-relaxed relative flex justify-between gap-4"
                id="ocupante-box">
                <button
                    class="no-print absolute -top-3 -right-3 bg-emerald-500 text-white rounded-full w-5 h-5 text-[9px] font-bold shadow hover:bg-emerald-600 transition hidden"
                    id="ocupante-restore"
                    onclick="document.querySelectorAll('.ocupante-row').forEach(r=>r.classList.remove('hidden'));this.classList.add('hidden');"
                    title="Restaurar campos ocultos">‚Ü∫</button>

                <div class="flex-1">
                    <div class="mb-1 ocupante-row flex items-center gap-1">
                        <span><strong>Ocupante :</strong> <span class="editable min-w-[200px]" contenteditable="true"
                                id="f-pax-name">---</span></span>
                        <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                            onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                            title="Ocultar">‚úï</button>
                    </div>
                    <div class="ocupante-row flex items-center gap-1">
                        <span class="w-24"><strong>Habitaci√≥n :</strong></span>
                        <span class="editable flex-1" contenteditable="true" id="f-room-summary">---</span>
                        <button class="no-print text-red-300 hover:text-red-600 text-[10px]"
                            onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                            title="Ocultar">‚úï</button>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4">
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Nro. Personas :</strong></span>
                            <span class="editable" contenteditable="true" id="f-pax-count">62</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>N¬∫ Bono :</strong></span>
                            <span class="editable" contenteditable="true" id="f-voucher">---</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Entrada :</strong></span>
                            <span class="editable" contenteditable="true" id="f-date-in">22-04-2026</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                        <div class="ocupante-row flex items-center gap-1">
                            <span class="w-24"><strong>Salida :</strong></span>
                            <span class="editable" contenteditable="true" id="f-date-out">24-04-2026</span>
                            <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto"
                                onclick="this.parentElement.classList.add('hidden');document.getElementById('ocupante-restore').classList.remove('hidden');"
                                title="Ocultar">‚úï</button>
                        </div>
                    </div>
                    <div
                        class="mt-1 border-t border-dotted border-gray-300 pt-1 text-[9px] text-gray-500 no-print flex gap-2">
                        <button onclick="addOcupanteField()" class="hover:text-black uppercase font-bold">+
                            Campo</button>
                    </div>
                </div>

                <!-- Espacio para Desglose (Eliminado de aqu√≠ para moverlo bajo el total) -->
                <div id="iva-summary-proforma" class="hidden"></div>
            </div>

            <!-- Tabla de Conceptos -->
            <table class="w-full text-[11px] proforma-table mb-2">
                <thead>
                    <tr class="border-y border-black font-black uppercase text-[9px]">
                        <th width="12%" class="text-left py-1.5">FECHA</th>
                        <th width="8%" class="text-center py-1.5">CANT.</th>
                        <th width="40%" class="text-left py-1.5">CONCEPTO</th>
                        <th width="10%" class="text-right py-1.5">PRECIO/U</th>
                        <th width="15%" class="text-right py-1.5">TOTAL</th>
                        <th width="15%" class="text-right py-1.5">ACUMULADO</th>
                        <th class="w-4 no-print border-none"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <div class="no-print flex justify-center mb-4 mt-2">
            <button onclick="addRow()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-[9px] uppercase font-bold tracking-widest transition border border-gray-300">
                + A√±adir Concepto
            </button>
        </div>

        <!-- TOTALES Y FOOTER -->
        <div class="mt-auto">
            <!-- Totales Din√°micos -->
            <div id="footer-totals" class="w-full"></div>

            <!-- Pol√≠ticas de Reserva (Solo en Confirmaci√≥n) -->
            <div id="tpl-policies" class="mt-12 text-[10px] leading-relaxed border-t border-slate-100 pt-6 hidden">
                <div class="grid grid-cols-2 gap-12 bg-slate-50/50 p-6 rounded-2xl border border-slate-100">
                    <div class="border-r border-slate-200 pr-6">
                        <h5
                            class="font-black text-[#2d5a43] uppercase mb-3 tracking-widest text-[9px] flex items-center gap-2">
                            <span class="w-2 h-2 bg-[#2d5a43] rounded-full"></span> Pol√≠ticas de Cancelaci√≥n
                        </h5>
                        <p class="editable text-slate-600 leading-relaxed italic" contenteditable="true">
                            Para garantizar la exclusividad de su estancia, la cancelaci√≥n gratuita se permite hasta 7
                            d√≠as antes de la llegada.
                            Entre 7 y 3 d√≠as, se aplicar√° el cargo de la primera noche. Para cancelaciones con menos de
                            72 horas o No-Show, se facturar√° el 100% de la estancia reservada.
                        </p>
                    </div>
                    <div>
                        <h5
                            class="font-black text-[#2d5a43] uppercase mb-3 tracking-widest text-[9px] flex items-center gap-2">
                            <span class="w-2 h-2 bg-[#10b981] rounded-full"></span> Garant√≠a y Pago
                        </h5>
                        <p class="editable text-slate-600 leading-relaxed" contenteditable="true">
                            La confirmaci√≥n definitiva queda supeditada al cumplimiento de los plazos de dep√≥sito
                            indicados en este documento.
                            El importe restante ser√° abonado durante el proceso de Check-in o mediante transferencia
                            bancaria previa seg√∫n acuerdo comercial establecido.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Footer Premium -->
            <div id="common-footer" class="mt-20 pt-6 border-t border-slate-200 text-[10px] font-pro">
                <div class="flex justify-between items-start">
                    <div class="flex gap-12">
                        <div class="space-y-1">
                            <p class="text-[#2d5a43] font-bold tracking-widest text-[8px] uppercase">Sede Social</p>
                            <p class="hotel-address-footer text-slate-700 font-medium">C/ Guadalupe, 6</p>
                            <p class="text-slate-500"><span
                                    class="hotel-cp-footer font-bold text-[#10b981]">13002</span> <span
                                    class="hotel-city-footer uppercase tracking-tighter">Ciudad Real</span></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[#2d5a43] font-bold tracking-widest text-[8px] uppercase">Contacto Digital
                            </p>
                            <p class="text-slate-700 italic flex items-center gap-1">‚úâÔ∏è <span
                                    class="hotel-email-footer">info@hotelguadiana.es</span></p>
                            <p class="text-slate-500 font-bold flex items-center gap-1">üåê <span
                                    class="hotel-web-footer">www.hotelguadiana.es</span></p>
                        </div>
                    </div>
                    <div class="text-right space-y-1">
                        <p class="text-[#2d5a43] font-bold tracking-widest text-[8px] uppercase">Atenci√≥n 24h</p>
                        <p class="text-slate-800 font-black text-xs flex items-center justify-end gap-1">üìû <span
                                class="hotel-tel-footer">926 22 33 13</span></p>
                        <p class="text-slate-400 text-[7px] italic mt-1">ID: <span
                                class="hotel-legal-footer opacity-60">CR-00035559</span></p>
                    </div>
                </div>
                <div
                    class="mt-10 flex justify-between items-center text-slate-300 text-[8px] border-t border-slate-50 pt-2">
                    <div class="flex gap-4">
                        <span id="timestamp-date">18-02-26</span>
                        <span id="timestamp-time">17:22</span>
                    </div>
                    <div class="tracking-widest opacity-50 uppercase">Original Document ‚Ä¢ Compiled with Nexus AI 2.5
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="no-print">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-[#2d5a43] flex items-center gap-2"></h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div id="ai-content" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto mb-6 pr-2">
                Generando respuesta...
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t">
                <button onclick="copyAIContent()" id="btn-copy"
                    class="text-xs font-bold uppercase tracking-widest text-emerald-700 bg-emerald-50 px-4 py-2 rounded-lg hover:bg-emerald-100 transition-all">
                    Copiar texto
                </button>
                <button onclick="closeAIModal()"
                    class="text-xs font-bold uppercase tracking-widest text-gray-500 bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Configuraci√≥n Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script>
        const HOTELS = {
            guadiana: {
                name: "Hotel",
                subname: "Guadiana",
                letter: "G",
                stars: "****",
                logo: "Logos/Sercotel Guadiana.jpg",
                brand: "by Sercotel",
                company: "SWEETMOON DESARROLLOS S.L.",
                nif: "B87067302",
                address: "C/ Guadalupe, 6",
                cp: "13003",
                city: "Ciudad Real",
                tel: "926 22 33 13",
                fax: "926 27 30 57",
                email: "info@hotelguadiana.es",
                web: "www.hotelguadiana.es",
                iban: "ES30 3190 3953 1851 8526 3521",
                legal: "Inscrito en la hoja CR-00035559 del Registro Mercantil de Ciudad Real. Folio electr√≥nico. Inscripci√≥n/anotaci√≥n 4"
            },
            cumbria: {
                name: "Hotel",
                subname: "Cumbria",
                letter: "C",
                stars: "***",
                logo: "Logos/Cumbria Spa&Hotel.jpg",
                brand: "Cumbria Spa",
                company: "MOON FREE PORT, S.L.",
                nif: "B87895058",
                address: "Ctra. Fuencaliente, s/n",
                cp: "13004",
                city: "Ciudad Real",
                tel: "926 25 10 25",
                fax: "926 25 10 26",
                email: "recepcion@hotelcumbria.es",
                web: "www.hotelcumbria.es",
                iban: "ES19 3081 0601 0850 0004 8966",
                legal: "Inscrito en el tomo 699 de libro 0 folio 2 hoja CR-32491 inscripci√≥n 2¬™"
            }
        };

        // --- CARGAR CONFIGURACI√ìN DESDE CLOUD ---
        async function refreshConfigFromCloud() {
            try {
                if (typeof db === 'undefined') return;
                const doc = await db.collection("settings").doc("main").get();
                if (doc.exists) {
                    const cloudData = doc.data();
                    if (cloudData.guadiana) Object.assign(HOTELS.guadiana, cloudData.guadiana);
                    if (cloudData.cumbria) Object.assign(HOTELS.cumbria, cloudData.cumbria);
                    console.log("‚úÖ Configuraci√≥n de hoteles sincronizada desde Cloud");
                    // Re-render si ya carg√≥
                    updateHotel(currentHotel);
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è Error cargando config cloud:", e);
            }
        }

        // Se carga desde js/firebase-config.js
        const apiKey = window.firebaseConfig ? window.firebaseConfig.apiKey : "";
        let currentTemplate = 'confirmacion';
        let currentHotel = 'guadiana';

        // Datos iniciales vac√≠os para permitir creaci√≥n manual
        let items = [];

        // Sincronizaci√≥n de datos comunes
        function syncFields() {
            // Sync all fields EXCEPT reserva-id (proforma uses fixed "PROFORMA" text)
            const fields = ['fecha-proforma', 'solicitante-org', 'solicitante-nombre', 'solicitante-email', 'reserva-personas', 'reserva-entrada', 'reserva-salida'];
            fields.forEach(f => {
                const el1 = document.getElementById(f + '-1');
                const el2 = document.getElementById(f + '-2');
                if (el1 && el2) {
                    if (document.activeElement !== el1) el1.innerText = el2.innerText;
                    if (document.activeElement !== el2) el2.innerText = el1.innerText;
                }
            });
            // Auto-guardado
            syncWithFicha();
        }
        setInterval(syncFields, 3000);

        function saveAndExit() {
            syncWithFicha();
            window.location.href = 'Gesti√≥n de Grupos.html';
        }

        async function callGemini(prompt) {
            let dynamicKey = window.firebaseConfig?.apiKey || "";
            let model = "gemini-1.5-flash";

            try {
                if (typeof db !== 'undefined') {
                    const settingsDoc = await db.collection("settings").doc("main").get();
                    if (settingsDoc.exists) {
                        const s = settingsDoc.data().system || {};
                        if (s.geminiApiKey) dynamicKey = s.geminiApiKey;
                        if (s.geminiModel) model = s.geminiModel;
                    }
                }
            } catch (e) {
                console.warn("Fallback to config key.");
            }

            if (!dynamicKey || dynamicKey === "TU_API_KEY_AQUI") {
                return "‚ö†Ô∏è ERROR: No se ha configurado la API Key en el panel de Configuraci√≥n.";
            }

            const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${dynamicKey}`;
            const fullPrompt = "Eres un asistente de recepci√≥n de un hotel de lujo (Hotel Guadiana). Tu tono es profesional, cort√©s y servicial. Siempre respondes en espa√±ol.\n\n" + prompt;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const msg = error.error?.message || "";
                    if (msg.includes("blocked") || msg.includes("PERMISSION_DENIED")) {
                        return "üö´ ACCESO DENEGADO: Tu API Key est√° bloqueada o no tiene los permisos necesarios (Generative Language API) en Google Cloud Console.";
                    }
                    throw new Error(msg || "Error en la llamada a la API");
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return `Error de conexi√≥n con la IA: ${e.message}`;
            }
        }

        async function generateAIEmail() {
            showAIModal("‚ú® Redactando Email Profesional");
            const total = items.reduce((acc, curr) => acc + (curr.precio || 0), 0);
            const cliente = document.getElementById('solicitante-org-1').innerText;
            const prompt = `Redacta un correo electr√≥nico profesional para enviar esta factura proforma. Cliente: ${cliente}, Total: ${formatNum(total)} ‚Ç¨. Tono amable y profesional.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        async function generateAIPlan() {
            showAIModal("‚ú® Sugerencia de Plan para el Grupo");
            const personas = document.getElementById('reserva-personas-1').innerText;
            const prompt = `Sugiere un plan de ocio en Ciudad Real para ${personas} personas.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        function showAIModal(title) {
            document.getElementById('ai-modal-title').innerText = title;
            document.getElementById('ai-content').innerText = "Generando...";
            document.getElementById('ai-modal').style.display = 'flex';
        }
        function closeAIModal() { document.getElementById('ai-modal').style.display = 'none'; }

        function loadSelectedGroup() {
            const saved = localStorage.getItem('selectedGroup');
            const today = new Date().toLocaleDateString('es-ES');

            console.log("üì¶ Cargando datos de Proforma desde LocalStorage...");

            if (!saved) {
                console.warn("‚ö†Ô∏è No se encontraron datos en 'selectedGroup'");
                // MODO MANUAL: Limpiar todos los campos del DOM y resetear items
                items = [];
                const idsToClear = [
                    'reserva-id', 'solicitante-org', 'solicitante-nombre', 'solicitante-tel', 'solicitante-email',
                    'reserva-personas', 'reserva-entrada', 'reserva-salida', 'client-address', 'client-city',
                    'client-nif', 'f-pax-name', 'f-pax-count', 'f-date-in', 'f-date-out', 'f-room-summary'
                ];
                idsToClear.forEach(id => {
                    const el1 = document.getElementById(id + '-1');
                    const el2 = document.getElementById(id + '-2');
                    const elExact = document.getElementById(id);
                    if (el1) el1.innerText = (id === 'reserva-id') ? 'MANUAL' : '';
                    if (el2) el2.innerText = (id === 'reserva-id') ? 'PROFORMA' : '';
                    if (elExact) elExact.innerText = '';
                });
                // Fechas hoy por defecto
                document.querySelectorAll('[id^="fecha-proforma-"]').forEach(el => el.innerText = today);
                return;
            }

            const formatDate = (val) => {
                if (!val) return "-";
                const str = val.toString().trim();
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                }
                // Si ya parece una fecha ISO o formato ES, devolverla tal cual
                return val;
            };

            const parseMoney = (val) => {
                if (val === undefined || val === null) return 0;
                if (typeof val === 'number') return val;
                const str = val.toString().trim();
                // Heur√≠stica: Si tiene coma Y punto, es formato ES (1.234,56). 
                // Si tiene punto al final (.XX) y no hay comas, es decimal standard (1234.56)
                if (str.includes(',') && str.includes('.')) {
                    return parseFloat(str.replace(/\./g, '').replace(',', '.'));
                } else if (str.includes(',')) {
                    return parseFloat(str.replace(',', '.'));
                }
                return parseFloat(str) || 0;
            };

            try {
                const group = JSON.parse(saved);
                console.log("‚úÖ Datos recuperados:", group);

                // 1. Vincular Hotel
                if ((group["Hotel_Asignado"] || "").toLowerCase().includes('cumb')) {
                    updateHotel('cumbria');
                } else {
                    updateHotel('guadiana');
                }

                // 2. Poblar campos de texto
                const mapping = {
                    'reserva-id': group["Reserva"] || '',
                    'solicitante-org': group["Fiscal_RazonSocial"] || group["Empresa/Agencia"] || group["Nombre del Grupo"] || '',
                    'solicitante-nombre': group["Com_Nombre_Contacto"] || group["Nombre del Grupo"] || '',
                    'solicitante-tel': group["Com_Telefono_Contacto"] || '',
                    'solicitante-email': group["Com_Email_Contacto"] || group["Email"] || group["Fiscal_Email"] || '',
                    'reserva-personas': group["Pax."] || '',
                    'reserva-entrada': formatDate(group["Entrada"]),
                    'reserva-salida': formatDate(group["Salida"]),
                    'fecha-proforma': new Date().toLocaleDateString('es-ES'),
                    // Fiscal Data
                    'client-address': group["Fiscal_Direccion"] || '',
                    'client-city': (group["Fiscal_CP"] ? group["Fiscal_CP"] + ' ' : '') + (group["Fiscal_Poblacion"] || ''),
                    'client-nif': group["Fiscal_CIF"] || '',
                    // New Proforma Box IDs
                    'f-pax-name': group["Nombre del Grupo"] || '',
                    'f-pax-count': group["Pax."] || '',
                    'f-date-in': formatDate(group["Entrada"]),
                    'f-date-out': formatDate(group["Salida"]),
                    'f-room-summary': group["RoomSummary"] || '---'
                };

                Object.keys(mapping).forEach(id => {
                    const el1 = document.getElementById(id + '-1');
                    const el2 = document.getElementById(id + '-2');
                    const elExact = document.getElementById(id);

                    if (el1) el1.innerText = mapping[id];
                    if (el2 && id !== 'reserva-id') el2.innerText = mapping[id];
                    if (elExact) elExact.innerText = mapping[id];
                });

                // 3. Cargar Items Guardados o Crear Inicial
                if (group.ProformaItems && Array.isArray(group.ProformaItems) && group.ProformaItems.length > 0) {
                    items = group.ProformaItems;
                } else {
                    const importe = parseMoney(group["Importe(*)"]);
                    if (importe > 0) {
                        items = [{
                            fecha: formatDate(group["Entrada"]),
                            hab: '',
                            cant: group["Pax."] || '1',
                            concepto: `ESTANCIA GRUPO: ${group["Nombre del Grupo"]}`,
                            precio: importe,
                            iva: 10,
                            regimen: 'AD'
                        }];
                    }
                }
            } catch (e) {
                console.error("‚ùå Error cargando grupo seleccionado:", e);
            }
        }

        function saveAndExit() {
            // 1. Gather current data from DOM to update the 'group' object
            const saved = localStorage.getItem('selectedGroup');
            if (saved) {
                let group = JSON.parse(saved);

                // Update Proforma Items
                group.ProformaItems = items;

                // Save back to selectedGroup (for persistence)
                localStorage.setItem('selectedGroup', JSON.stringify(group));

                // Update the main database (nexus_groups_data)
                const allGroupsStr = localStorage.getItem('nexus_groups_data');
                if (allGroupsStr) {
                    const allGroups = JSON.parse(allGroupsStr);
                    const idx = allGroups.findIndex(g => g["Reserva"] === group["Reserva"]);
                    if (idx !== -1) {
                        allGroups[idx] = { ...allGroups[idx], ...group };
                        localStorage.setItem('nexus_groups_data', JSON.stringify(allGroups));
                    }
                }

                // Set flag to re-open this ficha in Gestion de Grupos
                localStorage.setItem('openGroupFicha', group["Nombre del Grupo"]);
            }

            // Redirect
            window.location.href = 'Gesti√≥n de Grupos.html';
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Inicializar Firebase (si no lo est√°)
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(window.firebaseConfig);
            }
            if (typeof firebase !== 'undefined') window.db = firebase.firestore();

            await refreshConfigFromCloud();
            loadSelectedGroup();
            renderItems();
        });
        function copyAIContent() {
            navigator.clipboard.writeText(document.getElementById('ai-content').innerText);
            const btn = document.getElementById('btn-copy');
            if (btn) {
                btn.innerText = "¬°Copiado!";
                setTimeout(() => btn.innerText = "Copiar texto", 2000);
            }
        }

        function switchTemplate(tpl) {
            currentTemplate = tpl;
            document.getElementById('tpl-confirmacion').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('tpl-proforma').classList.toggle('hidden', tpl !== 'proforma');
            document.getElementById('tpl-policies').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('btn-confirmacion').className = tpl === 'confirmacion' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            document.getElementById('btn-proforma').className = tpl === 'proforma' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            renderItems();
        }

        function formatNum(num) {
            let n = parseFloat(num);
            if (isNaN(n)) return "0,00";
            return n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateHotel(hotelKey) {
            currentHotel = hotelKey;
            const h = HOTELS[hotelKey];
            if (!h) return;

            console.log(`üè® Cambiando hotel a: ${h.subname}`);

            // Actualizar Logos
            const img1 = document.getElementById('logo-img-1');
            const img2 = document.getElementById('logo-img-2');
            if (img1) img1.src = h.logo;
            if (img2) img2.src = h.logo;

            // Actualizar Headers Text (Por si acaso se usan)
            document.querySelectorAll('.hotel-name-display').forEach(el => {
                el.innerHTML = `${h.name} <span class="stars-display text-[#eab308]">${h.stars}</span>`;
            });
            document.querySelectorAll('.hotel-name-display-2').forEach(el => {
                el.innerHTML = `${h.name} <span class="stars-display-2 text-orange-400">${h.stars}</span>`;
            });

            document.querySelectorAll('.hotel-subname-display, .hotel-subname-display-2').forEach(el => el.innerText = h.subname);
            document.querySelectorAll('.hotel-brand-display, .hotel-brand-display-2').forEach(el => el.innerText = h.brand);
            document.querySelectorAll('.hotel-letter-display').forEach(el => el.innerText = h.letter);
            document.querySelectorAll('.hotel-city-display').forEach(el => el.innerText = h.city);

            // Actualizar Legal Text (Vertical)
            const legalSpan = document.querySelector('#tpl-proforma .absolute span');
            if (legalSpan) {
                legalSpan.innerHTML = `${h.company} &nbsp;&nbsp;&nbsp; ${h.legal} &nbsp;&nbsp;&nbsp; N.I.F. ${h.nif}`;
            }

            // Actualizar Footer (Robust search)
            const updateField = (selector, val) => {
                const el = document.querySelector(selector);
                if (el) el.innerText = val;
            };

            updateField('.hotel-address-footer', (h.address || '').toUpperCase());
            updateField('.hotel-cp-footer', h.cp || '');
            updateField('.hotel-city-footer', h.city || '');
            updateField('.hotel-email-footer', h.email || '');
            updateField('.hotel-web-footer', h.web || '');
            updateField('.hotel-tel-footer', h.tel || '');
            updateField('.hotel-fax-footer', h.fax || '');
            updateField('.hotel-legal-footer', h.legal || '');

            renderItems();
        }

        function renderItems() {
            const h = HOTELS[currentHotel];
            const now = new Date();
            const tsDate = document.getElementById('timestamp-date');
            const tsTime = document.getElementById('timestamp-time');
            if (tsDate) tsDate.innerText = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
            if (tsTime) tsTime.innerText = now.getHours() + "." + String(now.getMinutes()).padStart(2, '0');

            const containers = document.querySelectorAll('.invoice-items');
            const footer = document.getElementById('footer-totals');
            let total = 0;
            let runningTotal = 0;
            let base10 = 0, iva10 = 0, base21 = 0, iva21 = 0;

            containers.forEach(c => c.innerHTML = '');

            items.forEach((item, index) => {
                const precioUnitario = parseFloat(item.precio) || 0;
                const habs = parseFloat(item.hab) || 1;
                const cantidad = parseFloat(item.cant) || 1;
                const dias = parseFloat(item.dias) || 1;
                const subtotal = precioUnitario * habs * cantidad * dias;

                total += subtotal;
                runningTotal += subtotal;

                const ivaVal = parseFloat(item.iva) || 10;
                if (ivaVal === 10) {
                    const base = subtotal / 1.1;
                    base10 += base;
                    iva10 += (subtotal - base);
                } else {
                    const base = subtotal / 1.21;
                    base21 += base;
                    iva21 += (subtotal - base);
                }

                // Date handling
                const dateVal = toInputDate(item.fecha);

                const draggables = `draggable="true" ondragstart="dragStart(event, ${index})" ondragover="allowDrop(event)" ondrop="drop(event, ${index})" style="cursor: grab;"`;

                if (currentTemplate === 'confirmacion') {
                    // Modelo 1: Reserva
                    const row = `
                        <tr class="border-b group" ${draggables}>
                            <td class="p-1 flex items-center gap-1">
                                <span class="no-print opacity-0 group-hover:opacity-40 cursor-grab">‚ãÆ‚ãÆ</span>
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit text-gray-500 w-22 outline-none text-[9px]">
                            </td>
                            <td class="p-1 text-center font-bold text-gray-400 text-[10px]">${item.cant || '1'}</td>
                            <td class="p-1 text-[11px] font-black text-gray-800">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                            </td>
                            <td class="p-1 text-center text-gray-400">
                                <span class="editable text-[9px]" contenteditable="true" onblur="updateItem(${index}, 'regimen', this.innerText)" placeholder="-">${item.regimen || '-'}</span>
                            </td>
                            <td class="p-1 text-center text-[9px] text-gray-500">${item.dias || 1}</td>
                            <td class="p-1 text-right text-[10px]"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(precioUnitario)}</span></td>
                            <td class="p-1 text-right font-black text-gray-900 text-[11px]">${formatNum(subtotal)}</td>
                            <td class="p-1 text-right text-gray-300 font-medium text-[10px]">${formatNum(runningTotal)}</td>
                            <td class="p-1 no-print text-center">
                                <button onclick="removeItem(${index})" class="text-gray-300 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </td>
                        </tr>`;
                    document.querySelector('#tpl-confirmacion .invoice-items').insertAdjacentHTML('beforeend', row);
                } else {
                    // Modelo 2: Proforma / Factura (Sincronizado con el modelo visual solicitado)
                    const row = `
                        <tr class="h-7 group border-b border-gray-100" ${draggables}>
                            <td class="align-middle flex items-center gap-1 py-1">
                                <span class="no-print opacity-0 group-hover:opacity-40 cursor-grab">‚ãÆ‚ãÆ</span>
                                <input type="date" value="${dateVal}" onchange="updateItem(${index}, 'fecha', this.value)" class="bg-transparent font-inherit w-20 outline-none text-[9px] text-gray-500">
                            </td>
                            <td class="align-middle text-center font-bold text-gray-400 text-[10px]">${item.cant || '1'}</td>
                            <td class="align-middle font-black text-gray-800 text-[11px] uppercase py-1">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                            </td>
                            <td class="align-middle text-right text-gray-600 text-[10px]">${formatNum(precioUnitario)}</td>
                            <td class="align-middle text-right font-black text-gray-900 text-[11px]">${formatNum(subtotal)}</td>
                            <td class="align-middle text-right text-gray-300 font-medium text-[10px]">${formatNum(runningTotal)}</td>
                            <td class="no-print align-middle text-center py-1">
                                <button onclick="removeItem(${index})" class="text-gray-300 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </td>
                        </tr>`;
                    document.querySelector('#tpl-proforma .invoice-items').insertAdjacentHTML('beforeend', row);
                }
            });

            // Footer Logic (Confirmacion) - Full payment details
            if (currentTemplate === 'confirmacion') {
                const h = HOTELS[currentHotel];
                const entradaStr = document.getElementById('reserva-entrada-1')?.innerText || '21-04-2026';
                const [d, m, y] = entradaStr.split(/[-\/]/).map(Number);
                const fechaEntrada = (d && m && y) ? new Date(y < 100 ? 2000 + y : y, m - 1, d) : new Date();

                const fRelease = new Date(fechaEntrada);
                fRelease.setDate(fRelease.getDate() - (parseInt(JSON.parse(localStorage.getItem('selectedGroup') || '{}')["Com_Relix"]) || 22));

                const fDeposito1 = new Date(fechaEntrada);
                fDeposito1.setDate(fDeposito1.getDate() - 60);
                const fDeposito2 = new Date(fechaEntrada);
                fDeposito2.setDate(fDeposito2.getDate() - 30);

                const formatDate = (date) => date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

                footer.innerHTML = `
                    <div class="flex flex-col items-end mt-12 relative">
                        <!-- Sello de Autenticidad Luxury -->
                        <div class="absolute -left-6 top-0 opacity-[0.08] -rotate-12 pointer-events-none no-print">
                             <div class="border-[6px] border-[#2d5a43] p-3 rounded-full flex items-center justify-center w-32 h-32">
                                 <p class="text-[12px] font-black text-center leading-none text-[#2d5a43] uppercase tracking-tighter">Premium<br>Booking<br>Verified</p>
                             </div>
                        </div>

                        <div class="bg-gradient-to-br from-[#2d5a43] to-[#1a3326] text-white p-5 w-64 shadow-2xl mb-6 rounded-2xl border border-white/10 ring-4 ring-[#2d5a43]/5">
                            <p class="text-[7px] uppercase tracking-[0.3em] border-b border-white/10 pb-2 mb-3 text-left font-black opacity-60">Total Liquidaci√≥n de Reserva</p>
                            <div class="flex items-baseline justify-end gap-1">
                                <p class="text-3xl font-black tabular-nums tracking-tighter">${formatNum(total)}</p>
                                <span class="text-sm font-light opacity-50 uppercase">eur</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2 font-pro text-[10px]">
                        <!-- Barra de Pago Estilizada -->
                        <div class="flex w-full mb-8 px-5 bg-slate-100/80 backdrop-blur-sm border border-slate-200 py-3 rounded-2xl items-center justify-between">
                             <div class="flex items-center gap-4">
                                <button class="no-print bg-[#2d5a43] text-white px-4 py-1.5 rounded-full text-[9px] uppercase font-black hover:bg-[#1e3a2c] transition-all shadow-md flex items-center gap-2" onclick="alert('Iniciando pasarela de pago segura...')">
                                    <span class="text-xs">üîí</span> Pagar Ahora
                                </button>
                                <div class="h-6 w-px bg-slate-300"></div>
                                <span class="text-[9px] text-slate-500 font-medium">Transacci√≥n segura protegida por cifrado SSL 256-bit.</span>
                             </div>
                             <div class="flex items-center gap-4 py-1 px-4 bg-white rounded-xl border border-slate-200/50 shadow-sm">
                                 <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">Saldo Pendiente</span>
                                 <span class="text-base font-black text-slate-900">${formatNum(total)} ‚Ç¨</span>
                             </div>
                        </div>

                        <!-- Grid de Detalles Luxury -->
                        <div class="w-full grid grid-cols-[45%_55%] gap-12 px-6 text-[9px] leading-relaxed">
                            <div class="text-left py-2 pr-8 border-r border-slate-100/80">
                                <p class="font-black text-[#2d5a43] text-[10px] mb-4 border-b border-[#2d5a43]/10 pb-1.5 tracking-[0.2em] uppercase">Datos de Facturaci√≥n</p>
                                <p class="font-black text-slate-900 text-[11px] mb-1 uppercase tracking-tight">${h.company}</p>
                                <p class="text-slate-500 mb-4 font-bold">CIF: <span class="text-slate-800">${h.nif}</span></p>
                                <p class="text-slate-500 leading-normal mb-6 italic">${h.address}<br>${h.cp} ${h.city}</p>
                                
                                <div class="bg-[#2d5a43]/5 p-3 rounded-xl border border-[#2d5a43]/10">
                                     <p class="text-[7px] font-black text-[#2d5a43] uppercase mb-1 tracking-[0.2em] opacity-80">Cuenta de Abono Corriente</p>
                                     <p class="font-black text-slate-900 text-[11px] tracking-tight tabular-nums">${h.iban}</p>
                                </div>
                            </div>
                            <div class="text-right flex flex-col justify-center gap-4">
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center bg-slate-50/50 p-3 rounded-xl border border-dotted border-slate-200">
                                        <div class="text-left">
                                            <p class="text-[7px] text-slate-400 font-black uppercase tracking-widest">1er Pago Garant√≠a (30%)</p>
                                            <p class="text-[9px] text-slate-500">L√≠mite: <strong class="text-slate-800">${formatDate(fDeposito1)}</strong></p>
                                        </div>
                                        <span class="font-black text-base text-slate-900 tabular-nums">${formatNum(total * 0.3)} <span class="text-[10px] font-normal opacity-40">‚Ç¨</span></span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center bg-slate-50/50 p-3 rounded-xl border border-dotted border-slate-200">
                                        <div class="text-left">
                                            <p class="text-[7px] text-slate-400 font-black uppercase tracking-widest">Liquidaci√≥n Final (70%)</p>
                                            <p class="text-[9px] text-slate-500">L√≠mite: <strong class="text-slate-800">${formatDate(fDeposito2)}</strong></p>
                                        </div>
                                        <span class="font-black text-base text-slate-900 tabular-nums">${formatNum(total * 0.7)} <span class="text-[10px] font-normal opacity-40">‚Ç¨</span></span>
                                    </div>
                                </div>
                                
                                <div class="mt-4 py-2 px-4 rounded-lg bg-emerald-50/50 border border-emerald-100 inline-block self-end">
                                     <p class="text-[10px] text-[#2d5a43] font-black italic tracking-tight">
                                         FECHA RELEASE FINAL: <span class="ml-2 underline decoration-[#2d5a43]/30 decoration-2">${formatDate(fRelease)}</span>
                                     </p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else {
                // IVA Breakdown HTML (Shared)
                const breakdownHtml = `
                    <div style="background-color: #2d5a43; color: white; padding: 10px; border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); -webkit-print-color-adjust: exact;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 8px; text-transform: uppercase;">
                            <thead style="opacity: 0.7; border-bottom: 0.5px solid rgba(255,255,255,0.2);">
                                <tr>
                                    <th style="text-align: left; padding-bottom: 4px;">Tipo IVA</th>
                                    <th style="text-align: right; padding-bottom: 4px;">Base</th>
                                    <th style="text-align: right; padding-bottom: 4px;">Cuota</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${base10 > 0 ? `
                                <tr>
                                    <td style="padding-top: 4px;">REDUC. (10%)</td>
                                    <td style="text-align: right; padding-top: 4px;">${formatNum(base10)} ‚Ç¨</td>
                                    <td style="text-align: right; padding-top: 4px;">${formatNum(iva10)} ‚Ç¨</td>
                                </tr>` : ''}
                                ${base21 > 0 ? `
                                <tr>
                                    <td style="padding-top: 2px;">GRAL. (21%)</td>
                                    <td style="text-align: right; padding-top: 2px;">${formatNum(base21)} ‚Ç¨</td>
                                    <td style="text-align: right; padding-top: 2px;">${formatNum(iva21)} ‚Ç¨</td>
                                </tr>` : ''}
                                <tr style="border-top: 1px solid rgba(255,255,255,0.3); font-weight: bold;">
                                    <td style="padding-top: 6px;">TOTAL NETO</td>
                                    <td colspan="2" style="text-align: right; padding-top: 6px; font-size: 10px;">${formatNum(base10 + base21)} ‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                // Inyectar en paneles de reserva
                const summaryConfirmacion = document.getElementById('iva-summary-confirmacion');
                const summaryProforma = document.getElementById('iva-summary-proforma');
                if (summaryConfirmacion) summaryConfirmacion.innerHTML = breakdownHtml;
                if (summaryProforma) summaryProforma.innerHTML = breakdownHtml;

                // Footer Logic (Proforma) - Only the black box and small text
                footer.innerHTML = `
                    <div style="margin-top: 20px; width: 100%; display: flex; justify-content: flex-end;">
                        <div style="width: 320px; font-family: 'Montserrat', sans-serif;">
                            <!-- Total Section -->
                            <div style="background-color: #000; color: #fff; padding: 10px 16px; width: 100%; display: flex; justify-content: space-between; align-items: center; -webkit-print-color-adjust: exact; border-radius: 4px;">
                                <span style="font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;">Total Factura Proforma</span>
                                <span style="font-size: 18px; font-weight: 900;">${formatNum(total)} <span style="font-size: 12px; font-weight: 400;">‚Ç¨</span></span>
                            </div>
                            
                            <!-- Discrete IVA Breakdown Section -->
                            <div style="margin-top: 10px; border-top: 1px solid #f3f4f6; padding: 6px 0;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 7px; color: #6b7280; text-transform: uppercase;">
                                    <tr>
                                        <th style="text-align: left; opacity: 0.6; font-weight: 700;">Base Imponible</th>
                                        <th style="text-align: center; opacity: 0.6; font-weight: 700;">IVA</th>
                                        <th style="text-align: right; opacity: 0.6; font-weight: 700;">Cuota</th>
                                    </tr>
                                    ${base10 > 0 ? `
                                    <tr>
                                        <td style="padding: 2px 0;">${formatNum(base10)} ‚Ç¨</td>
                                        <td style="text-align: center; padding: 2px 0;">10%</td>
                                        <td style="text-align: right; padding: 2px 0;">${formatNum(iva10)} ‚Ç¨</td>
                                    </tr>` : ''}
                                    ${base21 > 0 ? `
                                    <tr>
                                        <td style="padding: 2px 0;">${formatNum(base21)} ‚Ç¨</td>
                                        <td style="text-align: center; padding: 2px 0;">21%</td>
                                        <td style="text-align: right; padding: 2px 0;">${formatNum(iva21)} ‚Ç¨</td>
                                    </tr>` : ''}
                                </table>
                            </div>
                            
                            <div style="margin-top: 8px; text-align: right;">
                                <p style="font-size: 8px; color: #9ca3af; font-style: italic; font-weight: 400; line-height: 1.3;">
                                    * Este documento es una liquidaci√≥n provisional (Factura Proforma).<br>
                                    No tiene validez como factura ordinaria hasta su emisi√≥n definitiva.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Digital Seal -->
                    <div style="margin-top: 32px; border-top: 1px solid #f3f4f6; padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 7px; color: #9ca3af; text-transform: uppercase;">Nexus Designer ‚Ä¢ ID: ${Math.random().toString(36).substr(2, 9).toUpperCase()}</div>
                        <div style="width: 80px; height: 80px; border: 1px solid #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 7px; color: #d1d5db; text-align: center; padding: 4px;">Sello<br>Digital</div>
                    </div>`;
            }

            syncWithFicha();
        }

        // --- Drag and Drop Helpers ---
        function addOcupanteField() {
            const box = document.getElementById('ocupante-box');
            const addBtn = box.querySelector('.no-print.mt-2');
            const newRow = document.createElement('div');
            newRow.className = 'ocupante-row flex items-center gap-1 mt-1';
            newRow.innerHTML = `
                    < span > <strong class="editable" contenteditable="true" style="display:inline-block;min-width:60px;">Campo</strong> : <span class="editable" contenteditable="true" style="display:inline-block;min-width:120px;">Valor</span></span >
                        <button class="no-print text-red-300 hover:text-red-600 text-[10px] ml-auto" onclick="this.parentElement.remove();if(!document.querySelector('.ocupante-row.hidden')){document.getElementById('ocupante-restore').classList.add('hidden');}" title="Eliminar">‚úï</button>
                `;
            box.insertBefore(newRow, addBtn);
        }

        function dragStart(ev, index) {
            ev.dataTransfer.setData("text/plain", index);
            ev.dataTransfer.effectAllowed = "move";
        }
        function allowDrop(ev) {
            ev.preventDefault();
        }
        function drop(ev, targetIndex) {
            ev.preventDefault();
            const sourceIndex = parseInt(ev.dataTransfer.getData("text/plain"));
            if (sourceIndex === targetIndex) return;

            const movedItem = items[sourceIndex];
            items.splice(sourceIndex, 1);
            items.splice(targetIndex, 0, movedItem);
            renderItems();
        }

        // --- Date Helpers ---
        function toInputDate(dateStr) {
            if (!dateStr) return '';
            // Detect ISO
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dateStr;
            // Parse DD-MM-YYYY or DD/MM/YYYY
            const parts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
            if (parts.length < 3) return '';
            let d = parts[0], m = parts[1], y = parts[2];
            if (d.length === 4) { [y, m, d] = parts; } // Handle YYYY-MM-DD passed as others
            if (y && y.length === 2) y = '20' + y;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        function formatDateForDisplay(isoDate) {
            if (!isoDate) return '';
            const d = new Date(isoDate);
            if (isNaN(d.getTime())) return isoDate;
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // --- Update Item Logic ---
        function updateItem(index, key, val) {
            if (key === 'fecha') {
                // Input date returns YYYY-MM-DD
                // Store as is or format? Let's format to DD-MM-YYYY for consistency with legacy
                items[index][key] = formatDateForDisplay(val).replace(/\//g, '-');
            } else if (['concepto', 'hab', 'cant', 'regimen', 'dias'].includes(key)) {
                items[index][key] = val;
            } else {
                items[index][key] = parseMoney(val);
            }
            renderItems();
        }

        function addRow() {
            items.push({ fecha: formatDateForDisplay(new Date().toISOString().split('T')[0]).replace(/\//g, '-'), hab: '', cant: '1', concepto: 'Nuevo Concepto', precio: 0, iva: 10, regimen: '' });
            renderItems();
        }
        function removeItem(index) { items.splice(index, 1); renderItems(); }

        function syncWithFicha() {
            const saved = localStorage.getItem('selectedGroup');
            if (!saved) return;

            let group = JSON.parse(saved);

            // 1. Calcular Totales desde Items
            const totalRevenue = items.reduce((acc, curr) => {
                const p = parseFloat(curr.precio) || 0;
                const h = parseFloat(curr.hab) || 1;
                const c = parseFloat(curr.cant) || 1;
                const d = parseFloat(curr.dias) || 1;
                return acc + (p * h * c * d);
            }, 0);
            const totalPax = items.reduce((acc, curr) => acc + (parseInt(curr.cant) || 0), 0);

            // 2. Fechas
            const entrada = document.getElementById('reserva-entrada-1')?.innerText || group["Entrada"];
            const salida = document.getElementById('reserva-salida-1')?.innerText || group["Salida"];

            // 3. Hotel
            const hotel = currentHotel === 'cumbria' ? 'Cumbria' : 'Guadiana';

            // 4. Actualizar Objeto Grupo
            group["Importe(*)"] = totalRevenue;
            group["Pax."] = document.getElementById('reserva-personas-1')?.innerText || group["Pax."];
            group["Entrada"] = entrada;
            group["Salida"] = salida;
            group["Hotel_Asignado"] = hotel;

            // GUARDAR ITEMS DE LA PROFORMA
            group["ProformaItems"] = items;

            // Sincronizar Dep√≥sitos
            group["Dep1_Importe"] = parseFloat((totalRevenue * 0.3).toFixed(2));
            group["Dep2_Importe"] = parseFloat((totalRevenue * 0.7).toFixed(2));

            // Sincronizar Release (7 d√≠as antes de entrada por defecto)
            if (entrada) {
                const parts = entrada.includes('/') ? entrada.split('/') : entrada.split('-');
                if (parts.length === 3) {
                    // Asumimos formato dd/mm/yyyy o yyyy-mm-dd
                    let d, m, y;
                    if (parts[0].length === 4) { [y, m, d] = parts; } else { [d, m, y] = parts; }

                    const fechaEntrada = new Date(y, m - 1, d);
                    const fechaRelease = new Date(fechaEntrada);

                    // C√°lculo din√°mico si tenemos los d√≠as de release
                    const diasRelease = parseInt(group["Com_Relix"]) || 22; // Por defecto 22 d√≠as
                    fechaRelease.setDate(fechaRelease.getDate() - diasRelease);

                    group["Com_Vencimiento_Rel"] = fechaRelease.toISOString().split('T')[0];
                }
            }
            if (!group["Com_Relix"]) group["Com_Relix"] = "22"; // Default Release Days

            // Guardar en LocalStorage para que Gesti√≥n de Grupos lo lea
            localStorage.setItem('selectedGroup', JSON.stringify(group));

            // Tambi√©n actualizar la lista principal 'nexus_groups_data' si es posible (simulaci√≥n)
            // En un entorno real, esto ser√≠a una llamada a Firebase updateDoc
            const allGroupsStr = localStorage.getItem('nexus_groups_data');
            if (allGroupsStr) {
                const allGroups = JSON.parse(allGroupsStr);
                const idx = allGroups.findIndex(g => g["Reserva"] === group["Reserva"]);
                if (idx !== -1) {
                    allGroups[idx] = { ...allGroups[idx], ...group };
                    localStorage.setItem('nexus_groups_data', JSON.stringify(allGroups));
                }
            }
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.querySelectorAll('.logo-placeholder').forEach(img => { img.src = e.target.result; img.classList.remove('hidden'); });
                    document.querySelectorAll('.font-logo').forEach(t => t.classList.add('hidden'));
                    const logoContainer = document.getElementById('default-logo-2');
                    if (logoContainer) logoContainer.classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


    </script>
</body>

</html>