<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Groups - Gestión Inteligente</title>
    <link rel="icon" type="image/png" href="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png">

    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM (Versión 18) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK (Compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes blynk {

            0%,
            100% {
                opacity: 1;
                filter: brightness(1);
            }

            50% {
                opacity: 0.6;
                filter: brightness(1.1);
            }
        }

        .animate-blynk {
            animation: blynk 1.5s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Configuración Firebase Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script type="text/babel">
        // Aseguramos que las librerías estén disponibles
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;

        // Definición de Iconos (SVG Manual para estabilidad)
        // Definición de Iconos (SVG Manual para estabilidad)
        const Icon = ({ path, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <g dangerouslySetInnerHTML={{ __html: path }} />
            </svg>
        );

        const IconCheck = (p) => <Icon path='<polyline points="20 6 9 17 4 12"></polyline>' {...p} />;
        const IconClock = (p) => <Icon path='<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>' {...p} />;
        const IconX = (p) => <Icon path='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' {...p} />;
        const IconChart = (p) => <Icon path='<line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>' {...p} />;
        const IconBrain = (p) => <Icon path='<path d="m12 14 4-4"></path><path d="M3.34 17a10 10 0 1 1 17.32 0"></path>' {...p} />; // Simple brain
        const IconUsers = (p) => <Icon path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' {...p} />;
        const IconTable = (p) => <Icon path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" x2="21" y1="9" y2="9"></line><line x1="3" x2="21" y1="15" y2="15"></line><line x1="9" x2="9" y1="3" y2="21"></line><line x1="15" x2="15" y1="3" y2="21"></line>' {...p} />;
        const IconMail = (p) => <Icon path='<rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>' {...p} />;
        const IconChevronDown = (p) => <Icon path='<path d="m6 9 6 6 6-6"></path>' {...p} />;
        const IconArrowRight = (p) => <Icon path='<path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path>' {...p} />;
        const IconCalendar = (p) => <Icon path='<rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path>' {...p} />;
        const IconFile = (p) => <Icon path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline>' {...p} />;
        const IconTrash = (p) => <Icon path='<path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>' {...p} />;
        const IconPlus = (p) => <Icon path='<path d="M5 12h14"></path><path d="M12 5v14"></path>' {...p} />;
        const IconRefresh = (p) => <Icon path='<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path>' {...p} />;
        const IconMore = (p) => <Icon path='<circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle>' {...p} />;
        const IconSave = (p) => <Icon path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>' {...p} />;
        const IconSearch = (p) => <Icon path='<circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>' {...p} />;
        const IconFilter = (p) => <Icon path='<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>' {...p} />;
        const IconPrinter = (p) => <Icon path='<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect>' {...p} />;
        const IconDownload = (p) => <Icon path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line>' {...p} />;
        const IconBed = (p) => <Icon path='<path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"></path><path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"></path>' {...p} />;
        const IconBuildingSkyscraper = (p) => <Icon path='<rect width="16" height="20" x="4" y="2" rx="2" ry="2"></rect><line x1="9" x2="9.01" y1="12" y2="12"></line><line x1="15" x2="15.01" y1="12" y2="12"></line><line x1="9" x2="9.01" y1="16" y2="16"></line><line x1="15" x2="15.01" y1="16" y2="16"></line><line x1="9" x2="9.01" y1="8" y2="8"></line><line x1="15" x2="15.01" y1="8" y2="8"></line>' {...p} />;
        const IconChevronLeft = (p) => <Icon path='<path d="m15 18-6-6 6-6"></path>' {...p} />;
        const IconChevronRight = (p) => <Icon path='<path d="m9 18 6-6-6-6"></path>' {...p} />;
        const IconChevronUp = (p) => <Icon path='<path d="m18 15-6-6-6 6"></path>' {...p} />;
        const IconSparkles = (p) => <Icon path='<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>' {...p} className={`${p.className || ""} text-yellow-400`} />;
        const IconUpload = (p) => <Icon path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>' {...p} />;
        const IconPieChart = (p) => <Icon path='<path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path>' {...p} />;
        const IconGroup = (p) => <Icon path='<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' {...p} />;
        const IconEdit = (p) => <Icon path='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>' {...p} />;

        // --- CONFIGURACIÓN FIREBASE ---
        // Se carga desde js/firebase-config.js
        const firebaseConfig = window.firebaseConfig;

        // Inicialización robusta
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- PRUEBA TÉCNICA OBLIGATORIA (Escritura inicial) ---
        db.collection("test").add({
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            test: true,
            userMessage: "Verificación de conexión desde App"
        }).then(docRef => {
            console.log("✅ Conexión Firestore EXITOSA. Doc ID:", docRef.id);
        }).catch(err => {
            console.error("❌ Error de conexión Firestore:", err);
        });

        // --- CONFIGURACIÓN IA (CONEXIÓN DIRECTA) ---
        async function callGemini(customPrompt) {
            const apiKey = window.firebaseConfig.apiKey;
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: customPrompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(`Error en servidor IA: ${errorMsg}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                console.error("Error en llamada IA:", err);
                return "Hubo un error al conectar con la IA estratégica. Por favor, intenta de nuevo.";
            }
        }

        // Datos iniciales de ejemplo
        const INITIAL_DATA = [
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACIÓN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "15", "Pernoct.": "30", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "Régimen": "HD", "Importe(*)": "1514", "Garantía": "ANTES 18:00" },
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACIÓN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "7", "Pernoct.": "14", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "Régimen": "HA", "Importe(*)": "536", "Garantía": "ANTES 18:00" },
            { "Reserva": "202263", "Nombre del Grupo": "TABLAO Y TUMBAO", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "60", "Pernoct.": "120", "Empresa/Agencia": "SALSEA 2026/TABLAO", "Segment.": "DIRECTO OFFLINE", "Régimen": "HA", "Importe(*)": "3732", "Garantía": "FLEXIBLE" },
            { "Reserva": "205249", "Nombre del Grupo": "BM BENFICA", "Entrada": "2026-01-23", "Salida": "2026-01-24", "Noches": "1", "Pax.": "22", "Pernoct.": "22", "Empresa/Agencia": "C.D. BENFICA", "Segment.": "DEPORTIVO", "Régimen": "PC", "Importe(*)": "2100", "Garantía": "PAGADO" }
        ];

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ff5722', '#795548'];

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [columns, setColumns] = useState(Object.keys(INITIAL_DATA[0]));
            const authorizingIds = useRef(new Set()); // Para evitar que onSnapshot restaure diffs en proceso de guardado

            const formatDate = (val) => {
                if (!val) return "-";
                const str = val.toString().trim();
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toLocaleDateString('es-ES');
                }
                return val;
            };
            const [activeTab, setActiveTab] = useState('calendar');
            const [searchTerm, setSearchTerm] = useState('');
            const [newColumnName, setNewColumnName] = useState('');
            const [showColumnModal, setShowColumnModal] = useState(false);
            const [expandedGroup, setExpandedGroup] = useState(null);
            const [expandedSegment, setExpandedSegment] = useState(null);

            // Estados para IA
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [showAiModal, setShowAiModal] = useState(false);

            // Estados para Filtros de Directorio de Grupos
            const [filterDirHotel, setFilterDirHotel] = useState('');
            const [filterDirCommercial, setFilterDirCommercial] = useState('');

            // Sincronización automática desde Proforma (LocalStorage -> Firestore)
            useEffect(() => {
                const syncFromProforma = async () => {
                    const saved = localStorage.getItem('selectedGroup');
                    if (saved) {
                        try {
                            const localGroup = JSON.parse(saved);
                            if (localGroup.Reserva) {
                                // Asegurar formato correcto para Firestore
                                const updatePayload = {
                                    "Importe(*)": localGroup["Importe(*)"],
                                    "Pax.": localGroup["Pax."],
                                    "Entrada": localGroup["Entrada"],
                                    "Salida": localGroup["Salida"],
                                    "Hotel_Asignado": localGroup["Hotel_Asignado"],
                                    "Dep1_Importe": localGroup["Dep1_Importe"],
                                    "Dep2_Importe": localGroup["Dep2_Importe"],
                                    "Com_Relix": localGroup["Com_Relix"],
                                    "Com_Vencimiento_Rel": localGroup["Com_Vencimiento_Rel"],
                                    "ProformaItems": localGroup["ProformaItems"] || [],
                                    "updatedAt": firebase.firestore.FieldValue.serverTimestamp()
                                };
                                await db.collection("groups").doc(String(localGroup.Reserva)).set(updatePayload, { merge: true });
                            }
                        } catch (e) {
                            console.error("Error sincronizando proforma:", e);
                        }
                    }
                };
                syncFromProforma();
            }, []);

            // Estados para Añadir Grupo
            const [showAddGroupModal, setShowAddGroupModal] = useState(false);
            const [showClientData, setShowClientData] = useState(false); // New state for client data popup
            const [newGroup, setNewGroup] = useState({
                "Nombre del Grupo": "",
                "Entrada": new Date().toISOString().split('T')[0],
                "Salida": "",
                "Pax.": "0",
                "Empresa/Agencia": "",
                "Segment.": "GRUPOS",
                "Régimen": "HD",
                "Importe(*)": "0",
                "Reserva": Math.floor(Math.random() * 900000 + 100000).toString(),
                "Estado": "Confirmada"
            });

            // --- Filtros y Ordenación ---
            const [filterStatus, setFilterStatus] = useState('confirmada'); // all, confirmada, anulada
            const [filterTime, setFilterTime] = useState('future'); // all, future, past
            const [sortConfig, setSortConfig] = useState({ key: 'Entrada', direction: 'asc' });

            // --- Procesamiento de Datos (Filtrado y Ordenación) ---
            const processedData = useMemo(() => {
                if (!data) return [];

                let filtered = [...data];

                // 0. Filtro de Validez (Reserva obligatoria)
                filtered = filtered.filter(row => row["Reserva"] && row["Reserva"].toString().trim() !== "" && row["Reserva"].toString().trim() !== "-");

                const today = new Date().toISOString().split('T')[0];

                // 1. Filtro de Estado
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(row => {
                        const state = (row["Estado"] || "").toLowerCase();
                        if (filterStatus === 'confirmada') return !state.includes('anulada') && !state.includes('cancelada');
                        if (filterStatus === 'anulada') return state.includes('anulada') || state.includes('cancelada');
                        return true;
                    });
                }

                // 2. Filtro de Tiempo
                if (filterTime !== 'all') {
                    filtered = filtered.filter(row => {
                        let dateStr = row["Entrada"];
                        if (dateStr) {
                            dateStr = dateStr.toString();
                            if (dateStr.includes('/') && dateStr.length === 10) {
                                const [d, m, y] = dateStr.split('/');
                                dateStr = `${y}-${m}-${d}`;
                            }
                        }

                        if (!dateStr) return false;
                        if (filterTime === 'future') return dateStr >= today;
                        if (filterTime === 'past') return dateStr < today;
                        return true;
                    });
                }

                // 3. Filtro de Texto (Global Search)
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    filtered = filtered.filter(row => {
                        return (
                            (row["Nombre del Grupo"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Empresa/Agencia"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Com_Comercial"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Reserva"] || "").toString().toLowerCase().includes(lowerTerm)
                        );
                    });
                }

                // 4. Ordenación
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let valA = a[sortConfig.key] || "";
                        let valB = b[sortConfig.key] || "";

                        // Tratamiento especial fechas
                        if (sortConfig.key === 'Entrada' || sortConfig.key === 'Salida') {
                            const strA = valA.toString();
                            const strB = valB.toString();
                            if (strA.includes('/')) valA = strA.split('/').reverse().join('-');
                            if (strB.includes('/')) valB = strB.split('/').reverse().join('-');
                        }
                        // Tratamiento números
                        if (sortConfig.key === 'Importe(*)' || sortConfig.key === 'Pax.') {
                            valA = parseFloat(valA.toString().replace('.', '').replace(',', '.')) || 0;
                            valB = parseFloat(valB.toString().replace('.', '').replace(',', '.')) || 0;
                        }

                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                return filtered;
            }, [data, filterStatus, filterTime, sortConfig]);

            // --- Cálculos de Estadísticas Globales (Reemplazado por lógica nueva) ---
            // Se usa stats calculado más abajo basado en processedData

            // --- Agrupación de Datos por "Nombre del Grupo" (Filtrados) ---
            const groupedData = useMemo(() => {
                const groups = {};

                processedData.forEach(row => {
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";
                    if (!groups[groupName]) {
                        groups[groupName] = {
                            name: groupName,
                            agency: row["Empresa/Agencia"] || "",
                            arrival: row["Entrada"],
                            departure: row["Salida"],
                            status: row["Estado"] || "Confirmada",
                            totalPax: 0,
                            totalRevenue: 0,
                            totalNights: 0,
                            records: []
                        };
                    }

                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) groups[groupName].totalRevenue += importe;
                    if (!isNaN(pax)) groups[groupName].totalPax += pax;
                    if (!isNaN(noches)) groups[groupName].totalNights += noches;

                    groups[groupName].records.push(row);
                });

                return Object.values(groups).sort((a, b) => b.totalRevenue - a.totalRevenue);
            }, [processedData]);

            // --- Análisis detallado por Segmentos (Filtrados) ---
            const segmentStats = useMemo(() => {
                const segments = {};

                processedData.forEach(row => {
                    let segName = row["Segment."] || "Sin Segmento";
                    if (segName === "GRTANTEO") segName = "GRUPO TANTEO"; // Unificar segmentos
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";

                    if (!segments[segName]) {
                        segments[segName] = {
                            name: segName,
                            revenue: 0,
                            pax: 0,
                            nights: 0,
                            count: 0,
                            groupList: new Set()
                        };
                    }

                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) segments[segName].revenue += importe;
                    if (!isNaN(pax)) segments[segName].pax += pax;
                    if (!isNaN(noches)) segments[segName].nights += noches;
                    segments[segName].count += 1;
                    segments[segName].groupList.add(groupName);
                });

                return Object.values(segments).map(s => ({
                    ...s,
                    groupCount: s.groupList.size,
                    groups: Array.from(s.groupList).sort()
                })).sort((a, b) => b.revenue - a.revenue);
            }, [processedData]);

            // --- Datos para Gráficos Globales (Filtrados) ---
            const chartData = useMemo(() => {
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const revenueByMonth = {};

                processedData.forEach(row => {
                    let dateStr = row["Entrada"];
                    if (dateStr) {
                        dateStr = dateStr.toString();
                        if (dateStr.includes('/') && dateStr.length === 10) {
                            dateStr = dateStr.split('/').reverse().join('-');
                        }
                    }

                    if (dateStr) {
                        const date = new Date(dateStr);
                        if (!isNaN(date)) {
                            const key = `${monthNames[date.getMonth()]} ${date.getFullYear().toString().slice(-2)}`;
                            const importe = parseFloat((row["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                            revenueByMonth[key] = (revenueByMonth[key] || 0) + (isNaN(importe) ? 0 : importe);
                        }
                    }
                });

                const barData = Object.keys(revenueByMonth).map(key => ({
                    name: key,
                    Ingresos: revenueByMonth[key]
                }));

                return { barData };
            }, [processedData]);

            // --- Top Grupos Chart ---
            const topGroupsData = useMemo(() => {
                return groupedData.slice(0, 10).map(g => ({
                    name: g.name.length > 15 ? g.name.substring(0, 15) + '...' : g.name,
                    fullDate: g.name,
                    Ingresos: g.totalRevenue
                }));
            }, [groupedData]);


            // --- Funciones IA ---
            const handleConsultantClick = async () => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                // Preparamos el resumen para la IA incluyendo datos de segmentación
                const summary = {
                    totalRevenue: stats.revenue,
                    totalGroups: stats.count,
                    topSegments: segmentStats.slice(0, 3).map(s => `${s.name} (${s.revenue.toFixed(0)}€)`).join(', '),
                    topMonths: chartData.barData.sort((a, b) => b.Ingresos - a.Ingresos).slice(0, 3).map(m => m.name).join(', ')
                };

                const prompt = `Actúa como un analista de Revenue Management experto para un hotel. 
                Analiza estos datos resumidos de grupos:
                - Ingresos Totales: ${summary.totalRevenue}
                - Total Grupos: ${summary.totalGroups}
                - Top 3 Segmentos (Ingresos): ${summary.topSegments}
                - Top Meses: ${summary.topMonths}
                
                Dame 3 conclusiones estratégicas breves y 1 recomendación de acción. Usa formato Markdown.
                Enfócate mucho en la rentabilidad de los segmentos. ¿Qué segmento deberíamos potenciar?`;

                try {
                    const result = await callGemini(prompt);
                    // Check if result is an error message
                    if (result && (result.includes("Error") || result.includes("Hubo un error"))) {
                        setAiResult({ title: "Error Detectado", content: `**Detalles:** ${result}\n\n*Nota:* Si usas el archivo local (file://), la restricción de API web puede bloquearlo.` });
                    } else {
                        setAiResult({ title: "Análisis Estratégico", content: result });
                    }
                } catch (e) {
                    setAiResult({ title: "Error Crítico", content: e.message });
                }
                setIsAiLoading(false);
            };

            const handleEmailClick = async (group) => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                const prompt = `Escribe un email formal y acogedor para el organizador del grupo "${group.name}".
                Detalles:
                - Agencia: ${group.agency}
                - Llegada: ${group.arrival}
                - Salida: ${group.departure}
                - Pax: ${group.totalPax}
                - Importe total estimado: ${group.totalRevenue}€
                
                El objetivo es confirmar los detalles y dar la bienvenida. Menciona que estamos a su disposición para cualquier petición especial (dietas, salones, etc). Firma como "Dpto. de Grupos". Usa formato Markdown.`;

                const result = await callGemini(prompt);
                setAiResult({ title: `Borrador Email: ${group.name}`, content: result });
                setIsAiLoading(false);
            };

            const handleProformaClick = (group) => {
                // Tomar datos agregados del grupo y pasarlos como un registro único
                const firstRec = group.records[0] || {};
                const groupData = {
                    ...firstRec,
                    "Nombre del Grupo": group.name,
                    "Empresa/Agencia": group.agency,
                    "Importe(*)": group.totalRevenue.toString(),
                    "Pax.": group.totalPax.toString(),
                    "Entrada": group.arrival,
                    "Salida": group.departure
                };
                localStorage.setItem('selectedGroup', JSON.stringify(groupData));
                window.location.href = 'Fac Prof.html';
            };

            // --- Persistencia FIREBASE ---
            useEffect(() => {
                const unsubscribe = db.collection("groups").onSnapshot((snapshot) => {
                    const roomData = [];
                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        // Garantizar que Reserva esté presente y sea fiel al ID del documento
                        roomData.push({ ...d, Reserva: d.Reserva || doc.id });
                    });

                    if (roomData.length > 0) {
                        // Ordenar por fecha de entrada antes de guardar en el estado
                        const getIsoDate = (val) => {
                            if (!val) return "9999-12-31";
                            const str = String(val);
                            const parts = str.split(/[\/-]/);
                            if (parts.length === 3) {
                                if (parts[0].length === 4) return str; // YYYY-MM-DD
                                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; // DD-MM-YYYY
                            }
                            return str;
                        };
                        const sorted = roomData.sort((a, b) => {
                            return getIsoDate(a["Entrada"]).localeCompare(getIsoDate(b["Entrada"]));
                        });

                        setData(prevData => {
                            // Si no hay diffs en el estado anterior ni estamos autorizando nada, usamos los datos de Firestore directos
                            if (!prevData.some(r => r._diff) && authorizingIds.current.size === 0) return sorted;

                            const merged = sorted.map(dbRow => {
                                const resID = String(dbRow.Reserva || "").trim();
                                if (authorizingIds.current.has(resID)) {
                                    // Esta fila se acaba de autorizar, NO restaurar diffs
                                    return dbRow;
                                }

                                const localMatch = prevData.find(p => String(p.Reserva || "").trim() === resID);

                                if (localMatch && localMatch._diff) {
                                    // Si los datos ya coinciden en los campos clave, ya no hay diff real
                                    const relevantKeys = ["Estado", "Entrada", "Salida", "Pax.", "Importe(*)", "Régimen", "Segment.", "Nombre del Grupo"];
                                    const dataMatches = relevantKeys.every(k => String(dbRow[k] || "").trim() === String(localMatch[k] || "").trim());

                                    if (dataMatches) return dbRow; // Limpiar diff automáticamente si ya está en DB

                                    return { ...dbRow, _diff: localMatch._diff, _changes: localMatch._changes };
                                }
                                return dbRow;
                            });

                            // Añadir filas locales que son nuevas y aún no existen en el servidor
                            prevData.forEach(p => {
                                const pID = String(p.Reserva || "").trim();
                                if (p._diff === 'new' &&
                                    !authorizingIds.current.has(pID) &&
                                    !sorted.some(s => String(s.Reserva || "").trim() === pID)) {
                                    merged.push(p);
                                }
                            });

                            return merged.sort((a, b) => getIsoDate(a["Entrada"]).localeCompare(getIsoDate(b["Entrada"])));
                        });

                        const allKeys = new Set();
                        roomData.forEach(r => Object.keys(r).forEach(k => {
                            if (!["_diff", "updatedAt"].includes(k)) allKeys.add(k);
                        }));
                        setColumns(Array.from(allKeys));
                    } else {
                        // Si no hay datos en Firestore pero hay locales con _diff, preservarlos
                        setData(prev => prev.filter(r => r._diff));
                    }
                }, (error) => {
                    console.error("Error en tiempo real Firebase:", error);
                });

                return () => unsubscribe();
            }, []);



            // Actualizar estadísticas: ENFOQUE COMERCIAL (Grupos, Estados, Pax)
            const stats = useMemo(() => {
                let totalRevenue = 0;
                let totalPax = 0;

                let activeCount = 0;
                let prospectCount = 0;
                let cancelledCount = 0;

                const uniqueGroups = new Set();

                processedData.forEach(row => {
                    // Sumas económicas (asumiendo que cada fila suma al total)
                    const importe = parseFloat((row["Importe(*)"] || "0").toString().replace(/\./g, '').replace(',', '.')) || 0;
                    const pax = parseInt(row["Pax."] || 0);
                    totalRevenue += importe;
                    totalPax += pax;

                    // Conteo de Grupos Únicos por Estado
                    const groupId = row["Reserva"] || row["Nombre del Grupo"];
                    if (groupId && !uniqueGroups.has(groupId)) {
                        uniqueGroups.add(groupId);
                        const status = (row["Estado"] || "PROSPECTO").toUpperCase();

                        if (status.includes("CONF") || status.includes("BLOQ") || status.includes("OK") || status.includes("CERR")) {
                            activeCount++;
                        } else if (status.includes("CANC") || status.includes("ANUL") || status.includes("NO")) {
                            cancelledCount++;
                        } else {
                            // Prospectos, Pre-reservas, Tentativos, Sin estado
                            prospectCount++;
                        }
                    }
                });

                return {
                    revenue: totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }),
                    active: activeCount,
                    prospects: prospectCount,
                    cancelled: cancelledCount,
                    pax: totalPax
                };
            }, [processedData]);

            // Auto-abrir Ficha si se detecta bandera en localStorage
            useEffect(() => {
                const groupToOpen = localStorage.getItem('openGroupFicha');
                if (groupToOpen && groupedData.length > 0) {
                    const found = groupedData.find(g => g.name === groupToOpen);
                    if (found) {
                        openFicha(found);
                        localStorage.removeItem('openGroupFicha');
                    }
                }
            }, [groupedData]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            // Estados para Selección de Hotel en Importación
            const [isHotelModalOpen, setIsHotelModalOpen] = useState(false);
            const [pendingFile, setPendingFile] = useState(null);

            // --- Funciones de Archivo (Parser Recargado) ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setPendingFile(file);
                setIsHotelModalOpen(true);
            };

            const confirmHotelAndProcess = (hotelName) => {
                const file = pendingFile;
                setIsHotelModalOpen(false);
                setPendingFile(null);

                const reader = new FileReader();

                const processMatrixData = (rows, defaultStatus) => {
                    let headerRowIndex = -1;
                    const validData = [];
                    let currentStatus = defaultStatus;
                    let headers = [];

                    // Barrido completo para detectar bloques
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        const rowStr = row.join(" ").toLowerCase();

                        // Detectar cambios de sección internos (por si acaso vienen en la misma hoja)
                        if (rowStr.includes("reservas de grupos anuladas") || rowStr.includes("anuladas")) {
                            currentStatus = "Anulada";
                        } else if (rowStr.includes("reservas de grupos confirmadas") || rowStr.includes("confirmadas")) {
                            currentStatus = "Confirmada";
                        }

                        // Detectar cabecera (Flexible: Si encontramos "Reserva" y algo que suene a "Grupo" o "Nombre")
                        const hasReserva = rowStr.includes("reserva");
                        const hasGrupo = rowStr.includes("grupo") || rowStr.includes("nombre del g");

                        if (hasReserva && hasGrupo) {
                            headerRowIndex = i;
                            if (Array.isArray(row)) headers = row.map(h => {
                                const val = (h || "").toString().trim();
                                const lower = val.toLowerCase();
                                // Normalizar nombre de columna para el sistema
                                if (lower.includes("nombre del g")) return "Nombre del Grupo";
                                if (lower.includes("segmen")) return "Segment.";
                                if (lower.includes("segmento")) return "Segment.";
                                if (lower.includes("entrada")) return "Entrada";
                                if (lower.includes("salida")) return "Salida";
                                if (lower.includes("importe")) return "Importe(*)";
                                return val;
                            });
                            continue;
                        }

                        // Si tenemos headers, procesamos la fila
                        if (headerRowIndex !== -1 && headers.length > 0) {
                            // Ignorar filas vacías o repetidas cabeceras
                            if (row.length === 0) continue;

                            const obj = {};
                            let hasData = false;

                            headers.forEach((header, idx) => {
                                if (header) {
                                    obj[header] = row[idx] || "";
                                    if (obj[header]) hasData = true;
                                }
                            });

                            if (hasData) {
                                const reservaVal = (obj["Reserva"] || "").toString().toLowerCase();
                                // Ignorar si parece otra cabecera
                                if (reservaVal.includes("reserva")) continue;

                                // Inyectar Estado detectado
                                obj["Estado"] = currentStatus;
                                obj["Hotel_Asignado"] = hotelName;

                                if (reservaVal.length > 0 || (obj["Nombre del Grupo"] && obj["Nombre del Grupo"].length > 0)) {
                                    validData.push(obj);
                                }
                            }
                        }
                    }

                    return validData;
                };

                if (file.name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: false,
                            complete: (res) => processMatrixData(res.data)
                        });
                    };
                    reader.readAsText(file);
                }
                else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let allDetectedData = [];

                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                            // Determinamos estado por nombre de hoja
                            let defaultStatus = "Confirmada";
                            if (sheetName.toLowerCase().includes("anula")) defaultStatus = "Anulada";

                            const sheetData = processMatrixData(matrix, defaultStatus);
                            allDetectedData = [...allDetectedData, ...sheetData];
                        });

                        if (allDetectedData.length > 0) {
                            sanitizeAndSetData(allDetectedData);
                        } else {
                            alert("No se encontraron datos en el Excel.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert("Formato no soportado.");
                }
            };

            const sanitizeAndSetData = (rawData) => {
                // Helper to normalize Excel Dates to YYYY-MM-DD
                const normalizeDate = (val) => {
                    if (!val) return "";
                    // Handle Excel Serial Date
                    if (typeof val === 'number' || /^\d{5}$/.test(val)) {
                        const serial = parseInt(val, 10);
                        if (serial > 25569) { // Reasonable date check
                            const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
                            return date.toISOString().split('T')[0];
                        }
                    }
                    // Handle DD/MM/YYYY or DD-MM-YYYY
                    const str = String(val).trim();
                    if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(str)) {
                        const parts = str.split(/[\/-]/); // [DD, MM, YYYY]
                        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                    // Handle YYYY-MM-DD (already ISO)
                    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                        return str;
                    }
                    return str; // Return as is if unknown format
                };

                const incomingRows = rawData.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(k => {
                        if (k && k.trim() !== "") {
                            let val = row[k];
                            // Normalize dates for 'Entrada' and 'Salida'
                            if (k === 'Entrada' || k === 'Salida' || k.includes('Date')) {
                                val = normalizeDate(val);
                            }
                            cleanRow[k.trim()] = val;
                        }
                    });
                    return cleanRow;
                });

                // Copia profunda de los datos actuales para el merge
                const mergedData = [...data];

                // 1. Procesar registros entrantes
                incomingRows.forEach(newRow => {
                    const resID = newRow["Reserva"];
                    if (!resID) return;

                    const existingIdx = mergedData.findIndex(r => String(r["Reserva"]) === String(resID));

                    if (existingIdx === -1) {
                        // Es un grupo nuevo (No estaba en DB)
                        mergedData.push({ ...newRow, "_diff": "new" });
                    } else {
                        // Es un grupo existente, verificar cambios
                        const existingRow = mergedData[existingIdx];
                        let diffType = null;
                        let changes = {};

                        // Check specific fields for changes
                        const relevantKeys = ["Estado", "Entrada", "Salida", "Pax.", "Importe(*)", "Régimen", "Segment.", "Nombre del Grupo"];

                        relevantKeys.forEach(key => {
                            const oldVal = String(existingRow[key] || "").trim();
                            const newVal = String(newRow[key] || "").trim();
                            if (oldVal !== newVal) {
                                changes[key] = { old: oldVal, new: newVal };
                            }
                        });

                        // Logic for diff type
                        if (newRow["Estado"]?.toLowerCase().includes("anul") && !existingRow["Estado"]?.toLowerCase().includes("anul")) {
                            diffType = "cancelled";
                        }
                        else if (Object.keys(changes).length > 0) {
                            diffType = "modified";
                        }

                        // Actualizar la fila conservando datos que no vienen en el excel pero están en DB
                        mergedData[existingIdx] = {
                            ...existingRow,
                            ...newRow,
                            "_diff": diffType || (existingRow._diff ? existingRow._diff : null), // Keep existing diff if not resolved
                            "_changes": Object.keys(changes).length > 0 ? changes : null
                        };
                    }
                });

                // Asegurar que 'Estado' esté en las columnas
                const allKeys = new Set();
                mergedData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));

                // Ordenar por fecha de entrada
                const sortedData = [...mergedData].sort((a, b) => {
                    const valA = String(a["Entrada"] || "9999-12-31");
                    const valB = String(b["Entrada"] || "9999-12-31");
                    return valA.localeCompare(valB);
                });

                // UPDATE LOCAL STATE ONLY - DO NOT SAVE TO FIREBASE YET
                setData(sortedData);
                setColumns(Array.from(allKeys).filter(k => !k.startsWith("_") && k !== "Hotel_Asignado"));

                // Alert user that review is needed
                const changesCount = sortedData.filter(r => r._diff).length;
                if (changesCount > 0) {
                    alert(`Se han detectado ${changesCount} cambios/nuevos registros.\n\nPor favor, revise las filas resaltadas en la tabla 'Editor (Excel)' y AUTORICE los cambios uno a uno.`);
                    setActiveTab('table'); // Switch to editor view to see changes
                } else {
                    alert("No se detectaron cambios respecto a la base de datos actual.");
                }
            };

            const acceptChanges = () => {
                const batch = db.batch();
                const pendingRows = data.filter(r => r._diff);

                if (pendingRows.length === 0) return;

                pendingRows.forEach(row => {
                    const { _diff, _changes, ...rest } = row;
                    const docRef = db.collection("groups").doc(String(row["Reserva"]));

                    // Sanitize rest
                    const clean = {};
                    Object.keys(rest).forEach(k => {
                        if (rest[k] !== undefined) clean[k] = rest[k];
                    });

                    batch.set(docRef, {
                        ...clean,
                        _diff: firebase.firestore.FieldValue.delete(),
                        _changes: firebase.firestore.FieldValue.delete(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                });

                console.log(`🚀 AUTORIZANDO TODO: ${pendingRows.length} registros...`);

                // Marcar IDs para que onSnapshot no los restaure
                pendingRows.forEach(r => authorizingIds.current.add(String(r["Reserva"]).trim()));

                // Optimistic update
                const oldData = [...data];
                setData(prev => prev.map(r => ({ ...r, _diff: null, _changes: null })));

                batch.commit().then(() => {
                    console.log("✅ AUTORIZACIÓN MASIVA EXITOSA");
                    // Limpiar tracker tras un pequeño delay para dejar que onSnapshot procese el cambio final
                    setTimeout(() => {
                        pendingRows.forEach(r => authorizingIds.current.delete(String(r["Reserva"]).trim()));
                    }, 2000);
                }).catch(err => {
                    console.error("❌ ERROR EN AUTORIZACIÓN MASIVA:", err);
                    alert("Error al autorizar todo: " + err.message);
                    pendingRows.forEach(r => authorizingIds.current.delete(String(r["Reserva"]).trim()));
                    setData(oldData); // Restore on error
                });
            };

            const exportCSV = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'Analisis_Grupos_Editado.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Funciones de Edición ---
            const handleCellChange = (rowIndex, column, value) => {
                const row = data[rowIndex];
                const resID = String(row["Reserva"]);

                // Actualización optimista
                const newData = [...data];
                newData[rowIndex][column] = value;
                setData(newData);

                // Actualizar Firebase con merge y timestamp
                db.collection("groups").doc(resID).set({
                    [column]: value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).catch(err => console.error("Error editando celda:", err));
            };

            const addNewColumn = () => {
                if (!newColumnName) return;
                const newData = data.map(row => ({ ...row, [newColumnName]: "" }));
                setData(newData);
                setColumns([...columns, newColumnName]);
                setNewColumnName('');
                setShowColumnModal(false);
            };

            // Estados para Ficha de Grupo
            const [showFichaModal, setShowFichaModal] = useState(false);
            const [selectedGroupFicha, setSelectedGroupFicha] = useState(null);

            // State for Room Manager Form
            const [roomManagerForm, setRoomManagerForm] = useState({
                hotel: '', // New field for Multi-Hotel support
                type: 'Habitación Doble (DBL)',
                dateIn: '', // Will init when modal opens
                dateOut: '',
                qty: 1,
                regime: 'AD',
                price: 0
            });
            const [editingId, setEditingId] = useState(null);

            const openFicha = (groupOrRow) => {
                let group = groupOrRow;

                // Handle case where we receive a flat row (e.g. from Gantt) instead of a grouped object
                if (!group.records) {
                    const groupName = group["Nombre del Grupo"];
                    const found = groupedData.find(g => g.name === groupName);
                    if (found) {
                        group = found;
                    } else {
                        // Fallback wrapper if not found in groupedData (should be rare)
                        group = {
                            ...groupOrRow,
                            name: groupName,
                            records: [groupOrRow]
                        };
                    }
                }

                // Auto-generate Rooming List if empty
                if (group.records && group.records.length > 0) {
                    const firstRecord = group.records[0];
                    let currentList = [];
                    try {
                        currentList = JSON.parse(firstRecord["RoomingList_JSON"] || "[]");
                    } catch (e) { currentList = []; }

                    if (currentList.length === 0) {
                        const newAutoList = [];

                        // Iterate through all records (multi-hotel)
                        // Group records by unique combination of Hotel + Dates to avoid duplicates from raw data line splits
                        const uniqueSegments = new Map();

                        group.records.forEach(r => {
                            const h = r["Hotel_Asignado"] || r["Hotel"] || "H. Pendiente";
                            const dIn = r["Entrada"];
                            const dOut = r["Salida"];
                            const key = `${h}|${dIn}|${dOut}`;

                            if (!uniqueSegments.has(key)) {
                                uniqueSegments.set(key, {
                                    hotel: h,
                                    dateIn: dIn,
                                    dateOut: dOut,
                                    pax: parseInt(r["Pax."] || "0"),
                                    price: parseFloat((r["Importe(*)"] || "0").toString().replace(/\./g, '').replace(',', '.')) || 0
                                });
                            } else {
                                // Accumulate pax/price if multiple lines for same segment?
                                // Usually raw data might be split by room type, but here we just have summary.
                                // Let's keep the first one or sum? For now, keep logic simple: 1 line per day.
                                const existing = uniqueSegments.get(key);
                                existing.pax += parseInt(r["Pax."] || "0");
                                existing.price += parseFloat((r["Importe(*)"] || "0").toString().replace(/\./g, '').replace(',', '.')) || 0;
                            }
                        });


                        uniqueSegments.forEach(seg => {
                            if (seg.dateIn && seg.dateOut) {
                                // Robust Date Parsing
                                const parseDate = (dStr) => {
                                    if (!dStr) return null;
                                    const s = dStr.toString();

                                    // Handle Excel Serial Date (e.g. 46088 -> 2026-03-07)
                                    // 5 digits, typically > 40000 for current years
                                    if (/^\d{5}$/.test(s)) {
                                        const serial = parseInt(s, 10);
                                        // Check if it's a reasonable serial number for a date (e.g. > 20000 which is year 1954)
                                        if (serial > 25569) {
                                            return new Date(Math.round((serial - 25569) * 86400 * 1000));
                                        }
                                    }

                                    // Handle DD-MM-YYYY or DD/MM/YYYY
                                    if (s.includes('-') && s.split('-')[0].length <= 2) {
                                        const [d, m, y] = s.split('-');
                                        return new Date(`${y}-${m}-${d}`);
                                    }
                                    if (s.includes('/') && s.split('/')[0].length <= 2) {
                                        const [d, m, y] = s.split('/');
                                        return new Date(`${y}-${m}-${d}`);
                                    }
                                    return new Date(s);
                                };

                                let start = parseDate(seg.dateIn);
                                let end = parseDate(seg.dateOut);

                                if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end > start) {
                                    // Loop through days
                                    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                                        const nextDay = new Date(d);
                                        nextDay.setDate(d.getDate() + 1);

                                        // Calculations for daily price (avg)
                                        const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                        const dailyPrice = totalDays > 0 ? (seg.price / totalDays) : 0;

                                        newAutoList.push({
                                            id: Date.now() + Math.random(),
                                            hotel: seg.hotel,
                                            type: 'Habitación (Auto)',
                                            dateIn: d.toISOString().split('T')[0],
                                            dateOut: nextDay.toISOString().split('T')[0],
                                            qty: Math.ceil(seg.pax / 2) || 1, // Assume DBL
                                            regime: 'AD', // Default
                                            price: (dailyPrice / (Math.ceil(seg.pax / 2) || 1)).toFixed(2), // Unit price approx
                                            nights: 1,
                                            total: dailyPrice.toFixed(2)
                                        });
                                    }
                                }
                            }
                        });

                        // Update the group object locally with the new list
                        if (newAutoList.length > 0) {
                            // We need to update the record's RoomingList_JSON
                            // Since we can't easily deep update state here without triggering re-renders or complexity,
                            // we'll update the 'group' object clone and let the state settle.
                            // BUT, to persist, we should probably call updateGroupMetadata later or just let user save.
                            // For now, we put it in the object passed to state.
                            group.records[0]["RoomingList_JSON"] = JSON.stringify(newAutoList);
                        }
                    }
                }

                setSelectedGroupFicha(group);
                setShowFichaModal(true);
            };

            const updateGroupMetadata = (name, field, value, hotelFilter = null) => {
                // ... existing implementation ...
                // (I will not touch updateGroupMetadata in this block as it is long, I will jump to addRoomBlock)
            };

            // ... (skipping updateGroupMetadata implementation here as I can't easily match large block without context, I will do separate edits if needed) ...

            // --- Room Manager Logic ---
            const addRoomBlock = () => {
                if (!selectedGroupFicha) return;

                const currentRecord = selectedGroupFicha.records[0] || {};
                let currentList = [];
                try {
                    currentList = JSON.parse(currentRecord["RoomingList_JSON"] || "[]");
                } catch (e) { currentList = []; }

                let nights = 1;
                if (roomManagerForm.dateIn && roomManagerForm.dateOut) {
                    const diff = new Date(roomManagerForm.dateOut) - new Date(roomManagerForm.dateIn);
                    nights = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    if (nights < 1) nights = 1;
                }

                const newItem = {
                    id: editingId || Date.now(),
                    hotel: roomManagerForm.hotel || currentRecord["Hotel_Asignado"] || "Hotel Guadiana", // Default to main hotel if empty
                    type: roomManagerForm.type,
                    dateIn: roomManagerForm.dateIn || currentRecord["Entrada"],
                    dateOut: roomManagerForm.dateOut || currentRecord["Salida"],
                    qty: parseInt(roomManagerForm.qty),
                    regime: roomManagerForm.regime,
                    price: parseFloat(roomManagerForm.price),
                    nights: nights,
                    total: (parseFloat(roomManagerForm.price) * parseInt(roomManagerForm.qty) * nights).toFixed(2)
                };

                let newList;
                if (editingId) {
                    newList = currentList.map(item => item.id === editingId ? newItem : item);
                    setEditingId(null);
                } else {
                    newList = [...currentList, newItem];
                }

                updateGroupMetadata(selectedGroupFicha.name, "RoomingList_JSON", JSON.stringify(newList));
                setRoomManagerForm(prev => ({ ...prev, qty: 1, price: 0 })); // Keep hotel/dates for convenience
            };

            const handleEditRoomBlock = (item) => {
                setRoomManagerForm({
                    hotel: item.hotel || selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "",
                    type: item.type,
                    dateIn: item.dateIn,
                    dateOut: item.dateOut,
                    qty: item.qty,
                    regime: item.regime,
                    price: item.price
                });
                setEditingId(item.id);
            };

            const calculateDeposits = (group, distribution = [30, 40, 30], hotelFilter = null) => {
                // Filtrar registros si es específico de hotel
                const records = hotelFilter
                    ? group.records.filter(r => (r["Hotel_Asignado"] || r["Hotel"]) === hotelFilter)
                    : group.records;

                if (records.length === 0) return;

                // Calcular total sumando los registros del hotel (o todos)
                const total = records.reduce((acc, r) => {
                    const val = parseFloat((r["Importe(*)"] || "0").toString().replace(/\./g, '').replace(',', '.')) || 0;
                    return acc + val;
                }, 0);

                const entrada = records[0]["Entrada"];
                let dateEntrada = new Date();

                if (entrada) {
                    const parts = entrada.includes('/') ? entrada.split('/') : entrada.split('-');
                    if (parts.length === 3) {
                        let d, m, y;
                        if (parts[0].length === 4) { [y, m, d] = parts; } else { [d, m, y] = parts; }
                        dateEntrada = new Date(y, m - 1, d);
                    }
                }

                const defaults = [
                    { label: "Pago Inicial", days: 60 },
                    { label: "Pago Intermedio", days: 30 },
                    { label: "Pago Final", days: 15 }
                ];

                ['Dep1', 'Dep2', 'Dep3'].forEach(k => {
                    updateGroupMetadata(group.name, `${k}_Label`, "", hotelFilter);
                    updateGroupMetadata(group.name, `${k}_Percent`, "", hotelFilter);
                    updateGroupMetadata(group.name, `${k}_Importe`, "", hotelFilter);
                    updateGroupMetadata(group.name, `${k}_Fecha`, "", hotelFilter);
                });

                distribution.forEach((pct, index) => {
                    if (index > 2) return;
                    const key = `Dep${index + 1}`;
                    const amount = (total * (pct / 100)).toFixed(2);
                    const def = defaults[index];

                    const date = new Date(dateEntrada);
                    date.setDate(date.getDate() - def.days);
                    const formattedDate = date.toISOString().split('T')[0];

                    updateGroupMetadata(group.name, `${key}_Label`, def.label, hotelFilter);
                    updateGroupMetadata(group.name, `${key}_Percent`, pct + "%", hotelFilter);
                    updateGroupMetadata(group.name, `${key}_Importe`, amount, hotelFilter);
                    updateGroupMetadata(group.name, `${key}_Fecha`, formattedDate, hotelFilter);
                });
            };

            const addNewRow = () => {
                const emptyRow = {};
                columns.forEach(col => emptyRow[col] = "");
                emptyRow["Entrada"] = new Date().toISOString().split('T')[0];
                setData([emptyRow, ...data]);
            };



            const removeRoomBlock = (id) => {
                if (!selectedGroupFicha) return;
                const currentRecord = selectedGroupFicha.records[0] || {};
                let currentList = [];
                try {
                    currentList = JSON.parse(currentRecord["RoomingList_JSON"] || "[]");
                } catch (e) { return; }

                const newList = currentList.filter(item => item.id !== id);
                updateGroupMetadata(selectedGroupFicha.name, "RoomingList_JSON", JSON.stringify(newList));
            };

            const toggleGroupExpand = (groupName) => {
                if (expandedGroup === groupName) setExpandedGroup(null);
                else setExpandedGroup(groupName);
            };

            const registerNewGroup = () => {
                if (!newGroup["Nombre del Grupo"]) {
                    alert("Por favor, introduce el nombre del grupo.");
                    return;
                }

                let nights = "0";
                if (newGroup.Entrada && newGroup.Salida) {
                    const diffTime = Math.abs(new Date(newGroup.Salida) - new Date(newGroup.Entrada));
                    nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24)).toString();
                }

                const groupToSave = { ...newGroup, "Noches": nights, "Pernoct.": (parseInt(newGroup["Pax."]) * parseInt(nights)).toString() };
                setData([groupToSave, ...data]);
                setShowAddGroupModal(false);
                setNewGroup({
                    "Nombre del Grupo": "",
                    "Entrada": new Date().toISOString().split('T')[0],
                    "Salida": "",
                    "Pax.": "0",
                    "Empresa/Agencia": "",
                    "Segment.": "GRUPOS",
                    "Régimen": "HD",
                    "Importe(*)": "0",
                    "Reserva": Math.floor(Math.random() * 900000 + 100000).toString(),
                    "Estado": "Confirmada"
                });
            };



            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-20">
                        <div className="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-2">
                                <a href="Admin.html" className="p-2 hover:bg-slate-700 rounded-lg transition-colors mr-2" title="Volver al Admin">
                                    <IconChevronLeft size={20} />
                                </a>
                                <div className="bg-white rounded-lg p-1 shadow-sm">
                                    <img src="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png" className="h-10 w-auto object-contain" alt="Logo Nexus" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold">Nexus Groups</h1>
                                    <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Inteligencia Hotelera</p>
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={() => setShowAddGroupModal(true)}
                                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 text-sm"
                                >
                                    <IconPlus size={16} /> Dar de Alta Grupo
                                </button>
                                <label className="bg-white hover:bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-bold shadow-sm border border-blue-200 transition-all flex items-center gap-2 cursor-pointer text-sm">
                                    <IconUpload size={16} /> Importar (CSV/XLS)
                                    <input type="file" className="hidden" accept=".csv, .xlsx, .xls" onChange={handleFileUpload} />
                                </label>
                                <button
                                    onClick={exportCSV}
                                    className="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-bold shadow-sm border border-slate-200 transition-all flex items-center gap-2 text-sm"
                                >
                                    <IconDownload size={16} /> Exportar
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto mt-6 px-4">
                        {/* KPI Cards: ENFOQUE COMERCIAL */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-emerald-500 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Grupos Activos</p>
                                        <p className="text-3xl font-black text-emerald-600 mt-1">{stats.active}</p>
                                    </div>
                                    <div className="p-2 bg-emerald-100 rounded text-emerald-600">
                                        <IconCheck size={20} />
                                    </div>
                                </div>
                                <p className="text-[10px] text-gray-400 mt-2 font-medium">Confirmados / Bloqueados</p>
                            </div>

                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-amber-500 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">En Prospección</p>
                                        <p className="text-3xl font-black text-amber-600 mt-1">{stats.prospects}</p>
                                    </div>
                                    <div className="p-2 bg-amber-100 rounded text-amber-600">
                                        <IconClock size={20} />
                                    </div>
                                </div>
                                <p className="text-[10px] text-gray-400 mt-2 font-medium">Tentativos / Pendientes</p>
                            </div>

                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Anulados</p>
                                        <p className="text-3xl font-black text-red-600 mt-1">{stats.cancelled}</p>
                                    </div>
                                    <div className="p-2 bg-red-100 rounded text-red-600">
                                        <IconX size={20} />
                                    </div>
                                </div>
                                <p className="text-[10px] text-gray-400 mt-2 font-medium">Cancelados / No Materializados</p>
                            </div>

                            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Forecast Total</p>
                                        <p className="text-xl font-black text-blue-700 mt-2 truncate">{stats.revenue}</p>
                                    </div>
                                    <div className="p-2 bg-blue-100 rounded text-blue-600">
                                        <IconChart size={20} />
                                    </div>
                                </div>
                                <p className="text-[10px] text-gray-400 mt-2 font-medium">{stats.pax} Pax Total</p>
                            </div>
                        </div>

                        {/* --- FILTERS TOOLBAR --- */}
                        <div className="bg-white p-3 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-center">
                            <div className="flex items-center gap-2">
                                <input
                                    type="text"
                                    placeholder="🔍 Buscar grupo, agencia, comercial..."
                                    className="border rounded px-2 py-1 text-sm w-60 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Estado:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                >
                                    <option value="all">Todos</option>
                                    <option value="confirmada">Confirmados</option>
                                    <option value="anulada">Anulados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Tiempo:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterTime}
                                    onChange={(e) => setFilterTime(e.target.value)}
                                >
                                    <option value="all">Historico Completo</option>
                                    <option value="future">Futuros (Desde hoy)</option>
                                    <option value="past">Pasados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2 ml-auto">
                                <span className="text-sm font-semibold text-gray-600">Ordenar por:</span>
                                <button onClick={() => requestSort('Entrada')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Entrada' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    📅 Fecha {sortConfig.key === 'Entrada' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                </button>
                                <button onClick={() => requestSort('Importe(*)')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Importe(*)' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    💰 Importe {sortConfig.key === 'Importe(*)' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                </button>
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex gap-4 mb-4 border-b border-gray-300 overflow-x-auto items-center justify-between">
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveTab('calendar')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'calendar' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconCalendar size={18} /> Calendario (Gantt)
                                </button>
                                <button
                                    onClick={() => setActiveTab('groups')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'groups' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconGroup size={18} /> Por Grupos
                                </button>
                                <button
                                    onClick={() => setActiveTab('segments')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'segments' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconPieChart size={18} /> Segmentación
                                </button>
                                <button
                                    onClick={() => setActiveTab('table')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'table' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconTable size={18} /> Validación Importación
                                </button>
                            </div>
                            {/* AI Main Button */}
                            {activeTab !== 'table' && (
                                <button
                                    onClick={handleConsultantClick}
                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm font-bold transition transform hover:scale-105 mb-2 md:mb-0"
                                >
                                    <IconBrain size={18} /> Consultor Virtual
                                    <IconSparkles size={14} />
                                </button>
                            )}
                        </div>

                        {/* --- CONTENT AREA --- */}

                        {/* 1A. CALENDAR (GANTT) VIEW (Priority 1) */}
                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-xl shadow p-4 overflow-hidden animate-fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-800">Calendario de Ocupación (Próximos 90 Días)</h3>
                                    <div className="flex gap-2 text-xs">
                                        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-emerald-500"></div> Confirmado</div>
                                        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-amber-500"></div> Bloqueo/Prospecto</div>
                                        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-red-400 opacity-50"></div> Cancelado</div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto relative pb-4 custom-scrollbar">
                                    <div className="min-w-[1200px]">
                                        {/* Header Days */}
                                        <div className="flex border-b border-slate-200 sticky top-0 bg-white z-20 shadow-sm">
                                            <div className="w-64 p-3 font-bold text-xs text-slate-500 uppercase shrink-0 bg-slate-50 border-r sticky left-0 z-30 shadow-r">Grupo / Hotel</div>
                                            <div className="flex flex-1">
                                                {Array.from({ length: 90 }).map((_, i) => {
                                                    const d = new Date();
                                                    d.setDate(d.getDate() + i);
                                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                                    const isToday = i === 0;
                                                    return (
                                                        <div key={i} className={`flex-1 min-w-[40px] h-12 flex flex-col items-center justify-center border-r border-slate-100 text-[10px] ${isToday ? 'bg-blue-50 border-blue-200' : isWeekend ? 'bg-slate-50' : ''}`}>
                                                            <span className={`font-bold ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{d.getDate()}</span>
                                                            <span className="text-slate-400 text-[8px] uppercase">{d.toLocaleDateString('es-ES', { weekday: 'short' }).slice(0, 2)}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Body Rows */}
                                        <div className="space-y-1 mt-1">
                                            {processedData.length === 0 ? (
                                                <div className="p-12 text-center text-slate-400 flex flex-col items-center">
                                                    <IconCalendar size={48} className="mb-2 opacity-20" />
                                                    <p>No hay grupos para mostrar en este rango con los filtros actuales.</p>
                                                </div>
                                            ) : processedData.map((group, idx) => {
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);

                                                // Parse Dates Robustly
                                                const parseDate = (dStr) => {
                                                    if (!dStr) return null;
                                                    const s = dStr.toString();
                                                    // Handle DD-MM-YYYY or DD/MM/YYYY
                                                    if (s.includes('-') && s.split('-')[0].length <= 2) {
                                                        const [d, m, y] = s.split('-');
                                                        return new Date(`${y}-${m}-${d}`);
                                                    }
                                                    if (s.includes('/') && s.split('/')[0].length <= 2) {
                                                        const [d, m, y] = s.split('/');
                                                        return new Date(`${y}-${m}-${d}`);
                                                    }
                                                    return new Date(s);
                                                };

                                                let start = parseDate(group.Entrada);
                                                let end = parseDate(group.Salida);

                                                if (!start || isNaN(start.getTime())) return null;
                                                if (!end || isNaN(end.getTime())) end = new Date(start);

                                                // Calculate Days from Today (index 0)
                                                const startDiff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
                                                let duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                                if (duration < 1) duration = 1;

                                                // Skip if completely in past or too far future
                                                if (startDiff + duration < 0 || startDiff > 90) return null;

                                                // Calculate Width/Position
                                                let displayStart = startDiff;
                                                let displayDuration = duration;

                                                if (displayStart < 0) {
                                                    displayDuration += displayStart; // Reduce duration by days passed
                                                    displayStart = 0;
                                                }

                                                // Calculate percentages
                                                const leftPercent = (displayStart / 90) * 100;
                                                const widthPercent = (displayDuration / 90) * 100;

                                                // Color Logic
                                                const status = (group["Estado"] || "").toLowerCase();
                                                let colorClass = "bg-blue-500 hover:bg-blue-600";
                                                if (status.includes('confirm')) colorClass = "bg-emerald-500 hover:bg-emerald-600";
                                                else if (status.includes('prospecto') || status.includes('bloq')) colorClass = "bg-amber-500 hover:bg-amber-600";
                                                else if (status.includes('cancel') || status.includes('anula')) colorClass = "bg-red-400 opacity-50";

                                                return (
                                                    <div key={idx} className="flex border-b border-slate-50 hover:bg-slate-50 transition-colors group relative h-14 items-center">
                                                        <div className="w-64 px-3 py-2 text-xs font-medium text-slate-700 border-r border-slate-100 shrink-0 sticky left-0 bg-white z-10 group-hover:bg-slate-50 shadow-r h-full flex flex-col justify-center">
                                                            <div className="truncate font-bold text-slate-800">{group["Nombre del Grupo"]}</div>
                                                            <div className="flex items-center gap-1 text-[9px] text-slate-400 mt-0.5">
                                                                <IconBuildingSkyscraper size={10} />
                                                                <span className="truncate max-w-[120px]">{group["Hotel_Asignado"] || group["Hotel"] || "N/A"}</span>
                                                                {group["Importe(*)"] && <span className="text-emerald-600 font-bold ml-auto">{parseFloat(group["Importe(*)"]).toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0, minimumFractionDigits: 0 })}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="flex-1 relative h-full"> {/* Row Track */}
                                                            {/* Grid Lines Background */}
                                                            <div className="absolute inset-0 flex pointer-events-none">
                                                                {Array.from({ length: 90 }).map((_, i) => {
                                                                    const d = new Date();
                                                                    d.setDate(d.getDate() + i);
                                                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                                                    return <div key={i} className={`flex-1 border-r border-slate-50 ${isWeekend ? 'bg-slate-50/50' : ''}`}></div>
                                                                })}
                                                            </div>

                                                            {/* The Bar */}
                                                            {widthPercent > 0 && (
                                                                <div
                                                                    className={`absolute h-8 rounded-lg shadow-sm ${colorClass} text-white text-[9px] flex items-center px-3 whitespace-nowrap overflow-hidden cursor-pointer transition-all z-0 top-3`}
                                                                    style={{ left: `${leftPercent}%`, width: `${widthPercent}%`, minWidth: '4px' }}
                                                                    onClick={() => openFicha(group)}
                                                                    title={`${group["Nombre del Grupo"]}\n${start.toLocaleDateString()} - ${end.toLocaleDateString()}\n${group["Pax."]} Pax`}
                                                                >
                                                                    <span className="font-bold truncate drop-shadow-md">{group["Nombre del Grupo"]}</span>
                                                                    {displayDuration > 5 && <span className="opacity-80 ml-2 text-[8px] font-normal">{group["Pax."]} Pax</span>}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. SEGMENTATION ANALYSIS (NEW) */}
                        {activeTab === 'segments' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Ingresos por Segmento</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={segmentStats} layout="vertical" margin={{ left: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                <XAxis type="number" hide />
                                                <YAxis type="category" dataKey="name" width={100} tick={{ fontSize: 11 }} interval={0} />
                                                <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                                <Bar dataKey="revenue" fill="#8884d8" radius={[0, 4, 4, 0]}>
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Distribución de Pax (Volumen)</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={segmentStats}
                                                    dataKey="pax"
                                                    nameKey="name"
                                                    cx="50%"
                                                    cy="50%"
                                                    outerRadius={80}
                                                    label={({ name, percent }) => `${(percent * 100).toFixed(0)}%`}
                                                >
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Detailed Table */}
                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="p-4 border-b bg-slate-50">
                                        <h3 className="text-lg font-bold text-slate-700">Tabla de Rentabilidad por Segmento</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs">
                                                <tr>
                                                    <th className="p-3 w-10"></th>
                                                    <th className="p-3">Segmento</th>
                                                    <th className="p-3 text-right"># Grupos</th>
                                                    <th className="p-3 text-right">Pax Total</th>
                                                    <th className="p-3 text-right">Noches Totales</th>
                                                    <th className="p-3 text-right">Ingresos Totales</th>
                                                    <th className="p-3 text-right">ADR Medio</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {segmentStats.map((seg, idx) => (
                                                    <React.Fragment key={idx}>
                                                        <tr className="hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => setExpandedSegment(expandedSegment === seg.name ? null : seg.name)}>
                                                            <td className="p-3 text-center text-gray-400">
                                                                {expandedSegment === seg.name ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />}
                                                            </td>
                                                            <td className="p-3 font-medium text-slate-800 flex items-center gap-2">
                                                                <span className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[idx % COLORS.length] }}></span>
                                                                {seg.name}
                                                            </td>
                                                            <td className="p-3 text-right font-bold text-blue-600">{seg.groupCount}</td>
                                                            <td className="p-3 text-right">{seg.pax}</td>
                                                            <td className="p-3 text-right">{seg.nights}</td>
                                                            <td className="p-3 text-right font-bold text-slate-700">
                                                                {seg.revenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                            <td className="p-3 text-right text-emerald-600 font-bold">
                                                                {(seg.nights > 0 ? (seg.revenue / seg.nights) : 0).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                        </tr>
                                                        {expandedSegment === seg.name && (
                                                            <tr>
                                                                <td colSpan="7" className="p-0 bg-slate-50">
                                                                    <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                                        {seg.groups.map((groupName, gIdx) => {
                                                                            const groupObj = groupedData.find(g => g.name === groupName);
                                                                            return (
                                                                                <div
                                                                                    key={gIdx}
                                                                                    onClick={() => groupObj && openFicha(groupObj)}
                                                                                    className="bg-white p-2 rounded border border-slate-200 shadow-sm hover:border-blue-500 hover:shadow-md transition-all cursor-pointer group"
                                                                                >
                                                                                    <div className="flex justify-between items-center mb-1">
                                                                                        <span className="text-[10px] font-black text-slate-400 tracking-wider">#{groupObj?.records[0]?.["Reserva"] || "-"}</span>
                                                                                        <span className="text-[9px] font-bold text-slate-500 bg-slate-100 px-1.5 rounded uppercase">{groupObj?.records[0]?.["Hotel"] || groupObj?.records[0]?.["Hotel_Asignado"] || "S/H"}</span>
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center">
                                                                                        <span className="text-xs font-bold text-slate-800 group-hover:text-blue-600 truncate">{groupName}</span>
                                                                                        <IconChevronRight size={14} className="text-slate-300 group-hover:text-blue-500" />
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. GROUP ANALYSIS */}
                        {/* 3. GROUP DIRECTORY */}
                        {activeTab === 'groups' && (
                            <div className="animate-fade-in space-y-4">
                                {/* Header del Directorio con Nuevos Filtros */}
                                <div className="bg-white rounded-2xl shadow-sm p-6 flex flex-col gap-4">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div>
                                            <h2 className="text-2xl font-black text-slate-800 tracking-tight">Gestión de Grupos</h2>
                                            <p className="text-sm text-slate-500 font-medium">Gestión unificada de grupos confirmados, bloqueados y enviados.</p>
                                        </div>
                                        <button
                                            onClick={() => setShowAddGroupModal(true)}
                                            className="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-emerald-900/10 transition-all flex items-center gap-2"
                                        >
                                            <IconPlus size={18} /> Nuevo Grupo
                                        </button>
                                    </div>

                                    {/* Barra de Herramientas de Filtrado */}
                                    <div className="flex flex-col md:flex-row gap-3">
                                        {/* Buscador */}
                                        <div className="relative flex-1">
                                            <IconSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                            <input
                                                type="text"
                                                placeholder="Buscar por nombre..."
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#2d5a43] transition-all"
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                            />
                                        </div>

                                        {/* Filtro Hotel */}
                                        <div className="md:w-48">
                                            <select
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all appearance-none cursor-pointer"
                                                value={filterDirHotel}
                                                onChange={(e) => setFilterDirHotel(e.target.value)}
                                            >
                                                <option value="">Todos los Hoteles</option>
                                                {[...new Set(groupedData.map(g => {
                                                    const h = g.records[0]?.["Hotel_Asignado"] || g.records[0]?.["Hotel"];
                                                    return h && h.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : h;
                                                }).filter(Boolean))].sort().map(h => (
                                                    <option key={h} value={h}>{h}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Filtro Comercial */}
                                        <div className="md:w-48">
                                            <select
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all appearance-none cursor-pointer"
                                                value={filterDirCommercial}
                                                onChange={(e) => setFilterDirCommercial(e.target.value)}
                                            >
                                                <option value="">Todos los Comerciales</option>
                                                {[...new Set(groupedData.map(g => {
                                                    const c = g.records[0]?.["Com_Comercial"];
                                                    return c ? (c.charAt(0).toUpperCase() + c.slice(1).toLowerCase()) : null;
                                                }).filter(Boolean))].sort().map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Listado de Grupos - VISTA DE TABLA (LINEAS) */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-50 border-b border-slate-200 text-xs font-black text-slate-400 uppercase tracking-wider">
                                                <th className="px-6 py-4 font-black">Hotel</th>
                                                <th className="px-6 py-4 font-black">Grupo / ID</th>
                                                <th className="px-6 py-4 font-black">Entrada</th>
                                                <th className="px-6 py-4 font-black">Salida</th>
                                                <th className="px-6 py-4 font-black text-center">Pax</th>
                                                <th className="px-6 py-4 font-black text-right">Importe</th>
                                                <th className="px-6 py-4 font-black text-center">Estado</th>
                                                <th className="px-6 py-4 font-black text-right">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {groupedData
                                                .filter(g => {
                                                    // 1. Buscador Texto
                                                    if (searchTerm && !g.name.toLowerCase().includes(searchTerm.toLowerCase())) return false;

                                                    const status = (g.records[0]?.["Com_Estado_Interno"] || g.status || "").toUpperCase();
                                                    // 2. Excluir Cancelados/Anulados
                                                    if (status.includes("ANUL") || status.includes("CANC")) return false;

                                                    // 3. Excluir Pasados
                                                    const today = new Date().toISOString().split('T')[0];
                                                    if (g.departure < today) return false;

                                                    // 4. Filtro Hotel
                                                    if (filterDirHotel) {
                                                        const raw = g.records[0]?.["Hotel_Asignado"] || g.records[0]?.["Hotel"];
                                                        const hotel = raw && raw.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : raw;
                                                        if (hotel !== filterDirHotel) return false;
                                                    }

                                                    // 5. Filtro Comercial
                                                    if (filterDirCommercial) {
                                                        const rawC = g.records[0]?.["Com_Comercial"];
                                                        const normalizedC = rawC ? (rawC.charAt(0).toUpperCase() + rawC.slice(1).toLowerCase()) : "";
                                                        if (normalizedC !== filterDirCommercial) return false;
                                                    }

                                                    return true;
                                                })
                                                .map((group, idx) => {
                                                    const status = group.records[0]?.["Com_Estado_Interno"] || "PROSPECTO";
                                                    let statusColor = "bg-slate-100 text-slate-500";
                                                    if (status === 'CONFIRMADO') statusColor = "bg-emerald-100 text-emerald-700";
                                                    if (status === 'BLOQUEADO') statusColor = "bg-indigo-100 text-indigo-700";
                                                    if (status === 'ENVIADO') statusColor = "bg-amber-100 text-amber-700";

                                                    // Normalizar nombre hotel para visualización
                                                    const rawHotel = group.records[0]?.["Hotel_Asignado"] || "Hotel Guadiana";
                                                    const displayHotel = rawHotel.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : rawHotel;

                                                    return (
                                                        <tr
                                                            key={idx}
                                                            className="hover:bg-slate-50 transition-colors cursor-pointer group"
                                                            onClick={() => openFicha(group)}
                                                        >
                                                            {/* HOTEL */}
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="p-2 bg-white border border-slate-100 rounded-lg shadow-sm">
                                                                        <IconBuildingSkyscraper size={16} className="text-slate-400" />
                                                                    </div>
                                                                    <span className="text-[10px] font-black text-slate-500 uppercase tracking-wide">
                                                                        {displayHotel}
                                                                    </span>
                                                                </div>
                                                            </td>

                                                            {/* GRUPO / ID */}
                                                            <td className="px-6 py-4">
                                                                <div>
                                                                    <div className="text-sm font-black text-slate-800 group-hover:text-[#2d5a43] transition-colors">{group.name}</div>
                                                                    <div className="text-[10px] font-bold text-slate-400 mt-0.5">
                                                                        ID: {group.records[0]?.["Reserva"] || "---"}
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            {/* FECHAS */}
                                                            <td className="px-6 py-4">
                                                                <div className="text-xs font-bold text-slate-600">{formatDate(group.arrival)}</div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="text-xs font-bold text-slate-600">{formatDate(group.departure)}</div>
                                                            </td>

                                                            {/* PAX */}
                                                            <td className="px-6 py-4 text-center">
                                                                <span className="inline-flex items-center justify-center min-w-[30px] h-[30px] rounded-lg bg-blue-50 text-blue-700 text-xs font-black">
                                                                    {group.totalPax}
                                                                </span>
                                                            </td>

                                                            {/* IMPORTE */}
                                                            <td className="px-6 py-4 text-right">
                                                                <div className="text-sm font-black text-slate-700">
                                                                    {group.totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}
                                                                </div>
                                                            </td>

                                                            {/* ESTADO */}
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${statusColor}`}>
                                                                    {status}
                                                                </span>
                                                            </td>

                                                            {/* ACCIONES */}
                                                            <td className="px-6 py-4 text-right">
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); handleProformaClick(group); }}
                                                                    className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"
                                                                    title="Ver Proforma"
                                                                >
                                                                    <IconFile size={16} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                        {groupedData.length === 0 && (
                                            <tbody>
                                                <tr>
                                                    <td colSpan="8" className="px-6 py-12 text-center text-slate-400 text-sm font-medium opacity-60">
                                                        No hay grupos activos que coincidan con los filtros.
                                                    </td>
                                                </tr>
                                            </tbody>
                                        )}
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 4. RAW DATA EDITOR */}
                        {activeTab === 'table' && (
                            <div className="bg-white rounded-lg shadow flex flex-col h-[70vh] animate-fade-in">
                                {/* Table Toolbar */}
                                <div className="p-4 border-b flex flex-wrap gap-4 justify-between items-center">
                                    <input
                                        type="text"
                                        placeholder="Buscar en todos los campos..."
                                        className="border rounded px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <div className="flex gap-2">
                                        {data.filter(r => r._diff).length > 0 && (
                                            <button
                                                onClick={() => {
                                                    if (window.confirm(`¿Estás seguro de que quieres autorizar los ${data.filter(r => r._diff).length} cambios detectados?`)) {
                                                        acceptChanges();
                                                    }
                                                }}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow-md transition flex items-center gap-2"
                                            >
                                                <IconCheck size={16} /> Autorizar Cambios ({data.filter(r => r._diff).length})
                                            </button>
                                        )}
                                        <button onClick={addNewRow} className="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Fila
                                        </button>
                                        <button onClick={() => setShowColumnModal(true)} className="bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Columna
                                        </button>
                                    </div>
                                </div>

                                {/* Table Container */}
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left text-sm border-collapse">
                                        <thead className="bg-slate-50 text-slate-600 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="p-3 font-bold border-b w-64 bg-slate-100 z-20">ACCIÓN REQUERIDA / CAMBIOS</th>
                                                <th className="p-3 font-semibold border-b">RESERVA</th>
                                                <th className="p-3 font-semibold border-b">GRUPO / TITULAR</th>
                                                <th className="p-3 font-semibold border-b">ENTRADA</th>
                                                <th className="p-3 font-semibold border-b">ESTADO</th>
                                                <th className="p-3 font-semibold border-b text-center">PAX</th>
                                                <th className="p-3 font-semibold border-b">SEGMENTO</th>
                                                <th className="p-3 font-semibold border-b text-right">IMPORTE</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {data
                                                .map((row, absIndex) => ({ row, absIndex }))
                                                .filter(({ row }) => row._diff)
                                                .map(({ row, absIndex }) => {
                                                    let rowClass = "hover:bg-slate-50 transition-colors group";
                                                    let badge = null;
                                                    let btnColor = "bg-slate-800 hover:bg-slate-900";
                                                    let changeDetails = [];

                                                    if (row._diff === "new") {
                                                        rowClass += " bg-green-50/30";
                                                        badge = <span className="text-green-600 font-black text-[10px] uppercase">NUEVO</span>;
                                                        btnColor = "bg-green-600 hover:bg-green-700";
                                                        changeDetails.push("Nuevo registro importado");
                                                    } else if (row._diff === "cancelled") {
                                                        rowClass += " bg-red-50/30";
                                                        badge = <span className="text-red-600 font-black text-[10px] uppercase">CANCELAR</span>;
                                                        btnColor = "bg-red-600 hover:bg-red-700";
                                                        changeDetails.push("Estado cambiado a ANULADA");
                                                    } else if (row._diff === "modified") {
                                                        rowClass += " bg-blue-50/30";
                                                        badge = <span className="text-blue-600 font-black text-[10px] uppercase">MODIFICADO</span>;
                                                        btnColor = "bg-blue-600 hover:bg-blue-700";

                                                        // Render specific changes
                                                        if (row._changes) {
                                                            Object.keys(row._changes).forEach(k => {
                                                                const ch = row._changes[k];
                                                                changeDetails.push(`${k}: ${ch.old} → ${ch.new}`);
                                                            });
                                                        } else {
                                                            changeDetails.push("Datos actualizados");
                                                        }
                                                    }

                                                    return (
                                                        <tr key={String(row.Reserva)} className={rowClass}>
                                                            <td className="p-3 border-b border-r border-slate-200 bg-white/50 sticky left-0 z-10 w-64 align-top">
                                                                <div className="flex flex-col gap-2">
                                                                    <div className="flex gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                const reservaID = String(row["Reserva"]);
                                                                                const confirmMsg = row._diff === 'cancelled' ?
                                                                                    `¿Confirmas la CANCELACIÓN del grupo ${row["Nombre del Grupo"]}?` :
                                                                                    `¿Confirmas la actualización del grupo ${row["Nombre del Grupo"]}?`;

                                                                                if (window.confirm(confirmMsg)) {
                                                                                    console.log("⚡ INICIANDO AUTORIZACIÓN:", reservaID);

                                                                                    // Bloquear en la referencia para el listener onSnapshot
                                                                                    authorizingIds.current.add(reservaID.trim());

                                                                                    // Guardar estado previo para posible rollback
                                                                                    const rowStateBefore = { ...row };

                                                                                    // OPTIMISTIC UPDATE: Quitar el diff inmediatamente
                                                                                    setData(prevData => {
                                                                                        return prevData.map(r =>
                                                                                            String(r.Reserva).trim() === reservaID.trim()
                                                                                                ? { ...r, _diff: null, _changes: null }
                                                                                                : r
                                                                                        );
                                                                                    });

                                                                                    const batch = db.batch();
                                                                                    // Sanitize: eliminar campos internos y undefined
                                                                                    const cleanedRow = {};
                                                                                    Object.keys(row).forEach(k => {
                                                                                        if (!k.startsWith('_') && row[k] !== undefined) {
                                                                                            cleanedRow[k] = row[k];
                                                                                        }
                                                                                    });

                                                                                    const docRef = db.collection("groups").doc(reservaID);
                                                                                    batch.set(docRef, {
                                                                                        ...cleanedRow,
                                                                                        _diff: firebase.firestore.FieldValue.delete(),
                                                                                        _changes: firebase.firestore.FieldValue.delete(),
                                                                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                                                    }, { merge: true });

                                                                                    console.log("📡 Enviando a Firestore...", reservaID);
                                                                                    batch.commit().then(() => {
                                                                                        console.log("✅ GUARDADO EXITOSO:", reservaID);
                                                                                        // Mantener el bloqueo unos segundos para evitar flasheos de onSnapshot
                                                                                        setTimeout(() => {
                                                                                            authorizingIds.current.delete(reservaID.trim());
                                                                                        }, 2000);
                                                                                    }).catch(err => {
                                                                                        console.error("❌ ERROR AL GUARDAR:", err);
                                                                                        alert("Error al guardar: " + err.message);
                                                                                        authorizingIds.current.delete(reservaID.trim());
                                                                                        // ROLLBACK: Restaurar el diff si falló
                                                                                        setData(prevData => {
                                                                                            return prevData.map(r =>
                                                                                                String(r.Reserva).trim() === reservaID.trim()
                                                                                                    ? rowStateBefore
                                                                                                    : r
                                                                                            );
                                                                                        });
                                                                                    });
                                                                                }
                                                                            }}
                                                                            className={`flex-1 py-1.5 rounded shadow-sm text-white font-bold text-[10px] flex items-center justify-center gap-1.5 transition-transform active:scale-95 ${btnColor}`}
                                                                        >
                                                                            <IconCheck size={12} stroke={3} /> {badge} - AUTORIZAR
                                                                        </button>
                                                                        <button
                                                                            onClick={() => {
                                                                                if (window.confirm("¿Descartar este cambio sugerido?")) {
                                                                                    const reservaID = String(row["Reserva"]);
                                                                                    setData(prevData => {
                                                                                        return prevData.map(r =>
                                                                                            String(r.Reserva) === reservaID
                                                                                                ? { ...r, _diff: null, _changes: null }
                                                                                                : r
                                                                                        );
                                                                                    });
                                                                                }
                                                                            }}
                                                                            className="px-2 bg-slate-200 text-slate-500 rounded hover:bg-slate-300 transition"
                                                                            title="Descartar"
                                                                        >
                                                                            <IconX size={12} />
                                                                        </button>
                                                                    </div>
                                                                    {/* Change Details */}
                                                                    <div className="text-[9px] text-slate-500 font-mono bg-white p-1.5 rounded border border-slate-100 shadow-sm leading-relaxed whitespace-pre-wrap">
                                                                        {changeDetails.map((d, i) => (
                                                                            <div key={i} className={d.includes('→') ? 'text-blue-600 font-bold' : ''}>• {d}</div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-3 border-b font-mono text-xs font-bold text-slate-500 align-top">{row["Reserva"]}</td>
                                                            <td className="p-3 border-b font-bold text-slate-700 text-xs align-top">{row["Nombre del Grupo"] || row["Empresa/Agencia"]}</td>
                                                            <td className="p-3 border-b text-xs align-top">{formatDate(row["Entrada"])}</td>
                                                            <td className="p-3 border-b text-xs font-bold align-top">{row["Estado"]}</td>
                                                            <td className="p-3 border-b text-center text-xs align-top">{row["Pax."]}</td>
                                                            <td className="p-3 border-b text-xs align-top font-semibold text-slate-600 uppercase">{row["Segment."]}</td>
                                                            <td className="p-3 border-b text-right text-xs font-mono align-top">{row["Importe(*)"]}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                        {data.filter(r => r._diff).length === 0 && (
                                            <tbody>
                                                <tr>
                                                    <td colSpan={columns.length + 1} className="p-12 text-center text-slate-400">
                                                        <div className="flex flex-col items-center gap-2">
                                                            <IconCheck size={48} className="text-emerald-200" />
                                                            <p className="font-bold text-lg text-slate-600">Todo Sincronizado</p>
                                                            <p className="text-sm">No hay cambios pendientes de revisión.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        )}
                                    </table>
                                </div>
                                <div className="p-2 border-t text-xs text-gray-500 text-center bg-slate-50 flex justify-between items-center px-4">
                                    <span>Mostrando solo registros con cambios ({data.filter(r => r._diff).length})</span>
                                    <div className="flex gap-4">
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-green-500"></div> Nuevo</div>
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div> Modificado</div>
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div> Cancelado</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal Añadir Columna */}
                    {showColumnModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-96">
                                <h3 className="text-lg font-bold mb-4">Añadir Nueva Columna</h3>
                                <input
                                    type="text"
                                    placeholder="Nombre (ej. Estado, Notas)"
                                    className="w-full border p-2 rounded mb-4"
                                    value={newColumnName}
                                    onChange={(e) => setNewColumnName(e.target.value)}
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowColumnModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button onClick={addNewColumn} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Añadir</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Añadir Grupo Manual */}
                    {showAddGroupModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl animate-fade-in overflow-hidden">
                                <div className="bg-[#2d5a43] p-6 text-white flex justify-between items-center">
                                    <div>
                                        <h3 className="text-xl font-bold">Registro de Nuevo Grupo</h3>
                                        <p className="text-emerald-100/70 text-xs">Introduce los detalles de la reserva manual</p>
                                    </div>
                                    <button onClick={() => setShowAddGroupModal(false)} className="text-white/60 hover:text-white transition-colors">
                                        <IconPlus className="rotate-45" size={24} />
                                    </button>
                                </div>
                                <div className="p-8 grid grid-cols-2 gap-6">
                                    <div className="col-span-2">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nombre del Grupo</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold transition-colors"
                                            placeholder="Ej: Boda Familia García / Congreso Médico"
                                            value={newGroup["Nombre del Grupo"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Nombre del Grupo": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entrada</label>
                                        <input
                                            type="date"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup.Entrada}
                                            onChange={(e) => setNewGroup({ ...newGroup, Entrada: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Salida</label>
                                        <input
                                            type="date"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup.Salida}
                                            onChange={(e) => setNewGroup({ ...newGroup, Salida: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Pax Totales</label>
                                        <input
                                            type="number"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Pax."]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Pax.": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Importe Total (€)</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            placeholder="0,00"
                                            value={newGroup["Importe(*)"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Importe(*)": e.target.value })}
                                        />
                                    </div>
                                    <div className="col-span-1">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Agencia / Empresa</label>
                                        <input
                                            type="text"
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Empresa/Agencia"]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Empresa/Agencia": e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Segmento</label>
                                        <select
                                            className="w-full border-b-2 border-slate-100 focus:border-[#2d5a43] outline-none py-2 text-slate-700 font-semibold"
                                            value={newGroup["Segment."]}
                                            onChange={(e) => setNewGroup({ ...newGroup, "Segment.": e.target.value })}
                                        >
                                            <option value="GRUPOS">GRUPOS</option>
                                            <option value="DEPORTIVO">DEPORTIVO</option>
                                            <option value="TOUR-OPERACIÓN">TOUR-OPERACIÓN</option>
                                            <option value="BODA/CELEBRACIÓN">BODA/CELEBRACIÓN</option>
                                            <option value="CONGRESO">CONGRESO</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="p-6 bg-slate-50 border-t flex gap-3">
                                    <button
                                        onClick={() => setShowAddGroupModal(false)}
                                        className="flex-1 py-4 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-100 transition-all uppercase text-xs tracking-widest"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={registerNewGroup}
                                        className="flex-[2] py-4 bg-[#2d5a43] text-white font-bold rounded-xl hover:bg-[#1e3a2c] transition-all shadow-lg shadow-emerald-900/10 uppercase text-xs tracking-widest"
                                    >
                                        Confirmar Alta
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Resultados IA */}
                    {showAiModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col animate-fade-in">
                                <div className="p-4 border-b bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-t-lg flex justify-between items-center">
                                    <h3 className="font-bold flex items-center gap-2">
                                        <IconBrain className="text-purple-300" />
                                        {aiResult ? aiResult.title : "Analizando datos..."}
                                    </h3>
                                    <button onClick={() => setShowAiModal(false)} className="text-slate-400 hover:text-white">&times;</button>
                                </div>
                                <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                                    {isAiLoading ? (
                                        <div className="flex flex-col items-center justify-center py-10">
                                            <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                            <p className="text-slate-500 animate-pulse-slow text-center">
                                                Gemini está analizando tus reservas... <br />
                                                <span className="text-xs">Buscando patrones y rentabilidad.</span>
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="prose prose-sm max-w-none text-slate-700" dangerouslySetInnerHTML={{ __html: marked.parse(aiResult?.content || "") }}></div>
                                    )}
                                </div>
                                <div className="p-4 border-t bg-slate-50 text-right rounded-b-lg">
                                    <button onClick={() => setShowAiModal(false)} className="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded transition">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showFichaModal && selectedGroupFicha && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-2">
                            <div className="bg-white rounded-xl shadow-2xl w-[98vw] h-[95vh] overflow-hidden flex flex-col animate-fade-in border border-slate-200 text-sm">
                                {/* CENTRO DE MANDO NEXUS (Header + Acciones) */}
                                <div className="bg-[#0f172a] text-white p-3 border-b border-white/10 shrink-0">
                                    <div className="flex justify-between items-start gap-4">
                                        <div className="flex gap-3">
                                            <div className="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20 shrink-0">
                                                <IconUsers size={20} />
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-xl font-black tracking-tight leading-none text-emerald-400">{selectedGroupFicha.name || "NOMBRE DEL GRUPO"}</h3>
                                                    <span className={`px-2 py-0.5 rounded text-[8px] font-black uppercase ${(selectedGroupFicha.records[0]?.["Estado"] || "").toLowerCase().includes('conf') ? 'bg-emerald-400 text-slate-900' : 'bg-orange-400 text-slate-900'}`}>
                                                        {selectedGroupFicha.records[0]?.["Estado"] || 'PROSPECTO'}
                                                    </span>
                                                    <span className="bg-white/10 px-2 py-0.5 rounded text-[8px] font-black text-white/80 uppercase">
                                                        {selectedGroupFicha.records[0]?.["Régimen"] || 'HD'}
                                                    </span>
                                                    <span className="bg-blue-500/20 px-2 py-0.5 rounded text-[8px] font-black text-blue-200 uppercase border border-blue-500/30">
                                                        {selectedGroupFicha.records[0]?.["Segment."] || 'GRUPOS'}
                                                    </span>
                                                </div>
                                                <p className="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1">
                                                    {selectedGroupFicha.records[0]?.["Empresa/Agencia"] || 'VENTA DIRECTA'} • {selectedGroupFicha.totalPax} PAX • REF: {selectedGroupFicha.records[0]?.["Reserva"]}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    // Ensure we are passing the most up-to-date record which contains all metadata updates
                                                    const baseRecord = selectedGroupFicha.records[0] || {};

                                                    // Recalculate Forecast for Proforma to ensure sync with Tarifa Neta
                                                    const neto = parseFloat(baseRecord["Com_Precio"] || "0");
                                                    const pax = parseInt(selectedGroupFicha.totalPax || 0);
                                                    const noches = parseInt(selectedGroupFicha.totalNights || 1);
                                                    const calculatedImporte = neto > 0 ? (neto * pax * noches).toFixed(2) : (selectedGroupFicha.totalRevenue || baseRecord["Importe(*)"]);

                                                    const proformaData = {
                                                        ...baseRecord,
                                                        "Importe(*)": calculatedImporte,
                                                        "Pax.": selectedGroupFicha.totalPax || baseRecord["Pax."],
                                                        "Hotel_Asignado": baseRecord["Hotel_Asignado"] || baseRecord["Hotel"] || "Guadiana",
                                                        "Email": selectedGroupFicha.email || baseRecord["Email"] || "",
                                                        "Nombre del Grupo": selectedGroupFicha.name || baseRecord["Nombre del Grupo"]
                                                    };

                                                    // Map Room Manager items to Proforma Items if they exist
                                                    try {
                                                        const roomList = JSON.parse(baseRecord["RoomingList_JSON"] || "[]");
                                                        if (roomList.length > 0) {
                                                            const mappedItems = roomList.map(r => ({
                                                                fecha: r.dateIn,
                                                                hab: r.qty.toString(),
                                                                cant: '',
                                                                concepto: `${r.type} (${r.regime})`,
                                                                precio: parseFloat(r.price),
                                                                iva: 10
                                                            }));
                                                            proformaData["ProformaItems"] = mappedItems;
                                                            proformaData["Importe(*)"] = roomList.reduce((acc, r) => acc + parseFloat(r.total), 0).toFixed(2);
                                                        }
                                                    } catch (e) { console.error("Error mapping room list", e); }

                                                    localStorage.setItem('selectedGroup', JSON.stringify(proformaData));
                                                    window.location.href = 'Fac Prof.html';
                                                }}
                                                className="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-emerald-500/20"
                                            >
                                                <IconTable size={12} /> PROFORMA / FACTURA
                                            </button>
                                            <button
                                                onClick={() => handleEmailClick(selectedGroupFicha)}
                                                className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-blue-600/20"
                                            >
                                                <IconMail size={12} /> REDACTAR EMAIL IA
                                            </button>
                                            <button
                                                onClick={() => setShowFichaModal(false)}
                                                className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-red-500/20"
                                            >
                                                <IconX size={12} /> SALIR
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar bg-slate-50/50">
                                    {/* DASHBOARD COMERCIAL HORIZONTAL - FORZADO CON GRID INLINE */}
                                    {/* DASHBOARD INTELIGENTE */}
                                    {(() => {
                                        const now = new Date();
                                        let daysToArrival = 0;

                                        // Robust Date Parsing for Arrival
                                        if (selectedGroupFicha.arrival) {
                                            const d = new Date(selectedGroupFicha.arrival);
                                            if (!isNaN(d.getTime())) {
                                                const diffTime = d - now;
                                                daysToArrival = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                            }
                                        }

                                        const releaseDateStr = selectedGroupFicha.records[0]?.["Com_Vencimiento_Rel"];
                                        let daysToRelease = null;
                                        if (releaseDateStr) {
                                            const releaseDate = new Date(releaseDateStr);
                                            if (!isNaN(releaseDate.getTime())) {
                                                daysToRelease = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
                                            }
                                        }

                                        const neto = parseFloat(selectedGroupFicha.records[0]?.["Com_Precio"] || "0");
                                        const pax = parseInt(selectedGroupFicha.totalPax || 0);
                                        const noches = parseInt(selectedGroupFicha.totalNights || 1);
                                        // Auto-calculate forecast if Net Rate is input, otherwise use Importe(*)
                                        const forecastVal = neto > 0 ? (neto * pax * noches).toFixed(2) : selectedGroupFicha.totalRevenue;

                                        return (
                                            <div className="flex flex-col gap-2 mb-2">
                                                {/* HEADER COMPACTO: ESTADO Y DATOS CLAVE */}
                                                <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                    {/* Estado */}
                                                    {/* Estado */}
                                                    <div className="w-40 relative">
                                                        <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Estado del Grupo</label>
                                                        <div className="relative h-10 w-full">
                                                            <select
                                                                className={`w-full h-full pl-3 pr-8 text-xs font-black uppercase rounded-lg text-white appearance-none outline-none border-2 border-transparent transition-all shadow-md cursor-pointer ${(selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto") === 'CONFIRMADO' ? 'bg-emerald-500 hover:bg-emerald-600' :
                                                                    (selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto") === 'BLOQUEADO' ? 'bg-indigo-500 hover:bg-indigo-600' :
                                                                        (selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto") === 'ENVIADO' ? 'bg-amber-400 hover:bg-amber-500 text-amber-900' :
                                                                            (selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto") === 'CANCELADO' ? 'bg-red-500 hover:bg-red-600' :
                                                                                'bg-slate-500 hover:bg-slate-600'
                                                                    }`}
                                                                value={selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || "Prospecto"}
                                                                onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Estado_Interno", e.target.value)}
                                                                style={{ WebkitAppearance: 'none', MozAppearance: 'none' }} // Force appearance-none
                                                            >
                                                                <option className="bg-white text-slate-800 font-bold" value="PROSPECTO">PROSPECTO</option>
                                                                <option className="bg-white text-slate-800 font-bold" value="ENVIADO">ENVIADO</option>
                                                                <option className="bg-white text-indigo-600 font-bold" value="BLOQUEADO">BLOQUEADO</option>
                                                                <option className="bg-white text-emerald-600 font-bold" value="CONFIRMADO">CONFIRMADO</option>
                                                                <option className="bg-white text-red-600 font-bold" value="CANCELADO">CANCELADO</option>
                                                            </select>
                                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-white/80">
                                                                <IconChevronDown size={14} stroke={3} />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Botón Datos Cliente */}
                                                    {/* Botón Datos Cliente + Segmentación */}
                                                    <div className="flex-1 flex gap-2">
                                                        <button
                                                            onClick={() => setShowClientData(true)}
                                                            className="flex-1 flex flex-col justify-center px-3 py-1 bg-white border border-blue-200 hover:border-blue-400 rounded group transition-all relative overflow-hidden"
                                                        >
                                                            {/* Segmentación como Marca de Agua / Etiqueta Flotante */}
                                                            <div className="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[9px] font-black px-2 py-0.5 rounded-bl shadow-sm border-b border-l border-blue-200 uppercase tracking-wider">
                                                                {selectedGroupFicha.records[0]?.["Segment."] || 'GRUPOS'}
                                                            </div>

                                                            <div className="flex items-center gap-1.5 mt-2">
                                                                <div className="bg-blue-100 p-1 rounded-full text-blue-600">
                                                                    <IconUsers size={12} />
                                                                </div>
                                                                <div className="text-left w-full overflow-hidden">
                                                                    <div className="text-[9px] font-black text-slate-400 uppercase leading-none mb-0.5">
                                                                        Cliente / Agencia
                                                                    </div>
                                                                    <div className="text-xs font-bold text-slate-800 truncate w-full pr-16" title={selectedGroupFicha.records[0]?.["Fiscal_RazonSocial"] || selectedGroupFicha.records[0]?.["Empresa/Agencia"] || "Sin Datos"}>
                                                                        {selectedGroupFicha.records[0]?.["Fiscal_RazonSocial"] || selectedGroupFicha.records[0]?.["Empresa/Agencia"] || "Indefinido"}
                                                                    </div>
                                                                </div>
                                                                <IconMore size={16} className="text-slate-300 group-hover:text-blue-500 ml-auto" />
                                                            </div>
                                                        </button>
                                                    </div>

                                                    {/* Forecast & Release - Compacted */}
                                                    <div className="flex gap-2">
                                                        <div className="w-20 text-right">
                                                            <label className="text-[8px] font-black text-slate-400 uppercase block">Forecast</label>
                                                            <span className="text-xs font-black text-emerald-600 font-mono tracking-tight">{forecastVal} €</span>
                                                        </div>
                                                        <div className="w-16 text-center">
                                                            <label className="text-[8px] font-black text-slate-400 uppercase block">Release</label>
                                                            <span className={`text-[10px] font-bold px-1 rounded ${daysToRelease < 7 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`}>
                                                                {daysToRelease !== null ? daysToRelease + 'd' : '-'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}

                                    {/* OBSERVACIONES EXTERNAS (PMS/Excel) */}
                                    {(selectedGroupFicha.records[0]?.["Observaciones"] || selectedGroupFicha.records[0]?.["Observac."]) && (
                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex gap-3 items-start animate-fade-in">
                                            <div className="bg-amber-100 text-amber-600 p-1.5 rounded-lg shrink-0 mt-0.5">
                                                <IconFile size={16} />
                                            </div>
                                            <div className="flex-1">
                                                <h4 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1">Observaciones de Origen (PMS)</h4>
                                                <p className="text-xs font-bold text-slate-700 whitespace-pre-line leading-relaxed border-l-2 border-amber-300 pl-2">
                                                    {selectedGroupFicha.records[0]?.["Observaciones"] || selectedGroupFicha.records[0]?.["Observac."]}
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {/* GESTOR DE HABITACIONES & INVENTARIO (REDISEÑADO) */}
                                    <div className="bg-slate-50/80 p-4 rounded-xl border border-slate-200 shadow-sm mt-4 backdrop-blur-sm">
                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex items-center gap-2">
                                                <div className="p-1.5 bg-blue-100/50 rounded-lg text-blue-600">
                                                    <IconBed size={16} stroke={2.5} />
                                                </div>
                                                <div>
                                                    <h4 className="text-xs font-black text-slate-700 uppercase tracking-wide">Gestión de Habitaciones</h4>
                                                    <p className="text-[10px] text-slate-400 font-medium leading-none">Inventario y Tarifas por Tipo</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <span className="block text-[9px] font-bold text-slate-400 uppercase tracking-widest">Forecast Real</span>
                                                <span className="text-sm font-black text-emerald-600 font-mono bg-white px-2 py-0.5 rounded border border-emerald-100 shadow-sm">
                                                    {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]").reduce((acc, i) => acc + parseFloat(i.total), 0)).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Formulario de Entrada - Diseño Compacto */}
                                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm mb-3">
                                            <div className="flex items-end gap-2 flex-wrap xl:flex-nowrap">
                                                {/* Selector de Hotel (Solo si hay más de 1 hotel o para asignar) */}
                                                <div className="w-40">
                                                    <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Hotel</label>
                                                    <div className="relative">
                                                        <select
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-3 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none cursor-pointer"
                                                            value={roomManagerForm.hotel}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, hotel: e.target.value })}
                                                        >
                                                            <option value="">{selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "Seleccionar..."}</option>
                                                            {Array.from(new Set(selectedGroupFicha.records.map(r => r["Hotel_Asignado"] || r["Hotel"]).filter(Boolean))).map(h => (
                                                                <option key={h} value={h}>{h}</option>
                                                            ))}
                                                        </select>
                                                        <IconChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={14} />
                                                    </div>
                                                </div>

                                                <div className="w-56">
                                                    <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Producto / Habitación</label>
                                                    <div className="relative">
                                                        <input
                                                            list="room-options-list"
                                                            type="text"
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-3 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400"
                                                            placeholder="Escribe o selecciona..."
                                                            value={roomManagerForm.type}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, type: e.target.value })}
                                                            onClick={(e) => e.target.select()}
                                                        />
                                                        <datalist id="room-options-list">
                                                            <option value="Habitación Doble (DBL)" />
                                                            <option value="Habitación Twin (TWI)" />
                                                            <option value="Habitación Individual (DUI)" />
                                                            <option value="Habitación Triple (TRI)" />
                                                            <option value="Junior Suite (JSU)" />
                                                            <option value="Doble Superior (DSUP)" />
                                                            <option value="Restaurante" />
                                                            <option value="Salón" />
                                                            <option value="Suplemento" />
                                                            <option value="Sala de Reuniones" />
                                                            <option value="Coffee Break" />
                                                        </datalist>
                                                        <IconChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={14} />
                                                    </div>
                                                </div>

                                                <div className="flex gap-1">
                                                    <div className="w-28">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Llegada</label>
                                                        <input
                                                            type="date"
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-2 text-xs font-medium text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                            value={roomManagerForm.dateIn}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, dateIn: e.target.value })}
                                                        />
                                                    </div>
                                                    <div className="w-28">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Salida</label>
                                                        <input
                                                            type="date"
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-2 text-xs font-medium text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                            value={roomManagerForm.dateOut}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, dateOut: e.target.value })}
                                                        />
                                                    </div>
                                                </div>

                                                <div className="w-14">
                                                    <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-center">Cant.</label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg text-center text-xs font-black text-slate-800 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                        value={roomManagerForm.qty}
                                                        onChange={e => setRoomManagerForm({ ...roomManagerForm, qty: e.target.value })}
                                                    />
                                                </div>

                                                <div className="w-16">
                                                    <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-center">Régimen</label>
                                                    <select
                                                        className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-1 text-center text-xs font-bold text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 appearance-none"
                                                        value={roomManagerForm.regime}
                                                        onChange={e => setRoomManagerForm({ ...roomManagerForm, regime: e.target.value })}
                                                    >
                                                        <option value="">-</option>
                                                        <option>AD</option>
                                                        <option>MP</option>
                                                        <option>PC</option>
                                                        <option>SA</option>
                                                        <option>TI</option>
                                                    </select>
                                                </div>

                                                <div className="w-20">
                                                    <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-right">Precio/U</label>
                                                    <div className="relative">
                                                        <input
                                                            type="number"
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg pl-2 pr-6 text-right text-xs font-bold text-slate-800 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20"
                                                            value={roomManagerForm.price}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, price: e.target.value })}
                                                        />
                                                        <span className="absolute right-2 top-2.5 text-[10px] text-slate-400 font-bold">€</span>
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={addRoomBlock}
                                                    className={`h-9 px-4 ${editingId ? 'bg-amber-500 hover:bg-amber-600 shadow-amber-500/20' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/20'} text-white rounded-lg shadow-md active:scale-95 transition-all flex items-center gap-2`}
                                                >
                                                    {editingId ? <IconRefresh size={14} stroke={3} /> : <span className="text-sm font-bold">+</span>}
                                                    <span className="text-xs font-bold uppercase">{editingId ? 'Actualizar' : 'Añadir'}</span>
                                                </button>
                                                {editingId && (
                                                    <button onClick={() => { setEditingId(null); setRoomManagerForm(prev => ({ ...prev, qty: 1, price: 0 })); }} className="px-2 text-slate-400 hover:text-slate-600">
                                                        <IconX size={16} />
                                                    </button>
                                                )}
                                            </div>
                                        </div>

                                        {/* Tabla de Resultados - Clean UI */}
                                        <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                                            <table className="w-full text-xs text-left border-collapse">
                                                <thead className="bg-slate-50 border-b border-slate-200">
                                                    <tr>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Hotel</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Producto</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Fechas</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">Noches</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">Hab</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">Rég.</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right">P. Unit</th>
                                                        <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right bg-slate-100/50">Total</th>
                                                        <th className="py-2.5 px-3 w-8"></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")).map((item) => (
                                                        <tr key={item.id} className="hover:bg-blue-50/50 transition-colors group">
                                                            <td className="py-2 px-3">
                                                                <div className="flex items-center gap-1">
                                                                    <IconBuildingSkyscraper size={10} className="text-slate-400" />
                                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">{item.hotel || selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "Hotel"}</span>
                                                                </div>
                                                            </td>
                                                            <td className="py-2 px-3 font-bold text-slate-700">{item.type}</td>
                                                            <td className="py-2 px-3">
                                                                <div className="flex items-center gap-2 text-[11px] font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded w-fit">
                                                                    <span>{new Date(item.dateIn).toLocaleDateString()}</span>
                                                                    <IconArrowRight size={10} className="text-slate-300" />
                                                                    <span>{new Date(item.dateOut).toLocaleDateString()}</span>
                                                                </div>
                                                            </td>
                                                            <td className="py-2 px-3 text-center">
                                                                <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100">{item.nights}</span>
                                                            </td>
                                                            <td className="py-2 px-3 text-center font-bold text-slate-800">{item.qty}</td>
                                                            <td className="py-2 px-3 text-center">
                                                                <span className="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-1.5 py-0.5 rounded">{item.regime}</span>
                                                            </td>
                                                            <td className="py-2 px-3 text-right font-medium text-slate-600">{parseFloat(item.price).toFixed(2)} €</td>
                                                            <td className="py-1 px-2 text-right font-black text-emerald-600 bg-emerald-50/30">{parseFloat(item.total).toLocaleString('es-ES', { minimumFractionDigits: 2 })} €</td>
                                                            <td className="py-1 px-2 text-center flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    onClick={() => handleEditRoomBlock(item)}
                                                                    className="p-1 hover:bg-amber-100 text-slate-300 hover:text-amber-500 rounded transition-colors"
                                                                    title="Editar"
                                                                >
                                                                    <IconEdit size={14} />
                                                                </button>
                                                                <button
                                                                    onClick={() => removeRoomBlock(item.id)}
                                                                    className="p-1 hover:bg-rose-100 text-slate-300 hover:text-rose-500 rounded transition-colors"
                                                                    title="Eliminar"
                                                                >
                                                                    <IconTrash size={14} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")).length === 0 && (
                                                        <tr>
                                                            <td colSpan="8" className="py-8 text-center">
                                                                <div className="flex flex-col items-center justify-center text-slate-300">
                                                                    <IconBed size={32} stroke={1} className="mb-2 opacity-50" />
                                                                    <p className="text-xs font-medium italic">No hay habitaciones asignadas.</p>
                                                                    <p className="text-[10px]">Usa el formulario superior para añadir inventario.</p>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* FINANZAS Y BITÁCORA - Premium Layout */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        {/* Tesorería - Horizontal Cards */}
                                        {/* Tesorería - MULTI HOTEL */}
                                        <div className="lg:col-span-2 bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between">
                                            {(() => {
                                                // Identificar hoteles únicos en el grupo
                                                const uniqueHotels = Array.from(new Set(selectedGroupFicha.records
                                                    .map(r => r["Hotel_Asignado"] || r["Hotel"] || "Desconocido")
                                                    .filter(h => h && h !== "-")
                                                ));

                                                // Estado local temporal para la pestaña de hotel (si no existe, usar el primer hotel)
                                                // Nota: Al ser renderizado dentro de un map/function component, idealmente debería ser state, 
                                                // pero como dirty fix usaremos una variable de referencia o simplemente iteraremos.
                                                // Para hacerlo bien con React puro, necesitaríamos un useState arriba.
                                                // Vamos a asumir que el usuario quiere ver TODOS los planes o seleccionarlos.
                                                // Simplificación: Mostraremos una sección POR CADA HOTEL encontrado.

                                                if (uniqueHotels.length === 0) uniqueHotels.push("General");

                                                return (
                                                    <div className="space-y-4">
                                                        {uniqueHotels.map(hotelName => {
                                                            // Obtener un registro representativo de este hotel para leer los metadatos
                                                            const hotelRecord = selectedGroupFicha.records.find(r => (r["Hotel_Asignado"] || r["Hotel"] || "Desconocido") === hotelName) || selectedGroupFicha.records[0];

                                                            // Calcular total para este hotel
                                                            const hotelTotal = selectedGroupFicha.records
                                                                .filter(r => (r["Hotel_Asignado"] || r["Hotel"] || "Desconocido") === hotelName)
                                                                .reduce((acc, r) => acc + (parseFloat((r["Importe(*)"] || "0").toString().replace(/\./g, '').replace(',', '.')) || 0), 0);

                                                            return (
                                                                <div key={hotelName} className="border-b last:border-0 pb-2 last:pb-0">
                                                                    <div className="flex justify-between items-center mb-3">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="bg-emerald-100 p-1 rounded text-emerald-600">
                                                                                <IconPieChart size={14} />
                                                                            </div>
                                                                            <div>
                                                                                <h4 className="text-[10px] font-black text-slate-700 uppercase tracking-widest">Tesorería: {hotelName}</h4>
                                                                                <span className="text-[9px] font-bold text-slate-400">Total: {hotelTotal.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex bg-slate-100 rounded-lg p-0.5">
                                                                            <button onClick={() => calculateDeposits(selectedGroupFicha, [30, 70], hotelName)} className="px-2 py-0.5 text-[9px] font-bold text-slate-600 hover:bg-white hover:text-emerald-600 hover:shadow-sm rounded transition-all">30/70</button>
                                                                            <button onClick={() => calculateDeposits(selectedGroupFicha, [50, 50], hotelName)} className="px-2 py-0.5 text-[9px] font-bold text-slate-600 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded transition-all">50/50</button>
                                                                            <button onClick={() => calculateDeposits(selectedGroupFicha, [100], hotelName)} className="px-2 py-0.5 text-[9px] font-bold text-slate-600 hover:bg-white hover:text-slate-800 hover:shadow-sm rounded transition-all">100%</button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="grid grid-cols-3 gap-2">
                                                                        {[
                                                                            { key: "Dep1", label: "Inicial", color: "blue" },
                                                                            { key: "Dep2", label: "2º Pago", color: "indigo" },
                                                                            { key: "Dep3", label: "Final", color: "emerald" }
                                                                        ].map((dep) => {
                                                                            const isPaid = hotelRecord[`${dep.key}_Status`] === "Cobrado";
                                                                            const percent = hotelRecord[`${dep.key}_Percent`] || "0%";
                                                                            const amount = hotelRecord[`${dep.key}_Importe`] || "0";

                                                                            return (
                                                                                <div key={dep.key} className={`relative p-1.5 rounded-lg border ${isPaid ? `bg-${dep.color}-50 border-${dep.color}-200` : 'bg-slate-50 border-slate-100'} transition-all hover:shadow-md group`}>
                                                                                    <div className="flex justify-between items-center mb-0.5">
                                                                                        <span className={`text-[8px] font-black uppercase ${isPaid ? `text-${dep.color}-700` : 'text-slate-400'}`}>{dep.label}</span>
                                                                                        <span className="text-[8px] font-bold text-slate-400 bg-white/50 px-1 rounded">{percent}</span>
                                                                                    </div>

                                                                                    <div className="text-center py-0.5 mb-1">
                                                                                        <span className={`text-xs font-black tracking-tight ${isPaid ? `text-${dep.color}-700` : 'text-slate-700'}`}>{amount} €</span>
                                                                                    </div>

                                                                                    <div className="flex gap-1">
                                                                                        <input
                                                                                            type="date"
                                                                                            className={`flex-1 min-w-0 bg-white/50 border border-transparent hover:border-slate-200 rounded px-1 py-0.5 text-[8px] font-bold text-slate-600 text-center focus:outline-none`}
                                                                                            value={hotelRecord[`${dep.key}_Fecha`] || ""}
                                                                                            onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, `${dep.key}_Fecha`, e.target.value, hotelName)}
                                                                                        />
                                                                                        <button
                                                                                            onClick={() => updateGroupMetadata(selectedGroupFicha.name, `${dep.key}_Status`, isPaid ? "Pendiente" : "Cobrado", hotelName)}
                                                                                            className={`flex-1 py-0.5 rounded text-[8px] font-black uppercase tracking-wider transition-all flex items-center justify-center gap-1 ${isPaid ? `bg-${dep.color}-500 text-white shadow-sm` : 'bg-slate-200 text-slate-400 hover:bg-slate-300'}`}
                                                                                        >
                                                                                            {isPaid ? <IconCheck size={8} stroke={4} /> : null}
                                                                                            {isPaid ? 'OK' : 'PND'}
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })()}
                                        </div>

                                        {/* Bitácora / Notas Operativas */}
                                        <div className="lg:col-span-1 bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col h-full relative overflow-hidden">
                                            <div className="absolute top-0 right-0 p-2 opacity-5">
                                                <IconFile size={60} />
                                            </div>
                                            <div className="flex items-center gap-2 mb-2 z-10">
                                                <div className="bg-amber-100 p-1 rounded text-amber-600">
                                                    <IconEdit size={14} />
                                                </div>
                                                <h4 className="text-[10px] font-black text-slate-700 uppercase tracking-widest">Notas de Control</h4>
                                            </div>
                                            <div className="flex-1 z-10">
                                                <textarea
                                                    className="w-full h-full bg-amber-50/50 border border-amber-100 rounded-lg p-2 text-[10px] font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none leading-relaxed placeholder-amber-300"
                                                    placeholder="Escribe aquí notas operativas, recordatorios o detalles importantes del grupo..."
                                                    value={selectedGroupFicha.records[0]?.["Com_Notas"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Notas", e.target.value)}
                                                ></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    {/* REGISTROS ARCHIVO (Opcional scrollable) */}
                                    <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                                        <table className="w-full text-[9px] leading-tight">
                                            <thead className="bg-[#0f172a] text-white font-black uppercase">
                                                <tr>
                                                    <th className="px-3 py-1.5 text-left">Reserva</th>
                                                    <th className="px-3 py-1.5 text-left">Hotel</th>
                                                    <th className="px-3 py-1.5 text-left">Periodo</th>
                                                    <th className="px-3 py-1.5 text-right">Hab</th>
                                                    <th className="px-3 py-1.5 text-right">Importe</th>
                                                    <th className="px-3 py-1.5 text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {selectedGroupFicha.records.map((rec, idx) => (
                                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-3 py-1.5 font-bold text-slate-900">{rec["Reserva"]}</td>
                                                        <td className="px-3 py-1.5 font-bold text-slate-500">{rec["Hotel_Asignado"] || rec["Hotel"] || "-"}</td>
                                                        <td className="px-3 py-1.5 text-slate-600">{formatDate(rec["Entrada"])} - {formatDate(rec["Salida"])}</td>
                                                        <td className="px-3 py-1.5 text-right font-bold">{rec["Hab."] || '-'}</td>
                                                        <td className="px-3 py-1.5 text-right font-black text-emerald-600">{rec["Importe(*)"]} €</td>
                                                        <td className="px-3 py-1.5 text-center">
                                                            <span className={`px-2 py-0.5 rounded text-[7px] font-black uppercase ${rec["Estado"]?.toLowerCase().includes('conf') ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                                {rec["Estado"] || '???'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                    }

                    {/* Popup Datos Cliente - Desacoplado con Z-Index Corregido */}
                    {showClientData && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100]">
                            <div className="bg-white rounded-xl shadow-2xl w-[90vw] max-w-2xl border border-slate-200 overflow-hidden animate-fade-in">
                                <div className="bg-slate-100 p-3 border-b flex justify-between items-center">
                                    <h3 className="font-black text-slate-700 uppercase text-xs flex items-center gap-2">
                                        <IconUsers size={16} /> Datos de Cliente, Operativa y Fiscal
                                    </h3>
                                    <button onClick={() => setShowClientData(false)} className="text-slate-400 hover:text-red-500"><IconX size={18} /></button>
                                </div>
                                <div className="p-4 space-y-4">
                                    {/* Operativa */}
                                    <div>
                                        <h4 className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2 border-b border-blue-100 pb-1">Operativa</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <div className="col-span-2">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">Email Contacto</label>
                                                <input type="text" className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-bold text-slate-700"
                                                    value={selectedGroupFicha.records[0]?.["Com_Email_Contacto"] || selectedGroupFicha.records[0]?.["Email"] || selectedGroupFicha.records[0]?.["E-mail"] || selectedGroupFicha.records[0]?.["Correo"] || selectedGroupFicha.records[0]?.["Mail"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Email_Contacto", e.target.value)}
                                                />
                                            </div>
                                            <div className="col-span-2">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">Comercial Asignado</label>
                                                <input type="text" className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-bold text-slate-700"
                                                    value={selectedGroupFicha.records[0]?.["Com_Comercial"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Comercial", e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Fiscal */}
                                    <div>
                                        <h4 className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-2 border-b border-emerald-100 pb-1">Datos Fiscales (Facturación)</h4>
                                        <div className="grid grid-cols-12 gap-3">
                                            <div className="col-span-8">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">Razón Social</label>
                                                <input type="text" className="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs font-bold text-slate-800 focus:ring-2 ring-emerald-100"
                                                    value={selectedGroupFicha.records[0]?.["Fiscal_RazonSocial"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Fiscal_RazonSocial", e.target.value)}
                                                />
                                            </div>
                                            <div className="col-span-4">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">CIF / NIF</label>
                                                <input type="text" className="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs font-bold text-slate-800"
                                                    value={selectedGroupFicha.records[0]?.["Fiscal_CIF"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Fiscal_CIF", e.target.value)}
                                                />
                                            </div>
                                            <div className="col-span-12">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">Dirección Completa</label>
                                                <input type="text" className="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs text-slate-600"
                                                    value={selectedGroupFicha.records[0]?.["Fiscal_Direccion"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Fiscal_Direccion", e.target.value)}
                                                />
                                            </div>
                                            <div className="col-span-3">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">CP</label>
                                                <input type="text" className="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs text-slate-600"
                                                    value={selectedGroupFicha.records[0]?.["Fiscal_CP"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Fiscal_CP", e.target.value)}
                                                />
                                            </div>
                                            <div className="col-span-9">
                                                <label className="text-[9px] font-black text-slate-400 uppercase">Población / Provincia</label>
                                                <input type="text" className="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs text-slate-600"
                                                    value={selectedGroupFicha.records[0]?.["Fiscal_Poblacion"] || ""}
                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Fiscal_Poblacion", e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-3 bg-slate-50 border-t flex justify-end">
                                    <button onClick={() => setShowClientData(false)} className="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold text-xs uppercase hover:bg-slate-700">Guardar y Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Selección de Hotel para Importación */}
                    {
                        isHotelModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[100] p-4">
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 animate-fade-in text-center">
                                    <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                        <IconUpload size={32} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">¿A qué hotel pertenecen estos datos?</h3>
                                    <p className="text-sm text-slate-500 mb-8">Selecciona el hotel para asignar correctamente las reservas importadas.</p>

                                    <div className="grid grid-cols-1 gap-4">
                                        <button
                                            onClick={() => confirmHotelAndProcess("Sercotel Guadiana")}
                                            className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                        >
                                            <span className="text-emerald-600">Sercotel Guadiana</span>
                                            <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Principal</span>
                                        </button>
                                        <button
                                            onClick={() => confirmHotelAndProcess("Cumbria Spa & Hotel")}
                                            className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                        >
                                            <span className="text-blue-600">Cumbria Spa & Hotel</span>
                                            <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Asociado</span>
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => { setIsHotelModalOpen(false); setPendingFile(null); }}
                                        className="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold uppercase tracking-widest"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>