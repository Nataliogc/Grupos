<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Groups - Gesti√≥n Inteligente</title>
    <link rel="icon" type="image/png" href="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png">

    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM (Versi√≥n 18 - PRODUCCI√ìN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK (Compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes blynk {

            0%,
            100% {
                opacity: 1;
                filter: brightness(1);
            }

            50% {
                opacity: 0.6;
                filter: brightness(1.1);
            }
        }

        .animate-blynk {
            animation: blynk 1.5s ease-in-out infinite;
        }

        /* === MEJORAS VISUALES === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Staggered entrance for KPI cards */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kpi-card {
            opacity: 0;
            animation: slideUp 0.5s ease-out forwards;
        }

        .kpi-card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .kpi-card:nth-child(2) {
            animation-delay: 0.12s;
        }

        .kpi-card:nth-child(3) {
            animation-delay: 0.19s;
        }

        .kpi-card:nth-child(4) {
            animation-delay: 0.26s;
        }

        /* Subtle dot pattern background */
        .bg-dot-pattern {
            background-image: radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Loading spinner */
        @keyframes nexus-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .nexus-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: nexus-spin 0.7s linear infinite;
        }

        /* Glass modal backdrop */
        .glass-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Hover glow for action buttons */
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        /* Smooth number counter feel */
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }

        /* Better focus visible */
        :focus-visible {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        /* Print optimization */
        @media print {

            header,
            .no-print {
                display: none !important;
            }

            .print-full {
                width: 100% !important;
                max-width: none !important;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Configuraci√≥n Firebase Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script type="text/babel">
        // Aseguramos que las librer√≠as est√©n disponibles
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;

        // Definici√≥n de Iconos (SVG Manual para estabilidad)
        // Definici√≥n de Iconos (SVG Manual para estabilidad)
        const Icon = ({ path, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <g dangerouslySetInnerHTML={{ __html: path }} />
            </svg>
        );

        const IconCheck = (p) => <Icon path='<polyline points="20 6 9 17 4 12"></polyline>' {...p} />;
        const IconClock = (p) => <Icon path='<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>' {...p} />;
        const IconX = (p) => <Icon path='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' {...p} />;
        const IconChart = (p) => <Icon path='<line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>' {...p} />;
        const IconBrain = (p) => <Icon path='<path d="m12 14 4-4"></path><path d="M3.34 17a10 10 0 1 1 17.32 0"></path>' {...p} />; // Simple brain
        const IconUsers = (p) => <Icon path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' {...p} />;
        const IconTable = (p) => <Icon path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" x2="21" y1="9" y2="9"></line><line x1="3" x2="21" y1="15" y2="15"></line><line x1="9" x2="9" y1="3" y2="21"></line><line x1="15" x2="15" y1="3" y2="21"></line>' {...p} />;
        const IconMail = (p) => <Icon path='<rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>' {...p} />;
        const IconChevronDown = (p) => <Icon path='<path d="m6 9 6 6 6-6"></path>' {...p} />;
        const IconArrowRight = (p) => <Icon path='<path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path>' {...p} />;
        const IconCalendar = (p) => <Icon path='<rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path>' {...p} />;
        const IconFile = (p) => <Icon path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline>' {...p} />;
        const IconTrash = (p) => <Icon path='<path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>' {...p} />;
        const IconPlus = (p) => <Icon path='<path d="M5 12h14"></path><path d="M12 5v14"></path>' {...p} />;
        const IconRefresh = (p) => <Icon path='<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path>' {...p} />;
        const IconMore = (p) => <Icon path='<circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle>' {...p} />;
        const IconSave = (p) => <Icon path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>' {...p} />;
        const IconSearch = (p) => <Icon path='<circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>' {...p} />;
        const IconFilter = (p) => <Icon path='<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>' {...p} />;
        const IconPrinter = (p) => <Icon path='<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect>' {...p} />;
        const IconDownload = (p) => <Icon path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line>' {...p} />;
        const IconBed = (p) => <Icon path='<path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"></path><path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"></path>' {...p} />;
        const IconBuildingSkyscraper = (p) => <Icon path='<rect width="16" height="20" x="4" y="2" rx="2" ry="2"></rect><line x1="9" x2="9.01" y1="12" y2="12"></line><line x1="15" x2="15.01" y1="12" y2="12"></line><line x1="9" x2="9.01" y1="16" y2="16"></line><line x1="15" x2="15.01" y1="16" y2="16"></line><line x1="9" x2="9.01" y1="8" y2="8"></line><line x1="15" x2="15.01" y1="8" y2="8"></line>' {...p} />;
        const IconChevronLeft = (p) => <Icon path='<path d="m15 18-6-6 6-6"></path>' {...p} />;
        const IconChevronRight = (p) => <Icon path='<path d="m9 18 6-6-6-6"></path>' {...p} />;
        const IconChevronUp = (p) => <Icon path='<path d="m18 15-6-6-6 6"></path>' {...p} />;
        const IconSparkles = (p) => <Icon path='<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>' {...p} className={`${p.className || ""} text-yellow-400`} />;
        const IconUpload = (p) => <Icon path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>' {...p} />;
        const IconPieChart = (p) => <Icon path='<path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path>' {...p} />;
        const IconGroup = (p) => <Icon path='<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' {...p} />;
        const IconEdit = (p) => <Icon path='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>' {...p} />;
        const IconGripVertical = (p) => <Icon path='<circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle>' {...p} />;
        const IconAlertTriangle = (p) => <Icon path='<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' {...p} />;
        const IconUser = (p) => <Icon path='<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' {...p} />;
        const IconSettings = (p) => <Icon path='<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>' {...p} />;
        const IconCircle = (p) => <Icon path='<circle cx="12" cy="12" r="10"></circle>' {...p} />;


        // --- CONFIGURACI√ìN FIREBASE ---
        // Se carga desde js/firebase-config.js
        const firebaseConfig = window.firebaseConfig;

        // Inicializaci√≥n robusta
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Conexi√≥n verificada por onSnapshot ‚Äî no hace falta write test en cada carga
        console.log("üîå Firestore inicializado. Proyecto:", firebaseConfig.projectId);

        // --- CONFIGURACI√ìN IA (CONEXI√ìN POR PAR√ÅMETROS) ---
        async function callGemini(customPrompt) {
            let apiKey = window.firebaseConfig.apiKey;
            let model = "gemini-1.5-flash";

            try {
                const settingsDoc = await db.collection("settings").doc("main").get();
                if (settingsDoc.exists) {
                    const s = settingsDoc.data().system || {};
                    if (s.geminiApiKey) apiKey = s.geminiApiKey;
                    if (s.geminiModel) model = s.geminiModel;
                }
            } catch (e) {
                console.warn("No se pudo cargar la API Key de Firestore, usando fallback.");
            }

            if (!apiKey || apiKey === "TU_API_KEY_AQUI") {
                return "‚ö†Ô∏è ERROR: No se ha configurado la API Key de Gemini en el panel de Configuraci√≥n.";
            }

            const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: customPrompt }] }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const msg = error.error?.message || "";
                    if (msg.includes("blocked") || msg.includes("PERMISSION_DENIED")) {
                        return "üö´ ACCESO DENEGADO: Tu API Key est√° bloqueada o no tiene los permisos necesarios (Generative Language API) en Google AI Studio.";
                    }
                    if (msg.includes("leaked")) {
                        return "‚ö†Ô∏è Tu API Key ha sido desactivada por seguridad (leaked). Por favor, introduce una nueva en el panel de Configuraci√≥n.";
                    }
                    throw new Error(`Error en servidor IA: ${msg || JSON.stringify(error)}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                console.error("Error en llamada IA:", err);
                return "Hubo un error al conectar con la IA estrat√©gica. Por favor, verifica tu conexi√≥n y la API Key en Configuraci√≥n.";
            }
        }

        // Datos iniciales de ejemplo
        const INITIAL_DATA = [
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACI√ìN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "15", "Pernoct.": "30", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "R√©gimen": "HD", "Importe(*)": "1514", "Garant√≠a": "ANTES 18:00" },
            { "Reserva": "196215", "Nombre del Grupo": "ORGANIZACI√ìN SALSEA", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "7", "Pernoct.": "14", "Empresa/Agencia": "SALSEA 2026", "Segment.": "GRUPOS", "R√©gimen": "HA", "Importe(*)": "536", "Garant√≠a": "ANTES 18:00" },
            { "Reserva": "202263", "Nombre del Grupo": "TABLAO Y TUMBAO", "Entrada": "2026-01-16", "Salida": "2026-01-18", "Noches": "2", "Pax.": "60", "Pernoct.": "120", "Empresa/Agencia": "SALSEA 2026/TABLAO", "Segment.": "DIRECTO OFFLINE", "R√©gimen": "HA", "Importe(*)": "3732", "Garant√≠a": "FLEXIBLE" },
            { "Reserva": "205249", "Nombre del Grupo": "BM BENFICA", "Entrada": "2026-01-23", "Salida": "2026-01-24", "Noches": "1", "Pax.": "22", "Pernoct.": "22", "Empresa/Agencia": "C.D. BENFICA", "Segment.": "DEPORTIVO", "R√©gimen": "PC", "Importe(*)": "2100", "Garant√≠a": "PAGADO" }
        ];

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ff5722', '#795548'];


        const parseNum = (v) => {
            if (v === null || v === undefined || v === "") return 0;
            if (typeof v === 'number') return v;
            // Stronger sanitization for common currency artifacts (spaces, currency symbols, defined as string "undefined")
            let s = String(v).trim().replace(/[‚Ç¨$\s]/g, '').replace(/\s+/g, '');
            if (s === "" || s === "-" || s === "---" || s === "N/A" || s === "undefined") return 0;

            const dotCount = (s.match(/\./g) || []).length;
            const commaCount = (s.match(/,/g) || []).length;

            // Mixed separators (e.g. 1.000,50 vs 1,000.50)
            if (dotCount > 0 && commaCount > 0) {
                if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
                    // Spanish/Europe: 1.234,56
                    s = s.replace(/\./g, '').replace(',', '.');
                } else {
                    // US/UK: 1,234.56
                    s = s.replace(/,/g, '');
                }
            } else if (commaCount > 1) {
                // Multiple commas (thousands separators)
                s = s.replace(/,/g, '');
            } else if (dotCount > 1) {
                // Multiple dots (thousands separators detected)
                s = s.replace(/\./g, '');
            } else if (commaCount === 1) {
                // Single comma: 1,234 (thousands) OR 1,23 (decimal)
                if (s.split(',').pop().length === 3 && s.length > 4) s = s.replace(',', '');
                else s = s.replace(',', '.');
            } else if (dotCount === 1) {
                // Single dot: 1.234 (thousands) OR 1.23 (decimal)
                if (s.split('.').pop().length === 3 && s.length > 4) s = s.replace(/\./g, '');
            }

            const res = parseFloat(s);
            if (isNaN(res)) return 0;

            // SHIELD for Barbaric Numbers: If amount > 100M, it's almost certainly a formatting glitch
            // In hotel groups, 100M is a safe ceiling for error detection.
            if (res > 100000000) {
                console.error("Glitch Detected! Barbary amount suppressed:", res);
                return 0; // Prevent garbage values from propagating
            }
            return res;
        };

        const normalizeId = (id) => {
            if (!id) return "";
            return String(id).trim().replace(/\.0$/, "");
        };

        const getBaseId = (id) => {
            if (!id) return "";
            return String(id).trim().replace(/\.0$/, "").split('_')[0];
        };

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [columns, setColumns] = useState(Object.keys(INITIAL_DATA[0]));
            const authorizingIds = useRef(new Set()); // Para evitar que onSnapshot restaure diffs en proceso de guardado

            const getStatusProps = (statusRaw, arrivalDate, estadoField) => {
                const s = (statusRaw || "").toString().toUpperCase();
                const e = (estadoField || "").toString().toUpperCase();
                const today = new Date().toISOString().split('T')[0];
                const arrival = arrivalDate ? toInputDate(arrivalDate) : null;

                // 0. CANCELADO / ANULADO / BAJA (PREFERENCIA M√ÅXIMA)
                if (s.includes("CANC") || s.includes("ANUL") || s.includes("BAJA") || e.includes("CANC") || e.includes("ANUL") || e.includes("BAJA"))
                    return { color: "bg-red-500/80", text: "bg-red-100 text-red-700", label: "CANCELADO" };

                // 1. PASADO (Si la fecha de entrada ya pas√≥)
                if (arrival && arrival < today) {
                    return { color: "bg-slate-400", text: "bg-slate-100 text-slate-500", label: "PASADO" };
                }

                // 2. TENTATIVA / TANTEO / BLOQUEADO
                if (s.includes("TANTEO") || s.includes("TENTA") || s.includes("BLOQ") || s.includes("OPCI"))
                    return { color: "bg-amber-500", text: "bg-amber-100 text-amber-700", label: "TENTATIVA" };

                // 3. CONFIRMADO / GARANTIZADO / GRUPOS
                if (s.includes("CONFIRM") || s.includes("GARANT") || s.includes("RESERVA") || s === "GRUPOS")
                    return { color: "bg-emerald-500", text: "bg-emerald-100 text-emerald-700", label: "CONFIRMADO" };

                // 4. PRESUPUESTO / ENVIADO / COTIZADO
                if (s.includes("PRESUP") || s.includes("ENVIA") || s.includes("COTIZ") || s.includes("OFERT"))
                    return { color: "bg-blue-500", text: "bg-blue-100 text-blue-700", label: "PRESUPUESTO" };

                // 5. PROSPECTO / PENDIENTE
                if (s.includes("PROSPEC") || s.includes("PENDIE"))
                    return { color: "bg-slate-500", text: "bg-slate-100 text-slate-700", label: s || "PROSPECTO" };

                return { color: "bg-slate-400", text: "bg-slate-100 text-slate-600", label: s || "ACTIVO" };
            };

            const toInputDate = (val) => {
                if (!val) return "";
                const str = String(val).trim();

                // Caso 1: Excel Serial (ej: 46129)
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toISOString().split('T')[0];
                }

                // Caso 2: DD/MM/YYYY -> YYYY-MM-DD
                if (str.includes('/')) {
                    const parts = str.split('/');
                    if (parts.length === 3) {
                        const [d, m, y] = parts;
                        return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }
                }

                // Caso 3: YYYY-MM-DD o DD-MM-YYYY
                if (str.includes('-')) {
                    const parts = str.split(/[-T ]/);
                    if (parts[0].length === 4) return parts.slice(0, 3).join('-'); // YYYY-MM-DD
                    if (parts[2].length === 4) { // DD-MM-YYYY
                        const [d, m, y] = parts;
                        return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }
                }

                return str;
            };

            const formatDate = (val) => {
                if (!val) return "-";
                const iso = toInputDate(val);
                if (!iso || !iso.includes('-')) return val;
                const [y, m, d] = iso.split('-');
                return `${d}/${m}/${y}`;
            };
            const [activeTab, setActiveTab] = useState('calendar');
            const [searchTerm, setSearchTerm] = useState('');
            const [newColumnName, setNewColumnName] = useState('');
            const [showColumnModal, setShowColumnModal] = useState(false);
            const [expandedGroup, setExpandedGroup] = useState(null);
            const [expandedSegment, setExpandedSegment] = useState(null);

            // Estados para IA
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [showAiModal, setShowAiModal] = useState(false);

            // Estados para Filtros de Directorio de Grupos
            const [filterDirHotel, setFilterDirHotel] = useState('');
            const [filterDirCommercial, setFilterDirCommercial] = useState('');
            const [commercials, setCommercials] = useState([
                { name: "NATALIO", active: true },
                { name: "EMILIA", active: true },
                { name: "CANDELARIA", active: true },
                { name: "MARTA", active: true }
            ]);

            const getCommColor = (name) => {
                if (!name) return 'bg-slate-300';
                const predefinedColors = [
                    'bg-emerald-500',
                    'bg-blue-500',
                    'bg-amber-500',
                    'bg-purple-500',
                    'bg-rose-500',
                    'bg-cyan-500',
                    'bg-indigo-500',
                    'bg-fuchsia-500'
                ];
                let idx = commercials.findIndex(c => c.name === name);
                if (idx === -1) {
                    let hash = 0;
                    for (let i = 0; i < name.length; i++) {
                        hash = name.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    idx = Math.abs(hash);
                }
                return predefinedColors[idx % predefinedColors.length];
            };

            // Cargar configuraci√≥n de comerciales desde Firestore
            useEffect(() => {
                const unsubscribe = db.collection("settings").doc("main").onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data() || {};
                        const system = data.system || {};
                        if (system.commercials && Array.isArray(system.commercials)) {
                            // Normalize: Ensure all are objects with name and active status
                            const normalized = system.commercials.map(comm => {
                                if (typeof comm === 'object' && comm !== null) return comm;
                                return { name: comm, active: true };
                            });
                            setCommercials(normalized);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            // Sincronizaci√≥n autom√°tica desde Proforma (LocalStorage -> Firestore)
            useEffect(() => {
                const syncFromProforma = async () => {
                    const saved = localStorage.getItem('selectedGroup');
                    if (saved) {
                        try {
                            const localGroup = JSON.parse(saved);
                            if (localGroup.Reserva) {
                                // Guard: Only sync if there's actual data to sync
                                if (parseFloat(localGroup["Importe(*)"]) > 0 || (localGroup["ProformaItems"] && localGroup["ProformaItems"].length > 0)) {
                                    const updatePayload = {};
                                    const fields = {
                                        "Importe(*)": localGroup["Importe(*)"],
                                        "Pax.": localGroup["Pax."],
                                        "Entrada": localGroup["Entrada"],
                                        "Salida": localGroup["Salida"],
                                        "Hotel_Asignado": localGroup["Hotel_Asignado"],
                                        "Dep1_Importe": localGroup["Dep1_Importe"],
                                        "Dep2_Importe": localGroup["Dep2_Importe"],
                                        "Com_Relix": localGroup["Com_Relix"],
                                        "Com_Vencimiento_Rel": localGroup["Com_Vencimiento_Rel"],
                                        "ProformaItems": localGroup["ProformaItems"] || []
                                    };

                                    Object.keys(fields).forEach(key => {
                                        if (fields[key] !== undefined) updatePayload[key] = fields[key];
                                    });

                                    updatePayload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                                    await db.collection("groups").doc(String(localGroup.Reserva)).set(updatePayload, { merge: true });
                                }
                            }
                        } catch (e) {
                            console.error("Error sincronizando proforma:", e);
                        }
                    }
                };
                syncFromProforma();
            }, []);

            // --- ATAJO DE TECLADO: ESC cierra modales ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        // Cerrar modales en orden de prioridad (el m√°s interno primero)
                        if (showAiModal) { setShowAiModal(false); return; }
                        if (showFichaModal) { setShowFichaModal(false); return; }
                        if (showColumnModal) { setShowColumnModal(false); return; }
                        if (isHotelModalOpen) { setIsHotelModalOpen(false); setPendingFile(null); return; }
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            });



            // --- Filtros y Ordenaci√≥n ---
            const [filterStatus, setFilterStatus] = useState('activos'); // all, activos, confirmada, anulada
            const [filterTime, setFilterTime] = useState('future'); // all, future, past
            const [kpiFilter, setKpiFilter] = useState(null); // 'active', 'prospect', 'release', 'followup'
            const [sortConfig, setSortConfig] = useState({ key: 'Entrada', direction: 'asc' });

            // --- Procesamiento de Datos (Filtrado y Ordenaci√≥n) ---
            const processedData = useMemo(() => {
                if (!data) return [];

                let filtered = [...data];

                // 0. Filtro de Validez (Reserva obligatoria) + Normalizaci√≥n de Segmentos
                filtered = filtered.filter(row => row["Reserva"] && row["Reserva"].toString().trim() !== "" && row["Reserva"].toString().trim() !== "-")
                    .map(row => {
                        let seg = (row["Segment."] || "").toString().trim().toUpperCase();
                        if (seg === "GRTANTEO" || seg === "GRUPO TANTEO") {
                            return { ...row, "Segment.": "GRUPO TANTEO" };
                        }
                        return row;
                    });

                const today = new Date().toISOString().split('T')[0];

                // 1. Filtro de Estado
                if (filterStatus !== 'all') {
                    filtered = filtered.filter(row => {
                        const stateProps = getStatusProps(row["Com_Estado_Interno"] || row["Segment."], row["Entrada"], row["Estado"]);
                        const label = stateProps.label.toLowerCase();

                        if (filterStatus === 'activos') return label !== 'cancelado';
                        if (filterStatus === 'confirmada') return label === 'confirmado';
                        if (filterStatus === 'tentativa') return label === 'tentativa';
                        if (filterStatus === 'presupuesto') return label === 'presupuesto';
                        if (filterStatus === 'prospecto') return label === 'prospecto';
                        if (filterStatus === 'anulada') return label === 'cancelado';
                        if (filterStatus === 'pasado') return label === 'pasado';

                        // Fallback case just in case something didn't match
                        return true;
                    });
                }

                // 2. Filtro de Tiempo
                if (filterTime !== 'all') {
                    filtered = filtered.filter(row => {
                        let dateStr = row["Entrada"];
                        if (dateStr) {
                            dateStr = dateStr.toString();
                            if (dateStr.includes('/') && dateStr.length === 10) {
                                const [d, m, y] = dateStr.split('/');
                                dateStr = `${y}-${m}-${d}`;
                            }
                        }

                        if (!dateStr) return false;
                        if (filterTime === 'future') return dateStr >= today;
                        if (filterTime === 'past') return dateStr < today;
                        return true;
                    });
                }

                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    const baseTerm = getBaseId(searchTerm).toLowerCase();
                    const isNumericTerm = /^\d+$/.test(baseTerm);

                    filtered = filtered.filter(row => {
                        const res = (row["Reserva"] || "").toString();
                        const normRes = normalizeId(res).toLowerCase();
                        const baseRes = getBaseId(res).toLowerCase();

                        // Match logic
                        const idMatch = normRes.includes(lowerTerm) ||
                            baseRes === baseTerm ||
                            (isNumericTerm && baseRes.startsWith(baseTerm));

                        return (
                            idMatch ||
                            (row["Nombre del Grupo"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Empresa/Agencia"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Com_Comercial"] || "").toLowerCase().includes(lowerTerm) ||
                            (row["Segment."] || "").toLowerCase().includes(lowerTerm)
                        );
                    });
                }

                // 3.5 Filtro de KPI (Alertas/Estados espec√≠ficos)
                if (kpiFilter) {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    const sevenDaysFromNow = new Date(now);
                    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

                    filtered = filtered.filter(row => {
                        const status = (row["Com_Estado_Interno"] || row["Segment."] || row["Estado"] || "PROSPECTO").toUpperCase();

                        if (kpiFilter === 'active') {
                            return status.includes("CONF") || status.includes("BLOQ") || status.includes("OK") || status.includes("CERR");
                        }
                        if (kpiFilter === 'prospect') {
                            return status.includes("TANTEO") || status.includes("TENTA") || status.includes("PROSPEC") || status.includes("PRESUP");
                        }
                        if (kpiFilter === 'pendingQuotes') {
                            const extStatus = (row["Estado"] || "").toLowerCase();
                            const intStatus = (row["Com_Estado_Interno"] || "").toLowerCase();
                            const isCancelled = extStatus.includes('anul') || extStatus.includes('cancel') || extStatus.includes('baja') ||
                                intStatus.includes('anul') || intStatus.includes('cancel') || intStatus.includes('baja') ||
                                extStatus.includes('descart') || intStatus.includes('descart') ||
                                extStatus.includes('rechaz') || intStatus.includes('rechaz');

                            const arrival = row["Entrada"] ? toInputDate(row["Entrada"]) : null;
                            const todayStr = now.toISOString().split('T')[0];
                            const isPast = arrival && arrival < todayStr;

                            if (isCancelled || isPast) return false;

                            const importe = parseNum(row["Importe(*)"]);
                            const rawImporte = String(row["Importe(*)"] || "0").trim();
                            const isZero = importe === 0 || rawImporte === "" || rawImporte === "0" || rawImporte === "0,00" || rawImporte === "0.00";

                            return (status.includes("PRESUP") || status.includes("PEND") || (row["Reserva"] && String(row["Reserva"]).startsWith("PRES."))) && isZero;
                        }
                        if (kpiFilter === 'release') {
                            let isReleaseUrgent = false;
                            const roomListStr = row.RoomingList_JSON;
                            if (roomListStr) {
                                try {
                                    const roomList = JSON.parse(roomListStr);
                                    roomList.forEach(item => {
                                        const dIn = new Date(toInputDate(item.dateIn));
                                        if (!isNaN(dIn.getTime())) {
                                            const diff = Math.ceil((dIn - now) / (1000 * 60 * 60 * 24));
                                            if (diff >= 0 && diff <= 7) isReleaseUrgent = true;
                                        }
                                    });
                                } catch (e) { }
                            }
                            const comRelease = row.Com_Vencimiento_Rel ? new Date(row.Com_Vencimiento_Rel) : null;
                            if (comRelease && !isNaN(comRelease.getTime())) {
                                if (comRelease <= sevenDaysFromNow) isReleaseUrgent = true;
                            }
                            return isReleaseUrgent;
                        }
                        if (kpiFilter === 'followup') {
                            const followUp = row.Com_Seguimiento ? new Date(row.Com_Seguimiento) : null;
                            if (followUp && !isNaN(followUp.getTime())) {
                                return followUp <= now;
                            }
                            return false;
                        }
                        return true;
                    });
                }

                // 4. Ordenaci√≥n
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let valA = a[sortConfig.key] || "";
                        let valB = b[sortConfig.key] || "";

                        // Tratamiento especial fechas
                        if (sortConfig.key === 'Entrada' || sortConfig.key === 'Salida') {
                            valA = toInputDate(valA) || "9999-99-99";
                            valB = toInputDate(valB) || "9999-99-99";
                        }
                        // Tratamiento n√∫meros
                        if (sortConfig.key === 'Importe(*)' || sortConfig.key === 'Pax.') {
                            valA = parseNum(valA);
                            valB = parseNum(valB);
                        }

                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                return filtered;
            }, [data, filterStatus, filterTime, searchTerm, kpiFilter, sortConfig]);

            // --- C√°lculos de Estad√≠sticas Globales (Reemplazado por l√≥gica nueva) ---
            // Se usa stats calculado m√°s abajo basado en processedData

            // --- Agrupaci√≥n de Datos por "Nombre del Grupo" (Filtrados) ---
            const groupedData = useMemo(() => {
                const groups = {};

                processedData.forEach(row => {
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";
                    if (!groups[groupName]) {
                        groups[groupName] = {
                            id: normalizeId(row["Reserva"]),
                            name: groupName,
                            agency: row["Empresa/Agencia"] || "",
                            arrival: row["Entrada"],
                            departure: row["Salida"],
                            status: row["Estado"] || "",
                            totalPax: 0,
                            totalRevenue: 0,
                            totalNights: 0,
                            records: []
                        };
                    }

                    let importe = parseNum(row["Importe(*)"]);
                    // Guard against corruption: Don't sum if it's already a glitch
                    if (importe > 10000000) importe = 0;

                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) groups[groupName].totalRevenue += importe;
                    if (!isNaN(pax)) groups[groupName].totalPax += pax;
                    if (!isNaN(noches)) groups[groupName].totalNights += noches;

                    groups[groupName].records.push(row);
                });

                return Object.values(groups).sort((a, b) => {
                    const key = sortConfig.key || 'totalRevenue';
                    const dir = sortConfig.direction === 'asc' ? 1 : -1;

                    let valA = a[key];
                    let valB = b[key];

                    // Fallback to record fields if not in group object top-level
                    if (valA === undefined) valA = a.records[0]?.[key] || "";
                    if (valB === undefined) valB = b.records[0]?.[key] || "";

                    // Special date handling
                    if (key === 'arrival' || key === 'Entrada') {
                        return (toInputDate(valA) || "9999").localeCompare(toInputDate(valB) || "9999") * dir;
                    }

                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return -1 * dir;
                    if (valA > valB) return 1 * dir;
                    return 0;
                });
            }, [processedData, sortConfig]);

            // --- An√°lisis detallado por Segmentos (Filtrados) ---
            const segmentStats = useMemo(() => {
                const segments = {};

                processedData.forEach(row => {
                    let segName = (row["Segment."] || "Sin Segmento").toString().trim().toUpperCase();
                    if (segName === "GRTANTEO") segName = "GRUPO TANTEO";
                    const groupName = row["Nombre del Grupo"] || "Sin Nombre";

                    if (!segments[segName]) {
                        segments[segName] = {
                            name: segName,
                            revenue: 0,
                            pax: 0,
                            nights: 0,
                            count: 0,
                            groupList: new Set()
                        };
                    }

                    const importe = parseNum(row["Importe(*)"]);
                    const pax = parseInt(row["Pax."] || 0);
                    const noches = parseInt(row["Noches"] || 0);

                    if (!isNaN(importe)) segments[segName].revenue += importe;
                    if (!isNaN(pax)) segments[segName].pax += pax;
                    if (!isNaN(noches)) segments[segName].nights += noches;
                    segments[segName].count += 1;
                    segments[segName].groupList.add(groupName);
                });

                return Object.values(segments).map(s => ({
                    ...s,
                    groupCount: s.groupList.size,
                    groups: Array.from(s.groupList).sort()
                })).sort((a, b) => b.revenue - a.revenue);
            }, [processedData]);

            // --- Datos para Gr√°ficos Globales (Filtrados) ---
            const chartData = useMemo(() => {
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const revenueByMonth = {};

                processedData.forEach(row => {
                    let dateStr = row["Entrada"];
                    if (dateStr) {
                        dateStr = dateStr.toString();
                        if (dateStr.includes('/') && dateStr.length === 10) {
                            dateStr = dateStr.split('/').reverse().join('-');
                        }
                    }

                    if (dateStr) {
                        const date = new Date(dateStr);
                        if (!isNaN(date)) {
                            const key = `${monthNames[date.getMonth()]} ${date.getFullYear().toString().slice(-2)}`;
                            const importe = parseNum(row["Importe(*)"]);
                            revenueByMonth[key] = (revenueByMonth[key] || 0) + (isNaN(importe) ? 0 : importe);
                        }
                    }
                });

                const barData = Object.keys(revenueByMonth).map(key => ({
                    name: key,
                    Ingresos: revenueByMonth[key]
                }));

                return { barData };
            }, [processedData]);

            // --- Top Grupos Chart ---
            const topGroupsData = useMemo(() => {
                return groupedData.slice(0, 10).map(g => ({
                    name: g.name.length > 15 ? g.name.substring(0, 15) + '...' : g.name,
                    fullDate: g.name,
                    Ingresos: g.totalRevenue
                }));
            }, [groupedData]);


            // --- Funciones IA ---
            const handleConsultantClick = async () => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                // Preparamos el resumen para la IA incluyendo datos de segmentaci√≥n
                const summary = {
                    totalRevenue: stats.revenue,
                    totalGroups: stats.count,
                    topSegments: segmentStats.slice(0, 3).map(s => `${s.name} (${s.revenue.toFixed(0)}‚Ç¨)`).join(', '),
                    topMonths: chartData.barData.sort((a, b) => b.Ingresos - a.Ingresos).slice(0, 3).map(m => m.name).join(', ')
                };

                const prompt = `Act√∫a como un analista de Revenue Management experto para un hotel. 
                Analiza estos datos resumidos de grupos:
                - Ingresos Totales: ${summary.totalRevenue}
                - Total Grupos: ${summary.totalGroups}
                - Top 3 Segmentos (Ingresos): ${summary.topSegments}
                - Top Meses: ${summary.topMonths}
                
                Dame 3 conclusiones estrat√©gicas breves y 1 recomendaci√≥n de acci√≥n. Usa formato Markdown.
                Enf√≥cate mucho en la rentabilidad de los segmentos. ¬øQu√© segmento deber√≠amos potenciar?`;

                try {
                    const result = await callGemini(prompt);
                    // Check if result is an error message
                    if (result && (result.includes("Error") || result.includes("Hubo un error"))) {
                        setAiResult({ title: "Error Detectado", content: `**Detalles:** ${result}\n\n*Nota:* Si usas el archivo local (file://), la restricci√≥n de API web puede bloquearlo.` });
                    } else {
                        setAiResult({ title: "An√°lisis Estrat√©gico", content: result });
                    }
                } catch (e) {
                    setAiResult({ title: "Error Cr√≠tico", content: e.message });
                }
                setIsAiLoading(false);
            };

            const handleEmailClick = async (group) => {
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiResult(null);

                const prompt = `Escribe un email formal y acogedor para el organizador del grupo "${group.name}".
                Detalles:
                - Agencia: ${group.agency}
                - Llegada: ${group.arrival}
                - Salida: ${group.departure}
                - Pax: ${group.totalPax}
                - Importe total estimado: ${group.totalRevenue}‚Ç¨
                
                El objetivo es confirmar los detalles y dar la bienvenida. Menciona que estamos a su disposici√≥n para cualquier petici√≥n especial (dietas, salones, etc). Firma como "Dpto. de Grupos". Usa formato Markdown.`;

                const result = await callGemini(prompt);
                setAiResult({ title: `Borrador Email: ${group.name}`, content: result });
                setIsAiLoading(false);
            };

            const handleProformaClick = (group) => {
                // Tomar datos agregados del grupo y pasarlos como un registro √∫nico
                const records = group.records || [];
                const firstRec = records[0] || {};

                // Buscar el primer record que tenga un PaymentPlan_JSON (por si acaso el primero no lo tiene)
                const recWithPlan = records.find(r => r.PaymentPlan_JSON) || firstRec;

                const groupData = {
                    ...firstRec,
                    "PaymentPlan_JSON": recWithPlan.PaymentPlan_JSON || "[]",
                    "Nombre del Grupo": group.name,
                    "Empresa/Agencia": group.agency || firstRec["Empresa/Agencia"] || "",
                    "Importe(*)": group.totalRevenue,
                    "Pax.": group.totalPax || firstRec["Pax."] || "0",
                    "Entrada": group.arrival || firstRec["Entrada"],
                    "Salida": group.departure || firstRec["Salida"],
                    "Hotel_Asignado": firstRec["Hotel_Asignado"] || firstRec["Hotel"] || "Guadiana"
                };

                // Mapping Room Manager items to ProformaItems if they exist
                try {
                    // Aggregate RoomingList_JSON from all records to be safe
                    let roomList = [];
                    const processedIds = new Set();
                    (group.records || []).forEach(r => {
                        try {
                            const list = JSON.parse(r["RoomingList_JSON"] || "[]");
                            list.forEach(item => {
                                if (item.id && !processedIds.has(item.id)) {
                                    roomList.push(item);
                                    processedIds.add(item.id);
                                } else if (!item.id) {
                                    roomList.push(item); // Fallback for items without ID
                                }
                            });
                        } catch (e) { }
                    });

                    if (roomList.length > 0) {
                        const mappedItems = [];
                        const fallbackDate = group.arrival || firstRec["Entrada"] || new Date().toISOString().split('T')[0];

                        roomList.forEach(r => {
                            const nights = parseInt(r.nights) || 1;
                            const dInStr = toInputDate(r.dateIn) || toInputDate(fallbackDate);
                            const dIn = new Date(dInStr);

                            for (let i = 0; i < nights; i++) {
                                const currentDay = new Date(dIn);
                                if (!isNaN(currentDay.getTime())) {
                                    currentDay.setDate(currentDay.getDate() + i);
                                }

                                const finalIso = !isNaN(currentDay.getTime()) ? currentDay.toISOString().split('T')[0] : toInputDate(fallbackDate);

                                mappedItems.push({
                                    fecha: formatDate(finalIso),
                                    hab: '1',
                                    cant: (parseInt(r.qty) || 1).toString(),
                                    concepto: `${r.type}${r.regime ? ` (${r.regime})` : ''}`,
                                    precio: parseFloat(r.price) || 0,
                                    iva: parseInt(r.iva || 10),
                                    regimen: r.regime || '',
                                    dias: '1',
                                    comision: r.comision
                                });
                            }
                        });
                        if (mappedItems.length > 0) {
                            groupData["ProformaItems"] = mappedItems;
                            groupData["Importe(*)"] = roomList.reduce((acc, r) => acc + (parseFloat(r.total) || 0), 0).toFixed(2);
                        }
                    }
                } catch (e) { console.error("Error mapping room list in list click", e); }

                localStorage.setItem('selectedGroup', JSON.stringify(groupData));
                const itemsToPass = groupData["ProformaItems"] && groupData["ProformaItems"].length > 0 ? groupData["ProformaItems"] : [];
                localStorage.setItem('nexus_proforma_items', JSON.stringify(itemsToPass));
                localStorage.setItem('nexus_proforma_reserva', String(groupData["Reserva"] || ""));
                window.location.href = 'Fac Prof.html';
            };

            // --- Persistencia FIREBASE ---
            useEffect(() => {
                const unsubscribe = db.collection("groups").onSnapshot((snapshot) => {
                    const roomData = [];
                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        roomData.push({ ...d, Reserva: d.Reserva || doc.id });
                    });

                    // Utility inside snapshot to normalize date comparisons
                    const toStandardDate = (v) => {
                        if (!v) return "";
                        const str = String(v).trim();
                        if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                            const [y, m, d] = str.split('-');
                            return `${d}/${m}/${y}`;
                        }
                        return str;
                    };

                    const getIsoDate = (val) => {
                        if (!val) return "9999-12-31";
                        const str = String(val);
                        const parts = str.split(/[\/-]/);
                        if (parts.length === 3) {
                            if (parts[0].length === 4) return str;
                            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                        return str;
                    };

                    setData(prevData => {
                        let merged = roomData.map(dbRow => {
                            const resID = normalizeId(dbRow.Reserva);

                            if (authorizingIds.current.has(resID)) {
                                return { ...dbRow, _diff: null, _changes: null };
                            }

                            const localMatch = prevData.find(p => normalizeId(p.Reserva) === resID);
                            if (localMatch) {
                                if (localMatch._diff) {
                                    // No sobreescribir estados de cancelaci√≥n que vienen de Firestore
                                    const dbStatus = (dbRow["Com_Estado_Interno"] || "").toUpperCase();
                                    const isCancelledInDb = dbStatus.includes("CANCEL") || dbStatus.includes("ANUL") || dbStatus.includes("BAJA");
                                    if (isCancelledInDb) {
                                        // Firestore marca como cancelado: ignorar estado local, respetar Firestore
                                        return { ...localMatch, ...dbRow, _diff: localMatch._diff, _changes: localMatch._changes };
                                    }
                                    return { ...dbRow, ...localMatch };
                                }
                                // Si no hay diff (datos limpios), debemos combinar local con firestore
                                // para no perder columnas excel que firestore no tiene a√∫n.
                                return { ...localMatch, ...dbRow, _diff: null, _changes: null };
                            }
                            return { ...dbRow, _diff: null, _changes: null };
                        });

                        const deduped = [];
                        const seenIds = new Set();
                        merged.forEach(row => {
                            const baseId = normalizeId(row.Reserva).split('_')[0];
                            if (!seenIds.has(baseId)) {
                                seenIds.add(baseId);
                                deduped.push(row);
                            }
                        });
                        merged = deduped;

                        const localNews = prevData.filter(p => p._diff === 'new' && !authorizingIds.current.has(String(p.Reserva).trim()));
                        localNews.forEach(p => {
                            if (!merged.some(m => String(m.Reserva).trim() === String(p.Reserva).trim())) {
                                merged.push(p);
                            }
                        });

                        return merged;
                    });

                    const allKeys = new Set();
                    roomData.forEach(r => Object.keys(r).forEach(k => {
                        if (!["_diff", "updatedAt"].includes(k)) allKeys.add(k);
                    }));
                    setColumns(Array.from(allKeys));
                }, (error) => {
                    console.error("Error en tiempo real Firebase:", error);
                });

                return () => unsubscribe();
            }, []);



            // Actualizar estad√≠sticas: ENFOQUE COMERCIAL (Grupos, Estados, Pax)
            const stats = useMemo(() => {
                let totalRevenue = 0;
                let totalPax = 0;
                let activeCount = 0;
                let prospectCount = 0;
                let pendingQuotes = 0;
                const uniquePendingGroups = new Set(); // Para deduplicar grupos multi-reserva en el KPI
                let releaseAlerts = 0;
                let followUpAlerts = 0;
                let proforma24h = 0;
                let commercialsCount = {};

                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const sevenDaysFromNow = new Date(now);
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

                const uniqueGroups = new Set();

                processedData.forEach(row => {
                    const extStatus = (row["Estado"] || "").toLowerCase();
                    const intStatus = (row["Com_Estado_Interno"] || "").toLowerCase();
                    const isCancelled = extStatus.includes('anul') || extStatus.includes('cancel') || extStatus.includes('baja') ||
                        intStatus.includes('anul') || intStatus.includes('cancel') || intStatus.includes('baja') ||
                        extStatus.includes('descart') || intStatus.includes('descart') ||
                        extStatus.includes('rechaz') || intStatus.includes('rechaz');

                    const importe = parseNum(row["Importe(*)"]);
                    // Solo sumar revenue/pax si NO est√° cancelado
                    if (!isCancelled) {
                        totalRevenue += importe;
                        totalPax += parseInt(row["Pax."] || 0);
                    }

                    const groupId = row["Reserva"] || row["Nombre del Grupo"];
                    if (groupId && !uniqueGroups.has(groupId)) {
                        uniqueGroups.add(groupId);

                        const comercial = row["Com_Comercial"];
                        if (comercial && !isCancelled) {
                            if (!commercialsCount[comercial]) commercialsCount[comercial] = 0;
                            commercialsCount[comercial]++;
                        }

                        const status = (row["Com_Estado_Interno"] || row["Segment."] || row["Estado"] || "PROSPECTO").toUpperCase();

                        // 1. Tanteos y Presupuestos
                        if (status.includes("TANTEO") || status.includes("TENTA") || status.includes("PROSPEC") || status.includes("PRESUP")) {
                            if (!isCancelled) {
                                prospectCount++;

                                const arrival = row["Entrada"] ? toInputDate(row["Entrada"]) : null;
                                const todayStr = now.toISOString().split('T')[0];
                                const isPast = arrival && arrival < todayStr;
                                const isDiscarded = status.includes("DESCART") || status.includes("RECHAZ") || status.includes("ANUL") || status.includes("CANCEL");

                                // Siempre excluir pasados o sin fecha del KPI Por Cotizar
                                // Deduplicar por nombre de grupo (un grupo con 2 reservas cuenta como 1)
                                // A√±adido: S√≥lo debe considerarse "Por Cotizar" si el importe es 0
                                const groupLabel = row["Nombre del Grupo"] || groupId;
                                const rawImporte = String(row["Importe(*)"] || "0").trim();
                                const isZero = importe === 0 || rawImporte === "" || rawImporte === "0" || rawImporte === "0,00" || rawImporte === "0.00";

                                if ((status.includes("PRESUP") || (row["Reserva"] && String(row["Reserva"]).startsWith("PRES."))) && arrival && !isPast && !isDiscarded && isZero && !uniquePendingGroups.has(groupLabel)) {
                                    uniquePendingGroups.add(groupLabel);
                                    pendingQuotes++;
                                }
                            }
                        } else if (status.includes("CONF") || status.includes("BLOQ") || status.includes("OK") || status.includes("CERR")) {
                            if (!isCancelled) activeCount++;
                        }

                        // 2. Release Alerts
                        let isReleaseUrgent = false;
                        const roomListStr = row.RoomingList_JSON;
                        if (roomListStr) {
                            try {
                                const roomList = JSON.parse(roomListStr);
                                roomList.forEach(item => {
                                    const dIn = new Date(toInputDate(item.dateIn));
                                    if (!isNaN(dIn.getTime())) {
                                        const diff = Math.ceil((dIn - now) / (1000 * 60 * 60 * 24));
                                        if (diff > 0 && diff <= 7) isReleaseUrgent = true;
                                    }
                                });
                            } catch (e) { }
                        }
                        const comRelease = row.Com_Vencimiento_Rel ? new Date(row.Com_Vencimiento_Rel) : null;
                        if (comRelease && !isNaN(comRelease.getTime())) {
                            if (comRelease <= sevenDaysFromNow) isReleaseUrgent = true;
                        }
                        if (isReleaseUrgent) releaseAlerts++;

                        // 3. Follow-up Alerts
                        const followUp = row.Com_Seguimiento ? new Date(row.Com_Seguimiento) : null;
                        if (followUp && !isNaN(followUp.getTime())) {
                            if (followUp <= now) followUpAlerts++;
                        }

                        // 4. Proformas 24h
                        if (row.ProformaItems && row.ProformaItems.length > 0) {
                            // Si tiene ProformaItems, consideramos que tiene proforma. 
                            // Podr√≠amos filtrar por fecha si existiera un campo de creaci√≥n espec√≠fico.
                            proforma24h++;
                        }
                    }
                });

                return {
                    revenue: totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }),
                    active: activeCount,
                    prospects: prospectCount,
                    pendingQuotes: pendingQuotes,
                    releaseAlerts: releaseAlerts,
                    followUpAlerts: followUpAlerts,
                    proformas: proforma24h,
                    pax: totalPax,
                    count: uniqueGroups.size,
                    commercialsCount: commercialsCount
                };
            }, [processedData]);

            // Auto-abrir Ficha si se detecta bandera en localStorage
            useEffect(() => {
                const groupToOpen = localStorage.getItem('openGroupFicha');
                if (groupToOpen && groupedData.length > 0) {
                    const found = groupedData.find(g => g.name === groupToOpen);
                    if (found) {
                        openFicha(found);
                        localStorage.removeItem('openGroupFicha');
                    }
                }
            }, [groupedData]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            // Estados para Selecci√≥n de Hotel en Importaci√≥n
            const [isHotelModalOpen, setIsHotelModalOpen] = useState(false);
            const [pendingFile, setPendingFile] = useState(null);

            // --- Funciones de Archivo (Parser Recargado) ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setPendingFile(file);
                setIsHotelModalOpen(true);
            };

            const confirmHotelAndProcess = (hotelName) => {
                const file = pendingFile;
                setIsHotelModalOpen(false);
                setPendingFile(null);

                const reader = new FileReader();

                const processMatrixData = (rows, defaultStatus) => {
                    let headerRowIndex = -1;
                    const validData = [];
                    let currentStatus = defaultStatus;
                    let headers = [];

                    // Barrido completo para detectar bloques
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        const rowStr = row.join(" ").toLowerCase();

                        // Detectar cambios de secci√≥n internos (prioridad: m√°s espec√≠fico primero)
                        if (rowStr.includes("reservas de grupos anuladas") || rowStr.includes("anuladas") || rowStr.includes("canceladas")) {
                            currentStatus = "Anulada";
                            console.log(`[Import] Secci√≥n detectada: ANULADAS (fila ${i + 1})`);
                        } else if (rowStr.includes("tentativa") || rowStr.includes("bloqueada") || rowStr.includes("en opcion") || rowStr.includes("en opci√≥n")) {
                            currentStatus = "Tentativa";
                            console.log(`[Import] Secci√≥n detectada: TENTATIVA/BLOQUEADA (fila ${i + 1})`);
                        } else if (rowStr.includes("reservas de grupos confirmadas") || rowStr.includes("confirmadas")) {
                            currentStatus = "Confirmada";
                            console.log(`[Import] Secci√≥n detectada: CONFIRMADAS (fila ${i + 1})`);
                        }

                        // Detectar cabecera (Flexible: Si encontramos "Reserva" y algo que suene a "Grupo" o "Nombre")
                        // Ampliamos variantes: id, ref, loc, localizador
                        const rowStrLower = rowStr.toLowerCase();
                        const hasReserva = rowStrLower.includes("reserva") || rowStrLower.includes(" ref") || rowStrLower.includes(" id ") || rowStrLower.includes("localiz") || rowStrLower.includes("cod.");
                        const hasGrupo = rowStrLower.includes("grupo") || rowStrLower.includes("nombre del g") || rowStrLower.includes("titular") || rowStrLower.includes("cliente");

                        if (hasReserva && hasGrupo) {
                            headerRowIndex = i;
                            if (Array.isArray(row)) headers = row.map(h => {
                                const val = (h || "").toString().trim();
                                const lower = val.toLowerCase();
                                // Normalizar nombre de columna para el sistema
                                if (lower.includes("nombre del g") || lower.includes("titular")) return "Nombre del Grupo";
                                if (lower.includes("segm") || lower.includes("mercado")) return "Segment.";
                                if (lower.includes("entrada") || lower === "llegada" || lower === "check-in" || lower === "checkin") return "Entrada";
                                if (lower.includes("salida") || lower === "check-out" || lower === "checkout") return "Salida";
                                if (lower.includes("importe") || lower.includes("revenue") || lower.includes("total")) return "Importe(*)";
                                if (lower.includes("estado") || lower.includes("status")) return "Estado";
                                if (lower.includes("garant")) return "Garant√≠a";
                                if (lower.includes("canal") || lower.includes("channel")) return "Canal";
                                if (lower.includes("noches") || lower.includes("nights")) return "Noches";
                                if (lower.includes("pernoct") || lower.includes("roomnights")) return "Pernoct.";
                                if (lower.includes("empresa") || lower.includes("agencia") || lower.includes("company")) return "Empresa/Agencia";
                                if (lower.includes("r√©gi") || lower.includes("regi") || lower.includes("meal")) return "R√©gimen";
                                if (lower.includes("pax") || lower.includes("personas")) return "Pax.";
                                if (lower.includes("precio u") || lower.includes("unit price") || lower.includes("tarifa neta")) return "Precio Unitario";
                                if (lower.includes("cant") || lower.includes("qty") || lower.includes("unidades")) return "Cantidad";
                                return val;
                            });
                            console.log(`[Import] Cabecera detectada en fila ${i + 1}:`, headers.filter(h => h).join(', '));
                            continue;
                        }

                        // Si tenemos headers, procesamos la fila
                        if (headerRowIndex !== -1 && headers.length > 0) {
                            // Ignorar filas vac√≠as o repetidas cabeceras
                            if (row.length === 0) continue;

                            const obj = {};
                            let hasData = false;

                            headers.forEach((header, idx) => {
                                if (header) {
                                    obj[header] = row[idx] !== undefined && row[idx] !== null ? row[idx] : "";
                                    if (obj[header] !== "") hasData = true;
                                }
                            });

                            if (hasData) {
                                const reservaVal = (obj["Reserva"] || "").toString().toLowerCase().trim();
                                // Ignorar si parece otra cabecera o fila de totales
                                if (reservaVal.includes("reserva") || reservaVal.includes("total")) continue;

                                // Inyectar Estado detectado si no viene en el excel
                                if (!obj["Estado"] || String(obj["Estado"]).trim() === "") obj["Estado"] = currentStatus;
                                obj["Hotel_Asignado"] = hotelName;

                                if (reservaVal.length > 0 || (obj["Nombre del Grupo"] && obj["Nombre del Grupo"].toString().trim().length > 0)) {
                                    validData.push(obj);
                                }
                            }
                        }
                    }

                    console.log(`[Import] processMatrixData: ${validData.length} filas v√°lidas extra√≠das`);
                    return validData;
                };

                if (file.name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: false,
                            complete: (res) => {
                                const csvData = processMatrixData(res.data, "Confirmada");
                                if (csvData.length > 0) {
                                    sanitizeAndSetData(csvData);
                                } else {
                                    alert("No se encontraron datos v√°lidos en el CSV.");
                                }
                            }
                        });
                    };
                    reader.readAsText(file);
                }
                else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let allDetectedData = [];

                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                            // Determinamos estado por nombre de hoja
                            let defaultStatus = "Confirmada";
                            if (sheetName.toLowerCase().includes("anula")) defaultStatus = "Anulada";

                            const sheetData = processMatrixData(matrix, defaultStatus);
                            allDetectedData = [...allDetectedData, ...sheetData];
                        });

                        if (allDetectedData.length > 0) {
                            sanitizeAndSetData(allDetectedData);
                        } else {
                            alert("No se encontraron datos en el Excel.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert("Formato no soportado.");
                }
            };

            const sanitizeAndSetData = (rawData) => {
                // Helper to normalize Excel Dates to YYYY-MM-DD
                const normalizeDate = (val) => {
                    if (!val) return "";
                    let d, m, y;

                    // Handle Excel Serial Date
                    if (typeof val === 'number' || (!isNaN(parseFloat(val)) && /^\d{5}$/.test(val))) {
                        const serial = parseInt(val, 10);
                        const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
                        d = date.getDate();
                        m = date.getMonth() + 1;
                        y = date.getFullYear();
                    } else {
                        const str = String(val).trim();
                        // Handle DD/MM/YYYY or DD-MM-YYYY
                        if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(str)) {
                            const parts = str.split(/[\/-]/);
                            [d, m, y] = parts.map(Number);
                        }
                        // Handle YYYY-MM-DD
                        else if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                            const [year, month, day] = str.split('-').map(Number);
                            [d, m, y] = [day, month, year];
                        }
                    }

                    if (d && m && y) {
                        return `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;
                    }
                    return String(val).trim();
                };

                const simpleRows = rawData.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(k => {
                        if (k && k.trim() !== "") {
                            let val = row[k];
                            // Normalize dates for 'Entrada' and 'Salida'
                            if (k === 'Entrada' || k === 'Salida' || k.includes('Date')) {
                                val = normalizeDate(val);
                            }
                            let cleanKey = k.trim();
                            let cleanVal = val;

                            // Normalizaci√≥n de Segmentos
                            if (cleanKey === "Segment.") {
                                let seg = (val || "").toString().trim().toUpperCase();
                                if (seg === "GRTANTEO") cleanVal = "GRUPO TANTEO";
                            }

                            cleanRow[cleanKey] = cleanVal;
                        }
                    });
                    return cleanRow;
                });

                // --- GROUPING LOGIC: Aggregating split reservations (same ID) ---
                const groupedMap = new Map();

                // Helper to get Date object from string
                const parseToDateObj = (str) => {
                    if (!str) return null;
                    const parts = String(str).split(/[\/-]/);
                    if (parts.length !== 3) return new Date(str);
                    if (parts[0].length === 4) return new Date(str); // YYYY-MM-DD
                    return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // DD/MM/YYYY
                };

                simpleRows.forEach(row => {
                    const id = normalizeId(row["Reserva"]);
                    if (!id || id === "-") {
                        // For rows without ID, treat as unique by using a random key
                        groupedMap.set(`TEMP-${Math.random()}`, row);
                        return;
                    }

                    if (!groupedMap.has(id)) {
                        groupedMap.set(id, { ...row });
                    } else {
                        const existing = groupedMap.get(id);

                        // 1. Sum Pax
                        const oldPax = parseNum(existing["Pax."]);
                        const newPax = parseNum(row["Pax."]);
                        existing["Pax."] = (oldPax + newPax).toString();

                        // 2. Sum Importe
                        const oldImp = parseNum(existing["Importe(*)"]);
                        const newImp = parseNum(row["Importe(*)"]);
                        existing["Importe(*)"] = (oldImp + newImp).toFixed(2);

                        // 3. Keep earliest Entrada and latest Salida
                        const eIn = parseToDateObj(existing["Entrada"]);
                        const rIn = parseToDateObj(row["Entrada"]);
                        if (rIn && eIn && rIn < eIn) existing["Entrada"] = row["Entrada"];

                        const eOut = parseToDateObj(existing["Salida"]);
                        const rOut = parseToDateObj(row["Salida"]);
                        if (rOut && eOut && rOut > eOut) existing["Salida"] = row["Salida"];

                        // 4. Join regime
                        if (row["R√©gimen"] && existing["R√©gimen"] !== row["R√©gimen"]) {
                            if (!existing["R√©gimen"].includes(row["R√©gimen"])) {
                                existing["R√©gimen"] = `${existing["R√©gimen"]}, ${row["R√©gimen"]}`;
                            }
                        }
                    }
                });

                const incomingRows = Array.from(groupedMap.values());

                // Auto-calculate Noches if missing but Entrada/Salida exist
                incomingRows.forEach(row => {
                    if ((!row["Noches"] || row["Noches"] === "" || row["Noches"] === "0") && row["Entrada"] && row["Salida"]) {
                        const eIn = parseToDateObj(row["Entrada"]);
                        const eOut = parseToDateObj(row["Salida"]);
                        if (eIn && eOut && !isNaN(eIn.getTime()) && !isNaN(eOut.getTime())) {
                            const diffDays = Math.round((eOut - eIn) / (1000 * 60 * 60 * 24));
                            if (diffDays > 0) row["Noches"] = diffDays.toString();
                        }
                    }
                });

                // Log import summary
                const totalPaxFound = incomingRows.reduce((a, b) => a + parseNum(b["Pax."]), 0);
                const totalImpFound = incomingRows.reduce((a, b) => a + parseNum(b["Importe(*)"]), 0);
                const mergedCount = simpleRows.length - incomingRows.length;
                console.log(`[Import] Resumen: ${simpleRows.length} filas brutas ‚Üí ${incomingRows.length} registros √∫nicos (Pax: ${totalPaxFound}, Importe: ${totalImpFound.toFixed(2)})`);

                // Copia profunda de los datos actuales para el merge
                const mergedData = [...data];

                // 1. Procesar registros entrantes
                incomingRows.forEach((newRow, idx) => {
                    // Generate a temp ID if Reserva is missing to avoid overwriting all empty reserva rows
                    if (!newRow["Reserva"]) {
                        newRow["Reserva"] = `TEMP-${Date.now()}-${idx}`;
                    }
                    const resID = normalizeId(newRow["Reserva"]);
                    const existingIdx = mergedData.findIndex(r => {
                        const existingId = normalizeId(r["Reserva"]);
                        return existingId === resID || existingId.startsWith(resID + "_") || resID.startsWith(existingId + "_");
                    });

                    if (existingIdx === -1) {
                        // Es un grupo nuevo (No estaba en DB)
                        mergedData.push({ ...newRow, "_diff": "new" });
                    } else {
                        // Es un grupo existente, verificar cambios
                        const existingRow = mergedData[existingIdx];
                        let diffType = null;
                        let changes = {};

                        // Check specific fields for changes
                        // REGLA: Excluimos 'Estado' de la comparaci√≥n para no generar diffs por algo que no vamos a sobreescribir (protecci√≥n manual)
                        const relevantKeys = ["Entrada", "Salida", "Pax.", "Importe(*)", "R√©gimen", "Segment.", "Nombre del Grupo", "Noches", "Pernoct.", "Empresa/Agencia"];

                        // --- ROBUST COMPARISON LOGIC ---
                        // Helper to parse any number format to a clean float
                        const toNum = (v) => parseNum(v);

                        // Helper to normalize any date to YYYY-MM-DD
                        const toIsoDate = (v) => {
                            if (v === null || v === undefined || v === "" || v === "---") return "";
                            let s = String(v).trim();

                            // Excel serial date
                            const numericVal = parseFloat(s);
                            if (!isNaN(numericVal) && numericVal > 40000 && numericVal < 60000 && !s.includes('/') && !s.includes('-')) {
                                const date = new Date(Math.round((numericVal - 25569) * 86400 * 1000));
                                return date.toISOString().split('T')[0];
                            }

                            let d, m, y;
                            if (/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/.test(s)) {
                                const parts = s.split(/[-\/T ]/);
                                [y, m, d] = parts;
                            } else if (/^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}/.test(s)) {
                                const parts = s.split(/[-\/]/);
                                [d, m, y] = parts;
                            }
                            if (d && m && y) {
                                return `${String(y).padStart(4, '20')}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            }
                            if (s !== "") console.warn(`[Import] Fecha no normalizable: "${s}" para reserva ${newRow["Reserva"]}`);
                            return "";
                        };

                        const NUMERIC_KEYS = new Set(["Importe(*)", "Pax.", "Noches", "Pernoct."]);
                        const DATE_KEYS = new Set(["Entrada", "Salida"]);

                        relevantKeys.forEach(key => {
                            const rawOld = existingRow[key];
                            const rawNew = newRow[key];

                            // Skip if both are effectively empty
                            const isEmptyOld = (rawOld === null || rawOld === undefined || String(rawOld).trim() === "" || String(rawOld).trim() === "---");
                            const isEmptyNew = (rawNew === null || rawNew === undefined || String(rawNew).trim() === "" || String(rawNew).trim() === "---");
                            if (isEmptyOld && isEmptyNew) return;

                            let isDifferent = false;

                            if (NUMERIC_KEYS.has(key)) {
                                const numOld = toNum(rawOld);
                                const numNew = toNum(rawNew);
                                // Both empty/NaN: no diff
                                if (isNaN(numOld) && isNaN(numNew)) return;
                                // One is NaN and other has a real value (> 0): diff
                                if (isNaN(numOld) !== isNaN(numNew)) {
                                    // Only flag if the valid one isn't zero
                                    const validNum = isNaN(numOld) ? numNew : numOld;
                                    isDifferent = Math.abs(validNum) > 0.01;
                                } else {
                                    // Both are numbers: compare with tolerance
                                    isDifferent = Math.abs(numOld - numNew) > 0.05;
                                }
                            } else if (DATE_KEYS.has(key)) {
                                const dateOld = toIsoDate(rawOld);
                                const dateNew = toIsoDate(rawNew);
                                if (dateOld === "" && dateNew === "") return;
                                isDifferent = dateOld !== dateNew;
                            } else {
                                // Text fields: case and whitespace insensitive
                                const normOld = isEmptyOld ? "" : String(rawOld).trim().toUpperCase().replace(/\s+/g, ' ');
                                const normNew = isEmptyNew ? "" : String(rawNew).trim().toUpperCase().replace(/\s+/g, ' ');
                                // Ignore empty‚Üíempty, but flag empty‚Üívalue
                                if (normOld === "" && normNew === "") return;
                                isDifferent = normOld !== normNew;
                            }

                            if (isDifferent) {
                                const displayOld = isEmptyOld ? "---" : rawOld;
                                const displayNew = isEmptyNew ? "---" : rawNew;
                                console.log(`[Diff] ${key} para Reserva ${newRow["Reserva"]}: "${displayOld}" ‚Üí "${displayNew}"`);
                                changes[key] = { old: displayOld, new: displayNew };
                            }
                        });

                        if (newStatus.includes("anul") && !oldStatus.includes("anul")) {
                            diffType = "cancelled";
                        }
                        else if (Object.keys(changes).length > 0) {
                            diffType = "modified";
                        }

                        // Actualizar la fila: SOLO sobreescribir campos que vienen del Excel
                        // Proteger campos editados en la app (metadata, comercial, dep√≥sitos, notas, etc.)
                        const APP_ONLY_FIELDS = new Set([
                            "Estado", "Com_Comercial", "Com_Estado_Interno", "Com_Notas", "Com_Seguimiento", "Com_Vencimiento_Rel", "Com_Precio",
                            "Dep1_Label", "Dep1_Percent", "Dep1_Importe", "Dep1_Fecha",
                            "Dep2_Label", "Dep2_Percent", "Dep2_Importe", "Dep2_Fecha",
                            "Dep3_Label", "Dep3_Percent", "Dep3_Importe", "Dep3_Fecha",
                            "PaymentPlan_JSON", "RoomingList_JSON",
                            "Fiscal_RazonSocial", "Fiscal_CIF", "Fiscal_Direccion", "Fiscal_CP", "Fiscal_Poblacion", "Fiscal_Provincia", "Fiscal_Pais",
                            "Email", "Telefono", "Persona_Contacto",
                            "Proforma_NetRate", "Proforma_Rooms", "Proforma_RoomList",
                            "updatedAt"
                        ]);

                        // Empezamos con la fila existente (DB), luego sobreescribimos SOLO con campos del Excel
                        const mergedRow = { ...existingRow };

                        // DETECTOR DE GESTI√ìN MANUAL: Si ya tiene RoomingList_JSON, protegemos campos core
                        let hasManualRooming = false;
                        try {
                            const rList = JSON.parse(existingRow.RoomingList_JSON || "[]");
                            if (Array.isArray(rList) && rList.length > 0) hasManualRooming = true;
                        } catch (e) { }

                        const CORE_FIELDS = new Set(["Importe(*)", "Pax.", "Entrada", "Salida", "R√©gimen", "Segment.", "Noches"]);

                        Object.keys(newRow).forEach(key => {
                            // No sobreescribir campos que son exclusivos de la app
                            if (APP_ONLY_FIELDS.has(key)) return;

                            // REGLA DE PREVALENCIA: Si el grupo est√° gestionado manualmente (con l√≠neas de precio),
                            // NO sobreescribir campos CORE con los del Excel.
                            if (hasManualRooming && CORE_FIELDS.has(key)) return;

                            // No sobreescribir con valor vac√≠o si el Excel no trae ese campo
                            if (newRow[key] === "" || newRow[key] === undefined || newRow[key] === null) return;

                            // NORMALIZAR AL GUARDAR: Para evitar diffs fantasma por formato, guardamos en formato limpio
                            if (NUMERIC_KEYS.has(key)) {
                                mergedRow[key] = toNum(newRow[key]).toString();
                            } else if (DATE_KEYS.has(key)) {
                                mergedRow[key] = toIsoDate(newRow[key]);
                            } else {
                                mergedRow[key] = newRow[key];
                            }
                        });

                        // Si no hay cambios reales detectados hoy, limpiamos el diff (evita diffs pegajosos)
                        if (Object.keys(changes).length === 0) {
                            mergedRow["_diff"] = null;
                            mergedRow["_changes"] = null;
                        } else {
                            mergedRow["_diff"] = diffType || (existingRow._diff ? existingRow._diff : null);
                            mergedRow["_changes"] = Object.keys(changes).length > 0 ? changes : null;
                        }
                        mergedData[existingIdx] = mergedRow;
                    }
                });

                // Asegurar que 'Estado' est√© en las columnas
                const allKeys = new Set();
                mergedData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));

                // Ordenar por fecha de entrada (ISO)
                const sortedData = [...mergedData].sort((a, b) => {
                    const valA = toInputDate(a["Entrada"]) || "9999";
                    const valB = toInputDate(b["Entrada"]) || "9999";
                    return valA.localeCompare(valB);
                });

                // UPDATE LOCAL STATE ONLY - DO NOT SAVE TO FIREBASE YET
                setData(sortedData);
                setColumns(Array.from(allKeys).filter(k => !k.startsWith("_") && k !== "Hotel_Asignado"));

                // Alert user that review is needed
                const newsCount = sortedData.filter(r => r._diff === 'new').length;
                const modsCount = sortedData.filter(r => r._diff === 'modified' || r._diff === 'cancelled').length;

                if (newsCount > 0 || modsCount > 0) {
                    alert(`‚úÖ IMPORTACI√ìN COMPLETADA:\n\nüöÄ ${newsCount} Nuevos Grupos detectados\nüìù ${modsCount} Modificaciones encontradas\n\nPor favor, revise y AUTORICE los cambios en la pesta√±a 'Cambios'.`);
                    setActiveTab('table'); // Switch to editor view to see changes
                } else {
                    alert("‚ú® TODO SINCRONIZADO: No se detectaron cambios ni grupos nuevos respecto a la base de datos actual.");
                }
            };

            const acceptChanges = () => {
                const batch = db.batch();
                const pendingRows = data.filter(r => r._diff);

                if (pendingRows.length === 0) return;

                pendingRows.forEach(row => {
                    const { _diff, _changes, ...rest } = row;
                    const resID = normalizeId(row["Reserva"]);
                    const docRef = db.collection("groups").doc(resID);

                    // Sanitize rest
                    const clean = {};
                    Object.keys(rest).forEach(k => {
                        if (rest[k] !== undefined) clean[k] = rest[k];
                    });

                    batch.set(docRef, {
                        ...clean,
                        _diff: firebase.firestore.FieldValue.delete(),
                        _changes: firebase.firestore.FieldValue.delete(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                });

                console.log(`üöÄ AUTORIZANDO TODO: ${pendingRows.length} registros...`);

                // Marcar IDs para que onSnapshot no los restaure
                pendingRows.forEach(r => authorizingIds.current.add(normalizeId(r["Reserva"])));

                // Optimistic update
                const oldData = [...data];
                setData(prev => prev.map(r => ({ ...r, _diff: null, _changes: null })));

                batch.commit().then(() => {
                    console.log("‚úÖ AUTORIZACI√ìN MASIVA EXITOSA");
                    // Limpiar tracker tras un peque√±o delay para dejar que onSnapshot procese el cambio final
                    setTimeout(() => {
                        pendingRows.forEach(r => authorizingIds.current.delete(normalizeId(r["Reserva"])));
                    }, 2000);
                }).catch(err => {
                    console.error("‚ùå ERROR EN AUTORIZACI√ìN MASIVA:", err);
                    alert("Error al autorizar todo: " + err.message);
                    pendingRows.forEach(r => authorizingIds.current.delete(normalizeId(r["Reserva"])));
                    setData(oldData); // Restore on error
                });
            };

            const exportCSV = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'Analisis_Grupos_Editado.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- Funciones de Edici√≥n ---
            const handleCellChange = (rowIndex, column, value) => {
                const row = data[rowIndex];
                const resID = String(row["Reserva"]);

                // Actualizaci√≥n optimista
                const newData = [...data];
                newData[rowIndex][column] = value;
                setData(newData);

                // Actualizar Firebase con merge y timestamp
                db.collection("groups").doc(resID).set({
                    [column]: value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).catch(err => console.error("Error editando celda:", err));
            };

            const addNewColumn = () => {
                if (!newColumnName) return;
                const newData = data.map(row => ({ ...row, [newColumnName]: "" }));
                setData(newData);
                setColumns([...columns, newColumnName]);
                setNewColumnName('');
                setShowColumnModal(false);
            };

            // Estados para Ficha de Grupo
            const [showFichaModal, setShowFichaModal] = useState(false);
            const [selectedGroupFicha, setSelectedGroupFicha] = useState(null);
            // Ref con la √∫ltima lista de inventario guardada (para PROFORMA, evita desincron√≠a con el estado)
            const lastRoomingListRef = useRef({ groupName: null, list: [] });

            // State for Room Manager Form
            const [roomManagerForm, setRoomManagerForm] = useState({
                hotel: '',
                type: 'Habitaci√≥n Doble (DBL)',
                dateIn: '',
                dateOut: '',
                qty: 1,
                regime: 'AD',
                price: 0,
                iva: 10 // Default IVA
            });
            const [editingId, setEditingId] = useState(null);

            // State for Commission Modal
            const [commissionModal, setCommissionModal] = useState({
                isOpen: false,
                itemIdx: null,
                tempCom: null
            });

            const calculateDefaultCommission = (price, regime, qty, nights) => {
                const p = parseFloat(price) || 0;
                const q = parseInt(qty) || 1;
                const n = parseInt(nights) || 1;
                const r = (regime || "").toUpperCase();
                let porcentaje = 10;

                // Desglose unitario inicial (SA como base)
                let desglose = {
                    Alojamiento: { valor: p, comisionable: true },
                    Desayuno: { valor: 0, comisionable: false },
                    Almuerzo: { valor: 0, comisionable: false },
                    Cena: { valor: 0, comisionable: false }
                };

                // L√≥gica de descompasado basada en r√©gimen (Heur√≠stica unitaria)
                if (r === 'AD') {
                    desglose.Desayuno.valor = 5;
                    desglose.Alojamiento.valor = Math.max(0, p - 5);
                } else if (r === 'MP') {
                    desglose.Desayuno.valor = 5;
                    desglose.Almuerzo.valor = 10;
                    desglose.Alojamiento.valor = Math.max(0, p - 15);
                } else if (r === 'PC') {
                    desglose.Desayuno.valor = 5;
                    desglose.Almuerzo.valor = 10;
                    desglose.Cena.valor = 10;
                    desglose.Alojamiento.valor = Math.max(0, p - 25);
                } else if (r === 'TI') {
                    desglose.Desayuno.valor = 4;
                    desglose.Almuerzo.valor = 8;
                    desglose.Cena.valor = 8;
                    desglose.Alojamiento.valor = Math.max(0, p - 20); // TI suele ser m√°s complejo, dejamos esto como base
                }

                const baseUnitaria = Object.entries(desglose).reduce((acc, [k, c]) => acc + (c.comisionable ? c.valor : 0), 0);

                return {
                    porcentaje,
                    modo: 'auto',
                    desglose,
                    base_unitaria: parseFloat(baseUnitaria.toFixed(2)),
                    comision_unitaria: parseFloat((baseUnitaria * porcentaje / 100).toFixed(2)),
                    total_comision: parseFloat((baseUnitaria * porcentaje / 100 * q * n).toFixed(2))
                };
            };

            const openFicha = (groupOrRow) => {
                let group = groupOrRow;

                // Handle case where we receive a flat row (e.g. from Gantt) instead of a grouped object
                if (!group.records) {
                    const groupName = group["Nombre del Grupo"];
                    const found = groupedData.find(g => g.name === groupName);
                    if (found) {
                        group = found;
                    } else {
                        // Fallback wrapper if not found in groupedData (should be rare)
                        group = {
                            ...groupOrRow,
                            name: groupName,
                            records: [groupOrRow]
                        };
                    }
                }

                // Initialize Room Manager Form with group dates
                if (group.records && group.records[0]) {
                    const rec = group.records[0];
                    setRoomManagerForm(prev => ({
                        ...prev,
                        hotel: rec["Hotel_Asignado"] || rec["Hotel"] || "",
                        dateIn: rec["Entrada"] || "",
                        dateOut: rec["Salida"] || "",
                        price: 0 // Reset price
                    }));
                }

                // Auto-generate Rooming List if empty
                if (group.records && group.records.length > 0) {
                    const firstRecord = group.records[0];
                    let currentList = [];
                    try {
                        currentList = JSON.parse(firstRecord["RoomingList_JSON"] || "[]");
                    } catch (e) { currentList = []; }

                    if (currentList.length === 0) {
                        const newAutoList = [];

                        // Iterate through all records (multi-hotel)
                        // Group records by unique combination of Hotel + Dates to avoid duplicates from raw data line splits
                        const uniqueSegments = new Map();

                        group.records.forEach(r => {
                            const h = r["Hotel_Asignado"] || r["Hotel"] || "H. Pendiente";
                            const dIn = r["Entrada"];
                            const dOut = r["Salida"];
                            const key = `${h}|${dIn}|${dOut}`;

                            // Numerical fixes for massive sums: detect if Importe is likely total and not additive
                            const imp = parseNum(r["Importe(*)"]);
                            const pax = parseInt(r["Pax."] || "0");

                            if (!uniqueSegments.has(key)) {
                                uniqueSegments.set(key, {
                                    hotel: h,
                                    dateIn: dIn,
                                    dateOut: dOut,
                                    pax: pax,
                                    price: imp
                                });
                            } else {
                                const existing = uniqueSegments.get(key);
                                // Heuristic: If we already have a high price, maybe don't sum if the new one is identical (likely same total repeated)
                                // But for now sum to satisfy legitimate additions.
                                existing.pax += pax;
                                existing.price += imp;
                            }
                        });


                        uniqueSegments.forEach(seg => {
                            if (seg.dateIn && seg.dateOut) {
                                // Robust Date Parsing
                                const parseDate = (dStr) => {
                                    if (!dStr) return null;
                                    const s = dStr.toString();

                                    // Handle Excel Serial Date (e.g. 46088 -> 2026-03-07)
                                    // 5 digits, typically > 40000 for current years
                                    if (/^\d{5}$/.test(s)) {
                                        const serial = parseInt(s, 10);
                                        // Check if it's a reasonable serial number for a date (e.g. > 20000 which is year 1954)
                                        if (serial > 25569) {
                                            return new Date(Math.round((serial - 25569) * 86400 * 1000));
                                        }
                                    }

                                    // Handle DD-MM-YYYY or DD/MM/YYYY
                                    if (s.includes('-') && s.split('-')[0].length <= 2) {
                                        const [d, m, y] = s.split('-');
                                        return new Date(`${y}-${m}-${d}`);
                                    }
                                    if (s.includes('/') && s.split('/')[0].length <= 2) {
                                        const [d, m, y] = s.split('/');
                                        return new Date(`${y}-${m}-${d}`);
                                    }
                                    return new Date(s);
                                };

                                let start = parseDate(seg.dateIn);
                                let end = parseDate(seg.dateOut);

                                if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end > start) {
                                    // Loop through days
                                    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                                        const nextDay = new Date(d);
                                        nextDay.setDate(d.getDate() + 1);

                                        // Calculations for daily price (avg)
                                        const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                        const dailyPrice = totalDays > 0 ? (seg.price / totalDays) : 0;

                                        newAutoList.push({
                                            id: Date.now() + Math.random(),
                                            hotel: seg.hotel,
                                            type: 'Habitaci√≥n (Auto)',
                                            dateIn: d.toISOString().split('T')[0],
                                            dateOut: nextDay.toISOString().split('T')[0],
                                            qty: Math.ceil(seg.pax / 2) || 1, // Assume DBL
                                            regime: 'AD', // Default
                                            price: (dailyPrice / (Math.ceil(seg.pax / 2) || 1)).toFixed(2), // Unit price approx
                                            nights: 1,
                                            total: dailyPrice.toFixed(2)
                                        });
                                    }
                                }
                            }
                        });

                        // Update the group object locally with the new list
                        if (newAutoList.length > 0) {
                            // We need to update the record's RoomingList_JSON
                            // Since we can't easily deep update state here without triggering re-renders or complexity,
                            // we'll update the 'group' object clone and let the state settle.
                            // BUT, to persist, we should probably call updateGroupMetadata later or just let user save.
                            // For now, we put it in the object passed to state.
                            if (group.records && group.records[0]) {
                                group.records[0]["RoomingList_JSON"] = JSON.stringify(newAutoList);
                            }
                        }
                    }
                }

                // Sincronizar ref de inventario para PROFORMA (al abrir ficha)
                try {
                    const rec = group.records && group.records[0];
                    if (rec) {
                        const list = JSON.parse(rec["RoomingList_JSON"] || "[]");
                        if (Array.isArray(list) && list.length > 0)
                            lastRoomingListRef.current = { groupName: group.name, list };
                    }
                } catch (e) { }

                setSelectedGroupFicha(group);
                setShowFichaModal(true);
            };

            const updateGroupMetadata = async (groupName, fieldOrUpdates, valueIfSingle = null, hotelFilter = null) => {
                const updates = typeof fieldOrUpdates === 'object' ? fieldOrUpdates : { [fieldOrUpdates]: valueIfSingle };

                // Si el usuario cambia a CANCELADO desde el dropdown, sincronizar tambi√©n el campo Estado
                if (updates["Com_Estado_Interno"] === "CANCELADO" && !updates["Estado"]) {
                    updates["Estado"] = "ANULADA";
                }

                // Capturar las filas actuales ANTES del update optimista (para el batch de Firestore)
                const currentGroupRows = data.filter(r =>
                    (r["Nombre del Grupo"] || "") === groupName &&
                    (!hotelFilter || (r["Hotel_Asignado"] || r["Hotel"]) === hotelFilter)
                );

                // 1. Optimistic UI Update
                setData(prevData => {
                    return prevData.map(row => {
                        const matchesGroup = (row["Nombre del Grupo"] || "") === groupName;
                        const matchesHotel = !hotelFilter || (row["Hotel_Asignado"] || row["Hotel"]) === hotelFilter;

                        if (matchesGroup && matchesHotel) {
                            return { ...row, ...updates };
                        }
                        return row;
                    });
                });

                // 2. Update selectedGroupFicha if it matches
                setSelectedGroupFicha(prev => {
                    if (!prev || prev.name !== groupName) return prev;
                    const updatedRecords = prev.records.map(r => {
                        const matchesHotel = !hotelFilter || (r["Hotel_Asignado"] || r["Hotel"]) === hotelFilter;
                        if (matchesHotel) {
                            return { ...r, ...updates };
                        }
                        return r;
                    });
                    return { ...prev, records: updatedRecords };
                });

                // 3. Persist to Firestore (usa currentGroupRows capturados antes del update optimista)
                try {
                    const batch = db.batch();

                    currentGroupRows.forEach(row => {
                        const resID = String(row.Reserva).trim();
                        if (resID) {
                            const docRef = db.collection("groups").doc(resID);
                            const payload = { ...updates, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                            batch.set(docRef, payload, { merge: true });
                        }
                    });

                    if (currentGroupRows.length === 0) {
                        console.warn("‚ö†Ô∏è updateGroupMetadata: No se encontraron filas para", groupName, "- el cambio puede no haberse guardado en Firestore.");
                    }

                    await batch.commit();
                    console.log("‚úÖ Update committed to Firestore", updates);
                } catch (err) {
                    console.error("‚ùå Error updating metadata:", err);
                }
            };

            // ... (skipping updateGroupMetadata implementation here as I can't easily match large block without context, I will do separate edits if needed) ...

            // --- Room Manager Logic ---
            const addRoomBlock = () => {
                if (!selectedGroupFicha) return;

                const currentRecord = selectedGroupFicha.records[0] || {};
                let currentList = [];
                try {
                    currentList = JSON.parse(currentRecord["RoomingList_JSON"] || "[]");
                } catch (e) { currentList = []; }

                let nights = 1;
                if (roomManagerForm.dateIn && roomManagerForm.dateOut) {
                    const dIn = new Date(toInputDate(roomManagerForm.dateIn));
                    const dOut = new Date(toInputDate(roomManagerForm.dateOut));
                    if (!isNaN(dIn) && !isNaN(dOut)) {
                        const diff = dOut - dIn;
                        nights = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    }
                    if (nights < 1) nights = 1;
                }

                const newItem = {
                    id: editingId || Date.now(),
                    hotel: roomManagerForm.hotel || currentRecord["Hotel_Asignado"] || "Hotel Guadiana",
                    type: roomManagerForm.type,
                    dateIn: roomManagerForm.dateIn || currentRecord["Entrada"],
                    dateOut: roomManagerForm.dateOut || currentRecord["Salida"],
                    qty: parseInt(roomManagerForm.qty),
                    regime: roomManagerForm.regime,
                    price: parseFloat(roomManagerForm.price),
                    iva: parseInt(roomManagerForm.iva || 10),
                    nights: nights,
                    total: (parseFloat(roomManagerForm.price) * parseInt(roomManagerForm.qty) * nights).toFixed(2),
                    comision: editingId
                        ? (currentList.find(i => i.id === editingId)?.comision || calculateDefaultCommission(roomManagerForm.price, roomManagerForm.regime, roomManagerForm.qty, nights))
                        : calculateDefaultCommission(roomManagerForm.price, roomManagerForm.regime, roomManagerForm.qty, nights)
                };

                // Si estamos editando y cambiamos precio/regimen/qty, recalculamos la comision auto si sigue en modo auto
                if (editingId && newItem.comision.modo === 'auto') {
                    newItem.comision = calculateDefaultCommission(roomManagerForm.price, roomManagerForm.regime, roomManagerForm.qty, nights);
                }

                let newList;
                if (editingId) {
                    newList = currentList.map(item => item.id === editingId ? newItem : item);
                    setEditingId(null);
                } else {
                    newList = [...currentList, newItem];
                }

                const newTotalSum = newList.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0);

                updateGroupMetadata(selectedGroupFicha.name, {
                    "RoomingList_JSON": JSON.stringify(newList),
                    "Importe(*)": newTotalSum.toFixed(2)
                });
                setRoomManagerForm(prev => ({ ...prev, qty: 1, price: 0 })); // Keep hotel/dates for convenience
            };

            const handleEditRoomBlock = (item) => {
                setRoomManagerForm({
                    hotel: item.hotel || selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "",
                    type: item.type,
                    dateIn: item.dateIn,
                    dateOut: item.dateOut,
                    qty: item.qty,
                    regime: item.regime,
                    price: item.price,
                    iva: item.iva || 10
                });
                setEditingId(item.id);
            };

            const handleRoomManagerDrop = (sourceIndex, targetIndex) => {
                if (sourceIndex === targetIndex) return;
                const currentRecord = selectedGroupFicha.records[0] || {};
                let currentList = [];
                try {
                    currentList = JSON.parse(currentRecord["RoomingList_JSON"] || "[]");
                } catch (e) { return; }

                const newList = [...currentList];
                const [moved] = newList.splice(sourceIndex, 1);
                newList.splice(targetIndex, 0, moved);

                const newTotalSum = newList.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0);

                updateGroupMetadata(selectedGroupFicha.name, {
                    "RoomingList_JSON": JSON.stringify(newList),
                    "Importe(*)": newTotalSum.toFixed(2)
                });
            };

            const calculateDeposits = (group, distribution = [100], hotelFilter = null) => {
                const records = hotelFilter
                    ? group.records.filter(r => (r["Hotel_Asignado"] || r["Hotel"]) === hotelFilter)
                    : group.records;

                if (records.length === 0) return;

                const roomingList = JSON.parse(group.records[0]?.["RoomingList_JSON"] || "[]");
                const hotelRoomingItems = hotelFilter ? roomingList.filter(i => i.hotel === hotelFilter) : roomingList;
                const total = hotelRoomingItems.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0) || records.reduce((acc, r) => {
                    const val = parseNum(r["Importe(*)"]);
                    return acc + val;
                }, 0);

                const entrada = records[0]?.["Entrada"];
                let dateEntrada = new Date();
                if (entrada) {
                    const parts = entrada.includes('/') ? entrada.split('/') : entrada.split('-');
                    if (parts.length === 3) {
                        let d, m, y;
                        if (parts[0].length === 4) { [y, m, d] = parts; } else { [d, m, y] = parts; }
                        dateEntrada = new Date(y, m - 1, d);
                    }
                }

                // Default labels/days for standard distributions
                const presetMeta = {
                    "30": { label: "Dep√≥sito Inicial", days: 60 },
                    "70": { label: "Pago Final", days: 15 },
                    "50": { label: "Dep√≥sito", days: 45 },
                    "100": { label: "Pago √önico", days: 30 }
                };

                const newPlan = distribution.map(pct => {
                    const meta = presetMeta[pct.toString()] || { label: "Nuevo Pago", days: 30 };
                    const date = new Date(dateEntrada);
                    date.setDate(date.getDate() - meta.days);
                    return {
                        id: Date.now() + Math.random(),
                        label: meta.label,
                        percent: pct,
                        amount: (total * (pct / 100)).toFixed(2),
                        releaseDays: meta.days,
                        date: date.toISOString().split('T')[0],
                        status: "Pendiente"
                    };
                });

                updateGroupMetadata(group.name, "PaymentPlan_JSON", JSON.stringify(newPlan), hotelFilter);
            };

            const updatePaymentPlan = (groupName, hotelFilter, plan) => {
                updateGroupMetadata(groupName, "PaymentPlan_JSON", JSON.stringify(plan), hotelFilter);
            };

            const addNewRow = () => {
                const emptyRow = {};
                columns.forEach(col => emptyRow[col] = "");
                emptyRow["Entrada"] = new Date().toISOString().split('T')[0];
                setData([emptyRow, ...data]);
            };



            const removeRoomBlock = (id) => {
                if (!selectedGroupFicha) return;
                const currentRecord = selectedGroupFicha.records[0] || {};
                let currentList = [];
                try {
                    currentList = JSON.parse(currentRecord["RoomingList_JSON"] || "[]");
                } catch (e) { return; }

                const newList = currentList.filter(item => item.id !== id);

                const newTotalSum = newList.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0);

                updateGroupMetadata(selectedGroupFicha.name, {
                    "RoomingList_JSON": JSON.stringify(newList),
                    "Importe(*)": newTotalSum.toFixed(2)
                });
            };

            const toggleGroupExpand = (groupName) => {
                if (expandedGroup === groupName) setExpandedGroup(null);
                else setExpandedGroup(groupName);
            };


            const clearDatabase = async () => {
                if (!window.confirm("‚ö†Ô∏è ATENCI√ìN: ¬øEst√°s ABSOLUTAMENTE seguro de que quieres BORRAR TODA la base de datos de grupos?\n\nEsta acci√≥n eliminar√° todos los registros en Firestore y NO se puede deshacer.")) {
                    return;
                }

                const secondConfirm = window.confirm("Segunda confirmaci√≥n: ¬øRealmente quieres borrar TODO?");
                if (!secondConfirm) return;

                try {
                    console.log("üî• Iniciando borrado masivo...");
                    const snapshot = await db.collection("groups").get();
                    if (snapshot.empty) {
                        alert("La base de datos ya est√° vac√≠a.");
                        return;
                    }

                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    alert("‚úÖ Base de datos borrada con √©xito. El sistema est√° ahora vac√≠o y listo para una nueva importaci√≥n.");
                    console.log("‚úÖ DB Cleared - State empty.");
                    setData([]); // Leave completely empty for debug
                } catch (err) {
                    console.error("‚ùå Error al borrar DB:", err);
                    alert("Error al borrar la base de datos: " + err.message);
                }
            };

            return (
                <div className="min-h-screen pb-10 bg-dot-pattern">
                    {/* Header */}
                    {/* Header: Global Navigation & Status */}
                    <header className="bg-white border-b border-slate-200 py-3 shadow-sm sticky top-0 z-50">
                        <div className="container mx-auto px-4 flex items-center justify-between gap-4">
                            {/* Brand & Subtitle */}
                            <div className="flex items-center gap-4 flex-1">
                                <a href="Admin.html" className="p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-500" title="Volver al Admin">
                                    <IconChevronLeft size={20} />
                                </a>
                                <div className="flex items-center gap-3">
                                    <div className="bg-slate-50 rounded-xl p-1.5 shadow-inner border border-slate-100">
                                        <img src="Nexus Groups/Nexus_Groups_ICO-removebg-preview.png" className="h-8 w-auto object-contain" alt="Nexus Logo" />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-black text-slate-800 leading-none flex items-center gap-2">Nexus <span className="text-emerald-600">Groups</span></h1>
                                        <p className="text-[11px] text-slate-500 font-medium mt-0.5">Gesti√≥n unificada de grupos y an√°lisis predictivo.</p>
                                    </div>
                                </div>
                            </div>

                            {/* Middle: Consultant Trigger */}
                            <div className="hidden lg:flex items-center gap-4">
                                <button
                                    onClick={handleConsultantClick}
                                    className="flex items-center gap-2 px-6 py-2 rounded-2xl bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors border border-indigo-100 shadow-sm"
                                >
                                    <span className="text-[11px] font-black uppercase tracking-widest">Consultor IA</span>
                                    <IconSparkles size={16} className="animate-pulse" />
                                </button>
                            </div>

                            {/* Actions Right */}
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setShowAddGroupModal(true)}
                                    className="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white p-2.5 rounded-xl shadow-lg shadow-emerald-200 transition-all"
                                    title="A√±adir Grupo"
                                >
                                    <IconPlus size={20} />
                                </button>

                                <div className="h-8 w-[1px] bg-slate-200 mx-1 hidden md:block"></div>

                                <div className="flex gap-1 md:gap-2">
                                    <label className="p-2 text-slate-400 hover:text-indigo-600 transition-colors cursor-pointer" title="Importar">
                                        <IconUpload size={20} />
                                        <input type="file" className="hidden" accept=".csv, .xlsx, .xls" onChange={handleFileUpload} />
                                    </label>
                                    <button onClick={exportCSV} className="p-2 text-slate-400 hover:text-emerald-600 transition-colors" title="Exportar">
                                        <IconDownload size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>



                    <div className="container mx-auto px-4">
                        {/* KPI Cards: ENFOQUE COMERCIAL */}
                        {/* KPI SECTION: Unificada en una sola l√≠nea elegante */}
                        <div className="flex flex-row flex-nowrap gap-3 mb-6 overflow-x-auto pb-2 custom-scrollbar">
                            {/* PENDIENTES DE COTIZAR */}
                            <div
                                onClick={() => setKpiFilter('pendingQuotes')}
                                className="min-w-[170px] flex-1 bg-rose-50 p-3 rounded-2xl shadow-sm border border-rose-200 flex flex-col justify-center cursor-pointer hover:bg-rose-100 transition-colors animate-pulse"
                            >
                                <div className="flex items-center gap-2 mb-1">
                                    <div className="w-1 h-3 bg-rose-600 rounded-full"></div>
                                    <span className="text-[10px] text-rose-600 font-bold uppercase tracking-wider">Por Cotizar</span>
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-2xl font-black text-rose-700 tabular-nums leading-none">{stats.pendingQuotes}</span>
                                    <span className="text-[10px] font-bold text-rose-500 uppercase">Grupos</span>
                                </div>
                            </div>


                            {/* RELEASE 7 D√çAS */}
                            <div className="min-w-[170px] flex-1 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
                                <div className="flex items-center gap-2 mb-1">
                                    <div className="w-1 h-3 bg-rose-500 rounded-full"></div>
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Release</span>
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-2xl font-black text-slate-800 tabular-nums leading-none">{stats.releaseAlerts}</span>
                                    <span className="text-[10px] font-bold text-rose-500 uppercase">7 D√≠as</span>
                                </div>
                            </div>

                            {/* TAREAS HOY */}
                            <div className="min-w-[170px] flex-1 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
                                <div className="flex items-center gap-2 mb-1">
                                    <div className="w-1 h-3 bg-blue-500 rounded-full"></div>
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Tareas</span>
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-2xl font-black text-slate-800 tabular-nums leading-none">{stats.followUpAlerts}</span>
                                    <span className="text-[10px] font-bold text-blue-500 uppercase">Hoy</span>
                                </div>
                            </div>

                            {/* RECUENTO POR COMERCIAL */}
                            <div className="w-[1px] bg-slate-200 mx-2 flex-shrink-0 self-stretch my-2"></div>
                            {Object.entries(stats.commercialsCount || {}).sort((a, b) => b[1] - a[1]).map(([name, count]) => (
                                <div key={name} className="min-w-[140px] flex-1 bg-slate-50/50 p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center hover:bg-white transition-colors">
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className={`w-1 h-3 rounded-full ${getCommColor(name)}`}></div>
                                        <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider truncate">{name}</span>
                                    </div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-2xl font-black text-slate-700 tabular-nums leading-none">{count}</span>
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Grupos</span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* --- FILTERS TOOLBAR --- */}
                        <div className="bg-white p-3 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-center">
                            {kpiFilter && (
                                <div className="flex items-center gap-2 bg-amber-50 border border-amber-200 px-3 py-1 rounded-full animate-pulse">
                                    <span className="text-[10px] font-black text-amber-700 uppercase tracking-widest flex items-center gap-1">
                                        <IconFilter size={12} /> Filtro Activo: {kpiFilter.toUpperCase()}
                                    </span>
                                    <button onClick={() => setKpiFilter(null)} className="text-amber-500 hover:text-amber-700 font-bold text-xs ring-1 ring-amber-200 rounded-full w-4 h-4 flex items-center justify-center bg-white">‚úï</button>
                                </div>
                            )}
                            {/* Buscador Global Unificado */}
                            <div className="relative">
                                <IconSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                <input
                                    type="text"
                                    placeholder="üîç Buscar grupo, agencia, reserva..."
                                    className="border rounded-xl pl-9 pr-8 py-1.5 text-sm w-80 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 font-bold"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                {searchTerm && (
                                    <button
                                        onClick={() => setSearchTerm('')}
                                        className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500 transition-colors"
                                    >
                                        <IconX size={14} />
                                    </button>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Estado:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                >
                                    <option value="all">Todos</option>
                                    <option value="activos">Activos (No Anulados)</option>
                                    <option value="confirmada">Confirmados</option>
                                    <option value="tentativa">Tentativas / Bloqueos</option>
                                    <option value="presupuesto">Presupuestos / Enviados</option>
                                    <option value="prospecto">Prospectos</option>
                                    <option value="anulada">Anulados / Cancelados</option>
                                    <option value="pasado">Pasados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-600">Tiempo:</span>
                                <select
                                    className="border rounded p-1 text-sm bg-gray-50"
                                    value={filterTime}
                                    onChange={(e) => setFilterTime(e.target.value)}
                                >
                                    <option value="all">Historico Completo</option>
                                    <option value="future">Futuros (Desde hoy)</option>
                                    <option value="past">Pasados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2 ml-auto">
                                <span className="text-sm font-semibold text-gray-600">Ordenar por:</span>
                                <button onClick={() => requestSort('Entrada')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Entrada' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    üìÖ Fecha {sortConfig.key === 'Entrada' && (sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì')}
                                </button>
                                <button onClick={() => requestSort('Importe(*)')} className={`text-xs px-2 py-1 rounded border ${sortConfig.key === 'Importe(*)' ? 'bg-blue-100 border-blue-300 font-bold' : 'bg-gray-50'}`}>
                                    üí∞ Importe {sortConfig.key === 'Importe(*)' && (sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì')}
                                </button>
                            </div>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex gap-4 mb-4 border-b border-gray-300 overflow-x-auto items-center justify-between">
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveTab('calendar')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'calendar' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconCalendar size={18} /> Calendario (Gantt)
                                </button>
                                <button
                                    onClick={() => setActiveTab('groups')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'groups' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconGroup size={18} /> Por Grupos <span className="text-[10px] bg-slate-100 px-1.5 rounded-full">{groupedData.length}</span>
                                </button>
                                <button
                                    onClick={() => setActiveTab('segments')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'segments' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconPieChart size={18} /> Segmentaci√≥n
                                </button>
                                <button
                                    onClick={() => setActiveTab('table')}
                                    className={`pb-2 px-4 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'table' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-blue-500 transition'}`}
                                >
                                    <IconTable size={18} /> Validaci√≥n Importaci√≥n {data.filter(r => r._diff).length > 0 && <span className="ml-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                                </button>
                            </div>
                            {/* AI Main Button */}
                            {activeTab !== 'table' && (
                                <button
                                    onClick={handleConsultantClick}
                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm font-bold transition transform hover:scale-105 mb-2 md:mb-0"
                                >
                                    <IconBrain size={18} /> Consultor Virtual
                                    <IconSparkles size={14} />
                                </button>
                            )}
                        </div>

                        {/* --- CONTENT AREA --- */}

                        {/* 1A. CALENDAR (GANTT) VIEW (Priority 1) */}
                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-xl shadow p-4 overflow-hidden animate-fade-in">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-800">Calendario de Ocupaci√≥n (Pr√≥ximos 90 D√≠as)</h3>
                                        <div className="flex gap-2 text-xs mt-1">
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-emerald-500"></div> Confirmado</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-indigo-500"></div> Bloqueado</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-amber-500"></div> Prospecto/Pend.</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-blue-400"></div> Enviado</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-red-400 opacity-50"></div> Cancelado</div>
                                        </div>
                                    </div>
                                    {/* Buscador eliminado aqu√≠ por redundancia - Usar el global superior */}
                                </div>
                                <div className="overflow-auto relative pb-4 custom-scrollbar" style={{ maxHeight: 'calc(100vh - 280px)' }}>
                                    <div className="min-w-[1200px]">
                                        {/* Month Labels Row */}
                                        <div className="flex border-b border-slate-100 sticky top-0 bg-white z-30">
                                            <div className="w-64 shrink-0 bg-slate-50 border-r sticky left-0 z-40"></div>
                                            <div className="flex flex-1">
                                                {(() => {
                                                    const monthSpans = [];
                                                    let currentMonth = -1;
                                                    let currentSpan = null;
                                                    const monthNames = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
                                                    for (let i = 0; i < 90; i++) {
                                                        const d = new Date();
                                                        d.setDate(d.getDate() + i);
                                                        const m = d.getMonth();
                                                        if (m !== currentMonth) {
                                                            if (currentSpan) monthSpans.push(currentSpan);
                                                            currentMonth = m;
                                                            currentSpan = { month: m, year: d.getFullYear(), label: `${monthNames[m]} ${d.getFullYear()}`, count: 1 };
                                                        } else {
                                                            currentSpan.count++;
                                                        }
                                                    }
                                                    if (currentSpan) monthSpans.push(currentSpan);
                                                    return monthSpans.map((ms, i) => (
                                                        <div key={i} style={{ flex: ms.count }} className="text-center text-[9px] font-black uppercase tracking-widest text-slate-500 py-1.5 border-r border-slate-200 bg-slate-50/80">
                                                            {ms.label}
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                        </div>
                                        {/* Header Days */}
                                        <div className="flex border-b border-slate-200 sticky top-[29px] bg-white z-20 shadow-sm">
                                            <div className="w-64 p-2 font-bold text-[10px] text-slate-500 uppercase shrink-0 bg-slate-50 border-r sticky left-0 z-30 shadow-r flex items-center">Grupo / Hotel</div>
                                            <div className="flex flex-1">
                                                {Array.from({ length: 90 }).map((_, i) => {
                                                    const d = new Date();
                                                    d.setDate(d.getDate() + i);
                                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                                    const isToday = i === 0;
                                                    const isFirstOfMonth = d.getDate() === 1;
                                                    return (
                                                        <div key={i} className={`flex-1 min-w-[40px] h-10 flex flex-col items-center justify-center border-r text-[10px] ${isFirstOfMonth ? 'border-l-2 border-l-slate-300' : 'border-slate-100'} ${isToday ? 'bg-blue-50 border-blue-200' : isWeekend ? 'bg-slate-50' : ''}`}>
                                                            <span className={`font-bold leading-none ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{d.getDate()}</span>
                                                            <span className={`text-[7px] uppercase leading-none mt-0.5 ${isToday ? 'text-blue-500 font-bold' : 'text-slate-400'}`}>{d.toLocaleDateString('es-ES', { weekday: 'short' }).slice(0, 2)}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Body Rows */}
                                        <div className="space-y-1 mt-1">
                                            {processedData.length === 0 ? (
                                                <div className="p-12 text-center text-slate-400 flex flex-col items-center">
                                                    <IconCalendar size={48} className="mb-2 opacity-20" />
                                                    <p>No hay grupos para mostrar en este rango con los filtros actuales.</p>
                                                </div>
                                            ) : processedData.map((group, idx) => {
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);

                                                // Parse Dates Robustly
                                                const parseDate = (dStr) => {
                                                    if (!dStr) return null;
                                                    const s = dStr.toString();
                                                    // Handle DD-MM-YYYY or DD/MM/YYYY
                                                    if (s.includes('-') && s.split('-')[0].length <= 2) {
                                                        const [d, m, y] = s.split('-');
                                                        return new Date(`${y}-${m}-${d}`);
                                                    }
                                                    if (s.includes('/') && s.split('/')[0].length <= 2) {
                                                        const [d, m, y] = s.split('/');
                                                        return new Date(`${y}-${m}-${d}`);
                                                    }
                                                    return new Date(s);
                                                };

                                                let start = parseDate(group.Entrada);
                                                let end = parseDate(group.Salida);

                                                if (!start || isNaN(start.getTime())) return null;
                                                if (!end || isNaN(end.getTime())) end = new Date(start);

                                                // Calculate Days from Today (index 0)
                                                const startDiff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
                                                let duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                                if (duration < 1) duration = 1;

                                                // Skip if completely in past or too far future
                                                if (startDiff + duration < 0 || startDiff > 90) return null;

                                                // Calculate Width/Position
                                                let displayStart = startDiff;
                                                let displayDuration = duration;

                                                if (displayStart < 0) {
                                                    displayDuration += displayStart; // Reduce duration by days passed
                                                    displayStart = 0;
                                                }

                                                // Calculate percentages
                                                const leftPercent = (displayStart / 90) * 100;
                                                const widthPercent = (displayDuration / 90) * 100;

                                                // Color Logic
                                                const st = getStatusProps(group["Com_Estado_Interno"] || group["Segment."], group["Entrada"], group["Estado"]);
                                                const colorClass = `${st.color} hover:brightness-110`;

                                                return (
                                                    <div key={idx} className="flex border-b border-slate-50 hover:bg-slate-50 transition-colors group relative h-14 items-center">
                                                        <div className="w-64 px-3 py-2 text-xs font-medium text-slate-700 border-r border-slate-100 shrink-0 sticky left-0 bg-white z-10 group-hover:bg-slate-50 shadow-r h-full flex flex-col justify-center">
                                                            <div className="truncate font-bold text-slate-800">{group["Nombre del Grupo"]}</div>
                                                            <div className="flex items-center gap-1 text-[9px] text-slate-400 mt-0.5">
                                                                <IconBuildingSkyscraper size={10} />
                                                                <span className="truncate max-w-[120px]">{group["Hotel_Asignado"] || group["Hotel"] || "N/A"}</span>
                                                                {group["Importe(*)"] && <span className="text-emerald-600 font-bold ml-auto">{parseFloat(group["Importe(*)"]).toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0, minimumFractionDigits: 0 })}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="flex-1 relative h-full"> {/* Row Track */}
                                                            {/* Grid Lines Background */}
                                                            <div className="absolute inset-0 flex pointer-events-none">
                                                                {Array.from({ length: 90 }).map((_, i) => {
                                                                    const d = new Date();
                                                                    d.setDate(d.getDate() + i);
                                                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                                                    return <div key={i} className={`flex-1 border-r border-slate-50 ${isWeekend ? 'bg-slate-50/50' : ''}`}></div>
                                                                })}
                                                            </div>

                                                            {/* The Bar */}
                                                            {widthPercent > 0 && (
                                                                <div
                                                                    className={`absolute h-8 rounded-lg shadow-sm ${colorClass} text-white text-[9px] flex items-center px-3 whitespace-nowrap overflow-hidden cursor-pointer transition-all z-0 top-3`}
                                                                    style={{ left: `${leftPercent}%`, width: `${widthPercent}%`, minWidth: '4px' }}
                                                                    onClick={() => openFicha(group)}
                                                                    title={`${group["Nombre del Grupo"]}\n${start.toLocaleDateString()} - ${end.toLocaleDateString()}\n${group["Pax."]} Pax`}
                                                                >
                                                                    <span className="font-bold truncate drop-shadow-md">{group["Nombre del Grupo"]}</span>
                                                                    {displayDuration > 5 && <span className="opacity-80 ml-2 text-[8px] font-normal">{group["Pax."]} Pax</span>}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. SEGMENTATION ANALYSIS (NEW) */}
                        {activeTab === 'segments' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Ingresos por Segmento</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={segmentStats} layout="vertical" margin={{ left: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                <XAxis type="number" hide />
                                                <YAxis type="category" dataKey="name" width={100} tick={{ fontSize: 11 }} interval={0} />
                                                <Tooltip formatter={(value) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value)} />
                                                <Bar dataKey="revenue" fill="#8884d8" radius={[0, 4, 4, 0]}>
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="bg-white p-6 rounded-lg shadow h-80">
                                        <h3 className="text-lg font-bold mb-4 text-slate-700">Distribuci√≥n de Pax (Volumen)</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={segmentStats}
                                                    dataKey="pax"
                                                    nameKey="name"
                                                    cx="50%"
                                                    cy="50%"
                                                    outerRadius={80}
                                                    label={({ name, percent }) => `${(percent * 100).toFixed(0)}%`}
                                                >
                                                    {segmentStats.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Detailed Table */}
                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="p-4 border-b bg-slate-50">
                                        <h3 className="text-lg font-bold text-slate-700">Tabla de Rentabilidad por Segmento</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs">
                                                <tr>
                                                    <th className="p-3 w-10"></th>
                                                    <th className="p-3">Segmento</th>
                                                    <th className="p-3 text-right"># Grupos</th>
                                                    <th className="p-3 text-right">Pax Total</th>
                                                    <th className="p-3 text-right">Noches Totales</th>
                                                    <th className="p-3 text-right">Ingresos Totales</th>
                                                    <th className="p-3 text-right">ADR Medio</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {segmentStats.map((seg, idx) => (
                                                    <React.Fragment key={idx}>
                                                        <tr className="hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => setExpandedSegment(expandedSegment === seg.name ? null : seg.name)}>
                                                            <td className="p-3 text-center text-gray-400">
                                                                {expandedSegment === seg.name ? <IconChevronUp size={16} /> : <IconChevronDown size={16} />}
                                                            </td>
                                                            <td className="p-3 font-medium text-slate-800 flex items-center gap-2">
                                                                <span className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[idx % COLORS.length] }}></span>
                                                                {seg.name}
                                                            </td>
                                                            <td className="p-3 text-right font-bold text-blue-600">{seg.groupCount}</td>
                                                            <td className="p-3 text-right">{seg.pax}</td>
                                                            <td className="p-3 text-right">{seg.nights}</td>
                                                            <td className="p-3 text-right font-bold text-slate-700">
                                                                {seg.revenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                            <td className="p-3 text-right text-emerald-600 font-bold">
                                                                {(seg.nights > 0 ? (seg.revenue / seg.nights) : 0).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </td>
                                                        </tr>
                                                        {expandedSegment === seg.name && (
                                                            <tr>
                                                                <td colSpan="7" className="p-0 bg-slate-50">
                                                                    <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                                        {seg.groups.map((groupName, gIdx) => {
                                                                            const groupObj = groupedData.find(g => g.name === groupName);
                                                                            return (
                                                                                <div
                                                                                    key={gIdx}
                                                                                    onClick={() => groupObj && openFicha(groupObj)}
                                                                                    className="bg-white p-2 rounded border border-slate-200 shadow-sm hover:border-blue-500 hover:shadow-md transition-all cursor-pointer group"
                                                                                >
                                                                                    <div className="flex justify-between items-center mb-1">
                                                                                        <span className="text-[10px] font-black text-slate-400 tracking-wider">#{groupObj?.records[0]?.["Reserva"] || "-"}</span>
                                                                                        <span className="text-[9px] font-bold text-slate-500 bg-slate-100 px-1.5 rounded uppercase">{groupObj?.records[0]?.["Hotel"] || groupObj?.records[0]?.["Hotel_Asignado"] || "S/H"}</span>
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center">
                                                                                        <span className="text-xs font-bold text-slate-800 group-hover:text-blue-600 truncate">{groupName}</span>
                                                                                        <IconChevronRight size={14} className="text-slate-300 group-hover:text-blue-500" />
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. GROUP ANALYSIS */}
                        {/* 3. GROUP DIRECTORY */}
                        {activeTab === 'groups' && (
                            <div className="animate-fade-in space-y-4">
                                {/* Header del Directorio con Nuevos Filtros */}
                                <div className="bg-white rounded-2xl shadow-sm p-6 flex flex-col gap-4">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div>
                                            <h2 className="text-2xl font-black text-slate-800 tracking-tight">Gesti√≥n de Grupos</h2>
                                            <p className="text-sm text-slate-500 font-medium">Gesti√≥n unificada de grupos confirmados, bloqueados y enviados.</p>
                                        </div>
                                        <button
                                            onClick={() => window.location.href = 'AltaEmail.html'}
                                            className="bg-[#2d5a43] text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-[#1e3a2c] transition-all shadow-lg shadow-emerald-900/10 active:scale-95 border border-emerald-800"
                                        >
                                            <IconPlus size={18} /> Nuevo Grupo
                                        </button>
                                    </div>

                                    {/* Barra de Herramientas de Filtrado */}
                                    <div className="flex flex-col md:flex-row gap-3">
                                        {/* Buscador eliminado de aqu√≠ por redundancia - El global superior ahora es visible */}

                                        {/* Filtro Hotel */}
                                        <div className="md:w-48">
                                            <select
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all appearance-none cursor-pointer"
                                                value={filterDirHotel}
                                                onChange={(e) => setFilterDirHotel(e.target.value)}
                                            >
                                                <option value="">Todos los Hoteles</option>
                                                {[...new Set(groupedData.map(g => {
                                                    const h = g.records[0]?.["Hotel_Asignado"] || g.records[0]?.["Hotel"];
                                                    return h && h.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : h;
                                                }).filter(Boolean))].sort().map(h => (
                                                    <option key={h} value={h}>{h}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Filtro Comercial */}
                                        <div className="md:w-48">
                                            <select
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all appearance-none cursor-pointer"
                                                value={filterDirCommercial}
                                                onChange={(e) => setFilterDirCommercial(e.target.value)}
                                            >
                                                <option value="">Todos los Comerciales</option>
                                                <option value="SIN_ASIGNAR">Sin Asignar</option>
                                                {commercials.filter(c => c.active).map(c => (
                                                    <option key={c.name} value={c.name}>{c.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Listado de Grupos - VISTA DE TABLA (LINEAS) */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-50 border-b border-slate-200 text-xs font-black text-slate-400 uppercase tracking-wider">
                                                <th className="px-6 py-4 font-black">Hotel</th>
                                                <th className="px-6 py-4 font-black">Grupo / ID</th>
                                                <th className="px-6 py-4 font-black">Comercial</th>
                                                <th className="px-6 py-4 font-black">Entrada</th>
                                                <th className="px-6 py-4 font-black">Salida</th>
                                                <th className="px-6 py-4 font-black text-center">Release</th>
                                                <th className="px-6 py-4 font-black text-center">Pax</th>
                                                <th className="px-6 py-4 font-black text-right">Importe</th>
                                                <th className="px-6 py-4 font-black text-center">Estado</th>
                                                <th className="px-6 py-4 font-black text-right">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {groupedData
                                                .filter(g => {
                                                    // 1. Buscador Texto (Ya filtrado por processedData)
                                                    // No necesitamos re-filtrar aqu√≠ si groupedData se basa en processedData
                                                    // pero respetamos searchTerm si de alguna forma se salt√≥ el primer filtro
                                                    if (searchTerm) {
                                                        const lowerTerm = searchTerm.toLowerCase();
                                                        const name = (g.name || "").toLowerCase();
                                                        const id = (g.id || "").toString().toLowerCase();
                                                        const agency = (g.agency || "").toLowerCase();
                                                        const comercial = (g.records?.[0]?.["Com_Comercial"] || "").toLowerCase();

                                                        const matches = name.includes(lowerTerm) || id.includes(lowerTerm) || agency.includes(lowerTerm) || comercial.includes(lowerTerm);
                                                        if (!matches) return false;
                                                    }

                                                    const status = (g.records[0]?.["Com_Estado_Interno"] || g.status || "").toUpperCase();

                                                    // 3. Filtro KPI activo (El m√°s estricto)
                                                    if (kpiFilter) {
                                                        if (kpiFilter === 'pendingQuotes') {
                                                            const isPresupuesto = status.includes("PRESUP") || (g.records[0]?.["Reserva"] && String(g.records[0]?.["Reserva"]).startsWith("PRES."));
                                                            const isDiscarded = status.includes("DESCART") || status.includes("RECHAZ") || status.includes("ANUL") || status.includes("CANCEL");
                                                            const arrivalIso = g.arrival ? toInputDate(g.arrival) : null;
                                                            const today = new Date().toISOString().split('T')[0];
                                                            const isPast = arrivalIso && arrivalIso < today;
                                                            const importe = parseNum(g.records[0]?.["Importe(*)"]);

                                                            if (!isPresupuesto || isDiscarded || isPast || importe > 0) return false;
                                                        }
                                                    } else {
                                                        // 3.5. Filtro de Estado normal (Si hay b√∫squeda, mostramos todo)
                                                        if (!searchTerm && (status.includes("ANUL") || status.includes("CANC")) && filterStatus !== 'anulada') return false;

                                                        // 3.6 Filtro de Fecha normal: Ocultar grupos PASADOS salvo que se solicite expl√≠citamente
                                                        if (!searchTerm && filterStatus !== 'pasado') {
                                                            const today = new Date().toISOString().split('T')[0];
                                                            const arrivalIso = g.arrival ? toInputDate(g.arrival) : null;
                                                            if (arrivalIso && arrivalIso < today) return false;
                                                        }
                                                    }

                                                    // 4. Filtro Hotel
                                                    if (filterDirHotel) {
                                                        const raw = g.records[0]?.["Hotel_Asignado"] || g.records[0]?.["Hotel"];
                                                        const hotel = raw && raw.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : raw;
                                                        if (hotel !== filterDirHotel) return false;
                                                    }

                                                    // 5. Filtro Comercial
                                                    if (filterDirCommercial) {
                                                        const rawC = (g.records[0]?.["Com_Comercial"] || "").trim().toUpperCase();
                                                        if (filterDirCommercial === 'SIN_ASIGNAR') {
                                                            if (rawC !== "") return false;
                                                        } else {
                                                            if (rawC !== filterDirCommercial.toUpperCase()) return false;
                                                        }
                                                    }

                                                    return true;
                                                })
                                                .map((group, idx) => {
                                                    const st = getStatusProps(group.records?.[0]?.["Com_Estado_Interno"] || group.records?.[0]?.["Segment."], group.arrival, group.records?.[0]?.["Estado"]);
                                                    const statusText = st.label;
                                                    const statusColor = st.text;

                                                    // Normalizar nombre hotel para visualizaci√≥n
                                                    const rawHotel = group.records[0]?.["Hotel_Asignado"] || "Hotel Guadiana";
                                                    const displayHotel = rawHotel.toLowerCase().includes('guadiana') ? 'Sercotel Guadiana' : rawHotel;

                                                    return (
                                                        <tr
                                                            key={idx}
                                                            className="hover:bg-slate-50 transition-colors cursor-pointer group"
                                                            onClick={() => openFicha(group)}
                                                        >
                                                            {/* HOTEL */}
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="p-2 bg-white border border-slate-100 rounded-lg shadow-sm">
                                                                        <IconBuildingSkyscraper size={16} className="text-slate-400" />
                                                                    </div>
                                                                    <span className="text-[10px] font-black text-slate-500 uppercase tracking-wide">
                                                                        {displayHotel}
                                                                    </span>
                                                                </div>
                                                            </td>

                                                            {/* GRUPO / ID */}
                                                            <td className="px-6 py-4">
                                                                <div>
                                                                    <div className="text-sm font-black text-slate-800 group-hover:text-[#2d5a43] transition-colors">{group.name}</div>
                                                                    <div className="text-[10px] font-bold text-slate-400 mt-0.5">
                                                                        ID: {group.records[0]?.["Reserva"] || "---"}
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            {/* COMERCIAL */}
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-1.5">
                                                                    <div className={`w-1.5 h-1.5 rounded-full ${getCommColor(group.records[0]?.["Com_Comercial"])}`}></div>
                                                                    <span className="text-[10px] font-bold text-slate-600 uppercase">
                                                                        {group.records[0]?.["Com_Comercial"] || "Sin Asignar"}
                                                                    </span>
                                                                </div>
                                                            </td>

                                                            {/* FECHAS */}
                                                            <td className="px-6 py-4">
                                                                <div className="text-xs font-bold text-slate-600">{formatDate(group.arrival)}</div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="text-xs font-bold text-slate-600">{formatDate(group.departure)}</div>
                                                            </td>

                                                            <td className="px-6 py-4 text-center">
                                                                {(() => {
                                                                    const now = new Date();
                                                                    now.setHours(0, 0, 0, 0);

                                                                    // Prioritize actual Release Date if set
                                                                    const relDateStr = group.records[0]?.["Com_Vencimiento_Rel"];
                                                                    if (relDateStr) {
                                                                        const relDate = new Date(relDateStr);
                                                                        if (!isNaN(relDate.getTime())) {
                                                                            const diffRel = Math.ceil((relDate - now) / (1000 * 60 * 60 * 24));
                                                                            return (
                                                                                <div className="flex flex-col items-center">
                                                                                    <span className={`text-[10px] font-black px-2 py-0.5 rounded shadow-sm ${diffRel <= 3 ? 'bg-rose-600 text-white animate-pulse' : (diffRel <= 7 ? 'bg-amber-500 text-white' : 'bg-emerald-500 text-white')}`}>
                                                                                        {diffRel}d (REL)
                                                                                    </span>
                                                                                    <span className="text-[8px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">L√≠mite Contrato</span>
                                                                                </div>
                                                                            );
                                                                        }
                                                                    }

                                                                    // Fallback to days to arrival
                                                                    const dIn = new Date(toInputDate(group.arrival));
                                                                    dIn.setHours(0, 0, 0, 0);
                                                                    const diffArr = Math.ceil((dIn - now) / (1000 * 60 * 60 * 24));
                                                                    return (
                                                                        <div className="flex flex-col items-center">
                                                                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${diffArr <= 7 && diffArr > 0 ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-600'}`}>
                                                                                {diffArr > 0 ? `${diffArr}d` : (diffArr === 0 ? 'HOY' : 'PASADO')}
                                                                            </span>
                                                                            <span className="text-[8px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">D√≠as a Llegada</span>
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </td>
                                                            {/* PAX */}
                                                            <td className="px-6 py-4 text-center">
                                                                <span className="inline-flex items-center justify-center min-w-[30px] h-[30px] rounded-lg bg-blue-50 text-blue-700 text-xs font-black">
                                                                    {group.totalPax}
                                                                </span>
                                                            </td>

                                                            {/* IMPORTE */}
                                                            <td className="px-6 py-4 text-right">
                                                                <div className="text-sm font-black text-slate-700">
                                                                    {group.totalRevenue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}
                                                                </div>
                                                            </td>

                                                            {/* ESTADO */}
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${statusColor}`}>
                                                                    {statusText}
                                                                </span>
                                                            </td>

                                                            {/* ACCIONES */}
                                                            <td className="px-6 py-4 text-right">
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); handleProformaClick(group); }}
                                                                    className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"
                                                                    title="Ver Proforma"
                                                                >
                                                                    <IconFile size={16} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                        {groupedData.length === 0 && (
                                            <tbody>
                                                <tr>
                                                    <td colSpan="8" className="px-6 py-12 text-center text-slate-400 text-sm font-medium opacity-60">
                                                        No hay grupos activos que coincidan con los filtros.
                                                    </td>
                                                </tr>
                                            </tbody>
                                        )}
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 4. RAW DATA EDITOR */}
                        {activeTab === 'table' && (
                            <div className="bg-white rounded-lg shadow flex flex-col h-[70vh] animate-fade-in">
                                {/* Table Toolbar */}
                                <div className="p-4 border-b flex flex-wrap gap-4 justify-between items-center">
                                    <input
                                        type="text"
                                        placeholder="Buscar en todos los campos..."
                                        className="border rounded px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <div className="flex gap-2">
                                        {data.filter(r => r._diff).length > 0 && (
                                            <button
                                                onClick={() => {
                                                    if (window.confirm(`¬øEst√°s seguro de que quieres autorizar los ${data.filter(r => r._diff).length} cambios detectados?`)) {
                                                        acceptChanges();
                                                    }
                                                }}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow-md transition flex items-center gap-2"
                                            >
                                                <IconCheck size={16} /> Autorizar Cambios ({data.filter(r => r._diff).length})
                                            </button>
                                        )}
                                        <button onClick={addNewRow} className="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Fila
                                        </button>
                                        <button onClick={() => setShowColumnModal(true)} className="bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-2 rounded text-sm font-medium transition flex items-center gap-1">
                                            <IconPlus /> Columna
                                        </button>
                                        <button
                                            onClick={clearDatabase}
                                            className="bg-red-50 text-red-600 hover:bg-red-100 px-3 py-2 rounded text-sm font-bold transition flex items-center gap-1 border border-red-200"
                                            title="BORRAR TODA LA BASE DE DATOS"
                                        >
                                            <IconTrash size={16} /> Borrar Todo
                                        </button>
                                    </div>
                                </div>

                                {/* Table Container */}
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left text-sm border-collapse">
                                        <thead className="bg-slate-50 text-slate-600 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="p-3 font-bold border-b w-64 bg-slate-100 z-20">ACCI√ìN REQUERIDA / CAMBIOS</th>
                                                <th className="p-3 font-semibold border-b">RESERVA</th>
                                                <th className="p-3 font-semibold border-b">GRUPO / TITULAR</th>
                                                <th className="p-3 font-semibold border-b">ENTRADA</th>
                                                <th className="p-3 font-semibold border-b">ESTADO</th>
                                                <th className="p-3 font-semibold border-b text-center">PAX</th>
                                                <th className="p-3 font-semibold border-b">SEGMENTO</th>
                                                <th className="p-3 font-semibold border-b text-right">IMPORTE</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {data
                                                .map((row, absIndex) => ({ row, absIndex }))
                                                .filter(({ row }) => {
                                                    if (!row._diff) return false;
                                                    if (searchTerm) {
                                                        const lowerTerm = searchTerm.toLowerCase();
                                                        const matches = Object.values(row).some(val =>
                                                            String(val).toLowerCase().includes(lowerTerm)
                                                        );
                                                        if (!matches) return false;
                                                    }
                                                    return true;
                                                })
                                                .map(({ row, absIndex }) => {
                                                    let rowClass = "hover:bg-slate-50 transition-colors group";
                                                    let badge = null;
                                                    let btnColor = "bg-slate-800 hover:bg-slate-900";
                                                    let changeDetails = [];

                                                    if (row._diff === "new") {
                                                        rowClass += " bg-green-50/30";
                                                        badge = <span className="text-green-600 font-black text-[10px] uppercase">NUEVO</span>;
                                                        btnColor = "bg-green-600 hover:bg-green-700";
                                                        changeDetails.push("Nuevo registro importado");
                                                    } else if (row._diff === "cancelled") {
                                                        rowClass += " bg-red-50/30";
                                                        badge = <span className="text-red-600 font-black text-[10px] uppercase">CANCELAR</span>;
                                                        btnColor = "bg-red-600 hover:bg-red-700";
                                                        changeDetails.push("Estado cambiado a ANULADA");
                                                    } else if (row._diff === "modified") {
                                                        rowClass += " bg-blue-50/30";
                                                        badge = <span className="text-blue-600 font-black text-[10px] uppercase">MODIFICADO</span>;
                                                        btnColor = "bg-blue-600 hover:bg-blue-700";

                                                        // Render specific changes
                                                        if (row._changes) {
                                                            Object.keys(row._changes).forEach(k => {
                                                                const ch = row._changes[k];
                                                                changeDetails.push(`${k}: ${ch.old} ‚Üí ${ch.new}`);
                                                            });
                                                        } else {
                                                            changeDetails.push("Datos actualizados");
                                                        }
                                                    }

                                                    return (
                                                        <tr key={String(row.Reserva)} className={rowClass}>
                                                            <td className="p-3 border-b border-r border-slate-200 bg-white/50 sticky left-0 z-10 w-64 align-top">
                                                                <div className="flex flex-col gap-2">
                                                                    <div className="flex gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                const reservaID = String(row["Reserva"]);
                                                                                const confirmMsg = row._diff === 'cancelled' ?
                                                                                    `¬øConfirmas la CANCELACI√ìN del grupo ${row["Nombre del Grupo"]}?` :
                                                                                    `¬øConfirmas la actualizaci√≥n del grupo ${row["Nombre del Grupo"]}?`;

                                                                                if (window.confirm(confirmMsg)) {
                                                                                    console.log("‚ö° INICIANDO AUTORIZACI√ìN:", reservaID);

                                                                                    // Bloquear en la referencia para el listener onSnapshot
                                                                                    authorizingIds.current.add(reservaID.trim());

                                                                                    // Guardar estado previo para posible rollback
                                                                                    const rowStateBefore = { ...row };

                                                                                    // OPTIMISTIC UPDATE: Quitar el diff inmediatamente usando el √≠ndice absoluto
                                                                                    setData(prevData => {
                                                                                        const newData = [...prevData];
                                                                                        if (newData[absIndex]) {
                                                                                            newData[absIndex] = { ...newData[absIndex], _diff: null, _changes: null };
                                                                                        }
                                                                                        return newData;
                                                                                    });

                                                                                    const batch = db.batch();
                                                                                    // Sanitize: eliminar campos internos y undefined
                                                                                    const cleanedRow = {};
                                                                                    Object.keys(row).forEach(k => {
                                                                                        if (!k.startsWith('_') && row[k] !== undefined) {
                                                                                            cleanedRow[k] = row[k];
                                                                                        }
                                                                                    });

                                                                                    const docRef = db.collection("groups").doc(reservaID);
                                                                                    batch.set(docRef, {
                                                                                        ...cleanedRow,
                                                                                        _diff: firebase.firestore.FieldValue.delete(),
                                                                                        _changes: firebase.firestore.FieldValue.delete(),
                                                                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                                                    }, { merge: true });

                                                                                    console.log("üì° Enviando a Firestore...", reservaID);
                                                                                    batch.commit().then(() => {
                                                                                        console.log("‚úÖ GUARDADO EXITOSO:", reservaID);
                                                                                        // Mantener el bloqueo unos segundos para evitar flasheos de onSnapshot
                                                                                        setTimeout(() => {
                                                                                            authorizingIds.current.delete(reservaID.trim());
                                                                                        }, 2000);
                                                                                    }).catch(err => {
                                                                                        console.error("‚ùå ERROR AL GUARDAR:", err);
                                                                                        alert("Error al guardar: " + err.message);
                                                                                        authorizingIds.current.delete(reservaID.trim());
                                                                                        // ROLLBACK: Restaurar el diff si fall√≥
                                                                                        setData(prevData => {
                                                                                            return prevData.map(r =>
                                                                                                String(r.Reserva).trim() === reservaID.trim()
                                                                                                    ? rowStateBefore
                                                                                                    : r
                                                                                            );
                                                                                        });
                                                                                    });
                                                                                }
                                                                            }}
                                                                            className={`flex-1 py-1.5 rounded shadow-sm text-white font-bold text-[10px] flex items-center justify-center gap-1.5 transition-transform active:scale-95 ${btnColor}`}
                                                                        >
                                                                            <IconCheck size={12} stroke={3} /> {badge} - AUTORIZAR
                                                                        </button>
                                                                        <button
                                                                            onClick={() => {
                                                                                if (window.confirm("¬øDescartar este cambio sugerido?")) {
                                                                                    setData(prevData => {
                                                                                        const newData = [...prevData];
                                                                                        if (newData[absIndex]) {
                                                                                            newData[absIndex] = { ...newData[absIndex], _diff: null, _changes: null };
                                                                                        }
                                                                                        return newData;
                                                                                    });
                                                                                }
                                                                            }}
                                                                            className="px-2 bg-slate-200 text-slate-500 rounded hover:bg-slate-300 transition"
                                                                            title="Descartar"
                                                                        >
                                                                            <IconX size={12} />
                                                                        </button>
                                                                    </div>
                                                                    {/* Change Details */}
                                                                    <div className="text-[9px] text-slate-500 font-mono bg-white p-1.5 rounded border border-slate-100 shadow-sm leading-relaxed whitespace-pre-wrap">
                                                                        {changeDetails.map((d, i) => (
                                                                            <div key={i} className={d.includes('‚Üí') ? 'text-blue-600 font-bold' : ''}>‚Ä¢ {d}</div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="p-3 border-b font-mono text-xs font-bold text-slate-500 align-top">{row["Reserva"]}</td>
                                                            <td className="p-3 border-b font-bold text-slate-700 text-xs align-top">{row["Nombre del Grupo"] || row["Empresa/Agencia"]}</td>
                                                            <td className="p-3 border-b text-xs align-top">{formatDate(row["Entrada"])}</td>
                                                            <td className="p-3 border-b text-xs font-bold align-top">{row["Estado"]}</td>
                                                            <td className="p-3 border-b text-center text-xs align-top">{row["Pax."]}</td>
                                                            <td className="p-3 border-b text-xs align-top font-semibold text-slate-600 uppercase">{row["Segment."]}</td>
                                                            <td className="p-3 border-b text-right text-xs font-mono align-top">{parseNum(row["Importe(*)"]).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚Ç¨</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                        {data.filter(r => r._diff).length === 0 && (
                                            <tbody>
                                                <tr>
                                                    <td colSpan={columns.length + 1} className="p-12 text-center text-slate-400">
                                                        <div className="flex flex-col items-center gap-2">
                                                            <IconCheck size={48} className="text-emerald-200" />
                                                            <p className="font-bold text-lg text-slate-600">Todo Sincronizado</p>
                                                            <p className="text-sm">No hay cambios pendientes de revisi√≥n.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        )}
                                    </table>
                                </div>
                                <div className="p-2 border-t text-xs text-gray-500 text-center bg-slate-50 flex justify-between items-center px-4">
                                    <span>Mostrando solo registros con cambios ({data.filter(r => r._diff).length})</span>
                                    <div className="flex gap-4">
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-green-500"></div> Nuevo</div>
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div> Modificado</div>
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div> Cancelado</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal A√±adir Columna */}
                        {showColumnModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className="bg-white p-6 rounded-lg shadow-xl w-96">
                                    <h3 className="text-lg font-bold mb-4">A√±adir Nueva Columna</h3>
                                    <input
                                        type="text"
                                        placeholder="Nombre (ej. Estado, Notas)"
                                        className="w-full border p-2 rounded mb-4"
                                        value={newColumnName}
                                        onChange={(e) => setNewColumnName(e.target.value)}
                                    />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setShowColumnModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                        <button onClick={addNewColumn} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">A√±adir</button>
                                    </div>
                                </div>
                            </div>
                        )}


                        {/* Modal Resultados IA */}
                        {showAiModal && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col animate-fade-in">
                                    <div className="p-4 border-b bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-t-lg flex justify-between items-center">
                                        <h3 className="font-bold flex items-center gap-2">
                                            <IconBrain className="text-purple-300" />
                                            {aiResult ? aiResult.title : "Analizando datos..."}
                                        </h3>
                                        <button onClick={() => setShowAiModal(false)} className="text-slate-400 hover:text-white">&times;</button>
                                    </div>
                                    <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                                        {isAiLoading ? (
                                            <div className="flex flex-col items-center justify-center py-10">
                                                <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                                                <p className="text-slate-500 animate-pulse-slow text-center">
                                                    Gemini est√° analizando tus reservas... <br />
                                                    <span className="text-xs">Buscando patrones y rentabilidad.</span>
                                                </p>
                                            </div>
                                        ) : (
                                            <div className="prose prose-sm max-w-none text-slate-700" dangerouslySetInnerHTML={{ __html: marked.parse(aiResult?.content || "") }}></div>
                                        )}
                                    </div>
                                    <div className="p-4 border-t bg-slate-50 text-right rounded-b-lg">
                                        <button onClick={() => setShowAiModal(false)} className="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded transition">Cerrar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {showFichaModal && selectedGroupFicha && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-2">
                                <div className="bg-white rounded-xl shadow-2xl w-[98vw] h-[95vh] overflow-hidden flex flex-col animate-fade-in border border-slate-200 text-sm">
                                    {/* CENTRO DE MANDO NEXUS (Header + Acciones) */}
                                    <div className="bg-[#0f172a] text-white p-3 border-b border-white/10 shrink-0">
                                        <div className="flex justify-between items-start gap-4">
                                            <div className="flex gap-3">
                                                <div className="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20 shrink-0">
                                                    <IconUsers size={20} />
                                                </div>
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <h3 className="text-xl font-black tracking-tight leading-none text-emerald-400">{selectedGroupFicha.name || "NOMBRE DEL GRUPO"}</h3>
                                                        {(() => {
                                                            const st = getStatusProps(selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || selectedGroupFicha.records[0]?.["Segment."], selectedGroupFicha.arrival, selectedGroupFicha.records[0]?.["Estado"]);
                                                            return (
                                                                <span className={`px-2 py-0.5 rounded text-[8px] font-black uppercase ${st.text}`}>
                                                                    {st.label}
                                                                </span>
                                                            );
                                                        })()}
                                                        <span className="bg-white/10 px-2 py-0.5 rounded text-[8px] font-black text-white/80 uppercase">
                                                            {selectedGroupFicha.records[0]?.["R√©gimen"] || 'HD'}
                                                        </span>
                                                        <span className="bg-blue-500/20 px-2 py-0.5 rounded text-[8px] font-black text-blue-200 uppercase border border-blue-500/30">
                                                            {selectedGroupFicha.records[0]?.["Segment."] || 'GRUPOS'}
                                                        </span>
                                                    </div>
                                                    <p className="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1">
                                                        {selectedGroupFicha.records[0]?.["Empresa/Agencia"] || 'VENTA DIRECTA'} ‚Ä¢ {selectedGroupFicha.totalPax} PAX ‚Ä¢ REF: {selectedGroupFicha.records[0]?.["Reserva"]}
                                                    </p>
                                                </div>
                                            </div>

                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        // Ensure we are passing the most up-to-date record which contains all metadata updates
                                                        const baseRecord = (selectedGroupFicha.records && selectedGroupFicha.records[0]) ? selectedGroupFicha.records[0] : {};

                                                        // Recalculate Forecast for Proforma to ensure sync with Tarifa Neta
                                                        const neto = parseNum(baseRecord["Com_Precio"] || "0");
                                                        const pax = parseInt(selectedGroupFicha.totalPax || 0);
                                                        const noches = parseInt(selectedGroupFicha.totalNights || 1);
                                                        const calculatedImporte = neto > 0 ? (neto * pax * noches).toFixed(2) : (selectedGroupFicha.totalRevenue || baseRecord["Importe(*)"]);

                                                        const proformaData = {
                                                            ...baseRecord,
                                                            "Importe(*)": calculatedImporte,
                                                            "Pax.": selectedGroupFicha.totalPax || baseRecord["Pax."],
                                                            "Empresa/Agencia": selectedGroupFicha.agency || baseRecord["Empresa/Agencia"] || "",
                                                            "Hotel_Asignado": baseRecord["Hotel_Asignado"] || baseRecord["Hotel"] || "Guadiana",
                                                            "Email": selectedGroupFicha.email || baseRecord["Email"] || "",
                                                            "Nombre del Grupo": selectedGroupFicha.name || baseRecord["Nombre del Grupo"],
                                                            "Entrada": selectedGroupFicha.arrival || baseRecord["Entrada"],
                                                            "Salida": selectedGroupFicha.departure || baseRecord["Salida"]
                                                        };

                                                        // Origen de l√≠neas de cargo: Agregaci√≥n de todos los registros del grupo
                                                        let roomList = [];
                                                        const processedIds = new Set();
                                                        (selectedGroupFicha.records || []).forEach(r => {
                                                            try {
                                                                const list = JSON.parse(r["RoomingList_JSON"] || "[]");
                                                                list.forEach(item => {
                                                                    if (item.id && !processedIds.has(item.id)) {
                                                                        roomList.push(item);
                                                                        processedIds.add(item.id);
                                                                    } else if (!item.id) {
                                                                        roomList.push(item);
                                                                    }
                                                                });
                                                            } catch (e) { }
                                                        });
                                                        try {
                                                            const mappedItems = [];
                                                            const fallbackDate = selectedGroupFicha.arrival || baseRecord["Entrada"] || new Date().toISOString().split('T')[0];

                                                            if (roomList.length > 0) {
                                                                roomList.forEach(r => {
                                                                    const nights = parseInt(r.nights) || 1;
                                                                    const dInStr = toInputDate(r.dateIn) || toInputDate(fallbackDate);
                                                                    const dIn = new Date(dInStr);

                                                                    for (let i = 0; i < nights; i++) {
                                                                        const currentDay = new Date(dIn);
                                                                        if (!isNaN(currentDay.getTime())) {
                                                                            currentDay.setDate(currentDay.getDate() + i);
                                                                        }

                                                                        const finalIso = !isNaN(currentDay.getTime()) ? currentDay.toISOString().split('T')[0] : toInputDate(fallbackDate);

                                                                        mappedItems.push({
                                                                            fecha: formatDate(finalIso),
                                                                            hab: '1',
                                                                            cant: String(parseInt(r.qty) || 1),
                                                                            concepto: `${r.type}${r.regime ? ` (${r.regime})` : ''}`,
                                                                            precio: parseFloat(r.price) || 0,
                                                                            iva: parseInt(r.iva || 10),
                                                                            regimen: r.regime || '',
                                                                            dias: '1',
                                                                            comision: r.comision
                                                                        });
                                                                    }
                                                                });
                                                            }

                                                            if (mappedItems.length > 0) {
                                                                proformaData["ProformaItems"] = mappedItems;
                                                                proformaData["Importe(*)"] = roomList.reduce((acc, r) => acc + (parseFloat(r.total) || 0), 0).toFixed(2);
                                                            }
                                                        } catch (e) {
                                                            console.error("Error mapping room list", e);
                                                        }

                                                        localStorage.setItem('selectedGroup', JSON.stringify(proformaData));
                                                        // Pasar √≠tems por clave dedicada para que Fac Prof los reciba siempre (evita p√©rdida por estado/ref)
                                                        const itemsToPass = proformaData["ProformaItems"] && proformaData["ProformaItems"].length > 0 ? proformaData["ProformaItems"] : [];
                                                        localStorage.setItem('nexus_proforma_items', JSON.stringify(itemsToPass));
                                                        localStorage.setItem('nexus_proforma_reserva', String(baseRecord["Reserva"] || selectedGroupFicha.records?.[0]?.["Reserva"] || ""));
                                                        window.location.href = 'Fac Prof.html';
                                                    }}
                                                    className="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-emerald-500/20"
                                                >
                                                    <IconTable size={12} /> PROFORMA / FACTURA
                                                </button>
                                                <button
                                                    onClick={() => handleEmailClick(selectedGroupFicha)}
                                                    className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-blue-600/20"
                                                >
                                                    <IconMail size={12} /> REDACTAR EMAIL IA
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        // Directly perform annul without native confirm dialog
                                                        const fichaRecords = selectedGroupFicha?.records || [];
                                                        const fichaName = selectedGroupFicha?.name;

                                                        setShowFichaModal(false);

                                                        setData(prevData => prevData.map(row => {
                                                            if ((row["Nombre del Grupo"] || "") === fichaName) {
                                                                return { ...row, "Com_Estado_Interno": "CANCELADO", "Estado": "ANULADA" };
                                                            }
                                                            return row;
                                                        }));

                                                        try {
                                                            const batch = db.batch();
                                                            fichaRecords.forEach(rec => {
                                                                const resID = String(rec["Reserva"] || "").trim();
                                                                if (resID) {
                                                                    batch.set(db.collection("groups").doc(resID), {
                                                                        "Com_Estado_Interno": "CANCELADO",
                                                                        "Estado": "ANULADA",
                                                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                                    }, { merge: true });
                                                                }
                                                            });
                                                            await batch.commit();
                                                            console.log("‚úÖ Anulado en Firestore:", fichaName);
                                                        } catch (err) {
                                                            console.error("‚ùå Error anulando:", err);
                                                        }
                                                    }}
                                                    className="px-3 py-1.5 bg-slate-700 hover:bg-red-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-black/20"
                                                >
                                                    <IconTrash size={12} /> ANULAR GRUPO
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        setShowFichaModal(false);
                                                    }}
                                                    className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg font-black text-[10px] transition-all flex items-center gap-2 shadow-lg shadow-red-500/20"
                                                >
                                                    <IconX size={12} stroke={3} /> GUARDAR Y SALIR
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar bg-slate-50/50">
                                        {/* DASHBOARD COMERCIAL HORIZONTAL - FORZADO CON GRID INLINE */}
                                        {/* DASHBOARD INTELIGENTE */}
                                        {(() => {
                                            const now = new Date();
                                            let daysToArrival = 0;

                                            // Robust Date Parsing for Arrival
                                            if (selectedGroupFicha.arrival) {
                                                const d = new Date(selectedGroupFicha.arrival);
                                                if (!isNaN(d.getTime())) {
                                                    const diffTime = d - now;
                                                    daysToArrival = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                                }
                                            }

                                            const releaseDateStr = selectedGroupFicha.records[0]?.["Com_Vencimiento_Rel"];
                                            let daysToRelease = null;
                                            if (releaseDateStr) {
                                                const releaseDate = new Date(releaseDateStr);
                                                if (!isNaN(releaseDate.getTime())) {
                                                    daysToRelease = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
                                                }
                                            }

                                            const neto = parseNum(selectedGroupFicha.records[0]?.["Com_Precio"] || "0");
                                            const pax = parseInt(selectedGroupFicha.totalPax || 0);
                                            const noches = parseInt(selectedGroupFicha.totalNights || 1);
                                            // Auto-calculate forecast if Net Rate is input, otherwise use Importe(*)
                                            // C√°lculos de IVA Agregados para el Panel
                                            const roomList = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]");
                                            let totalB10 = 0, totalI10 = 0, totalB21 = 0, totalI21 = 0;
                                            roomList.forEach(item => {
                                                const sub = parseFloat(item.total) || 0;
                                                const rate = item.iva == 21 ? 1.21 : 1.10;
                                                const base = sub / rate;
                                                if (item.iva == 21) {
                                                    totalB21 += base;
                                                    totalI21 += (sub - base);
                                                } else {
                                                    totalB10 += base;
                                                    totalI10 += (sub - base);
                                                }
                                            });
                                            const grandTotal = roomList.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0);

                                            // B√∫squeda de pagos urgentes (<= 2 d√≠as)
                                            const urgentPayments = [];
                                            const todayForAlert = new Date();
                                            todayForAlert.setHours(0, 0, 0, 0);

                                            selectedGroupFicha.records.forEach(r => {
                                                try {
                                                    const plan = JSON.parse(r.PaymentPlan_JSON || "[]");
                                                    plan.forEach(p => {
                                                        if (p.status !== "Cobrado") {
                                                            const d = new Date(toInputDate(p.date));
                                                            d.setHours(0, 0, 0, 0);
                                                            const diff = Math.ceil((d - todayForAlert) / (1000 * 60 * 60 * 24));
                                                            if (diff <= 2) {
                                                                urgentPayments.push({ ...p, hotel: r["Hotel_Asignado"] || r["Hotel"] || "Gral." });
                                                            }
                                                        }
                                                    });
                                                } catch (e) { }
                                            });

                                            return (
                                                <div className="flex flex-col gap-2 mb-2">
                                                    {urgentPayments.length > 0 && (
                                                        <div className="bg-rose-600 text-white p-2 rounded-lg flex items-center gap-3 animate-pulse shadow-lg shadow-rose-600/20">
                                                            <IconAlertTriangle size={16} stroke={3} />
                                                            <div className="flex-1">
                                                                <p className="text-[10px] font-black uppercase tracking-tight">¬°Atenci√≥n! Pagos Pendientes</p>
                                                                <div className="flex flex-wrap gap-x-4">
                                                                    {urgentPayments.slice(0, 3).map((up, i) => (
                                                                        <span key={i} className="text-[9px] font-bold opacity-90">
                                                                            ‚Ä¢ {up.label}: {parseFloat(up.amount).toLocaleString('es-ES')}‚Ç¨ ({up.hotel})
                                                                        </span>
                                                                    ))}
                                                                    {urgentPayments.length > 3 && <span className="text-[9px] font-bold opacity-90">‚Ä¢ ...y {urgentPayments.length - 3} m√°s</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                    {/* PANEL FINANCIERO CORPORATIVO */}
                                                    <div className="bg-[#2d5a43] text-white p-3 rounded-lg shadow-lg flex justify-between items-center border border-emerald-800">
                                                        <div className="flex gap-6">
                                                            <div>
                                                                <p className="text-[8px] font-black uppercase opacity-60 mb-0.5">Base Imponible</p>
                                                                <p className="text-sm font-black tabular-nums">{(totalB10 + totalB21).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</p>
                                                            </div>
                                                            <div>
                                                                <p className="text-[8px] font-black uppercase opacity-60 mb-0.5">Cuota IVA</p>
                                                                <p className="text-sm font-black tabular-nums">{(totalI10 + totalI21).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</p>
                                                            </div>
                                                            <div className="border-l border-white/20 pl-6">
                                                                <p className="text-[8px] font-black uppercase opacity-60 mb-0.5">Desglose Detallado</p>
                                                                <div className="flex gap-3 text-[9px] font-bold">
                                                                    {totalB10 > 0 && <span className="bg-white/10 px-1.5 py-0.5 rounded">10%: {totalI10.toFixed(2)}‚Ç¨</span>}
                                                                    {totalB21 > 0 && <span className="bg-white/10 px-1.5 py-0.5 rounded">21%: {totalI21.toFixed(2)}‚Ç¨</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-[9px] font-black uppercase tracking-widest text-emerald-300">Total Previsi√≥n</p>
                                                            <p className="text-2xl font-black text-white drop-shadow-md">
                                                                {grandTotal.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    {/* HEADER COMPACTO: ESTADO Y DATOS CLAVE */}
                                                    <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                        {/* Estado */}
                                                        <div className="w-40 relative">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Estado del Grupo</label>
                                                            <div className="relative h-10 w-full">
                                                                {(() => {
                                                                    const rawStatus = selectedGroupFicha.records[0]?.["Com_Estado_Interno"] || selectedGroupFicha.records[0]?.["Segment."] || selectedGroupFicha.records[0]?.["Estado"] || "PROSPECTO";
                                                                    const st = getStatusProps(rawStatus, selectedGroupFicha.arrival, selectedGroupFicha.records[0]?.["Estado"]);

                                                                    let selectVal = "PROSPECTO";
                                                                    const s = rawStatus.toUpperCase();
                                                                    if (s.includes("CONFIRM") || s.includes("GARANT") || s.includes("RESERVA") || s === "GRUPOS") selectVal = "CONFIRMADO";
                                                                    else if (s.includes("TANTEO") || s.includes("TENTA") || s.includes("BLOQ") || s.includes("OPCI")) selectVal = "TENTATIVA";
                                                                    else if (s.includes("PRESUP") || s.includes("ENVIA") || s.includes("COTIZ") || s.includes("OFERT")) selectVal = "PRESUPUESTO";
                                                                    else if (s.includes("CANC") || s.includes("ANUL") || s.includes("BAJA")) selectVal = "CANCELADO";
                                                                    else if (s.includes("PROSPEC") || s.includes("PENDIE")) selectVal = "PROSPECTO";

                                                                    return (
                                                                        <select
                                                                            className={`w-full h-full pl-3 pr-8 text-xs font-black uppercase rounded-lg text-white appearance-none outline-none border-2 border-transparent transition-all shadow-md cursor-pointer ${st.color}`}
                                                                            value={selectVal}
                                                                            onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Estado_Interno", e.target.value)}
                                                                            style={{ WebkitAppearance: 'none', MozAppearance: 'none' }}
                                                                        >
                                                                            <option className="bg-white text-slate-800 font-bold" value="PRESUPUESTO">PRESUPUESTO</option>
                                                                            <option className="bg-white text-amber-600 font-bold" value="TENTATIVA">TENTATIVA</option>
                                                                            <option className="bg-white text-emerald-600 font-bold" value="CONFIRMADO">CONFIRMADO</option>
                                                                            <option className="bg-white text-red-600 font-bold" value="CANCELADO">CANCELADO</option>
                                                                            <option className="bg-white text-slate-500 font-bold" value="PROSPECTO">PROSPECTO</option>
                                                                        </select>
                                                                    );
                                                                })()}
                                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-white/80">
                                                                    <IconChevronDown size={14} stroke={3} />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Hotel Asignado Selector (New) */}
                                                        <div className="w-40 relative">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Hotel Principal</label>
                                                            <div className="relative h-10 w-full">
                                                                <select
                                                                    className="w-full h-full pl-3 pr-8 text-xs font-black uppercase rounded-lg bg-white border-2 border-slate-200 text-slate-700 appearance-none outline-none hover:border-blue-400 transition-all shadow-sm cursor-pointer"
                                                                    value={selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "Sercotel Guadiana"}
                                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Hotel_Asignado", e.target.value)}
                                                                >
                                                                    <option value="Sercotel Guadiana">Sercotel Guadiana</option>
                                                                    <option value="Cumbria Spa & Hotel">Cumbria Spa & Hotel</option>
                                                                </select>
                                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                    <IconChevronDown size={14} stroke={3} />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Comercial Asignado */}
                                                        <div className="w-28 relative">
                                                            <div className="flex justify-between items-center mb-1">
                                                                <label className="text-[9px] font-black text-slate-400 uppercase block leading-none">Comercial</label>
                                                                {(() => {
                                                                    const currentComm = selectedGroupFicha.records[0]?.["Com_Comercial"];
                                                                    const isCommInactive = currentComm && commercials.some(c => c.name === currentComm && !c.active);
                                                                    if (isCommInactive) {
                                                                        return (
                                                                            <span className="flex items-center gap-1 text-[8px] font-black text-rose-500 animate-pulse" title="Comercial Inactivo - ¬°Reasignar!">
                                                                                <IconAlertTriangle size={10} /> INACTIVO
                                                                            </span>
                                                                        );
                                                                    }
                                                                    return null;
                                                                })()}
                                                            </div>
                                                            <div className="relative h-10 w-full">
                                                                <select
                                                                    className={`w-full h-full pl-2 pr-6 text-[9px] font-black uppercase rounded-lg bg-white border-2 text-slate-700 appearance-none outline-none transition-all shadow-sm cursor-pointer ${selectedGroupFicha.records[0]?.["Com_Comercial"] && commercials.some(c => c.name === selectedGroupFicha.records[0]?.["Com_Comercial"] && !c.active)
                                                                        ? 'border-rose-200 bg-rose-50 text-rose-700 hover:border-rose-400'
                                                                        : 'border-slate-200 hover:border-blue-400'
                                                                        }`}
                                                                    value={selectedGroupFicha.records[0]?.["Com_Comercial"] || ""}
                                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Comercial", e.target.value)}
                                                                >
                                                                    <option value="">SIN ASIGNAR</option>
                                                                    {/* Only show active ones or the current one if it's inactive (so it's selectable/visible) */}
                                                                    {commercials.filter(c => (c.active || c.name === (selectedGroupFicha.records[0]?.["Com_Comercial"]))).map(c => (
                                                                        <option key={c.name} value={c.name}>{c.name} {!c.active ? '(INACTIVO)' : ''}</option>
                                                                    ))}
                                                                </select>
                                                                <div className="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                    <IconChevronDown size={10} stroke={3} />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Nuevos Controles de Gesti√≥n: Seguimiento y Release */}
                                                        <div className="flex gap-1.5 flex-1">
                                                            <div className="flex-1">
                                                                <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Pr√≥x. Seguimiento</label>
                                                                <input
                                                                    type="date"
                                                                    className={`w-full h-10 px-2 text-[10px] font-black rounded-lg border-2 ${selectedGroupFicha.records[0]?.["Com_Seguimiento"] && new Date(selectedGroupFicha.records[0]?.["Com_Seguimiento"]) <= new Date() ? 'border-blue-300 bg-blue-50 text-blue-700' : 'border-slate-100 bg-white text-slate-600'} outline-none focus:border-blue-500 transition-all`}
                                                                    value={selectedGroupFicha.records[0]?.["Com_Seguimiento"] || ""}
                                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Seguimiento", e.target.value)}
                                                                />
                                                            </div>
                                                            <div className="flex-1">
                                                                <label className="text-[9px] font-black text-slate-400 uppercase block mb-1 font-black">L√≠mite Release</label>
                                                                <input
                                                                    type="date"
                                                                    className={`w-full h-10 px-2 text-[10px] font-black rounded-lg border-2 ${daysToRelease !== null && daysToRelease <= 7 ? 'border-rose-300 bg-rose-50 text-rose-700' : 'border-slate-100 bg-white text-slate-600'} outline-none focus:border-rose-500 transition-all`}
                                                                    value={selectedGroupFicha.records[0]?.["Com_Vencimiento_Rel"] || ""}
                                                                    onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Vencimiento_Rel", e.target.value)}
                                                                />
                                                            </div>
                                                        </div>

                                                        {/* Bot√≥n Datos Cliente + Segmentaci√≥n */}
                                                        <div className="flex-1 flex gap-2">
                                                            <button
                                                                onClick={() => setShowClientData(true)}
                                                                className="flex-1 flex flex-col justify-center px-3 py-1 bg-white border border-blue-200 hover:border-blue-400 rounded group transition-all relative overflow-hidden"
                                                            >
                                                                {/* Segmentaci√≥n como Marca de Agua / Etiqueta Flotante */}
                                                                <div className="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[9px] font-black px-2 py-0.5 rounded-bl shadow-sm border-b border-l border-blue-200 uppercase tracking-wider">
                                                                    {selectedGroupFicha.records[0]?.["Segment."] || 'GRUPOS'}
                                                                </div>

                                                                <div className="flex items-center gap-1.5 mt-2">
                                                                    <div className="bg-blue-100 p-1 rounded-full text-blue-600">
                                                                        <IconUsers size={12} />
                                                                    </div>
                                                                    <div className="text-left w-full overflow-hidden">
                                                                        <div className="text-[9px] font-black text-slate-400 uppercase leading-none mb-0.5">
                                                                            Cliente / Agencia
                                                                        </div>
                                                                        <div className="text-xs font-bold text-slate-800 truncate w-full pr-16" title={selectedGroupFicha.records[0]?.["Fiscal_RazonSocial"] || selectedGroupFicha.records[0]?.["Empresa/Agencia"] || "Sin Datos"}>
                                                                            {selectedGroupFicha.records[0]?.["Fiscal_RazonSocial"] || selectedGroupFicha.records[0]?.["Empresa/Agencia"] || "Indefinido"}
                                                                        </div>
                                                                    </div>
                                                                    <IconMore size={16} className="text-slate-300 group-hover:text-blue-500 ml-auto" />
                                                                </div>
                                                            </button>
                                                        </div>

                                                        {/* Forecast & Release - Compacted */}
                                                        <div className="flex gap-2">
                                                            <div className="w-20 text-right">
                                                                <label className="text-[8px] font-black text-slate-400 uppercase block">Forecast</label>
                                                                <span className="text-xs font-black text-emerald-600 font-mono tracking-tight">{grandTotal.toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</span>
                                                            </div>
                                                            <div className="w-16 text-center">
                                                                <label className="text-[8px] font-black text-slate-400 uppercase block">Release</label>
                                                                <span className={`text-[10px] font-bold px-1 rounded ${daysToRelease < 7 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`}>
                                                                    {daysToRelease !== null ? daysToRelease + 'd' : '-'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}

                                        {/* OBSERVACIONES EXTERNAS (PMS/Excel) */}
                                        {(selectedGroupFicha.records[0]?.["Observaciones"] || selectedGroupFicha.records[0]?.["Observac."]) && (
                                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex gap-3 items-start animate-fade-in">
                                                <div className="bg-amber-100 text-amber-600 p-1.5 rounded-lg shrink-0 mt-0.5">
                                                    <IconFile size={16} />
                                                </div>
                                                <div className="flex-1">
                                                    <h4 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1">Observaciones de Origen (PMS)</h4>
                                                    <p className="text-xs font-bold text-slate-700 whitespace-pre-line leading-relaxed border-l-2 border-amber-300 pl-2">
                                                        {selectedGroupFicha.records[0]?.["Observaciones"] || selectedGroupFicha.records[0]?.["Observac."]}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* GESTOR DE HABITACIONES & INVENTARIO (REDISE√ëADO) */}
                                        <div className="bg-slate-50/80 p-4 rounded-xl border border-slate-200 shadow-sm mt-4 backdrop-blur-sm">
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="p-1.5 bg-blue-100/50 rounded-lg text-blue-600">
                                                        <IconBed size={16} stroke={2.5} />
                                                    </div>
                                                    <div>
                                                        <h4 className="text-xs font-black text-slate-700 uppercase tracking-wide">Gesti√≥n de Habitaciones</h4>
                                                        <p className="text-[10px] text-slate-400 font-medium leading-none">Inventario y Tarifas por Tipo</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <span className="block text-[9px] font-bold text-slate-400 uppercase tracking-widest">Forecast Real</span>
                                                    <span className="text-sm font-black text-emerald-600 font-mono bg-white px-2 py-0.5 rounded border border-emerald-100 shadow-sm">
                                                        {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]").reduce((acc, i) => acc + parseFloat(i.total), 0)).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}
                                                    </span>
                                                </div>
                                            </div>

                                            {/* Formulario de Entrada - Dise√±o Compacto */}
                                            <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm mb-3">
                                                <div className="flex items-end gap-2 flex-wrap xl:flex-nowrap">
                                                    {/* Selector de Hotel (Solo si hay m√°s de 1 hotel o para asignar) */}
                                                    <div className="w-40">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Hotel</label>
                                                        <div className="relative">
                                                            <select
                                                                className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-3 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none cursor-pointer"
                                                                value={roomManagerForm.hotel}
                                                                onChange={e => setRoomManagerForm({ ...roomManagerForm, hotel: e.target.value })}
                                                            >
                                                                <option value="">{selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "Seleccionar..."}</option>
                                                                {Array.from(new Set(selectedGroupFicha.records.map(r => r["Hotel_Asignado"] || r["Hotel"]).filter(Boolean))).map(h => (
                                                                    <option key={h} value={h}>{h}</option>
                                                                ))}
                                                            </select>
                                                            <IconChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={14} />
                                                        </div>
                                                    </div>

                                                    <div className="w-56">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Producto / Habitaci√≥n</label>
                                                        <div className="relative">
                                                            <input
                                                                list="room-options-list"
                                                                type="text"
                                                                className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-3 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400"
                                                                placeholder="Escribe o selecciona..."
                                                                value={roomManagerForm.type}
                                                                onChange={e => setRoomManagerForm({ ...roomManagerForm, type: e.target.value })}
                                                                onClick={(e) => e.target.select()}
                                                            />
                                                            <datalist id="room-options-list">
                                                                <option value="Habitaci√≥n Doble (DBL)" />
                                                                <option value="Habitaci√≥n Twin (TWI)" />
                                                                <option value="Habitaci√≥n Individual (DUI)" />
                                                                <option value="Habitaci√≥n Triple (TRI)" />
                                                                <option value="Junior Suite (JSU)" />
                                                                <option value="Doble Superior (DSUP)" />
                                                                <option value="Restaurante" />
                                                                <option value="Sal√≥n" />
                                                                <option value="Suplemento" />
                                                                <option value="Sala de Reuniones" />
                                                                <option value="Coffee Break" />
                                                            </datalist>
                                                            <IconChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={14} />
                                                        </div>
                                                    </div>

                                                    <div className="flex gap-1">
                                                        <div className="w-28">
                                                            <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Llegada</label>
                                                            <input
                                                                type="date"
                                                                className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-2 text-xs font-medium text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                                value={toInputDate(roomManagerForm.dateIn)}
                                                                onChange={e => setRoomManagerForm({ ...roomManagerForm, dateIn: e.target.value })}
                                                            />
                                                        </div>
                                                        <div className="w-28">
                                                            <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1">Salida</label>
                                                            <input
                                                                type="date"
                                                                className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-2 text-xs font-medium text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                                value={toInputDate(roomManagerForm.dateOut)}
                                                                onChange={e => setRoomManagerForm({ ...roomManagerForm, dateOut: e.target.value })}
                                                            />
                                                        </div>
                                                    </div>

                                                    <div className="w-14">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-center">Cant.</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg text-center text-xs font-black text-slate-800 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                                                            value={roomManagerForm.qty}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, qty: e.target.value })}
                                                        />
                                                    </div>

                                                    <div className="w-16">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-center">R√©gimen</label>
                                                        <select
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg px-1 text-center text-xs font-bold text-slate-600 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 appearance-none"
                                                            value={roomManagerForm.regime}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, regime: e.target.value })}
                                                        >
                                                            <option value="">-</option>
                                                            <option>AD</option>
                                                            <option>MP</option>
                                                            <option>PC</option>
                                                            <option>SA</option>
                                                            <option>TI</option>
                                                        </select>
                                                    </div>

                                                    <div className="w-20">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-right">Precio/U</label>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg pl-2 pr-6 text-right text-xs font-bold text-slate-800 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20"
                                                                value={roomManagerForm.price}
                                                                onChange={e => setRoomManagerForm({ ...roomManagerForm, price: e.target.value })}
                                                            />
                                                            <span className="absolute right-2 top-2.5 text-[10px] text-slate-400 font-bold">‚Ç¨</span>
                                                        </div>
                                                    </div>

                                                    <div className="w-16">
                                                        <label className="block text-[9px] font-black text-slate-400 uppercase mb-1 ml-1 text-center">IVA</label>
                                                        <select
                                                            className="w-full h-9 bg-slate-50 border border-slate-200 rounded-lg text-center text-xs font-bold text-slate-600 outline-none focus:border-blue-500 transition-all appearance-none cursor-pointer"
                                                            value={roomManagerForm.iva}
                                                            onChange={e => setRoomManagerForm({ ...roomManagerForm, iva: e.target.value })}
                                                        >
                                                            <option value="10">10%</option>
                                                            <option value="21">21%</option>
                                                        </select>
                                                    </div>

                                                    <button
                                                        onClick={addRoomBlock}
                                                        className={`h-9 px-4 ${editingId ? 'bg-amber-500 hover:bg-amber-600 shadow-amber-500/20' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/20'} text-white rounded-lg shadow-md active:scale-95 transition-all flex items-center gap-2`}
                                                    >
                                                        {editingId ? <IconRefresh size={14} stroke={3} /> : <span className="text-sm font-bold">+</span>}
                                                        <span className="text-xs font-bold uppercase">{editingId ? 'Actualizar' : 'A√±adir'}</span>
                                                    </button>
                                                    {editingId && (
                                                        <button onClick={() => { setEditingId(null); setRoomManagerForm(prev => ({ ...prev, qty: 1, price: 0 })); }} className="px-2 text-slate-400 hover:text-slate-600">
                                                            <IconX size={16} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Tabla de Resultados - Clean UI */}
                                            <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                                                <table className="w-full text-xs text-left border-collapse">
                                                    <thead className="bg-slate-50 border-b border-slate-200">
                                                        <tr>
                                                            <th className="py-2.5 px-3 w-8"></th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Hotel</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Producto</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider">Fecha Cargo</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">Noches</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">Cantidad</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">R√©g.</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right">P. Unit</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center">IVA</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right bg-blue-50/20">Base Com.</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-center bg-blue-50/20">%</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right bg-blue-50/20">Comisi√≥n ‚Ç¨</th>
                                                            <th className="py-2.5 px-3 font-black text-slate-400 text-[9px] uppercase tracking-wider text-right bg-slate-100/50">Total</th>
                                                            <th className="py-2.5 px-3 w-8"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")).map((item, index) => (
                                                            <tr
                                                                key={item.id}
                                                                draggable
                                                                onDragStart={e => e.dataTransfer.setData("idx", index)}
                                                                onDragOver={e => e.preventDefault()}
                                                                onDrop={e => handleRoomManagerDrop(parseInt(e.dataTransfer.getData("idx")), index)}
                                                                className="hover:bg-blue-50/50 transition-colors group cursor-default"
                                                            >
                                                                <td className="py-2 px-3">
                                                                    <div className="text-slate-300 group-hover:text-slate-400 cursor-grab active:cursor-grabbing">
                                                                        <IconGripVertical size={14} />
                                                                    </div>
                                                                </td>
                                                                <td className="py-2 px-3">
                                                                    <div className="flex items-center gap-1">
                                                                        <IconBuildingSkyscraper size={10} className="text-slate-400" />
                                                                        <span className="text-[10px] font-bold text-slate-500 uppercase">{item.hotel || selectedGroupFicha.records[0]?.["Hotel_Asignado"] || "Hotel"}</span>
                                                                    </div>
                                                                </td>
                                                                <td className="py-2 px-3">
                                                                    <input
                                                                        type="text"
                                                                        className="bg-transparent border-none font-bold text-slate-700 outline-none w-full uppercase text-[11px]"
                                                                        value={item.type}
                                                                        onChange={(e) => {
                                                                            const newRL = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]");
                                                                            newRL[index].type = e.target.value.toUpperCase();
                                                                            updateGroupMetadata(selectedGroupFicha.name, "RoomingList_JSON", JSON.stringify(newRL));
                                                                        }}
                                                                    />
                                                                </td>
                                                                <td className="py-2 px-3">
                                                                    <div className="flex items-center gap-2 text-[11px] font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded w-fit">
                                                                        <span>{formatDate(item.dateIn)}</span>
                                                                    </div>
                                                                </td>
                                                                <td className="py-2 px-3 text-center">
                                                                    <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100">{item.nights}</span>
                                                                </td>
                                                                <td className="py-2 px-3 text-center font-bold text-slate-800">{item.qty}</td>
                                                                <td className="py-2 px-3 text-center">
                                                                    <span className="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-1.5 py-0.5 rounded">{item.regime}</span>
                                                                </td>
                                                                <td className="py-2 px-3 text-right font-medium text-slate-600">{parseFloat(item.price).toFixed(2)} ‚Ç¨</td>
                                                                <td className="py-2 px-3 text-center">
                                                                    <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${item.iva == 21 ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                        {item.iva || 10}%
                                                                    </span>
                                                                </td>
                                                                <td className="py-2 px-3 text-right bg-blue-50/10 border-l border-blue-50">
                                                                    <div className="flex items-center justify-end gap-1">
                                                                        <span className="text-[10px] font-bold text-slate-500">{(item.comision?.base_unitaria ? (item.comision.base_unitaria * item.qty * item.nights) : (item.comision?.base_calculada || 0)).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</span>

                                                                        <button
                                                                            onClick={() => setCommissionModal({
                                                                                isOpen: true,
                                                                                itemIdx: index,
                                                                                tempCom: item.comision?.desglose
                                                                                    ? JSON.parse(JSON.stringify(item.comision))
                                                                                    : calculateDefaultCommission(item.price, item.regime, item.qty, item.nights)

                                                                            })}
                                                                            className="p-1 hover:bg-blue-100 text-blue-400 hover:text-blue-600 rounded transition-colors"
                                                                            title="Configurar desglose de comisi√≥n"
                                                                        >
                                                                            <IconSettings size={12} />
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                                <td className="py-2 px-3 text-center bg-blue-50/10">
                                                                    <span className="text-[10px] font-bold text-slate-600">{item.comision?.porcentaje || 10}%</span>
                                                                </td>
                                                                <td className="py-2 px-3 text-right bg-blue-50/10 border-r border-blue-50">
                                                                    <span className="text-[10px] font-black text-blue-700">
                                                                        {item.comision?.total_comision !== undefined
                                                                            ? item.comision.total_comision.toLocaleString('es-ES', { minimumFractionDigits: 2 })
                                                                            : ((item.comision?.base_calculada || 0) * (item.comision?.porcentaje || 10) / 100).toLocaleString('es-ES', { minimumFractionDigits: 2 })
                                                                        } ‚Ç¨
                                                                    </span>

                                                                </td>
                                                                <td className="py-1 px-2 text-right font-black text-emerald-600 bg-emerald-50/30">{parseFloat(item.total).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</td>
                                                                <td className="py-1 px-2 text-center flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button
                                                                        onClick={() => handleEditRoomBlock(item)}
                                                                        className="p-1 hover:bg-amber-100 text-slate-300 hover:text-amber-500 rounded transition-colors"
                                                                        title="Editar"
                                                                    >
                                                                        <IconEdit size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeRoomBlock(item.id)}
                                                                        className="p-1 hover:bg-rose-100 text-slate-300 hover:text-rose-500 rounded transition-colors"
                                                                        title="Eliminar"
                                                                    >
                                                                        <IconTrash size={14} />
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                        {(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")).length === 0 && (
                                                            <tr>
                                                                <td colSpan="8" className="py-8 text-center">
                                                                    <div className="flex flex-col items-center justify-center text-slate-300">
                                                                        <IconBed size={32} stroke={1} className="mb-2 opacity-50" />
                                                                        <p className="text-xs font-medium italic">No hay habitaciones asignadas.</p>
                                                                        <p className="text-[10px]">Usa el formulario superior para a√±adir inventario.</p>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        {/* FINANZAS Y BIT√ÅCORA - Premium Layout */}
                                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
                                            {/* Tesorer√≠a - Horizontal Cards */}
                                            {/* Tesorer√≠a - DIN√ÅMICA (4 de 12) */}
                                            <div className="lg:col-span-4 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                                                {(() => {
                                                    const uniqueHotels = Array.from(new Set(selectedGroupFicha.records
                                                        .map(r => r["Hotel_Asignado"] || r["Hotel"] || "Desconocido")
                                                        .filter(h => h && h !== "-")
                                                    ));
                                                    if (uniqueHotels.length === 0) uniqueHotels.push("General");

                                                    const roomingList = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]");

                                                    return (
                                                        <div className="flex-1 divide-y divide-slate-100 overflow-y-auto max-h-[400px] custom-scrollbar">
                                                            {uniqueHotels.map(hotelName => {
                                                                const hotelRoomingItems = roomingList.filter(i => i.hotel === hotelName || (hotelName === "General" && !i.hotel));
                                                                const hotelTotal = hotelRoomingItems.reduce((acc, i) => acc + (parseFloat(i.total) || 0), 0) || parseFloat(selectedGroupFicha.records.find(r => (r["Hotel_Asignado"] || r["Hotel"]) === hotelName)?.["Importe(*)"] || 0);

                                                                const hotelRecord = selectedGroupFicha.records.find(r => (r["Hotel_Asignado"] || r["Hotel"] || "Desconocido") === hotelName) || selectedGroupFicha.records[0];

                                                                let plan = [];
                                                                try { plan = JSON.parse(hotelRecord.PaymentPlan_JSON || "[]"); } catch (e) { plan = []; }

                                                                const totalPercent = plan.reduce((acc, p) => acc + (parseFloat(p.percent) || 0), 0);
                                                                const arrivalDate = hotelRecord["Entrada"];

                                                                const handlePlanChange = (idx, field, val) => {
                                                                    const newPlan = [...plan];
                                                                    newPlan[idx] = { ...newPlan[idx], [field]: val };
                                                                    if (field === 'percent' || field === 'releaseDays') {
                                                                        const pct = parseFloat(newPlan[idx].percent) || 0;
                                                                        const days = parseInt(newPlan[idx].releaseDays) || 0;
                                                                        newPlan[idx].amount = (hotelTotal * (pct / 100)).toFixed(2);
                                                                        const d = new Date(toInputDate(arrivalDate));
                                                                        d.setDate(d.getDate() - days);
                                                                        newPlan[idx].date = d.toISOString().split('T')[0];
                                                                    }
                                                                    updatePaymentPlan(selectedGroupFicha.name, hotelName, newPlan);
                                                                };

                                                                const addPlanRow = () => {
                                                                    const remaining = Math.max(0, 100 - totalPercent);
                                                                    const d = new Date(toInputDate(arrivalDate));
                                                                    const days = 30;
                                                                    d.setDate(d.getDate() - days);
                                                                    const newRow = { id: Date.now(), label: remaining === 100 ? "Pago √önico" : "Nuevo Pago", percent: remaining, amount: (hotelTotal * (remaining / 100)).toFixed(2), releaseDays: days, date: d.toISOString().split('T')[0], status: "Pendiente" };
                                                                    updatePaymentPlan(selectedGroupFicha.name, hotelName, [...plan, newRow]);
                                                                };

                                                                const removePlanRow = (idx) => {
                                                                    updatePaymentPlan(selectedGroupFicha.name, hotelName, plan.filter((_, i) => i !== idx));
                                                                };

                                                                return (
                                                                    <div key={hotelName} className="p-2 bg-slate-50/20">
                                                                        <div className="flex justify-between items-center mb-1.5 px-1 bg-white p-1 rounded border border-slate-100 shadow-sm">
                                                                            <div className="flex items-center gap-2">
                                                                                <div className="bg-emerald-600 p-0.5 rounded text-white"><IconPieChart size={10} /></div>
                                                                                <span className="text-[10px] font-black text-slate-700 uppercase">{hotelName}</span>
                                                                                <span className="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1.5 rounded">{hotelTotal.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' })}</span>
                                                                            </div>
                                                                            <div className="flex bg-slate-100 rounded p-0.5 gap-0.5">
                                                                                {["30/70", "50/50", "100"].map(p => (
                                                                                    <button key={p} onClick={() => calculateDeposits(selectedGroupFicha, p === "30/70" ? [30, 70] : (p === "50/50" ? [50, 50] : [100]), hotelName)} className="px-1.5 py-0.5 text-[8px] font-black text-slate-500 hover:bg-white hover:text-emerald-500 rounded transition-all">{p}</button>
                                                                                ))}
                                                                            </div>
                                                                        </div>

                                                                        <div className="space-y-1.5">
                                                                            <div className="grid grid-cols-[25px_60px_100px_85px_90px_60px_60px_25px] gap-1 px-1 mb-1 text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                                                                                <div></div><div className="text-center">%</div><div className="text-right pr-4">Importe</div><div className="text-center pr-2">Release</div><div className="text-center">Fecha</div><div className="text-center">Estado</div><div></div><div></div>
                                                                            </div>
                                                                            {plan.map((dep, idx) => {
                                                                                const isPaid = dep.status === "Cobrado";
                                                                                const today = new Date(); today.setHours(0, 0, 0, 0);
                                                                                const depDate = new Date(toInputDate(dep.date)); depDate.setHours(0, 0, 0, 0);
                                                                                const isWarning = !isPaid && Math.ceil((depDate - today) / (1000 * 60 * 60 * 24)) <= 2;

                                                                                return (
                                                                                    <div key={dep.id} className={`grid grid-cols-[25px_60px_100px_85px_90px_60px_60px_25px] items-center gap-1 p-1 rounded border ${isPaid ? 'bg-emerald-50/40 border-emerald-100/50' : (isWarning ? 'bg-rose-50 border-rose-200 animate-pulse' : 'bg-white border-slate-100')} hover:border-slate-300 transition-all group shadow-sm pl-1`}>
                                                                                        <div className="flex justify-center">{isWarning ? <IconAlertTriangle size={10} className="text-rose-500" /> : <div className={`w-1.5 h-1.5 rounded-full ${isPaid ? 'bg-emerald-500' : 'bg-slate-300'}`}></div>}</div>
                                                                                        <div className="flex items-center gap-0.5 justify-center bg-slate-50 rounded px-1 min-w-[45px] h-5 border border-slate-100"><input type="number" className="bg-transparent border-none text-[10px] font-black text-slate-600 w-8 text-right outline-none" value={dep.percent} onChange={(e) => handlePlanChange(idx, 'percent', e.target.value)} /><span className="text-[8px] font-black text-slate-400 ml-0.5">%</span></div>
                                                                                        <div className="text-right pr-4"><span className={`text-[12px] font-black tabular-nums ${isPaid ? 'text-emerald-700' : (isWarning ? 'text-rose-700' : 'text-slate-700')}`}>{parseFloat(dep.amount || 0).toLocaleString('es-ES', { minimumFractionDigits: 2 })}‚Ç¨</span></div>
                                                                                        <div className="flex items-center justify-center bg-blue-50 shadow-inner rounded px-1.5 min-w-[55px] h-6 border border-blue-100 mx-auto"><input type="number" className="bg-transparent border-none text-[11px] font-black text-blue-700 w-8 text-center outline-none" value={dep.releaseDays} onChange={(e) => handlePlanChange(idx, 'releaseDays', e.target.value)} /><span className="text-[8px] font-black text-blue-400 ml-0.5 transition-colors">D</span></div>
                                                                                        <div className={`text-[10px] font-bold tabular-nums text-center ${isWarning ? 'text-rose-600 font-black' : 'text-slate-500'}`}>{formatDate(dep.date)}</div>
                                                                                        <div className="flex justify-center">{/* Badge Estado */}
                                                                                            <span className={`text-[8px] font-black px-1.5 py-0.5 rounded shadow-sm ${isPaid ? 'bg-emerald-100 text-emerald-700' : (isWarning ? 'bg-rose-600 text-white' : 'bg-slate-100 text-slate-500')}`}>
                                                                                                {isPaid ? 'OK' : 'PND'}
                                                                                            </span>
                                                                                        </div>
                                                                                        <button onClick={() => handlePlanChange(idx, 'status', isPaid ? "Pendiente" : "Cobrado")} className={`h-5 w-full rounded text-[9px] font-black transition-all ${isPaid ? 'bg-emerald-600 text-white shadow-sm shadow-emerald-200' : 'bg-slate-100 text-slate-400'}`}>{isPaid ? <IconCheck size={10} stroke={4} className="mx-auto" /> : 'PND'}</button>
                                                                                        <button onClick={() => removePlanRow(idx)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500 transition-opacity flex justify-center"><IconTrash size={12} /></button>
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                            {totalPercent < 100 && (
                                                                                <button onClick={addPlanRow} className="w-full py-2 border border-dashed border-slate-200 rounded text-slate-400 hover:border-slate-400 hover:text-slate-500 transition-all text-[9px] font-black uppercase flex items-center justify-center gap-2 bg-white"><IconPlus size={12} /> A√±adir Tramo ({100 - totalPercent}%)</button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    );
                                                })()}
                                            </div>

                                            {/* Bit√°cora / Notas Operativas (8 de 12) */}
                                            <div className="lg:col-span-8 bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col h-full relative overflow-hidden">
                                                <div className="absolute top-0 right-0 p-2 opacity-5">
                                                    <IconFile size={60} />
                                                </div>
                                                <div className="flex items-center gap-2 mb-2 z-10">
                                                    <div className="bg-amber-100 p-1 rounded text-amber-600">
                                                        <IconEdit size={14} />
                                                    </div>
                                                    <h4 className="text-[10px] font-black text-slate-700 uppercase tracking-widest">Notas de Control</h4>
                                                </div>
                                                <div className="flex-1 z-10">
                                                    <textarea
                                                        className="w-full h-full bg-amber-50/50 border border-amber-100 rounded-lg p-2 text-[10px] font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none leading-relaxed placeholder-amber-300"
                                                        placeholder="Escribe aqu√≠ notas operativas, recordatorios o detalles importantes del grupo..."
                                                        value={selectedGroupFicha.records[0]?.["Com_Notas"] || ""}
                                                        onChange={(e) => updateGroupMetadata(selectedGroupFicha.name, "Com_Notas", e.target.value)}
                                                    ></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        {/* REGISTROS ARCHIVO (Opcional scrollable) */}
                                        <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                                            <table className="w-full text-[9px] leading-tight">
                                                <thead className="bg-[#0f172a] text-white font-black uppercase">
                                                    <tr>
                                                        <th className="px-3 py-1.5 text-left">Reserva</th>
                                                        <th className="px-3 py-1.5 text-left">Hotel</th>
                                                        <th className="px-3 py-1.5 text-left">Periodo</th>
                                                        <th className="px-3 py-1.5 text-right">Cantidad</th>
                                                        <th className="px-3 py-1.5 text-right">Importe</th>
                                                        <th className="px-3 py-1.5 text-center">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {selectedGroupFicha.records.map((rec, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                            <td className="px-3 py-1.5 font-bold text-slate-900">{rec["Reserva"]}</td>
                                                            <td className="px-3 py-1.5 font-bold text-slate-500">{rec["Hotel_Asignado"] || rec["Hotel"] || "-"}</td>
                                                            <td className="px-3 py-1.5 text-slate-600">{formatDate(rec["Entrada"])} - {formatDate(rec["Salida"])}</td>
                                                            <td className="px-3 py-1.5 text-right font-bold">{rec["Hab."] || '-'}</td>
                                                            <td className="px-3 py-1.5 text-right font-black text-emerald-600">{parseNum(rec["Importe(*)"]).toLocaleString('es-ES', { minimumFractionDigits: 2 })} ‚Ç¨</td>
                                                            <td className="px-3 py-1.5 text-center">
                                                                <span className={`px-2 py-0.5 rounded text-[7px] font-black uppercase ${rec["Estado"]?.toLowerCase().includes('conf') ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                                    {rec["Estado"] || '???'}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                        }


                        {/* Modal de Comisi√≥n Unitario - Inteligencia por Unidad */}
                        {commissionModal.isOpen && (
                            <div className="fixed inset-0 bg-slate-900/10 backdrop-blur-[2px] flex items-center justify-center z-[110] animate-fade-in">
                                <div className="bg-white rounded-xl shadow-2xl w-[90vw] max-w-[340px] border border-slate-200 overflow-hidden">
                                    <div className="bg-[#0f172a] px-4 py-3 flex justify-between items-center text-white">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-blue-500/20 p-1.5 rounded-lg border border-blue-500/30">
                                                <IconSettings size={14} className="text-blue-400" />
                                            </div>
                                            <div>
                                                <h3 className="font-black uppercase text-[10px] tracking-widest text-white leading-none">C√°lculo de Comisi√≥n</h3>
                                                <p className="text-[7px] font-bold text-slate-400 uppercase mt-0.5 tracking-tighter">Desglose por Conceptos Unitarios</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setCommissionModal({ isOpen: false, itemIdx: null, tempCom: null })} className="w-7 h-7 flex items-center justify-center rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-all">
                                            <IconX size={18} />
                                        </button>
                                    </div>

                                    <div className="p-4 space-y-5 text-left bg-slate-50/30">
                                        {/* info unitaria info pills */}
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="bg-white p-2 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400">
                                                    <span className="text-[10px] font-black">‚Ç¨</span>
                                                </div>
                                                <div>
                                                    <span className="block text-[7px] font-black text-slate-400 uppercase tracking-widest">Precio Unidad</span>
                                                    <span className="text-xs font-black text-slate-700">{parseFloat(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")[commissionModal.itemIdx].price).toFixed(2)} ‚Ç¨</span>
                                                </div>
                                            </div>
                                            <div className="bg-white p-2 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400">
                                                    <IconUsers size={12} />
                                                </div>
                                                <div>
                                                    <span className="block text-[7px] font-black text-slate-400 uppercase tracking-widest">Total Pax</span>
                                                    <span className="text-xs font-black text-slate-500">{JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")[commissionModal.itemIdx].qty} uni.</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-[1fr_100px] gap-3">
                                            <div>
                                                <label className="block text-[8px] font-black text-slate-500 uppercase mb-1.5 ml-1 tracking-widest">Porcentaje Comisionable</label>
                                                <div className="relative group">
                                                    <input
                                                        type="number"
                                                        className="w-full h-10 bg-white border border-slate-200 rounded-xl px-3 text-sm font-black text-blue-600 outline-none focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 transition-all shadow-sm"
                                                        value={commissionModal.tempCom.porcentaje}
                                                        onChange={e => setCommissionModal(prev => ({ ...prev, tempCom: { ...prev.tempCom, porcentaje: parseFloat(e.target.value) || 0 } }))}
                                                    />
                                                    <span className="absolute right-3 top-2.5 text-xs text-slate-300 font-black">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-[8px] font-black text-slate-500 uppercase mb-1.5 ml-1 tracking-widest">Procedencia</label>
                                                <div className="relative">
                                                    <select
                                                        className="w-full h-10 bg-white border border-slate-200 rounded-xl px-2 text-[10px] font-black text-slate-600 outline-none appearance-none hover:border-slate-300 transition-all shadow-sm cursor-pointer"
                                                        value={commissionModal.tempCom.modo}
                                                        onChange={e => setCommissionModal(prev => ({ ...prev, tempCom: { ...prev.tempCom, modo: e.target.value } }))}
                                                    >
                                                        <option value="auto">üí∞ AUTO</option>
                                                        <option value="manual">‚úçÔ∏è MANUAL</option>
                                                    </select>
                                                    <IconChevronDown size={14} className="absolute right-2 top-3 text-slate-300 pointer-events-none" />
                                                </div>
                                            </div>
                                        </div>

                                        {commissionModal.tempCom.modo === 'auto' ? (
                                            <div className="space-y-2">
                                                <div className="flex justify-between items-center px-1">
                                                    <label className="block text-[8px] font-black text-slate-400 uppercase tracking-[0.2em]">Desglose del Precio</label>
                                                    <div className="flex items-center gap-1.5">
                                                        <div className="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></div>
                                                        <span className="text-[7px] font-bold text-slate-400 uppercase">Comisionable</span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 gap-2">
                                                    {Object.entries(commissionModal.tempCom.desglose || {}).map(([key, data]) => (
                                                        <div key={key} className={`flex items-center gap-2 p-1.5 rounded-xl border transition-all ${data.comisionable ? 'bg-white border-blue-100 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <div className={`p-1 rounded-md ${data.comisionable ? 'bg-blue-50 text-blue-500' : 'bg-slate-200 text-slate-400'}`}>
                                                                    <IconCircle size={8} fill="currentColor" />
                                                                </div>
                                                                <span className="text-[9px] font-black text-slate-600 uppercase w-20 truncate">{key}</span>
                                                                <div className="relative flex-1">
                                                                    <input
                                                                        type="number"
                                                                        className="w-full h-7 bg-transparent border-none rounded text-xs font-black px-1 outline-none text-right pr-4"
                                                                        value={data.valor}
                                                                        onChange={e => {
                                                                            const val = parseFloat(e.target.value) || 0;
                                                                            const newDesglose = { ...commissionModal.tempCom.desglose, [key]: { ...data, valor: val } };
                                                                            setCommissionModal(prev => ({ ...prev, tempCom: { ...prev.tempCom, desglose: newDesglose } }));
                                                                        }}
                                                                    />
                                                                    <span className="absolute right-0 top-1.5 text-[9px] text-slate-300 font-bold">‚Ç¨</span>
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.preventDefault();
                                                                    const newDesglose = { ...commissionModal.tempCom.desglose, [key]: { ...data, comisionable: !data.comisionable } };
                                                                    setCommissionModal(prev => ({ ...prev, tempCom: { ...prev.tempCom, desglose: newDesglose } }));
                                                                }}
                                                                className={`w-7 h-7 rounded-lg flex items-center justify-center border transition-all ${data.comisionable ? 'bg-blue-600 border-blue-600 text-white shadow-md shadow-blue-500/20' : 'bg-white border-slate-200 text-slate-200 hover:border-slate-300'}`}
                                                                title="¬øEs Comisionable?"
                                                            >
                                                                {data.comisionable ? <IconCheck size={14} stroke={4} /> : <div className="w-1.5 h-1.5 rounded-full bg-slate-200"></div>}
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                {(() => {
                                                    const sum = Object.values(commissionModal.tempCom.desglose || {}).reduce((acc, c) => acc + c.valor, 0);
                                                    const unitPrice = parseFloat(JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")[commissionModal.itemIdx].price);
                                                    const diff = Math.abs(sum - unitPrice);
                                                    if (diff > 0.01) {
                                                        return (
                                                            <div className="bg-red-50 text-red-500 p-1.5 rounded text-[8px] font-bold flex items-center gap-1.5 animate-pulse">
                                                                <IconAlertTriangle size={10} />
                                                                <span>LA SUMA ({sum.toFixed(2)}‚Ç¨) NO COINCIDE CON EL PRECIO UNITARIO ({unitPrice.toFixed(2)}‚Ç¨)</span>
                                                            </div>
                                                        );
                                                    }
                                                    return null;
                                                })()}
                                            </div>
                                        ) : (
                                            <div>
                                                <label className="block text-[8px] font-black text-slate-400 uppercase mb-0.5 ml-1">Base Comisi√≥n Unitaria (‚Ç¨)</label>
                                                <div className="relative">
                                                    <input
                                                        type="number"
                                                        className="w-full h-8 bg-emerald-50 border border-emerald-100 rounded-lg px-2 text-[11px] font-black text-emerald-700 outline-none"
                                                        value={commissionModal.tempCom.base_unitaria}
                                                        onChange={e => setCommissionModal(prev => ({ ...prev, tempCom: { ...prev.tempCom, base_unitaria: parseFloat(e.target.value) || 0 } }))}
                                                    />
                                                    <span className="absolute right-2 top-2 text-[9px] text-emerald-300 font-bold">‚Ç¨</span>
                                                </div>
                                            </div>
                                        )}

                                        <div className="bg-[#0f172a] mx-4 my-2 px-4 py-4 rounded-2xl text-white shadow-xl shadow-slate-200 relative overflow-hidden group">
                                            {/* decorative background element */}
                                            <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl -mr-12 -mt-12 group-hover:bg-blue-500/20 transition-all"></div>

                                            <div className="grid grid-cols-2 gap-4 relative z-10">
                                                <div className="border-r border-white/10 pr-2">
                                                    <span className="block text-[8px] text-slate-400 font-black uppercase tracking-widest mb-1">Base Comisionable</span>
                                                    <div className="flex items-baseline gap-1">
                                                        <span className="text-lg font-black text-white tracking-tight">
                                                            {(() => {
                                                                const base = commissionModal.tempCom.modo === 'auto'
                                                                    ? Object.values(commissionModal.tempCom.desglose || {}).reduce((acc, c) => acc + (c.comisionable ? c.valor : 0), 0)
                                                                    : (commissionModal.tempCom.base_unitaria || 0);
                                                                return base.toLocaleString('es-ES', { minimumFractionDigits: 2 });
                                                            })()}
                                                        </span>
                                                        <span className="text-[10px] font-bold text-slate-500">‚Ç¨/u</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <span className="block text-[8px] text-emerald-400/80 font-black uppercase tracking-widest mb-1">Comisi√≥n Unidad</span>
                                                    <div className="flex items-baseline gap-1">
                                                        <span className="text-lg font-black text-emerald-400 tracking-tight">
                                                            {(() => {
                                                                const base = commissionModal.tempCom.modo === 'auto'
                                                                    ? Object.values(commissionModal.tempCom.desglose || {}).reduce((acc, c) => acc + (c.comisionable ? c.valor : 0), 0)
                                                                    : (commissionModal.tempCom.base_unitaria || 0);
                                                                return (base * (commissionModal.tempCom.porcentaje || 0) / 100).toLocaleString('es-ES', { minimumFractionDigits: 2 });
                                                            })()}
                                                        </span>
                                                        <span className="text-[10px] font-bold text-emerald-600/60">‚Ç¨</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="mt-4 pt-3 border-t border-white/5 flex justify-between items-center relative z-10">
                                                <div className="flex flex-col">
                                                    <span className="text-[7px] font-black text-slate-500 uppercase tracking-widest">Importe Total L√≠nea</span>
                                                    <p className="text-[8px] font-bold text-slate-600">(Comisi√≥n √ó Pax √ó Noches)</p>
                                                </div>
                                                <div className="bg-white/5 px-3 py-1.5 rounded-xl border border-white/10 group-hover:border-emerald-500/30 transition-all">
                                                    <span className="text-lg font-black text-white tabular-nums tracking-tighter">
                                                        {(() => {
                                                            const item = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")[commissionModal.itemIdx];
                                                            const base = commissionModal.tempCom.modo === 'auto'
                                                                ? Object.values(commissionModal.tempCom.desglose || {}).reduce((acc, c) => acc + (c.comisionable ? c.valor : 0), 0)
                                                                : (commissionModal.tempCom.base_unitaria || 0);
                                                            return (base * (commissionModal.tempCom.porcentaje || 0) / 100 * item.qty * item.nights).toLocaleString('es-ES', { minimumFractionDigits: 2 });
                                                        })()} <span className="text-xs font-normal opacity-40 ml-0.5">‚Ç¨</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="p-4 bg-white border-t flex gap-3">
                                        <button
                                            onClick={() => setCommissionModal({ isOpen: false, itemIdx: null, tempCom: null })}
                                            className="flex-1 h-11 rounded-xl text-[10px] font-black text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all uppercase tracking-widest border border-transparent hover:border-slate-200"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={() => {
                                                const com = { ...commissionModal.tempCom };
                                                const item = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]")[commissionModal.itemIdx];

                                                if (com.modo === 'auto') {
                                                    com.base_unitaria = Object.values(com.desglose).reduce((acc, c) => acc + (c.comisionable ? c.valor : 0), 0);
                                                }
                                                com.comision_unitaria = parseFloat((com.base_unitaria * com.porcentaje / 100).toFixed(2));
                                                com.total_comision = parseFloat((com.comision_unitaria * item.qty * item.nights).toFixed(2));

                                                const newRL = JSON.parse(selectedGroupFicha.records[0]?.["RoomingList_JSON"] || "[]");
                                                newRL[commissionModal.itemIdx].comision = com;
                                                updateGroupMetadata(selectedGroupFicha.name, "RoomingList_JSON", JSON.stringify(newRL));
                                                setCommissionModal({ isOpen: false, itemIdx: null, tempCom: null });
                                            }}
                                            className="flex-[2] h-11 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] rounded-xl text-[10px] text-white font-black shadow-lg shadow-blue-600/20 transition-all uppercase tracking-[0.2em] flex items-center justify-center gap-2"
                                        >
                                            <IconSave size={16} />
                                            <span>Aplicar Comisi√≥n</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Selecci√≥n de Hotel para Importaci√≥n */}
                        {
                            isHotelModalOpen && (
                                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[100] p-4">
                                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 animate-fade-in text-center">
                                        <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                            <IconUpload size={32} />
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-800 mb-2">¬øA qu√© hotel pertenecen estos datos?</h3>
                                        <p className="text-sm text-slate-500 mb-8">Selecciona el hotel para asignar correctamente las reservas importadas.</p>

                                        <div className="grid grid-cols-1 gap-4">
                                            <button
                                                onClick={() => confirmHotelAndProcess("Sercotel Guadiana")}
                                                className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                            >
                                                <span className="text-emerald-600">Sercotel Guadiana</span>
                                                <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Principal</span>
                                            </button>
                                            <button
                                                onClick={() => confirmHotelAndProcess("Cumbria Spa & Hotel")}
                                                className="py-4 bg-slate-50 border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 rounded-2xl font-bold text-slate-700 transition-all flex flex-col items-center gap-1 group"
                                            >
                                                <span className="text-blue-600">Cumbria Spa & Hotel</span>
                                                <span className="text-[10px] text-slate-400 font-normal uppercase tracking-widest">Hotel Asociado</span>
                                            </button>
                                        </div>

                                        <button
                                            onClick={() => { setIsHotelModalOpen(false); setPendingFile(null); }}
                                            className="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold uppercase tracking-widest"
                                        >
                                            Cancelar
                                        </button>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans space-y-4">
                            <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
                            </div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">¬°Oops! Algo sali√≥ mal.</h1>
                            <p className="text-slate-500 max-w-md text-sm leading-relaxed">
                                Ha ocurrido un error inesperado en la interfaz. Hemos registrado el problema. Por favor, recarga la p√°gina para continuar.
                            </p>
                            <button
                                onClick={() => window.location.reload()}
                                className="mt-6 px-6 py-2.5 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800 transition-colors shadow-md"
                            >
                                Recargar Aplicaci√≥n
                            </button>
                            <div className="mt-8 p-4 bg-white/50 border border-slate-200 rounded-lg text-left overflow-auto max-w-2xl w-full">
                                <p className="text-xs font-mono text-slate-400 break-all">{this.state.error?.toString()}</p>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>