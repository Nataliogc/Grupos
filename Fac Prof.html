<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas - Hotel Guadiana</title>
    <!-- Static Styles (Tailwind Compiled) -->
    <link rel="stylesheet" href="style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Montserrat:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap');

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
            }

            .page-container {
                box-shadow: none;
                margin: 0;
                border: none;
                width: 100%;
                min-height: auto;
            }

            .editable:hover {
                background: transparent;
            }

            select {
                appearance: none;
                -webkit-appearance: none;
                border: none;
                background: transparent;
                padding: 0;
            }

            .print-bg-green {
                background-color: #2d5a43 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-bg-gray {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s;
        }

        .editable {
            min-height: 1.2em;
            min-width: 20px;
            display: inline-block;
            cursor: text;
        }

        .editable:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
        }

        .editable:focus {
            outline: 2px solid #2d5a43;
            background: white;
        }

        .font-pro {
            font-family: 'Courier Prime', monospace;
            letter-spacing: -0.5px;
        }

        .font-logo {
            font-family: 'Libre Baskerville', serif;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 10mm 15mm;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tab-active {
            border-bottom: 3px solid #2d5a43;
            color: #2d5a43;
            font-weight: bold;
        }

        .logo-placeholder {
            max-height: 80px;
            max-width: 250px;
            object-fit: contain;
        }

        .legal-footer {
            font-size: 8px;
            line-height: 1.3;
            color: #1f2937;
            text-align: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        #ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .iva-breakdown-small {
            font-size: 9px;
            color: #4b5563;
            line-height: 1.4;
        }

        /* Estilos espec√≠ficos Proforma PDF */
        .proforma-header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .proforma-header-table td {
            vertical-align: top;
        }

        .proforma-box {
            border: 1px solid black;
            display: inline-block;
            width: 220px;
            font-size: 10px;
            font-family: 'Courier Prime', monospace;
        }

        .proforma-box-header {
            border-bottom: 1px solid black;
            display: flex;
            font-weight: bold;
            background: #f9fafb;
        }

        .proforma-box-header div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-header div:last-child {
            border-right: none;
        }

        .proforma-box-row {
            display: flex;
        }

        .proforma-box-row div {
            flex: 1;
            padding: 2px 5px;
            text-align: center;
            border-right: 1px solid black;
        }

        .proforma-box-row div:last-child {
            border-right: none;
        }

        .proforma-table th {
            border-bottom: 2px solid black;
            border-top: 1px solid black;
            padding: 5px 0;
            font-weight: bold;
            text-align: left;
            font-size: 10px;
        }

        .proforma-table td {
            padding: 4px 0;
            font-size: 10px;
            vertical-align: top;
        }

        .proforma-total-box {
            background-color: #2d5a43;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            width: 300px;
            float: right;
        }

        .clean-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 4px;
        }

        .clean-label {
            font-weight: bold;
            width: 100px;
        }
    </style>
</head>

<body class="bg-gray-200 p-0 md:p-8">

    <!-- Panel de Control Superior -->
    <div
        class="max-w-[210mm] mx-auto mb-6 no-print bg-white shadow-lg rounded-xl p-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex gap-6 items-center">
            <a href="Admin.html" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-[#2d5a43]"
                title="Volver al Admin">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </a>
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entorno de
                    Trabajo</span>
                <div class="flex gap-4">
                    <button onclick="switchTemplate('confirmacion')" id="btn-confirmacion"
                        class="pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Confirmaci√≥n</button>
                    <button onclick="switchTemplate('proforma')" id="btn-proforma"
                        class="pb-2 px-2 text-gray-400 hover:text-gray-600 transition-all uppercase text-xs tracking-widest whitespace-nowrap">Modelo
                        Factura Proforma</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Seleccionar Hotel</span>
            <select id="hotel-selector" onchange="updateHotel(this.value)"
                class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#2d5a43]">
                <option value="guadiana">Sercotel Guadiana</option>
                <option value="cumbria">Sercotel Cumbria</option>
            </select>
        </div>

        <div class="flex gap-2">
            <button onclick="generateAIEmail()"
                class="bg-emerald-50 hover:bg-emerald-100 text-[#2d5a43] px-3 py-2 rounded-lg font-bold text-[10px] uppercase border border-emerald-200 transition-all flex items-center gap-1">
                ‚ú® Redactar Email
            </button>
            <button onclick="window.print()"
                class="bg-[#2d5a43] hover:bg-[#1e3a2c] text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all uppercase text-[10px]">
                Imprimir / PDF
            </button>
        </div>
    </div>

    <!-- CONTENEDOR DE LA P√ÅGINA -->
    <div id="capture-area" class="page-container shadow-2xl border border-gray-300">

        <!-- MODELO 1: CONFIRMACI√ìN (Estilo Moderno) -->
        <div id="tpl-confirmacion" class="template-content font-sans">
            <div class="flex justify-between items-start mb-8">
                <div class="logo-box">
                    <img id="logo-img-1" src="Logos/Sercotel Guadiana.jpg" class="max-h-24 w-auto object-contain"
                        alt="Logo">
                </div>
                <div class="text-right">
                    <h3
                        class="text-lg font-bold text-gray-700 border-b-2 border-gray-700 inline-block mb-1 uppercase tracking-tighter">
                        Confirmaci√≥n de Reserva</h3>
                    <p class="text-sm font-bold">Reserva: <span class="editable" id="reserva-id-1"
                            contenteditable="true">206268</span></p>
                    <p class="text-[10px] text-gray-400 italic">Fecha: <span class="editable" id="fecha-proforma-1"
                            contenteditable="true">12/02/2026</span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="border-l-4 border-[#2d5a43] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Solicitante</h4>
                    <div class="text-xs space-y-1">
                        <p><strong>Organismo:</strong> <span class="editable" id="solicitante-org-1"
                                contenteditable="true">EAPN-ES</span></p>
                        <p><strong>Contacto:</strong> <span class="editable" id="solicitante-nombre-1"
                                contenteditable="true">MARCELLO RONCHI</span></p>
                        <p><strong>Email:</strong> <span class="editable" id="solicitante-email-1"
                                contenteditable="true">marcello.ronchi@eapn.es</span></p>
                    </div>
                </div>
                <div class="border-l-4 border-[#eab308] pl-4">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase mb-1">Reserva</h4>
                    <div class="text-xs grid grid-cols-2 gap-x-1">
                        <span class="text-gray-500">Personas:</span> <span class="editable font-bold"
                            id="reserva-personas-1" contenteditable="true">70</span>
                        <span class="text-gray-500">Entrada:</span> <span class="editable font-bold"
                            id="reserva-entrada-1" contenteditable="true">21-04-2026</span>
                        <span class="text-gray-500">Salida:</span> <span class="editable font-bold"
                            id="reserva-salida-1" contenteditable="true">24-04-2026</span>
                    </div>
                </div>
            </div>

            <table class="w-full text-[10px] mb-6 border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-[#2d5a43] border-b-2 border-[#2d5a43] uppercase text-[8px] font-bold">
                        <th class="p-2 text-left">Fecha</th>
                        <th class="p-2 text-center w-8">Cant.</th>
                        <th class="p-2 text-left">Concepto</th>
                        <th class="p-2 text-center w-8">Reg</th>
                        <th class="p-2 text-center w-8">D√≠as</th>
                        <th class="p-2 text-right w-16">Precio</th>
                        <th class="p-2 text-center w-12">IVA</th>
                        <th class="p-2 text-right w-20">Importe</th>
                        <th class="p-2 w-4 no-print"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <!-- MODELO 2: FACTURA PROFORMA (REDISE√ëADO PARA COINCIDIR CON IMAGEN) -->
        <div id="tpl-proforma" class="template-content hidden font-pro text-black">

            <!-- Texto Vertical Legal -->
            <div class="absolute left-[3mm] top-0 bottom-0 flex items-center justify-center text-[8px] text-black font-sans font-bold"
                style="writing-mode: vertical-rl; transform: rotate(180deg);">
                <span class="whitespace-nowrap italic">SWEETMOON DESARROLLOS S.L. &nbsp;&nbsp;&nbsp; Inscrito en la hoja
                    CR-00035559 del Registro Mercantil de Ciudad Real. Folio electr√≥nico. Inscripci√≥n/anotaci√≥n 4
                    &nbsp;&nbsp;&nbsp; N.I.F. B-87067302</span>
            </div>

            <table class="w-full mb-6">
                <tr>
                    <td width="55%" class="align-top">
                        <div class="flex items-center gap-4 mb-8">
                            <img id="logo-img-2" src="Logos/Sercotel Guadiana.jpg"
                                class="max-h-20 w-auto object-contain" alt="Logo">
                        </div>

                        <!-- Caja Datos Factura -->
                        <div class="proforma-box w-[250px] border-black">
                            <div class="proforma-box-header bg-gray-100 border-b border-black">
                                <div class="border-r border-black">Factura</div>
                                <div class="border-r border-black">Fecha</div>
                                <div>Pag.</div>
                            </div>
                            <div class="proforma-box-row">
                                <div class="border-r border-black font-bold text-[10px]" id="reserva-id-2">PROVISIONAL
                                </div>
                                <div class="border-r border-black text-xs"><span class="editable" id="fecha-proforma-2"
                                        contenteditable="true">12-02-2026</span></div>
                                <div class="text-xs">1</div>
                            </div>
                        </div>
                    </td>
                    <td width="45%" class="align-top pt-4">
                        <div class="text-[12px] leading-tight font-bold">
                            <div class="flex justify-between items-start mb-1">
                                <span class="editable uppercase" id="solicitante-org-2"
                                    contenteditable="true">EAPN-ES</span>
                                <span class="editable" contenteditable="true">42583</span>
                            </div>
                            <div class="editable" contenteditable="true">CALLE MELQUIADES BIEINCINTO 7</div>
                            <div class="editable" contenteditable="true">28053 MADRID</div>
                            <div class="mt-8">
                                <span class="font-bold">N.I.F. : </span>
                                <span class="editable" contenteditable="true">G45556586</span>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- Caja Datos Ocupante -->
            <div class="border border-black p-2 mb-6 text-[11px] leading-relaxed">
                <div class="mb-2"><strong>Ocupante :</strong> <span class="editable min-w-[200px]"
                        contenteditable="true">EAPN</span></div>
                <div class="grid grid-cols-[1fr_1fr_1fr] gap-x-2">
                    <div>
                        <strong>Habitaci√≥n :</strong> <span class="editable w-16" contenteditable="true"></span><br>
                        <strong>Nro. Personas :</strong> <span class="editable font-bold" id="reserva-personas-2"
                            contenteditable="true">70</span>
                    </div>
                    <div>
                        <strong>Entrada :</strong> <span class="editable font-bold" id="reserva-entrada-2"
                            contenteditable="true">21-04-2026</span><br>
                        <strong>Salida :</strong> <span class="editable font-bold" id="reserva-salida-2"
                            contenteditable="true">24-04-2026</span>
                    </div>
                    <div>
                        <strong>N¬∫ Bono :</strong> <span class="editable" contenteditable="true">42583</span>
                    </div>
                </div>
            </div>

            <!-- Tabla de Conceptos -->
            <table class="w-full text-[11px] proforma-table mb-2">
                <thead>
                    <tr class="border-y border-black">
                        <th width="12%" class="text-left font-bold py-1">FECHA</th>
                        <th width="8%" class="text-left font-bold py-1">HAB.</th>
                        <th width="8%" class="text-left font-bold py-1">CANT.</th>
                        <th width="32%" class="text-left font-bold py-1">CONCEPTO</th>
                        <th width="13%" class="text-right font-bold py-1 uppercase">Cargos</th>
                        <th width="13%" class="text-right font-bold py-1 uppercase">Abonos</th>
                        <th width="14%" class="text-right font-bold py-1 uppercase">Saldo</th>
                        <th class="w-4 no-print border-none"></th>
                    </tr>
                </thead>
                <tbody class="invoice-items"></tbody>
            </table>
        </div>

        <div class="no-print flex justify-center mb-4 mt-2">
            <button onclick="addRow()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-[9px] uppercase font-bold tracking-widest transition border border-gray-300">
                + A√±adir Concepto
            </button>
        </div>

        <!-- TOTALES Y FOOTER -->
        <div class="mt-auto">
            <!-- Totales Din√°micos -->
            <div id="footer-totals" class="w-full"></div>

            <!-- Pol√≠ticas de Reserva (Solo en Confirmaci√≥n) -->
            <div id="tpl-policies" class="mt-8 text-[10px] leading-relaxed border-t border-gray-100 pt-4 hidden">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h5 class="font-bold text-[#2d5a43] uppercase mb-2">Pol√≠ticas de Cancelaci√≥n</h5>
                        <p class="editable" contenteditable="true">Cancelaci√≥n gratuita hasta 7 d√≠as antes de la
                            llegada. Entre 7 y 3 d√≠as, cargo de la 1¬™ noche. Menos de 72 horas o No-Show, cargo del 100%
                            de la estancia.</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-[#2d5a43] uppercase mb-2">Garant√≠a y Pago</h5>
                        <p class="editable" contenteditable="true">Para confirmar la reserva se requiere el cumplimiento
                            de los plazos de dep√≥sito indicados. El resto del pago se realizar√° en el check-in o seg√∫n
                            acuerdo comercial.</p>
                    </div>
                </div>

            </div>

            <!-- Footer con dise√±o verde -->
            <div id="common-footer" class="mt-20 pt-4 border-t border-black text-[10px] font-pro">
                <div class="flex justify-between items-end">
                    <div class="flex gap-8">
                        <div>
                            <span class="text-[#2d5a43] font-bold hotel-address-footer">C/GUADIANA 36</span><br>
                            <span class="text-[#22c55e] font-bold hotel-cp-footer">13002</span> <span
                                class="hotel-city-footer">Ciudad Real</span>
                        </div>
                        <div>
                            <span class="text-[#2d5a43] font-bold">E-mail:</span> <span
                                class="hotel-email-footer">info@hotelguadiana.es</span><br>
                            <span class="text-[#22c55e] font-bold">Web:</span> <span
                                class="hotel-web-footer">www.hotelguadiana.es</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[#2d5a43] font-bold">Tel:</span> <span class="hotel-tel-footer">926 22 33
                            13</span><br>
                        <span class="text-[#22c55e] font-bold">Fax:</span> <span class="hotel-fax-footer">926 27 30
                            57</span>
                    </div>
                </div>
                <!-- Hora y Fecha pie de p√°gina -->
                <div class="mt-8 flex justify-between text-gray-400 text-[9px]">
                    <div class="flex gap-4">
                        <span id="timestamp-date">12-02-26</span>
                        <span id="timestamp-time">16.50</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="no-print">
        <div
            class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-[#2d5a43] flex items-center gap-2"></h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div id="ai-content" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto mb-6 pr-2">
                Generando respuesta...
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t">
                <button onclick="copyAIContent()" id="btn-copy"
                    class="text-xs font-bold uppercase tracking-widest text-emerald-700 bg-emerald-50 px-4 py-2 rounded-lg hover:bg-emerald-100 transition-all">
                    Copiar texto
                </button>
                <button onclick="closeAIModal()"
                    class="text-xs font-bold uppercase tracking-widest text-gray-500 bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Configuraci√≥n Centralizada -->
    <script src="js/firebase-config.js"></script>

    <script>
        const HOTELS = {
            guadiana: {
                name: "Hotel",
                subname: "Guadiana",
                letter: "G",
                stars: "****",
                logo: "Logos/Sercotel Guadiana.jpg",
                brand: "by Sercotel",
                company: "SWEETMOON DESARROLLOS S.L.",
                nif: "B87067302",
                address: "C/ Guadalupe, 6",
                cp: "13003",
                city: "Ciudad Real",
                tel: "926 22 33 13",
                fax: "926 27 30 57",
                email: "info@hotelguadiana.es",
                web: "www.hotelguadiana.es",
                iban: "ES30 3190 3953 1851 8526 3521",
                legal: "Inscrito en la hoja CR-00035559 del Registro Mercantil de Ciudad Real. Folio electr√≥nico. Inscripci√≥n/anotaci√≥n 4"
            },
            cumbria: {
                name: "Hotel",
                subname: "Cumbria",
                letter: "C",
                stars: "***",
                logo: "Logos/Cumbria Spa&Hotel.jpg",
                brand: "Cumbria Spa",
                company: "MOON FREE PORT, S.L.",
                nif: "B87895058",
                address: "Ctra. Fuencaliente, s/n",
                cp: "13004",
                city: "Ciudad Real",
                tel: "926 25 10 25",
                fax: "926 25 10 26",
                email: "recepcion@hotelcumbria.es",
                web: "www.hotelcumbria.es",
                iban: "ES19 3081 0601 0850 0004 8966",
                legal: "Inscrito en el tomo 699 de libro 0 folio 2 hoja CR-32491 inscripci√≥n 2¬™"
            }
        };

        // Se carga desde js/firebase-config.js
        const apiKey = window.firebaseConfig ? window.firebaseConfig.apiKey : "";
        let currentTemplate = 'confirmacion';
        let currentHotel = 'guadiana';

        // Datos iniciales actualizados para coincidir con la imagen
        let items = [
            { fecha: '21-04-26', hab: '8', cant: '', concepto: 'HABITACION D.STD Y DESAYUNO', precio: 475.52, iva: 10 },
            { fecha: '21-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '22-04-26', hab: '', cant: '70', concepto: 'HABITACION D.STD Y MEDIA PENSI', precio: 5902.40, iva: 10 },
            { fecha: '22-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '23-04-26', hab: '', cant: '70', concepto: 'HABITACION D.STD Y MEDIA PENSI', precio: 5902.40, iva: 10 },
            { fecha: '23-04-26', hab: '', cant: '70', concepto: 'PICNIC', precio: 1050.00, iva: 10 },
            { fecha: '24-04-26', hab: '', cant: '', concepto: 'SALONES/ALQUILER', precio: 100.00, iva: 21 }
        ];

        // Sincronizaci√≥n de datos comunes
        function syncFields() {
            const fields = ['reserva-id', 'fecha-proforma', 'solicitante-org', 'solicitante-nombre', 'solicitante-email', 'reserva-personas', 'reserva-entrada', 'reserva-salida'];
            fields.forEach(f => {
                const el1 = document.getElementById(f + '-1');
                const el2 = document.getElementById(f + '-2');
                if (el1 && el2) {
                    if (document.activeElement !== el1) el1.innerText = el2.innerText;
                    if (document.activeElement !== el2) el2.innerText = el1.innerText;
                }
            });
        }
        setInterval(syncFields, 1000);

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            // Incorporamos la instrucci√≥n del sistema en el prompt para cumplir con el formato estricto solicitado
            const fullPrompt = "Eres un asistente de recepci√≥n de un hotel de lujo (Hotel Guadiana). Tu tono es profesional, cort√©s y servicial. Siempre respondes en espa√±ol.\n\n" + prompt;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: fullPrompt }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error API Gemini:", errorText);
                    throw new Error("Error en la llamada a la API");
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                return "Error de conexi√≥n con la IA.";
            }
        }

        async function generateAIEmail() {
            showAIModal("‚ú® Redactando Email Profesional");
            const total = items.reduce((acc, curr) => acc + (curr.precio || 0), 0);
            const cliente = document.getElementById('solicitante-org-1').innerText;
            const prompt = `Redacta un correo electr√≥nico profesional para enviar esta factura proforma. Cliente: ${cliente}, Total: ${formatNum(total)} ‚Ç¨. Tono amable y profesional.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        async function generateAIPlan() {
            showAIModal("‚ú® Sugerencia de Plan para el Grupo");
            const personas = document.getElementById('reserva-personas-1').innerText;
            const prompt = `Sugiere un plan de ocio en Ciudad Real para ${personas} personas.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-content').innerText = result;
        }

        function showAIModal(title) {
            document.getElementById('ai-modal-title').innerText = title;
            document.getElementById('ai-content').innerText = "Generando...";
            document.getElementById('ai-modal').style.display = 'flex';
        }
        function closeAIModal() { document.getElementById('ai-modal').style.display = 'none'; }

        function loadSelectedGroup() {
            const saved = localStorage.getItem('selectedGroup');
            if (!saved) return;

            const formatDate = (val) => {
                if (!val) return "-";
                const str = val.toString().trim();
                const num = parseFloat(str);
                if (!isNaN(num) && num > 40000 && num < 60000) {
                    const date = new Date(Math.round((num - 25569) * 86400 * 1000));
                    return date.toLocaleDateString('es-ES');
                }
                return val;
            };

            try {
                const group = JSON.parse(saved);

                // 1. Vincular Hotel
                if ((group["Hotel_Asignado"] || "").toLowerCase().includes('cumb')) {
                    updateHotel('cumbria');
                } else {
                    updateHotel('guadiana');
                }

                // 2. Poblar campos de texto
                const mapping = {
                    'reserva-id': group["Reserva"] || '',
                    'solicitante-org': group["Empresa/Agencia"] || group["Nombre del Grupo"] || '',
                    'solicitante-nombre': group["Nombre del Grupo"] || '',
                    'reserva-personas': group["Pax."] || '',
                    'reserva-entrada': formatDate(group["Entrada"]),
                    'reserva-salida': formatDate(group["Salida"]),
                    'fecha-proforma': new Date().toLocaleDateString('es-ES')
                };

                Object.keys(mapping).forEach(id => {
                    const el1 = document.getElementById(id + '-1');
                    const el2 = document.getElementById(id + '-2');
                    if (el1) el1.innerText = mapping[id];
                    if (el2) el2.innerText = mapping[id];
                });

                // 3. Crear item inicial con el importe del grupo
                const importe = parseFloat((group["Importe(*)"] || "0").toString().replace('.', '').replace(',', '.'));
                if (!isNaN(importe)) {
                    items = [{
                        fecha: formatDate(group["Entrada"]),
                        hab: '',
                        cant: group["Pax."] || '1',
                        concepto: `ESTANCIA GRUPO: ${group["Nombre del Grupo"]}`,
                        precio: importe,
                        iva: 10
                    }];
                }
            } catch (e) {
                console.error("Error cargando grupo seleccionado:", e);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadSelectedGroup();
            renderItems();
        });
        function copyAIContent() {
            navigator.clipboard.writeText(document.getElementById('ai-content').innerText);
            const btn = document.getElementById('btn-copy');
            if (btn) {
                btn.innerText = "¬°Copiado!";
                setTimeout(() => btn.innerText = "Copiar texto", 2000);
            }
        }

        function switchTemplate(tpl) {
            currentTemplate = tpl;
            document.getElementById('tpl-confirmacion').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('tpl-proforma').classList.toggle('hidden', tpl !== 'proforma');
            document.getElementById('tpl-policies').classList.toggle('hidden', tpl !== 'confirmacion');
            document.getElementById('btn-confirmacion').className = tpl === 'confirmacion' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            document.getElementById('btn-proforma').className = tpl === 'proforma' ? 'pb-2 px-2 tab-active transition-all uppercase text-xs tracking-widest' : 'pb-2 px-2 text-gray-400 transition-all uppercase text-xs tracking-widest';
            renderItems();
        }

        function updateHotel(hotelKey) {
            currentHotel = hotelKey;
            const h = HOTELS[hotelKey];

            // Actualizar Logos
            const img1 = document.getElementById('logo-img-1');
            const img2 = document.getElementById('logo-img-2');
            if (img1) img1.src = h.logo;
            if (img2) img2.src = h.logo;

            // Actualizar Headers Text (Por si acaso se usan)
            document.querySelectorAll('.hotel-name-display').forEach(el => el.innerHTML = `${h.name} <span class="stars-display text-[#eab308]">${h.stars}</span>`);
            document.querySelectorAll('.hotel-name-display-2').forEach(el => el.innerHTML = `${h.name} <span class="stars-display-2 text-orange-400">${h.stars}</span>`);
            document.querySelectorAll('.hotel-subname-display, .hotel-subname-display-2').forEach(el => el.innerText = h.subname);
            document.querySelectorAll('.hotel-brand-display, .hotel-brand-display-2').forEach(el => el.innerText = h.brand);
            document.querySelectorAll('.hotel-letter-display').forEach(el => el.innerText = h.letter);
            document.querySelectorAll('.hotel-city-display').forEach(el => el.innerText = h.city);

            // Actualizar Legal Text (Vertical)
            const legalSpan = document.querySelector('#tpl-proforma .absolute span');
            if (legalSpan) {
                legalSpan.innerHTML = `${h.company} &nbsp;&nbsp;&nbsp; ${h.legal} &nbsp;&nbsp;&nbsp; N.I.F. ${h.nif}`;
            }

            // Actualizar Footer
            document.querySelector('.hotel-address-footer').innerText = h.address.toUpperCase();
            document.querySelector('.hotel-cp-footer').innerText = h.cp;
            document.querySelector('.hotel-city-footer').innerText = h.city;
            document.querySelector('.hotel-email-footer').innerText = h.email;
            document.querySelector('.hotel-web-footer').innerText = h.web;
            document.querySelector('.hotel-tel-footer').innerText = h.tel;
            document.querySelector('.hotel-fax-footer').innerText = h.fax;

            renderItems();
        }

        function renderItems() {
            const h = HOTELS[currentHotel];
            const now = new Date();
            const tsDate = document.getElementById('timestamp-date');
            const tsTime = document.getElementById('timestamp-time');
            if (tsDate) tsDate.innerText = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
            if (tsTime) tsTime.innerText = now.getHours() + "." + String(now.getMinutes()).padStart(2, '0');

            const containers = document.querySelectorAll('.invoice-items');
            const footer = document.getElementById('footer-totals');
            let total = 0;
            let runningTotal = 0;
            let base10 = 0, iva10 = 0, base21 = 0, iva21 = 0;

            containers.forEach(c => c.innerHTML = '');

            items.forEach((item, index) => {
                const subtotal = parseFloat(item.precio) || 0;
                total += subtotal;
                runningTotal += subtotal;

                const ivaVal = parseFloat(item.iva) || 10;
                if (ivaVal === 10) {
                    const base = subtotal / 1.1;
                    base10 += base;
                    iva10 += (subtotal - base);
                } else {
                    const base = subtotal / 1.21;
                    base21 += base;
                    iva21 += (subtotal - base);
                }

                if (currentTemplate === 'confirmacion') {
                    const row = `
                        <tr class="border-b">
                            <td class="p-2 text-gray-400"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'fecha', this.innerText)">${item.fecha}</span></td>
                            <td class="p-2 text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'cant', this.innerText)">${item.cant || ''}</span></td>
                            <td class="p-2"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span></td>
                            <td class="p-2 text-center">-</td>
                            <td class="p-2 text-center">1</td>
                            <td class="p-2 text-right"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(subtotal)}</span></td>
                            <td class="p-2 text-center">${ivaVal}%</td>
                            <td class="p-2 text-right font-bold">${formatNum(subtotal)}</td>
                            <td class="p-2 no-print"><button onclick="removeItem(${index})" class="text-red-300 hover:text-red-600">‚úï</button></td>
                        </tr>`;
                    document.querySelector('#tpl-confirmacion .invoice-items').insertAdjacentHTML('beforeend', row);
                } else {
                    const row = `
                        <tr class="h-6">
                            <td class="align-top">${item.fecha}</td>
                            <td class="align-top text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'hab', this.innerText)">${item.hab || ''}</span></td>
                            <td class="align-top text-center"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'cant', this.innerText)">${item.cant || ''}</span></td>
                            <td class="align-top uppercase font-bold text-[10px]">
                                <span class="editable" contenteditable="true" onblur="updateItem(${index}, 'concepto', this.innerText)">${item.concepto}</span>
                            </td>
                            <td class="align-top text-right font-bold"><span class="editable" contenteditable="true" onblur="updateItem(${index}, 'precio', this.innerText)">${formatNum(subtotal)}</span></td>
                            <td class="align-top text-right"></td>
                            <td class="align-top text-right font-bold">${formatNum(runningTotal)}</td>
                            <td class="no-print align-top text-center"><button onclick="removeItem(${index})" class="text-red-300 hover:text-red-600">‚úï</button></td>
                        </tr>`;
                    document.querySelector('#tpl-proforma .invoice-items').insertAdjacentHTML('beforeend', row);
                }
            });

            if (currentTemplate === 'confirmacion') {
                footer.innerHTML = `
                    <div class="flex flex-col items-end mt-4">
                        <div class="bg-[#2d5a43] text-white p-4 w-64 shadow-lg mb-2">
                            <p class="text-[8px] uppercase tracking-widest border-b border-emerald-800 mb-1 text-left">Total Factura (IVA inc.)</p>
                            <p class="text-xl font-bold text-right">${formatNum(total)} ‚Ç¨</p>
                        </div>
                        <div class="text-right text-[9px] text-gray-500 mr-1">
                            ${base10 > 0 ? `<p>I.V.A. 10% sobre ${formatNum(base10)} = ${formatNum(iva10)} ya incluido.</p>` : ''}
                            ${base21 > 0 ? `<p>I.V.A. 21% sobre ${formatNum(base21)} = ${formatNum(iva21)} ya incluido.</p>` : ''}
                        </div>
                    </div>`;
            } else {

                // C√°lculo de fechas autom√°tico
                const entradaStr = document.getElementById('reserva-entrada-2')?.innerText || '21-04-2026';
                const [d, m, y] = entradaStr.split('-').map(Number);
                const fechaEntrada = new Date(y, m - 1, d);

                const fRelease = new Date(fechaEntrada);
                fRelease.setDate(fRelease.getDate() - 7);

                const fDeposito1 = new Date(fechaEntrada);
                fDeposito1.setDate(fDeposito1.getDate() - 60);

                const fDeposito2 = new Date(fechaEntrada);
                fDeposito2.setDate(fDeposito2.getDate() - 30);

                const formatDate = (date) => {
                    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                };

                footer.innerHTML = `
                    <div class="mt-4 flex flex-col items-end font-pro text-[11px]">
                        <div class="flex w-full border-t border-black pt-2 mb-6 px-4">
                            <div class="w-1/2"></div>
                            <div class="w-1/2 flex justify-between">
                                <span class="font-bold text-sm tracking-tighter">TOTAL FACTURA</span>
                                <span class="font-bold text-sm">${formatNum(total)}</span>
                            </div>
                        </div>
                        
                        <div class="w-1/2 pr-4 text-right space-y-1 mb-8">
                            ${base10 > 0 ? `<p>I.V.A. 10% sobre ${formatNum(base10)} = ${formatNum(iva10)} ya Incluido.</p>` : ''}
                            ${base21 > 0 ? `<p>I.V.A. 21% sobre ${formatNum(base21)} = ${formatNum(iva21)} ya Incluido.</p>` : ''}
                        </div>

                        <div class="flex w-full font-bold text-sm mb-4 px-4">
                             <div class="w-1/2 text-left">
                                <div class="text-[10px] font-normal mt-1 border border-gray-200 p-2 rounded no-print bg-gray-50 flex items-center gap-2 cursor-pointer hover:bg-emerald-50 transition" onclick="alert('Solicitando enlace de pago seguro Redsys...')">
                                    <span class="text-emerald-600">üí≥</span> Solicitar enlace de pago seguro
                                </div>
                             </div>
                             <div class="w-1/2 flex justify-between">
                                 <span class="tracking-tighter">TOTAL a PAGAR</span>
                                 <span>${formatNum(total)}</span>
                             </div>
                        </div>

                        <div class="w-full grid grid-cols-2 gap-8 px-4 mt-4">
                            <div class="text-left leading-relaxed text-[10px]">
                                <p class="font-bold text-sm mb-1">${h.subname === 'Cumbria' ? 'Cumbria Spa & Hotel' : 'Sercotel Guadiana'}</p>
                                <p>${h.company} - ${h.nif}</p>
                                <p class="font-bold italic text-emerald-800">IBAN ${h.subname === 'Cumbria' ? 'EUROCAJA RURAL' : 'GLOBALCAJA'}: ${h.iban}</p>
                            </div>
                            <div class="text-right space-y-1">
                                <p><strong>1er Dep√≥sito Requerido (30%):</strong> <span class="editable" contenteditable="true">${formatNum(total * 0.3)}</span> ‚Ç¨ (Vence: ${formatDate(fDeposito1)})</p>
                                <p><strong>2¬∫ Dep√≥sito Requerido (70%):</strong> <span class="editable" contenteditable="true">${formatNum(total * 0.7)}</span> ‚Ç¨ (Vence: ${formatDate(fDeposito2)})</p>
                                <p class="pt-2 text-[10px] text-gray-600 italic"><strong>Fecha de Release Final:</strong> ${formatDate(fRelease)}</p>
                            </div>
                        </div>
                    </div>`;
            }
        }

        function formatNum(n) {
            return new Number(n).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateItem(index, key, val) {
            if (['concepto', 'fecha', 'hab', 'cant'].includes(key)) {
                items[index][key] = val;
            } else {
                items[index][key] = parseFloat(val.toString().replace(/\./g, '').replace(',', '.')) || 0;
            }
            renderItems();
        }

        function addRow() {
            items.push({ fecha: '24-04-26', hab: '', cant: '1', concepto: 'Nuevo Concepto', precio: 0, iva: 10 });
            renderItems();
        }
        function removeItem(index) { items.splice(index, 1); renderItems(); }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.querySelectorAll('.logo-placeholder').forEach(img => { img.src = e.target.result; img.classList.remove('hidden'); });
                    document.querySelectorAll('.font-logo').forEach(t => t.classList.add('hidden'));
                    const logoContainer = document.getElementById('default-logo-2');
                    if (logoContainer) logoContainer.classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


    </script>
</body>

</html>